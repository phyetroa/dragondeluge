<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Dragon Deluge">
    <meta name="theme-color" content="#0e0a06">
    <title>Dragon Deluge</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bangers&family=Rajdhani:wght@500;700&family=Oswald:wght@700&display=swap');

        :root {
            --db-orange: #ff6a00;
            --db-gold: #f5c518;
            --db-red: #e53935;
            --db-dark: #0e0a06;
            --db-panel: rgba(20, 10, 5, 0.92);
            --db-border: rgba(245, 197, 24, 0.6);
            --db-glow: rgba(255, 140, 0, 0.4);
        }

        body {
            margin: 0;
            overflow: hidden;
            background: radial-gradient(ellipse at center, #1a0800 0%, #000 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: 'Rajdhani', sans-serif;
            color: white;
            user-select: none;
        }

        .game-wrapper {
            position: relative;
            max-width: 100%;
            max-height: 100%;
            aspect-ratio: 1100 / 650;
            border: 2px solid var(--db-gold);
            border-radius: 3px;
            overflow: hidden;
            box-shadow: 0 0 60px rgba(255, 140, 0, 0.35), 0 0 20px rgba(255, 100, 0, 0.2) inset;
            flex-shrink: 0;
        }

        .xenoverse-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: 
                linear-gradient(rgba(255, 140, 0, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 140, 0, 0.03) 1px, transparent 1px);
            background-size: 55px 55px;
            pointer-events: none;
            z-index: 5;
        }

        .crt-scanlines {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(0,0,0,0) 50%, rgba(0,0,0,0.06) 50%);
            background-size: 100% 3px;
            pointer-events: none;
            z-index: 10;
            opacity: 0.25;
        }

        canvas {
            width: 100%;
            height: 100%;
            image-rendering: pixelated;
            background-color: #0a0602;
            display: block;
        }

        /* ‚îÄ‚îÄ TELA DE LOGIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        /* Overlay cobre a tela inteira e centraliza o painel */
        #auth-overlay {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: radial-gradient(ellipse at center, #1a0800 0%, #000 100%);
            z-index: 300;
            overflow-y: auto;
            padding: 16px;
            box-sizing: border-box;
        }

        /* Painel central do login */
        .auth-panel {
            background: linear-gradient(160deg, rgba(30,10,2,0.98) 0%, rgba(10,5,2,1) 100%);
            padding: 40px 28px 32px;
            border-top: 3px solid var(--db-gold);
            border-bottom: 3px solid var(--db-gold);
            border-left: 1px solid rgba(245,197,24,0.3);
            border-right: 1px solid rgba(245,197,24,0.3);
            text-align: center;
            width: 100%;
            max-width: 420px;
            box-sizing: border-box;
            backdrop-filter: blur(20px);
            clip-path: polygon(12px 0%, 100% 0%, calc(100% - 12px) 100%, 0% 100%);
            position: relative;
            flex-shrink: 0;
        }

        /* Brilho dourado pulsante na borda do login */
        .auth-panel::before {
            content: '';
            position: absolute;
            inset: -1px;
            background: linear-gradient(135deg, rgba(245,197,24,0.15), transparent 60%);
            pointer-events: none;
        }

        .auth-content { position: relative; z-index: 1; }

        h1.title {
            font-family: 'Bangers', cursive;
            color: #fff;
            font-size: 72px;
            margin: 0 0 2px;
            text-transform: uppercase;
            letter-spacing: 4px;
            line-height: 1;
            text-shadow: 0 0 30px rgba(255,140,0,0.8), 3px 3px 0px #c07000, 6px 6px 0px rgba(0,0,0,0.5);
        }

        .title-dragon { color: #ff8c00; }
        .title-deluge { color: #f5c518; }

        .subtitle {
            color: rgba(245, 197, 24, 0.7);
            font-weight: 700;
            font-size: 11px;
            letter-spacing: 6px;
            margin-bottom: 32px;
            display: block;
            text-transform: uppercase;
        }

        .auth-divider {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
        }
        .auth-divider::before, .auth-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(245,197,24,0.4), transparent);
        }
        .auth-divider span {
            font-size: 11px;
            color: rgba(245,197,24,0.5);
            letter-spacing: 3px;
        }

        .input-group {
            margin-bottom: 18px;
            text-align: left;
        }

        .input-group label {
            display: block;
            font-size: 11px;
            color: var(--db-gold);
            margin-bottom: 8px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        input { 
            padding: 14px 16px;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(245,197,24,0.25);
            border-bottom: 2px solid rgba(245,197,24,0.5);
            width: 100%;
            color: #fff;
            font-family: 'Rajdhani';
            box-sizing: border-box;
            font-size: 18px;
            transition: 0.3s;
            border-radius: 0;
        }

        input:focus {
            outline: none;
            background: rgba(255,140,0,0.08);
            border-color: var(--db-gold);
            border-bottom-color: var(--db-orange);
            box-shadow: 0 4px 20px rgba(255,140,0,0.15);
        }

        button.spark-btn { 
            padding: 18px;
            background: linear-gradient(135deg, var(--db-orange), #c05000);
            border: none;
            color: #fff;
            cursor: pointer;
            font-family: 'Bangers', cursive;
            font-size: 26px;
            letter-spacing: 3px;
            width: 100%;
            margin-top: 18px;
            transition: 0.25s;
            text-transform: uppercase;
            clip-path: polygon(10px 0%, 100% 0%, calc(100% - 10px) 100%, 0% 100%);
            text-shadow: 1px 1px 0 rgba(0,0,0,0.5);
        }

        button.spark-btn:hover {
            background: linear-gradient(135deg, #ff8c00, var(--db-gold));
            color: #000;
            transform: scale(1.03);
            box-shadow: 0 0 25px rgba(255,140,0,0.5);
            text-shadow: none;
        }

        #game-modal {
            position: absolute;
            bottom: 55px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, rgba(255,140,0,0.95), rgba(200,80,0,0.95));
            color: #fff;
            padding: 12px 44px;
            font-family: 'Bangers', cursive;
            font-size: 22px;
            letter-spacing: 2px;
            z-index: 200;
            display: none;
            clip-path: polygon(8px 0%, 100% 0%, calc(100% - 8px) 100%, 0% 100%);
            text-shadow: 1px 1px 0 rgba(0,0,0,0.4);
            box-shadow: 0 4px 20px rgba(255,100,0,0.4);
        }

        /* ‚îÄ‚îÄ OVERLAY DE ROTA√á√ÉO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        #rotate-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #0e0a06;
            z-index: 9999;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 24px;
        }
        #rotate-overlay .rotate-icon {
            font-size: 72px;
            animation: rotateHint 2s ease-in-out infinite;
        }
        #rotate-overlay p {
            font-family: 'Bangers', cursive;
            font-size: 28px;
            color: var(--db-gold);
            letter-spacing: 3px;
            text-align: center;
            margin: 0;
            text-shadow: 0 0 20px rgba(255,140,0,0.6);
        }
        #rotate-overlay small {
            font-family: 'Rajdhani', sans-serif;
            font-size: 13px;
            color: rgba(245,197,24,0.5);
            letter-spacing: 2px;
        }
        @keyframes rotateHint {
            0%,100% { transform: rotate(0deg); }
            40%      { transform: rotate(90deg); }
            60%      { transform: rotate(90deg); }
        }

        /* ‚îÄ‚îÄ RESPONSIVO MOBILE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        /* Em qualquer tela mobile o wrapper mant√©m o aspect ratio 1100/650
           e fica centralizado ‚Äî nunca estica o canvas */
        @media (max-width: 900px) {
            body {
                padding: 0;
                overflow: hidden;
                touch-action: none;
            }
            .game-wrapper {
                /* Mant√©m propor√ß√£o ‚Äî barras pretas em vez de esticar */
                aspect-ratio: 1100 / 650;
                width: min(100vw, calc(100vh * 1100 / 650));
                height: min(100vh, calc(100vw * 650 / 1100));
                max-width: 100vw;
                max-height: 100vh;
                border: none;
                border-radius: 0;
            }
            canvas {
                width: 100% !important;
                height: 100% !important;
            }
            h1.title { font-size: 48px; }
            .subtitle { font-size: 9px; }
            .auth-panel {
                clip-path: none;
                border-radius: 8px;
                border: 2px solid var(--db-gold);
                padding: 28px 20px 24px;
            }
            #fullscreenBtn {
                width: 40px;
                height: 40px;
                font-size: 20px;
                opacity: 0.7;
            }
        }

        /* Portrait: mostrar overlay de rota√ß√£o */
        @media (orientation: portrait) and (max-width: 900px) {
            #rotate-overlay { display: flex; }
            .game-wrapper    { display: none; }
            /* login continua vis√≠vel em portrait ‚Äî s√≥ o canvas some */
        }

        /* Landscape mobile: mesma l√≥gica de aspect ratio */
        @media (orientation: landscape) and (max-height: 500px) {
            body { padding: 0; }
            .game-wrapper {
                aspect-ratio: 1100 / 650;
                width: min(100vw, calc(100vh * 1100 / 650));
                height: min(100vh, calc(100vw * 650 / 1100));
                max-width: 100vw;
                max-height: 100vh;
                border: none;
                border-radius: 0;
            }
            canvas {
                width: 100% !important;
                height: 100% !important;
            }
            .auth-panel {
                clip-path: none;
                border-radius: 8px;
                border: 2px solid var(--db-gold);
                padding: 20px 16px;
            }
            h1.title     { font-size: 44px; }
            .subtitle    { font-size: 9px; letter-spacing: 3px; }
            .input-group { margin-bottom: 10px; }
            input        { padding: 10px 14px; font-size: 16px; }
            button.spark-btn { padding: 12px; font-size: 22px; margin-top: 10px; }
        }

        /* ‚îÄ‚îÄ PERFIL DO JOGADOR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        #profile-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.88); z-index: 500;
            justify-content: center; align-items: center;
        }
        .profile-box {
            background: linear-gradient(160deg, rgba(25,10,2,0.99), rgba(10,4,1,1));
            border-top: 3px solid var(--db-gold);
            border-bottom: 3px solid var(--db-gold);
            border-left: 1px solid rgba(245,197,24,0.3);
            border-right: 1px solid rgba(245,197,24,0.3);
            padding: 28px 26px; width: 90%; max-width: 490px;
            font-family: 'Rajdhani', sans-serif; color: #fff; position: relative;
            max-height: 82vh; overflow-y: auto;
            clip-path: polygon(10px 0%, 100% 0%, calc(100% - 10px) 100%, 0% 100%);
        }
        .profile-title { font-family: 'Bangers', cursive; font-size: 36px; letter-spacing: 2px; margin: 0 0 4px; color: #ff8c00; text-shadow: 2px 2px 0 #800; }
        .profile-sub { font-size: 11px; color: rgba(245,197,24,0.6); letter-spacing: 4px; display: block; margin-bottom: 18px; text-transform: uppercase; }
        .profile-stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 18px; }
        .pstat { background: rgba(255,140,0,0.07); padding: 10px; text-align: center; border: 1px solid rgba(245,197,24,0.2); border-bottom: 2px solid rgba(245,197,24,0.4); }
        .pstat-label { display: block; font-size: 10px; color: rgba(245,197,24,0.55); margin-bottom: 4px; letter-spacing: 2px; text-transform: uppercase; }
        .pstat-val { font-size: 22px; font-family: 'Bangers', cursive; letter-spacing: 1px; }
        .profile-section-title { font-size: 11px; color: var(--db-gold); letter-spacing: 3px; margin: 14px 0 8px; border-bottom: 1px solid rgba(245,197,24,0.25); padding-bottom: 4px; text-transform: uppercase; }
        .battle-row { display: flex; justify-content: space-between; align-items: center; padding: 7px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 14px; gap: 8px; }
        .close-profile { position: absolute; top: 12px; right: 14px; background: rgba(255,140,0,0.1); border: 1px solid rgba(245,197,24,0.3); color: var(--db-gold); cursor: pointer; font-size: 16px; width: 30px; height: 30px; transition: 0.2s; }
        .close-profile:hover { background: rgba(255,140,0,0.3); color: #fff; }

        /* ‚îÄ‚îÄ BOT√ÉO TELA CHEIA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        #fullscreenBtn {
            position: absolute; top: 8px; right: 8px; z-index: 100;
            width: 32px; height: 32px;
            background: rgba(0,0,0,0.6);
            border: 1px solid rgba(245,197,24,0.5);
            color: #f5c518;
            font-size: 16px; cursor: pointer;
            border-radius: 4px;
            display: flex; align-items: center; justify-content: center;
            opacity: 0.5; transition: opacity 0.2s, background 0.2s;
            line-height: 1;
        }
        #fullscreenBtn:hover { opacity: 1; background: rgba(255,140,0,0.3); }
    </style>
</head>
<body>

<div id="rotate-overlay">
    <div class="rotate-icon">üì±</div>
    <p>üêâ RODE O DISPOSITIVO üêâ</p>
    <small>O JOGO REQUER MODO PAISAGEM</small>
</div>

<div id="game-modal">SYSTEM MESSAGE</div>

<div id="auth-overlay">
    <div class="auth-panel">
        <div class="auth-content">
            <h1 class="title"><span class="title-dragon">DRAGON</span><br><span class="title-deluge">DELUGE</span></h1>
            <span class="subtitle">üêâ Patrulha do Tempo ‚Äî Centro de Combate üêâ</span>
            <div class="auth-divider"><span>ACESSO DO GUERREIRO</span></div>
            <div class="input-group">
                <label>‚öî Nome do Guerreiro</label>
                <input type="text" id="user" placeholder="Ex: Goku, Vegeta...">
            </div>
            <div class="input-group">
                <label>üîí C√≥digo de Acesso</label>
                <input type="password" id="pass" placeholder="Senha secreta">
            </div>
            <button class="spark-btn" onclick="handleAuth()">üêâ ENTRAR NA BATALHA</button>
        </div>
    </div>
</div>

<!-- PERFIL DO JOGADOR -->
<div id="profile-overlay">
    <div class="profile-box">
        <button class="close-profile" onclick="window.closeProfile()">‚úï</button>
        <h2 class="profile-title" id="profile-name">GUERREIRO</h2>
        <span class="profile-sub" id="profile-sub">FICHA DO OPERADOR</span>
        <div class="profile-stat-grid" id="profile-stats"></div>
        <div class="profile-section-title">üìä HIST√ìRICO DE BATALHAS</div>
        <div id="profile-battles"></div>
    </div>
</div>

<div class="game-wrapper" id="gameWrapper">
    <div class="xenoverse-overlay"></div>
    <div class="crt-scanlines"></div>
    <canvas id="gameCanvas" width="1100" height="650"></canvas>
    <button id="fullscreenBtn" title="Tela Cheia" onclick="toggleFullscreen()">‚õ∂</button>
</div>

<script type="module">
// ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
// ‚ïë           DRAGON DELUGE ‚Äî GUIA DE PERSONALIZA√á√ÉO            ‚ïë
// ‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
// ‚ïë  ONDE EDITAR CADA COISA:                                     ‚ïë
// ‚ïë  üìã Miss√µes:       procure "STORY_SEQUENCE"                  ‚ïë
// ‚ïë  üé≠ Personagens:   procure "charactersDB"                    ‚ïë
// ‚ïë  üëó Trajes:        adicione isCostume:true no charactersDB   ‚ïë
// ‚ïë  ‚ö° Transforma√ß√µes: adicione isTransformation:true no DB     ‚ïë
// ‚ïë  üõí Itens da Loja: procure "itemsDB"                         ‚ïë
// ‚ïë  üåÄ Fus√µes:        procure "FUSION_RECIPES"                  ‚ïë
// ‚ïë  üåç Cen√°rios:      procure "BATTLE_STAGES"                   ‚ïë
// ‚ïë  ‚öîÔ∏è  Efeitos Itens: procure "useItem"                         ‚ïë
// ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

// ==========================================
// 0. FIREBASE (RANKING GLOBAL)
// ==========================================
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, doc, setDoc, getDoc, addDoc, onSnapshot, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

let app, auth, db;
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

try {
    const firebaseConfigStr = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
    if (firebaseConfigStr && firebaseConfigStr.trim() !== "" && firebaseConfigStr !== "{}") {
        const firebaseConfig = JSON.parse(firebaseConfigStr);
        if (Object.keys(firebaseConfig).length > 0) {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        }
    }
} catch (e) {
    console.warn("Aviso: Configura√ß√£o Cloud n√£o detetada. O jogo funcionar√° no Modo Local (Offline).");
}

let fbUser = null;
let leaderboardData = [];
window._fbReady = false;
window._fbUser = null;

const initAuth = async () => {
    if (!auth) return;
    try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            await signInWithCustomToken(auth, __initial_auth_token);
        } else {
            await signInAnonymously(auth);
        }
    } catch (e) { console.error("Erro na autentica√ß√£o Cloud", e); }
};
initAuth();

if (auth) {
    onAuthStateChanged(auth, (user) => {
        fbUser = user;
        window._fbUser = user;
        window._fbReady = !!user;
        if (user && db) {
            const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard');
            onSnapshot(colRef, (snapshot) => {
                let data = [];
                snapshot.forEach(d => data.push({id: d.id, ...d.data()}));
                data.sort((a, b) => {
                    if ((b.maxSurvival || 0) !== (a.maxSurvival || 0)) return (b.maxSurvival || 0) - (a.maxSurvival || 0);
                    return (b.victories || 0) - (a.victories || 0);
                });
                leaderboardData = data;
            }, (err) => console.error("Erro no Ranking", err));
        }
    });
}

async function saveCloud() {
    if (!fbUser || !player.name || !db) return;
    try {
        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'leaderboard', fbUser.uid);
        await setDoc(docRef, {
            name: player.name,
            level: player.level,
            exp: player.exp,
            victories: player.victories || 0,
            defeats: player.defeats || 0,
            maxSurvival: player.maxSurvivalWave || 0,
            zeni: player.zeni || 0,
            updatedAt: new Date().getTime()
        }, { merge: true });
    } catch (e) { console.warn("Erro a gravar na cloud", e); }
}

async function saveBattleHistory(result, enemyName, mode) {
    if (!fbUser || !db) return;
    try {
        const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'battles', fbUser.uid, 'history');
        await addDoc(colRef, {
            result, enemyName, mode,
            playerName: player.name,
            level: player.level,
            timestamp: new Date().getTime()
        });
    } catch(e) {}
}
window.saveBattleHistory = saveBattleHistory;

// ‚îÄ‚îÄ PERFIL DO JOGADOR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let profileData = null;
let profileBattles = [];

function openProfile(uid, name) {
    const overlay = document.getElementById('profile-overlay');
    if (!overlay) return;
    overlay.style.display = 'flex';
    document.getElementById('profile-name').textContent = name ? name.toUpperCase() : 'GUERREIRO';
    document.getElementById('profile-sub').textContent = 'FICHA DO OPERADOR';
    document.getElementById('profile-stats').innerHTML = '<p style="color:#aaa">A carregar...</p>';
    document.getElementById('profile-battles').innerHTML = '<p style="color:#aaa">A carregar...</p>';

    // Dados do leaderboard
    const entry = leaderboardData.find(e => e.id === uid);
    if (entry) {
        document.getElementById('profile-stats').innerHTML = `
            <div class="pstat"><span class="pstat-label">N√çVEL</span><span class="pstat-val">${entry.level || '?'}</span></div>
            <div class="pstat"><span class="pstat-label">VIT√ìRIAS</span><span class="pstat-val" style="color:#2ecc71">${entry.victories || 0}</span></div>
            <div class="pstat"><span class="pstat-label">DERROTAS</span><span class="pstat-val" style="color:#e74c3c">${entry.defeats || 0}</span></div>
            <div class="pstat"><span class="pstat-label">ONDA M√ÅX</span><span class="pstat-val" style="color:#f1c40f">${entry.maxSurvival || 0}</span></div>
            <div class="pstat"><span class="pstat-label">ZENI</span><span class="pstat-val">${(entry.zeni || 0).toLocaleString()}</span></div>
        `;
    } else {
        // Dados locais (pr√≥prio jogador sem firebase)
        document.getElementById('profile-stats').innerHTML = `
            <div class="pstat"><span class="pstat-label">N√çVEL</span><span class="pstat-val">${player.level}</span></div>
            <div class="pstat"><span class="pstat-label">VIT√ìRIAS</span><span class="pstat-val" style="color:#2ecc71">${player.victories || 0}</span></div>
            <div class="pstat"><span class="pstat-label">DERROTAS</span><span class="pstat-val" style="color:#e74c3c">${player.defeats || 0}</span></div>
            <div class="pstat"><span class="pstat-label">ONDA M√ÅX</span><span class="pstat-val" style="color:#f1c40f">${player.maxSurvivalWave || 0}</span></div>
            <div class="pstat"><span class="pstat-label">ZENI</span><span class="pstat-val">${(player.zeni || 0).toLocaleString()}</span></div>
        `;
    }

    // Hist√≥rico de batalhas do firebase
    if (db && uid) {
        const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'battles', uid, 'history');
        const q = query(colRef, orderBy('timestamp', 'desc'), limit(10));
        onSnapshot(q, snap => {
            if (snap.empty) {
                document.getElementById('profile-battles').innerHTML = '<p style="color:#aaa;font-size:13px">Sem batalhas registadas.</p>';
                return;
            }
            let html = '';
            snap.forEach(d => {
                const b = d.data();
                const col = b.result === 'WIN' ? '#2ecc71' : '#e74c3c';
                const icon = b.result === 'WIN' ? '‚öîÔ∏è' : 'üíÄ';
                const date = new Date(b.timestamp).toLocaleDateString('pt-PT');
                html += `<div class="battle-row"><span style="color:${col}">${icon} ${b.result}</span> <span>vs ${b.enemyName}</span> <span style="color:#aaa;font-size:12px">${b.mode} ¬∑ ${date}</span></div>`;
            });
            document.getElementById('profile-battles').innerHTML = html;
        }, () => {
            document.getElementById('profile-battles').innerHTML = '<p style="color:#aaa;font-size:13px">Hist√≥rico indispon√≠vel (offline).</p>';
        });
    } else {
        document.getElementById('profile-battles').innerHTML = '<p style="color:#aaa;font-size:13px">Firebase n√£o dispon√≠vel.</p>';
    }
}
window.openProfile = openProfile;

function closeProfile() {
    const overlay = document.getElementById('profile-overlay');
    if (overlay) overlay.style.display = 'none';
}
window.closeProfile = closeProfile;

// ==========================================
// 1. DADOS E CONFIGURA√á√ïES UNIFICADOS
// ==========================================
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
ctx.imageSmoothingEnabled = false; 

const UI_COLORS = {
    accent: "#ff8c00",     // Laranja DB principal
    secondary: "#f5c518",  // Dourado DB
    danger: "#e53935",     // Vermelho
    success: "#43a047",    // Verde
    ki: "#1e88e5",         // Azul ki
    panel: "rgba(15, 6, 2, 0.88)",
    border: "rgba(245, 197, 24, 0.55)"
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ñ∂  BASE DE DADOS DE PERSONAGENS ‚Äî para adicionar um personagem:
//    Copie um bloco existente e modifique as chaves. Campos:
//      name: string           ‚Üí nome exibido
//      path: string           ‚Üí caminho da sprite
//      hp/maxHp: number       ‚Üí vida m√°xima
//      moves: array           ‚Üí lista de movimentos
//      transList: array       ‚Üí chaves das transforma√ß√µes desbloque√°veis
//      isTransformation:bool  ‚Üí se √© uma forma transformada
//      isCostume:bool         ‚Üí se √© um traje alternativo
//      baseChar: string       ‚Üí chave do personagem base (para trajes)
//      price: number          ‚Üí pre√ßo na loja (0 = gr√°tis, undefined = n√£o vend√°vel)
//      shopScale: number      ‚Üí escala de exibi√ß√£o na loja
//      aura: string           ‚Üí cor da aura (ex: "#00d2ff")
//      isEvil: bool           ‚Üí se √© membro do lado mau (para Marca Majin)
//      absorbList: array      ‚Üí [{target:"X", result:"Y"}] para absor√ß√£o (Cell)
//      hidden: bool           ‚Üí se true, o personagem N√ÉO aparece na sele√ß√£o de personagem
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const charactersDB = {
    // ---- GOKU Z (BASE E TRAJES) ----
    "GokuC": {
        baseChar: "GokuC",
        name: "GOKU (CL√ÅSSICO)",
        hp: 1000,
        maxHp: 1000,
        price: 0,
        kiCost: 50,
        scale: 4.0,
        path: "Personagens/GokuC.png",
        moves: [
            { name: "GOLPE DO BAST√ÉO", dmg: 50, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "KAMEHAMEHA", dmg: 150, type: "beam", cost: 50 },
            { name: "PEDRA, PAPEL E TESOURA", dmg: 100, type: "physical", cost: 80 }
        ],
        transList: ["OozaruC"],
        costumes: ["GokuC2", "GokuC3", "GokuC4"]
    },

    "GokuC2": {
        name: "GOKU (C) TRAJE 2",
        isCostume: true,
        baseChar: "GokuC",
        hp: 1000,
        maxHp: 1000,
        price: 1500,
        kiCost: 50,
        scale: 4.0,
        path: "Personagens/GokuC2.png",
        moves: [
            { name: "GOLPE DO BAST√ÉO", dmg: 50, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "KAMEHAMEHA", dmg: 150, type: "beam", cost: 50 },
            { name: "PEDRA, PAPEL E TESOURA", dmg: 100, type: "physical", cost: 80 }
        ],
        transList: [],
        costumes: []
    },

    "GokuC3": {
        name: "GOKU (C) TRAJE 3",
        isCostume: true,
        baseChar: "GokuC",
        hp: 1000,
        maxHp: 1000,
        price: 1500,
        kiCost: 50,
        scale: 4.0,
        path: "Personagens/GokuC3.png",
        moves: [
            { name: "GOLPE DO BAST√ÉO", dmg: 50, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "KAMEHAMEHA", dmg: 150, type: "beam", cost: 50 },
            { name: "PEDRA, PAPEL E TESOURA", dmg: 100, type: "physical", cost: 80 }
        ],
        transList: [],
        costumes: []
    },

    "GokuC4": {
        name: "GOKU (C) TRAJE 4",
        isCostume: true,
        baseChar: "GokuC",
        hp: 1000,
        maxHp: 1000,
        price: 1500,
        kiCost: 50,
        scale: 4.0,
        path: "Personagens/GokuC4.png",
        moves: [
            { name: "GOLPE DO BAST√ÉO", dmg: 50, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "KAMEHAMEHA", dmg: 150, type: "beam", cost: 50 },
            { name: "PEDRA, PAPEL E TESOURA", dmg: 100, type: "physical", cost: 80 }
        ],
        transList: [],
        costumes: []
    },

    "OozaruC": {
        baseChar: "OozaruC",
        name: "OOZARU",
        isTransformation: true,
        hp: 3000,
        maxHp: 3000,
        price: 2000, 
        kiCost: 50,
        scale: 3.5,
        previewScale: 2.5,
        shopScale: 1.3,
        path: "Personagens/Oozaru.png",
        moves: [
            { name: "PISADA GIGANTE", dmg: 200, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "CHOU MAKOUHOU", dmg: 400, type: "beam", cost: 50 },
            { name: "ESMAGAMENTO", dmg: 300, type: "physical", cost: 100 }
        ],
        transList: [],
        costumes: []
    },

    "GokuZ": {
        baseChar: "GokuZ",
        name: "GOKU (Z)",
        hp: 1200,
        maxHp: 1200,
        price: 0,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/GokuZ.png",
        moves: [
            { name: "SOCO COMBINADO", dmg: 75, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "KAMEHAMEHA", dmg: 220, type: "beam", cost: 40 },
            { name: "GENKIDAMA", dmg: 550, type: "sphere", cost: 100 }
        ],
        transList: ["GokuZKaioken"],
        costumes: ["GokuZ2", "GokuZ3", "GokuZ4", "GokuZ5", "GokuZ6", "GokuZ7", "GokuZ8"]
    },

    "GokuZKaioken": {
        baseChar: "GokuZKaioken",
        name: "GOKU (KAIOKEN)",
        isTransformation: true,
        hp: 1400,
        maxHp: 1400,
        price: 1000, 
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/GokuZKK.png",
        moves: [
            { name: "SOCO KK", dmg: 90, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "KAMEHAMEHA X2", dmg: 300, type: "beam", cost: 40 },
            { name: "INVESTIDA KAIOKEN", dmg: 100, type: "physical", cost: 50 }
        ],
        transList: [],
        costumes: []
    },

    "GokuZ2": {
        name: "GOKU (TRAJE 2)",
        isCostume: true,
        baseChar: "GokuZ",
        hp: 1200,
        maxHp: 1200,
        price: 1500,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/GokuZ2.png",
        moves: [
            { name: "SOCO COMBINADO", dmg: 75, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "KAMEHAMEHA", dmg: 220, type: "beam", cost: 40 },
            { name: "GENKIDAMA", dmg: 550, type: "sphere", cost: 100 }
        ],
        transList: [],
        costumes: []
    },

    "GokuZ3": {
        name: "GOKU (TRAJE 3)",
        isCostume: true,
        baseChar: "GokuZ",
        hp: 1200,
        maxHp: 1200,
        price: 1500,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/GokuZ3.png",
        moves: [
            { name: "COMBO Z3", dmg: 80, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "KAMEHAMEHA", dmg: 220, type: "beam", cost: 40 },
            { name: "GOLPE FINAL", dmg: 500, type: "physical", cost: 90 }
        ],
        transList: ["GokuZ3KK"],
        costumes: []
    },

    "GokuZ3KK": {
        baseChar: "GokuZ3KK",
        name: "GOKU (Z3) KAIOKEN",
        isTransformation: true,
        hp: 1400,
        maxHp: 1400,
        price: 1200,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/GokuZ3KK.png",
        moves: [
            { name: "ATAQUE KK", dmg: 100, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "KAMEHAMEHA X4", dmg: 350, type: "beam", cost: 50 },
            { name: "INVESTIDA", dmg: 600, type: "physical", cost: 100 }
        ],
        transList: [],
        costumes: []
    },

    "GokuZ4": {
        name: "GOKU (TRAJE 4)",
        isCostume: true,
        baseChar: "GokuZ",
        hp: 1250,
        maxHp: 1250,
        price: 1500,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/GokuZ4.png",
        moves: [
            { name: "COMBO", dmg: 100, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "KAMEHAMEHA", dmg: 350, type: "beam", cost: 50 },
            { name: "GENKIDAMA", dmg: 600, type: "physical", cost: 100 }
        ],
        transList: ["GokuZ4SSJ"],
        costumes: []
    },

    "GokuZ4SSJ": {
        baseChar: "GokuZ4SSJ",
        name: "GOKU (Z4) SSJ",
        isTransformation: true,
        hp: 1500,
        maxHp: 1500,
        price: 1500, 
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/GokuZ4SSJ.png",
        moves: [
            { name: "COMBOMETEORIC", dmg: 120, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "SUPERKAMEHAMEHA", dmg: 400, type: "beam", cost: 50 },
            { name: "GOLPEDEENERGIAMAXIMA", dmg: 700, type: "beam", cost: 100 }
        ],
        transList: [],
        costumes: ["GokuZ4-2SSJ"] 
    },

    "GokuZ4-2SSJ": {
        name: "GOKU (Z4) SSJ T2",
        isCostume: true,
        isTransformation: true,
        baseChar: "GokuZ4SSJ",
        hp: 1500,
        maxHp: 1500,
        price: 1500,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/GokuZ4-2SSJ.png",
        moves: [
            { name: "COMBOMETEORIC", dmg: 120, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "SUPERKAMEHAMEHA", dmg: 400, type: "beam", cost: 50 },
            { name: "ANGRY KAMEHAMEHA", dmg: 750, type: "beam", cost: 100 }
        ],
        transList: [],
        costumes: []
    },

    "GokuZ5": {
        name: "GOKU (TRAJE 5)",
        isCostume: true,
        baseChar: "GokuZ",
        hp: 1250,
        maxHp: 1250,
        price: 1500,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/GokuZ5.png",
        moves: [
            { name: "COMBO Z3", dmg: 80, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "KAMEHAMEHA", dmg: 220, type: "beam", cost: 40 },
            { name: "GOLPE FINAL", dmg: 500, type: "physical", cost: 90 }
        ],
        transList: ["GokuZ5SSJ"],
        costumes: []
    },

    "GokuZ5SSJ": {
        baseChar: "GokuZ5SSJ",
        name: "GOKU (Z5) SSJ",
        isTransformation: true,
        hp: 1500,
        maxHp: 1500,
        price: 1500,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/GokuZ5SSJ.png",
        moves: [
            { name: "COMBO Z3", dmg: 80, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "KAMEHAMEHA", dmg: 220, type: "beam", cost: 40 },
            { name: "GOLPE FINAL", dmg: 500, type: "physical", cost: 90 }
        ],
        transList: [],
        costumes: []
    },

    "GokuZ6": {
        name: "GOKU (TRAJE 6)",
        isCostume: true,
        baseChar: "GokuZ",
        hp: 1250,
        maxHp: 1250,
        price: 1500,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/GokuZ6.png",
        moves: [
            { name: "COMBO Z3", dmg: 80, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "KAMEHAMEHA", dmg: 220, type: "beam", cost: 40 },
            { name: "GOLPE FINAL", dmg: 500, type: "physical", cost: 90 }
        ],
        transList: ["GokuZ6SSJ", "GokuZ6SSJGrau2", "GokuZ6SSJGrau3"],
        costumes: []
    },

    "GokuZ6SSJ": {
        baseChar: "GokuZ6SSJ",
        name: "GOKU (Z6) SSJ",
        isTransformation: true,
        hp: 1500,
        maxHp: 1500,
        price: 1500,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/GokuZ6SSJ.png",
        moves: [
            { name: "COMBO Z3", dmg: 80, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "GOLPE FRENETICO", dmg: 300, type: "physical", cost: 40 },
            { name: "SUPERKAMEHAMEH", dmg: 450, type: "beam", cost: 90 }
        ],
        transList: ["GokuZ6SSJGrau2"],
        costumes: []
    },

    "GokuZ6SSJGrau2": {
        baseChar: "GokuZ6SSJGrau2",
        name: "GOKU SSJ GRAU 2",
        isTransformation: true,
        hp: 1600,
        maxHp: 1600,
        price: 2000, 
        kiCost: 60,
        scale: 4.8,
        path: "Personagens/GokuZ6SSJGrau2.png",
        moves: [
            { name: "COMBO Z3", dmg: 80, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "GOLPE FRENETICO", dmg: 300, type: "physical", cost: 40 },
            { name: "SUPERKAMEHAMEH", dmg: 450, type: "beam", cost: 90 }
        ],
        transList: ["GokuZ6SSJGrau3"],
        costumes: []
    },

    "GokuZ6SSJGrau3": {
        baseChar: "GokuZ6SSJGrau3",
        name: "GOKU SSJ GRAU 3",
        isTransformation: true,
        hp: 1800,
        maxHp: 1800,
        price: 2500,
        kiCost: 70,
        scale: 4.8,
        path: "Personagens/GokuZ6SSJGrau3.png",
        moves: [
            { name: "COMBO Z3", dmg: 100, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "GOLPE FRENETICO", dmg: 350, type: "physical", cost: 40 },
            { name: "SUPERKAMEHAMEH", dmg: 550, type: "beam", cost: 90 }
        ],
        transList: [],
        costumes: []
    },

    "GokuZ7": {
        name: "GOKU (TRAJE 7)",
        isCostume: true,
        baseChar: "GokuZ",
        hp: 1250,
        maxHp: 1250,
        price: 1500,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/GokuZ7.png",
        moves: [
            { name: "SOCO COMBINADO", dmg: 75, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "KAMEHAMEHA", dmg: 220, type: "beam", cost: 40 },
            { name: "GENKIDAMA", dmg: 550, type: "sphere", cost: 100 }
        ],
        transList: ["GokuZ7SSJ"],
        costumes: []
    },

    "GokuZ7SSJ": {
        baseChar: "GokuZ7SSJ",
        name: "GOKU (Z7) SSJ",
        isTransformation: true,
        hp: 1500,
        maxHp: 1500,
        price: 1500,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/GokuZ7SSJ.png",
        moves: [
            { name: "COMBOMETEORIC", dmg: 120, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "SUPERKAMEHAMEHA", dmg: 400, type: "beam", cost: 50 },
            { name: "GOLPEDEENERGIAMAXIMA", dmg: 700, type: "beam", cost: 100 }
        ],
        transList: [],
        costumes: []
    },

    "GokuZ8": {
        name: "GOKU (Z8)",
        isCostume: true,
        baseChar: "GokuZ",
        canFuse: true,
        hp: 1300,
        maxHp: 1300,
        price: 1500,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/GokuZ8.png",
        moves: [
            { name: "SOCO COMBINADO", dmg: 85, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "KAMEHAMEHA", dmg: 250, type: "beam", cost: 40 },
            { name: "GENKIDAMA", dmg: 600, type: "sphere", cost: 100 }
        ],
        transList: ["GokuSSJ","GokuSSJ2","GokuSSJ3"],
        costumes: []
    },

    "GokuSSJ": {
        baseChar: "GokuSSJ",
        name: "GOKU (SSJ)",
        isTransformation: true,
        hp: 1400,
        maxHp: 1400,
        price: 1500, 
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/GokuZ8SSJ.png",
        moves: [
            { name: "ASSALTO SSJ", dmg: 100, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "SUPER KAMEHAMEHA", dmg: 320, type: "beam", cost: 40 },
            { name: "ANGRY KAME", dmg: 650, type: "beam", cost: 90 }
        ],
        transList: ["GokuSSJ2"],
        costumes: []
    },

    "GokuSSJ2": {
        baseChar: "GokuSSJ2",
        name: "GOKU (SSJ2)",
        isTransformation: true,
        hp: 1600,
        maxHp: 1600,
        price: 2000, 
        kiCost: 60,
        scale: 4.8,
        path: "Personagens/GokuZ8SSJ2.png",
        moves: [
            { name: "METEOR SMASH", dmg: 120, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "SUPER KAMEHAMEHA", dmg: 350, type: "beam", cost: 45 },
            { name: "DRAGON FIST", dmg: 750, type: "physical", cost: 95 }
        ],
        transList: ["GokuSSJ3"],
        costumes: []
    },

    "GokuSSJ3": {
        baseChar: "GokuSSJ3",
        name: "GOKU (SSJ3)",
        isTransformation: true,
        hp: 2200,
        maxHp: 2200,
        price: 3000, 
        kiCost: 80,
        scale: 4.8,
        path: "Personagens/GokuZ8SSJ3.png",
        moves: [
            { name: "GOLPE Meteorioco", dmg: 150, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "TRUE KAMEHAMEHA", dmg: 450, type: "beam", cost: 50 },
            { name: "Investida Dupla", dmg: 950, type: "physical", cost: 100 }
        ],
        transList: [],
        costumes: []
    },

// ==========================================
// GOKU D (DAIMA)
// ==========================================
"GokuD": {
    baseChar: "GokuD",
    name: "GOKU (D)",
    hp: 1600,
    maxHp: 1600,
    price: 2500,
    kiCost: 50,
    scale: 4.2,
    path: "Personagens/GokuD.png",
    moves: [
        { name: "COMBO D", dmg: 110, type: "physical" },
        { name: "CARREGAR KI", dmg: 0, type: "charge" },
        { name: "KAMEHAMEHA", dmg: 320, type: "beam", cost: 40 },
        { name: "SUPER GENKIDAMA", dmg: 750, type: "sphere", cost: 90 }
    ],
    transList: ["GokuDSSJ","GokuDSSJ2","GokuDSSJ3","GokuDSSJ4"],
    costumes: ["GokuD2", "GokuD3"]
},

"GokuDSSJ": {
    baseChar: "GokuDSSJ",
    name: "GOKU (D) SSJ",
    isTransformation: true,
    hp: 2000,
    maxHp: 2000,
    price: 2000,
    kiCost: 40,
    scale: 4.2,
    path: "Personagens/GokuDSSJ.png",
    moves: [
        { name: "COMBO SSJ", dmg: 130, type: "physical" },
        { name: "CARREGAR KI", dmg: 0, type: "charge" },
        { name: "SUPER KAMEHAMEHA", dmg: 380, type: "beam", cost: 45 },
        { name: "GOLPE DO DRAG√ÉO", dmg: 850, type: "physical", cost: 95 }
    ],
    transList: ["GokuDSSJ2"],
    costumes: []
},

"GokuDSSJ2": {
    baseChar: "GokuDSSJ2",
    name: "GOKU (D) SSJ2",
    isTransformation: true,
    hp: 2600,
    maxHp: 2600,
    price: 2500,
    kiCost: 50,
    scale: 4.2,
    path: "Personagens/GokuDSSJ2.png",
    moves: [
        { name: "METEOR SMASH", dmg: 150, type: "physical" },
        { name: "CARREGAR KI", dmg: 0, type: "charge" },
        { name: "TRUE KAMEHAMEHA", dmg: 450, type: "beam", cost: 50 },
        { name: "EXPLOS√ÉO DE KI", dmg: 900, type: "sphere", cost: 100 }
    ],
    transList: ["GokuDSSJ3"],
    costumes: []
},

"GokuDSSJ3": {
    baseChar: "GokuDSSJ3",
    name: "GOKU (D) SSJ3",
    isTransformation: true,
    hp: 3000,
    maxHp: 3000,
    price: 3500,
    kiCost: 70,
    scale: 4.2,
    path: "Personagens/GokuDSSJ3.png",
    moves: [
        { name: "PUNHO DO DRAG√ÉO", dmg: 180, type: "physical" },
        { name: "CARREGAR KI", dmg: 0, type: "charge" },
        { name: "KAMEHAMEHA 10X", dmg: 550, type: "beam", cost: 55 },
        { name: "DRAGON FIST BARRAGE", dmg: 1100, type: "physical", cost: 100 }
    ],
    transList: [],
    costumes: []
},

"GokuD2": { 
    baseChar: "GokuD2",
    name: "GOKU (D) T2", 
    isCostume: true, 
    hp: 1600,
    maxHp: 1600,
    price: 1500,
    kiCost: 50,
    scale: 4.2, 
    path: "Personagens/GokuD2.png", 
    moves: [
        { name: "COMBO D", dmg: 110, type: "physical" },
        { name: "CARREGAR KI", dmg: 0, type: "charge" },
        { name: "KAMEHAMEHA", dmg: 320, type: "beam", cost: 40 },
        { name: "SUPER GENKIDAMA", dmg: 750, type: "sphere", cost: 90 }
    ],
    transList: ["GokuD2SSJ","GokuD2SSJ2","GokuD2SSJ3","GokuD2SSJ4"],
    costumes: [] 
},

"GokuD2SSJ": { 
    baseChar: "GokuD2SSJ",
    name: "GOKU (D2) SSJ", 
    isTransformation: true, 
    hp: 2000,
    maxHp: 2000,
    price: 2000,
    kiCost: 40,
    scale: 4.2, 
    path: "Personagens/GokuD2SSJ.png", 
    moves: [
        { name: "COMBO SSJ", dmg: 130, type: "physical" },
        { name: "CARREGAR KI", dmg: 0, type: "charge" },
        { name: "SUPER KAMEHAMEHA", dmg: 380, type: "beam", cost: 45 },
        { name: "GOLPE DO DRAG√ÉO", dmg: 850, type: "physical", cost: 95 }
    ],
    transList: ["GokuD2SSJ2","GokuD2SSJ3"],
    costumes: [] 
},

"GokuD2SSJ2": { 
    baseChar: "GokuD2SSJ2",
    name: "GOKU (D2) SSJ2", 
    isTransformation: true, 
    hp: 2600,
    maxHp: 2600,
    price: 2500,
    kiCost: 50,
    scale: 4.2, 
    path: "Personagens/GokuD2SSJ2.png", 
    moves: [
        { name: "METEOR SMASH", dmg: 150, type: "physical" },
        { name: "CARREGAR KI", dmg: 0, type: "charge" },
        { name: "TRUE KAMEHAMEHA", dmg: 450, type: "beam", cost: 50 },
        { name: "EXPLOS√ÉO DE KI", dmg: 900, type: "sphere", cost: 100 }
    ],
    transList: ["GokuD2SSJ3"],
    costumes: [] 
},

"GokuD2SSJ3": { 
    baseChar: "GokuD2SSJ3",
    name: "GOKU (D2) SSJ3", 
    isTransformation: true, 
    hp: 3000,
    maxHp: 3000,
    price: 3500,
    kiCost: 70,
    scale: 4.2, 
    path: "Personagens/GokuD2SSJ3.png", 
    moves: [
        { name: "PUNHO DO DRAG√ÉO", dmg: 180, type: "physical" },
        { name: "CARREGAR KI", dmg: 0, type: "charge" },
        { name: "KAMEHAMEHA 10X", dmg: 550, type: "beam", cost: 55 },
        { name: "DRAGON FIST BARRAGE", dmg: 1100, type: "physical", cost: 100 }
    ],
    transList: ["GokuD2SSJ4"],
    costumes: [] 
},

"GokuD2SSJ4": {
    baseChar: "GokuD2SSJ4",
    name: "GOKU (D) SSJ4",
    isTransformation: true,
    hp: 3000,
    maxHp: 3000,
    price: 5000,
    kiCost: 90,
    scale: 4.8,
    path: "Personagens/GokuD2SSJ4.png",
    moves: [
        { name: "METEORO IMPACTO", dmg: 210, type: "physical" },
        { name: "CARREGAR KI", dmg: 0, type: "charge" },
        { name: "KAMEHAMEHA AUMENTADO 10X", dmg: 650, type: "beam", cost: 50 },
        { name: "PUNHO DO DRAG√ÉO DOURADO", dmg: 1250, type: "physical", cost: 100 }
    ],
    transList: [],
    costumes: []
},

"GokuD3": { 
    baseChar: "GokuD3",
    name: "GOKU (D) T3", 
    isCostume: true, 
    hp: 1600,
    maxHp: 1600,
    price: 1500,
    kiCost: 50,
    scale: 4.2, 
    path: "Personagens/GokuD3.png", 
    moves: [
        { name: "COMBO D", dmg: 110, type: "physical" },
        { name: "CARREGAR KI", dmg: 0, type: "charge" },
        { name: "KAMEHAMEHA", dmg: 320, type: "beam", cost: 40 },
        { name: "SUPER GENKIDAMA", dmg: 750, type: "sphere", cost: 90 }
    ],
    transList: ["GokuD3SSJ3","GokuDSSJ4"],
    costumes: [] 
},

"GokuD3SSJ3": { 
    baseChar: "GokuD3SSJ3",
    name: "GOKU (D3) SSJ3", 
    isTransformation: true, 
    hp: 3000,
    maxHp: 3000,
    price: 3500,
    kiCost: 70,
    scale: 4.2, 
    path: "Personagens/GokuD3SSJ3.png", 
    moves: [
        { name: "PUNHO DO DRAG√ÉO", dmg: 180, type: "physical" },
        { name: "CARREGAR KI", dmg: 0, type: "charge" },
        { name: "KAMEHAMEHA 10X", dmg: 550, type: "beam", cost: 55 },
        { name: "DRAGON FIST BARRAGE", dmg: 1100, type: "physical", cost: 100 }
    ],
    transList: ["GokuDSSJ4"],
    costumes: [] 
},

"GokuDSSJ4": { 
    baseChar: "GokuDSSJ4",
    name: "GOKU (D) SSJ4 (ALT)", 
    isTransformation: true, 
    hp: 3000,
    maxHp: 3000,
    price: 5000,
    kiCost: 90,
    scale: 4.8, 
    path: "Personagens/GokuDSSJ4.png",
    moves: [
        { name: "METEORO IMPACTO", dmg: 210, type: "physical" },
        { name: "CARREGAR KI", dmg: 0, type: "charge" },
        { name: "KAMEHAMEHA AUMENTADO 10X", dmg: 650, type: "beam", cost: 50 },
        { name: "PUNHO DO DRAG√ÉO DOURADO", dmg: 1250, type: "physical", cost: 100 }
    ],
    transList: [],
    costumes: []
},
// ==========================================
    // GOKU GT E SUAS FORMAS
    // ==========================================
    "GokuGt": {
        baseChar: "GokuGt",
        name: "Goku (GT)",
        isCostume: false,
        isTransformation: false,
        hp: 1000,
        maxHp: 1000,
        price: 4500,
        kiCost: 50,
        scale: 4.4, // Crian√ßa
        path: "Personagens/GokuGt.png",
        moves: [
            { name: "Bast√£o M√°gico", dmg: 25, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Kamehameha", dmg: 90, type: "beam", cost: 50 },
            { name: "Pedra, Papel, Tesoura", dmg: 130, type: "physical", cost: 100 }
        ],
        transList: ["GokuGtSSJ","GokuGtSSJ3","OozaruSSJ","GokuGtSSJ4"],
        costumes: []
    },
    "GokuGtSSJ": {
        name: "Goku Super Saiyajin (GT)",
        isCostume: false,
        isTransformation: true,
        baseChar: "GokuGt",
        hp: 1400,
        maxHp: 1400,
        price: 3000,
        kiCost: 50,
        scale: 4.4,
        path: "Personagens/GokuGtSSJ.png",
        moves: [
            { name: "Chute Ciclone", dmg: 35, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Super Kamehameha", dmg: 130, type: "beam", cost: 50 },
            { name: "Smash Meteoro", dmg: 180, type: "physical", cost: 100 }
        ],
        transList: ["GokuGtSSJ3"],
        costumes: []
    },
    "GokuGtSSJ3": {
        name: "Goku Super Saiyajin 3 (GT)",
        isCostume: false,
        isTransformation: true,
        baseChar: "GokuGt",
        hp: 2000,
        maxHp: 2000,
        price: 5000,
        kiCost: 50,
        scale: 4.5, // Levemente maior/mais aura
        path: "Personagens/GokuGtSSJ3.png",
        moves: [
            { name: "Punho do Drag√£o", dmg: 55, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Kamehameha Verdadeiro", dmg: 180, type: "beam", cost: 50 },
            { name: "Super Punho do Drag√£o", dmg: 260, type: "physical", cost: 100 }
        ],
        transList: ["OozaruSSJ"],
        costumes: []
    },
    "OozaruSSJ": {
        name: "Oozaru Dourado",
        isCostume: false,
        isTransformation: true,
        baseChar: "GokuGt",
        hp: 3000,
        maxHp: 3000,
        price: 8000,
        kiCost: 50,
        scale: 3.3, // Gigante
        previewScale: 2.5,
        shopScale: 1.3,
        path: "Personagens/OozaruSSJ.png",
        moves: [
            { name: "Esmagar", dmg: 80, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Chou Makouhou", dmg: 240, type: "beam", cost: 50 },
            { name: "Destrui√ß√£o S√≠smica", dmg: 350, type: "physical", cost: 100 }
        ],
        transList: ["GokuGtSSJ4"],
        costumes: []
    },
    "GokuGtSSJ4": {
        name: "Goku Super Saiyajin 4",
        isCostume: false,
        isTransformation: true,
        baseChar: "GokuGt",
        hp: 3000,
        maxHp: 3000,
        price: 12000,
        kiCost: 50,
        scale: 4.8, // Retorna ao tamanho adulto
        path: "Personagens/GokuGtSSJ4.png",
        moves: [
            { name: "Soco Metralhadora", dmg: 85, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Kamehameha Aumentado 10x", dmg: 280, type: "beam", cost: 50 },
            { name: "Punho do Drag√£o Dourado", dmg: 420, type: "physical", cost: 100 }
        ],
        transList: ["GokuGtSSJ4FullPower"],
        costumes: []
    },
    "GokuGtSSJ4FullPower": {
        name: "Goku SSJ4 Full Power",
        isCostume: false,
        isTransformation: true,
        baseChar: "GokuGt",
        hp: 3000,
        maxHp: 3000,
        price: 18000,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/GokuGtSSJ4FullPower.png",
        moves: [
            { name: "Impacto Ilimitado", dmg: 100, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Kamehameha 100x", dmg: 350, type: "beam", cost: 50 },
            { name: "Absor√ß√£o Esfera de Energia", dmg: 500, type: "physical", cost: 100 }
        ],
        transList: [],
        costumes: []
    },

// ==========================================
// GOKU DBS
// ==========================================
"GokuDBS": {
    baseChar: "GokuDBS",
    name: "GOKU (DBS)",
    canFuse: true,
    hp: 2500,
    maxHp: 2500,
    price: 3500,
    kiCost: 50,
    scale: 4.8,
    path: "Personagens/GokuDBS.png",
    moves: [
        { name: "COMBO DIVINO", dmg: 120, type: "physical" },
        { name: "CARREGAR KI", dmg: 0, type: "charge" },
        { name: "KAMEHAMEHA DIVINO", dmg: 350, type: "beam", cost: 45 },
        { name: "GOLPE DO DRAG√ÉO", dmg: 800, type: "physical", cost: 90 }
    ],
    transList: ["GokuDBSSSJ3","GokuDBSGod","GokuDBSBlue","GokuDBSUI","GokuDBSMUI"],
    costumes: ["GokuDBS2","GokuDBS(BROLY)","GokuDBS(BROLY)(T2)","GokuDBS(BROLY)(T3)"]
},

"GokuDBSSSJ3": {
    baseChar: "GokuDBSSSJ3",
    name: "GOKU (DBS) SSJ3",
    isTransformation: true,
    hp: 3000,
    maxHp: 3000,
    price: 4000,
    kiCost: 50,
    scale: 4.8,
    path: "Personagens/GokuDBSSSJ3.png",
    moves: [
        { name: "ATAQUE FEROZ", dmg: 150, type: "physical" },
        { name: "CARREGAR KI", dmg: 0, type: "charge" },
        { name: "SUPER KAMEHAMEHA", dmg: 400, type: "beam", cost: 45 },
        { name: "METEOR SMASH", dmg: 900, type: "physical", cost: 95 }
    ],
    transList: ["GokuDBSGod"],
    costumes: []
},

"GokuDBSGod": {
    baseChar: "GokuDBSGod",
    name: "GOKU (DBS) GOD",
    isTransformation: true,
    hp: 3000,
    maxHp: 3000,
    price: 5000,
    kiCost: 70,
    scale: 4.8,
    path: "Personagens/GokuDBSGod.png",
    moves: [
        { name: "SABRE DE LUZ", dmg: 170, type: "physical" },
        { name: "CARREGAR KI", dmg: 0, type: "charge" },
        { name: "LIMIT BREAKER KAME", dmg: 480, type: "beam", cost: 50 },
        { name: "GOD DRAGON SMASH", dmg: 1000, type: "sphere", cost: 100 }
    ],
    transList: ["GokuDBSBlue"],
    costumes: []
},

"GokuDBSBlue": {
    baseChar: "GokuDBSBlue",
    name: "GOKU (DBS) BLUE",
    isTransformation: true,
    hp: 3000,
    maxHp: 3000,
    price: 6000,
    kiCost: 90,
    scale: 4.8,
    path: "Personagens/GokuDBSBlue.png",
    moves: [
        { name: "RUSH DIVINO", dmg: 200, type: "physical" },
        { name: "CARREGAR KI", dmg: 0, type: "charge" },
        { name: "GOD KAMEHAMEHA", dmg: 550, type: "beam", cost: 50 },
        { name: "SUPREME DRAGON FIST", dmg: 1150, type: "physical", cost: 100 }
    ],
    transList: ["GokuDBSBKK"],
    costumes: ["GokuDBSBlueT2"]
},

"GokuDBSBKK": {
    baseChar: "GokuDBSBKK",
    name: "GOKU BLUE KAIOKEN",
    isTransformation: true,
    hp: 3000,
    maxHp: 3000,
    price: 7000,
    kiCost: 90,
    scale: 4.8,
    path: "Personagens/GokuDBSBKK.png",
    moves: [
        { name: "COMBO X10", dmg: 240, type: "physical" },
        { name: "CARREGAR KI", dmg: 0, type: "charge" },
        { name: "KAMEHAMEHA X10", dmg: 650, type: "beam", cost: 50 },
        { name: "F√öRIA DIVINA", dmg: 1300, type: "sphere", cost: 100 }
    ],
    transList: [],
    costumes: []
},

"GokuDBSBlueT2": { 
    baseChar: "GokuDBSBlueT2",
    name: "GOKU BLUE T2", 
    isCostume: true, 
    isTransformation: true,
    hp: 3000,
    maxHp: 3000,
    price: 1500,
    kiCost: 90,
    scale: 4.8, 
    path: "Personagens/GokuDBSBlueT2.png",
    moves: [
        { name: "RUSH DIVINO", dmg: 200, type: "physical" },
        { name: "CARREGAR KI", dmg: 0, type: "charge" },
        { name: "GOD KAMEHAMEHA", dmg: 550, type: "beam", cost: 50 },
        { name: "SUPREME DRAGON FIST", dmg: 1150, type: "physical", cost: 100 }
    ],
    transList: [],
    costumes: []
},

"GokuDBS2": { 
    baseChar: "GokuDBS2",
    name: "GOKU (DBS) T2", 
    isCostume: true, 
    hp: 2500,
    maxHp: 2500,
    price: 1500,
    kiCost: 50,
    scale: 4.8, 
    path: "Personagens/GokuDBS2.png", 
    moves: [
        { name: "COMBO DIVINO", dmg: 120, type: "physical" },
        { name: "CARREGAR KI", dmg: 0, type: "charge" },
        { name: "KAMEHAMEHA DIVINO", dmg: 350, type: "beam", cost: 45 },
        { name: "GOLPE DO DRAG√ÉO", dmg: 800, type: "physical", cost: 90 }
    ],
    transList: ["GokuDBS2SSJ","GokuDBS2God","GokuDBS2Blue"],
    costumes: []
},

"GokuDBS2SSJ": {
    baseChar: "GokuDBS2SSJ",
    name: "GOKU (DBS2) SSJ",
    isTransformation: true,
    hp: 3000,
    maxHp: 3000,
    price: 3500,
    kiCost: 40,
    scale: 4.8,
    path: "Personagens/GokuDBS2SSJ.png",
    moves: [
        { name: "COMBO SSJ", dmg: 140, type: "physical" },
        { name: "CARREGAR KI", dmg: 0, type: "charge" },
        { name: "KAMEHAMEHA", dmg: 380, type: "beam", cost: 45 },
        { name: "SUPER METEOR", dmg: 850, type: "physical", cost: 90 }
    ],
    transList: ["GokuDBS2God"],
    costumes: []
},

"GokuDBS2God": { 
    baseChar: "GokuDBS2God",
    name: "GOKU (DBS2) GOD", 
    isTransformation: true, 
    hp: 3000,
    maxHp: 3000,
    price: 5000,
    kiCost: 70,
    scale: 4.8, 
    path: "Personagens/GokuDBS2God.png", 
    moves: [
        { name: "SABRE DE LUZ", dmg: 170, type: "physical" },
        { name: "CARREGAR KI", dmg: 0, type: "charge" },
        { name: "LIMIT BREAKER KAME", dmg: 480, type: "beam", cost: 50 },
        { name: "GOD DRAGON SMASH", dmg: 1000, type: "sphere", cost: 100 }
    ],
    transList: ["GokuDBS2Blue"],
    costumes: []
},

"GokuDBS2Blue": { 
    baseChar: "GokuDBS2Blue",
    name: "GOKU (DBS2) BLUE", 
    isTransformation: true, 
    hp: 3000,
    maxHp: 3000,
    price: 6000,
    kiCost: 90,
    scale: 4.8, 
    path: "Personagens/GokuDBS2Blue.png",
    moves: [
        { name: "RUSH DIVINO", dmg: 200, type: "physical" },
        { name: "CARREGAR KI", dmg: 0, type: "charge" },
        { name: "GOD KAMEHAMEHA", dmg: 550, type: "beam", cost: 50 },
        { name: "SUPREME DRAGON FIST", dmg: 1150, type: "physical", cost: 100 }
    ],
    transList: ["GokuDBS2BKK"],
    costumes: []
},

"GokuDBS2BKK": { 
    baseChar: "GokuDBS2BKK",
    name: "GOKU DBS2 BKK", 
    isTransformation: true, 
    hp: 3000,
    maxHp: 3000,
    price: 7000,
    kiCost: 90,
    scale: 4.8, 
    path: "Personagens/GokuDBS2BKK.png",
    moves: [
        { name: "COMBO X10", dmg: 240, type: "physical" },
        { name: "CARREGAR KI", dmg: 0, type: "charge" },
        { name: "KAMEHAMEHA X10", dmg: 650, type: "beam", cost: 50 },
        { name: "F√öRIA DIVINA", dmg: 1300, type: "sphere", cost: 100 }
    ],
    transList: ["GokuDBS2BKKX20"],
    costumes: []
},

"GokuDBS2BKKX20": {
    baseChar: "GokuDBS2BKKX20",
    name: "GOKU DBS2 BKKx20",
    isTransformation: true,
    hp: 3000,
    maxHp: 3000,
    price: 8500,
    kiCost: 100,
    scale: 4.8,
    path: "Personagens/GokuDBS2BKKX20.png",
    moves: [
        { name: "COMBO X20", dmg: 280, type: "physical" },
        { name: "CARREGAR KI", dmg: 0, type: "charge" },
        { name: "KAMEHAMEHA X20", dmg: 800, type: "beam", cost: 50 },
        { name: "EXPLOS√ÉO DE PODER ABSOLUTO", dmg: 1500, type: "sphere", cost: 100 }
    ],
    transList: [],
    costumes: []
},
"GokuDBSUI": {
        name: "Goku Instinto Superior (Incompleto)",
        isCostume: false,
        isTransformation: true,
        baseChar: "GokuDBS",
        hp: 3000,
        maxHp: 3000,
        price: 12000,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/GokuDBSUI.png",
        moves: [
            { name: "Esquiva e Contra-Ataque", dmg: 80, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Flash Divino", dmg: 260, type: "beam", cost: 50 },
            { name: "Deslize Supremo", dmg: 400, type: "physical", cost: 100 }
        ],
        transList: ["GokuDBSMUI"],
        costumes: []
    },
    "GokuDBSMUI": {
        name: "Goku Instinto Superior (MUI)",
        isCostume: false,
        isTransformation: true,
        baseChar: "GokuDBS",
        hp: 3000,
        maxHp: 3000,
        price: 20000,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/GokuDBSMUI.png",
        moves: [
            { name: "Golpes Invis√≠veis", dmg: 100, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Kamehameha Supremo", dmg: 350, type: "beam", cost: 50 },
            { name: "Ataque Prateado", dmg: 500, type: "physical", cost: 100 }
        ],
        transList: [],
        costumes: []
    },
        // ==========================================
    // GOKU DBS (BROLY) E SUAS FORMAS
    // ==========================================
    "GokuDBS(BROLY)": {
        baseChar: "GokuDBS(BROLY)",
        name: "Goku (DBS Broly)",
        isCostume: true,
        isTransformation: false,
        hp: 1000,
        maxHp: 1000,
        price: 5000,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/GokuDBS(BROLY).png",
        moves: [
            { name: "Combo Corpo-a-Corpo", dmg: 30, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Kamehameha", dmg: 100, type: "beam", cost: 50 },
            { name: "Meteoro de P√©gaso", dmg: 150, type: "physical", cost: 100 }
        ],
        transList: ["GokuDBS(BROLY)SSJ","GokuDBS(BROLY)God","GokuDBS(BROLY)Blue"],
        costumes: []
    },
    "GokuDBS(BROLY)SSJ": {
        name: "Goku Super Saiyajin (DBS)",
        isCostume: false,
        isTransformation: true,
        baseChar: "GokuDBS(BROLY)",
        hp: 1500,
        maxHp: 1500,
        price: 3000,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/GokuDBS(BROLY)SSJ.png",
        moves: [
            { name: "Chute S√¥nico", dmg: 40, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Super Kamehameha", dmg: 150, type: "beam", cost: 50 },
            { name: "Ataque Meteoro", dmg: 200, type: "physical", cost: 100 }
        ],
        transList: ["GokuDBS(BROLY)God"],
        costumes: []
    },
    "GokuDBS(BROLY)God": {
        name: "Goku Super Saiyajin God",
        isCostume: false,
        isTransformation: true,
        baseChar: "GokuDBS(BROLY)",
        hp: 2000,
        maxHp: 2000,
        price: 5000,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/GokuDBS(BROLY)God.png",
        moves: [
            { name: "God Smash", dmg: 55, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "God Bind", dmg: 180, type: "beam", cost: 50 },
            { name: "Limitbreaker Kamehameha", dmg: 250, type: "physical", cost: 100 }
        ],
        transList: ["GokuDBS(BROLY)Blue"],
        costumes: []
    },
    "GokuDBS(BROLY)Blue": {
        name: "Goku Super Saiyajin Blue",
        isCostume: false,
        isTransformation: true,
        baseChar: "GokuDBS",
        hp: 2800,
        maxHp: 2800,
        price: 8000,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/GokuDBS(BROLY)Blue.png",
        moves: [
            { name: "Blue Combo", dmg: 70, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "God Kamehameha", dmg: 220, type: "beam", cost: 50 },
            { name: "Explos√£o Divina", dmg: 320, type: "physical", cost: 100 }
        ],
        transList: ["GokuDBS(BROLY)(T2)Blue"],
        costumes: []
    },
    "GokuDBS(BROLY)(T2)Blue": {
        name: "Goku SSB (Sem Casaco)",
        isCostume: false, // Tratando como transi√ß√£o visual do Blue
        isTransformation: true,
        baseChar: "GokuDBS",
        hp: 2800,
        maxHp: 2800,
        price: 2000,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/GokuDBS(BROLY)(T2)Blue.png",
        moves: [
            { name: "Combo Furioso", dmg: 75, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Kamehameha Blue", dmg: 220, type: "beam", cost: 50 },
            { name: "Golpe Esmagador", dmg: 330, type: "physical", cost: 100 }
        ],
        transList: [],
        costumes: []
    },
    "GokuDBS(BROLY)(T2)": {
        name: "Goku (DBS Broly) - Traje Frio",
        isCostume: true,
        isTransformation: false,
        baseChar: "GokuDBS",
        hp: 1000,
        maxHp: 1000,
        price: 2000,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/GokuDBS(BROLY)(T2).png",
        moves: [
            { name: "Golpe de Frio", dmg: 30, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Kamehameha", dmg: 100, type: "beam", cost: 50 },
            { name: "Ataque R√°pido", dmg: 150, type: "physical", cost: 100 }
        ],
        transList: ["GokuDBS(BROLY)(T3)Blue"],
        costumes: []
    },
     "GokuDBS(BROLY)(T3)Blue": {
        name: "Goku SSB (Traje Frio)",
        isCostume: false,
        isTransformation: true,
        baseChar: "GokuDBS",
        hp: 2800,
        maxHp: 2800,
        price: 2000,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/GokuDBS(BROLY)(T3)Blue.png",
        moves: [
            { name: "Impacto G√©lido", dmg: 70, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Kamehameha Divino", dmg: 220, type: "beam", cost: 50 },
            { name: "ExplosiveWave", dmg: 320, type: "physical", cost: 100 }
        ],
        transList: [],
        costumes: []
    },
     "GokuDBS(BROLY)(T3)": {
        name: "Goku (DBS Broly) - Traje Rasgado",
        isCostume: true,
        isTransformation: false,
        baseChar: "GokuDBS",
        hp: 1000,
        maxHp: 1000,
        price: 1500,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/GokuDBS(BROLY)(T3).png",
        moves: [
            { name: "Golpe Desesperado", dmg: 35, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Kamehameha Furioso", dmg: 110, type: "beam", cost: 50 },
            { name: "Investida Pesada", dmg: 160, type: "physical", cost: 100 }
        ],
        transList: [],
        costumes: []
    },
    

// ==========================================
    // VEGETA Z
    // ==========================================
    "VegetaScouter": {
        baseChar: "VegetaScouter",
        name: "VEGETA (SCOUTER)",
        isEvil: true,
        hp: 2500,
        maxHp: 2500,
        price: 3500,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/VegetaScouter.png",
        moves: [
            { name: "COMBO ELITE", dmg: 130, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "GALICK GUN", dmg: 380, type: "beam", cost: 45 },
            { name: "DIRTY FIREWORKS", dmg: 800, type: "sphere", cost: 90 }
        ],
        transList: ["VegetaScouterOozaru"],
        costumes: ["VegetaScouter2", "VegetaScouter3"]
    },

    "VegetaScouter2": {
        baseChar: "VegetaScouter2",
        name: "VEGETA (SCOUTER) T2",
        isCostume: true,
        isEvil: true,
        hp: 2500,
        maxHp: 2500,
        price: 1500,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/VegetaScouter2.png",
        moves: [
            { name: "COMBO ELITE", dmg: 130, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "GALICK GUN", dmg: 380, type: "beam", cost: 45 },
            { name: "DIRTY FIREWORKS", dmg: 800, type: "sphere", cost: 90 }
        ],
        transList: [],
        costumes: []
    },

    "VegetaScouter3": {
        baseChar: "VegetaScouter3",
        name: "VEGETA (SCOUTER) T3",
        isCostume: true,
        isEvil: true,
        hp: 2500,
        maxHp: 2500,
        price: 1500,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/VegetaScouter3.png",
        moves: [
            { name: "COMBO ELITE", dmg: 130, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "GALICK GUN", dmg: 380, type: "beam", cost: 45 },
            { name: "DIRTY FIREWORKS", dmg: 800, type: "sphere", cost: 90 }
        ],
        transList: [],
        costumes: []
    },

    "VegetaScouterOozaru": {
        baseChar: "VegetaScouterOozaru",
        name: "VEGETA (OOZARU)",
        isTransformation: true,
        isEvil: true,
        hp: 3000,
        maxHp: 3000,
        price: 5000,
        kiCost: 50,
        scale: 3.5,
        previewScale: 2.5,
        shopScale: 1.3,
        path: "Personagens/VegetaScouterOozaru.png",
        moves: [
            { name: "ESMAGAMENTO MACACO", dmg: 220, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "CHOU MAKOHOU", dmg: 500, type: "beam", cost: 50 },
            { name: "DESTRUI√á√ÉO LUNAR", dmg: 1000, type: "sphere", cost: 100 }
        ],
        transList: [],
        costumes: []
    },

    "VegetaZ": {
        baseChar: "VegetaZ",
        name: "VEGETA (Z)",
        isEvil: true,
        hp: 1200,
        maxHp: 1200,
        price: 1000,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/VegetaZ.png",
        moves: [
            { name: "GOLPE ORGULHOSO", dmg: 80, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "GALICK GUN", dmg: 240, type: "beam", cost: 40 },
            { name: "BIG BANG ATTACK", dmg: 480, type: "sphere", cost: 80 }
        ],
        transList: ["VegetaZSSJ"],
        costumes: ["VegetaZ2", "VegetaZ3"]
    },

    "VegetaZSSJ": {
        baseChar: "VegetaZSSJ",
        name: "VEGETA (SSJ)",
        isTransformation: true,
        isEvil: true,
        hp: 1400,
        maxHp: 1400,
        price: 1500,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/VegetaZSSJ.png",
        moves: [
            { name: "FINAL BLOW", dmg: 115, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "SUPER GALICK", dmg: 340, type: "beam", cost: 40 },
            { name: "FINAL FLASH", dmg: 700, type: "sphere", cost: 90 }
        ],
        transList: [],
        costumes: []
    },

    "VegetaZ2": {
        baseChar: "VegetaZ2",
        name: "VEGETA (TRAJE 2)",
        isCostume: true,
        isEvil: true,
        hp: 1200,
        maxHp: 1200,
        price: 1500,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/VegetaZ2.png",
        moves: [
            { name: "GOLPE ORGULHOSO", dmg: 80, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "GALICK GUN", dmg: 240, type: "beam", cost: 40 },
            { name: "BIG BANG ATTACK", dmg: 480, type: "sphere", cost: 80 }
        ],
        transList: ["VegetaZ2SSJ", "VegetaZ2SV"],
        costumes: []
    },

    "VegetaZ2SSJ": {
        baseChar: "VegetaZ2SSJ",
        name: "VEGETA (Z2) SSJ",
        isTransformation: true,
        isEvil: true,
        hp: 1400,
        maxHp: 1400,
        price: 1500,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/VegetaZ2SSJ.png",
        moves: [
            { name: "FINAL BLOW", dmg: 115, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "SUPER GALICK", dmg: 340, type: "beam", cost: 40 },
            { name: "FINAL FLASH", dmg: 700, type: "sphere", cost: 90 }
        ],
        transList: ["VegetaZ2SV"],
        costumes: []
    },

    "VegetaZ2SV": {
        baseChar: "VegetaZ2SV",
        name: "SUPER VEGETA",
        isTransformation: true,
        isEvil: true,
        hp: 1600,
        maxHp: 1600,
        price: 2500,
        kiCost: 60,
        scale: 4.8,
        path: "Personagens/VegetaZ2SV.png",
        moves: [
            { name: "CHUVA DE SOCOS", dmg: 140, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "ATAQUE BIG BANG", dmg: 450, type: "sphere", cost: 50 },
            { name: "SUPER FINAL FLASH", dmg: 850, type: "beam", cost: 100 }
        ],
        transList: [],
        costumes: []
    },

    "VegetaZ3": {
        name: "VEGETA (TRAJE 3)",
        isCostume: true,
        baseChar: "VegetaZ",
        isEvil: true,
        canFuse: true,
        hp: 1200,
        maxHp: 1200,
        price: 1500,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/VegetaZ3.png",
        moves: [
            { name: "GOLPE ORGULHOSO", dmg: 80, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "GALICK GUN", dmg: 240, type: "beam", cost: 40 },
            { name: "BIG BANG ATTACK", dmg: 480, type: "sphere", cost: 80 }
        ],
        transList: ["VegetaZ3SSJ","VegetaZ3SSJ2"],
        costumes: []
    },

    "VegetaZ3SSJ": {
        baseChar: "VegetaZ3SSJ",
        name: "VEGETA (Z3) SSJ",
        isTransformation: true,
        isEvil: true,
        hp: 1400,
        maxHp: 1400,
        price: 1500,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/VegetaZ3SSJ.png",
        moves: [
            { name: "FINAL BLOW", dmg: 115, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "SUPER GALICK", dmg: 340, type: "beam", cost: 40 },
            { name: "FINAL FLASH", dmg: 700, type: "sphere", cost: 90 }
        ],
        transList: ["VegetaZ3SSJ2"],
        costumes: []
    },

    "VegetaZ3SSJ2": {
        baseChar: "VegetaZ3SSJ2",
        name: "VEGETA (Z3) SSJ2",
        isTransformation: true,
        isEvil: true,
        hp: 1600,
        maxHp: 1600,
        price: 2000,
        kiCost: 60,
        scale: 4.8,
        path: "Personagens/VegetaZ3SSJ2.png",
        moves: [
            { name: "METEOR CRASH", dmg: 140, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "IMPACTO M√ÅXIMO", dmg: 400, type: "physical", cost: 50 },
            { name: "SUPER FINAL FLASH", dmg: 800, type: "beam", cost: 100 }
        ],
        transList: [],
        costumes: []
    },

    "MajinVegeta": {
        baseChar: "MajinVegeta",
        name: "MAJIN VEGETA",
        isTransformation: true,
        isEvil: true,
        hp: 2000,
        maxHp: 2000,
        price: 3500,
        kiCost: 70,
        scale: 4.8,
        path: "Personagens/MajinVegeta.png",
        moves: [
            { name: "ORGULHO OBSCURO", dmg: 180, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "IMPACTO AT√îMICO", dmg: 500, type: "beam", cost: 60 },
            { name: "EXPLOS√ÉO FINAL", dmg: 1200, type: "sphere", cost: 100 }
        ],
        transList: [],
        costumes: []
    },
// ==========================================
    // VEGETA D (DAIMA/GT)
    // ==========================================
    "VegetaD": {
        baseChar: "VegetaD",
        name: "VEGETA (D)",
        hp: 1500,
        maxHp: 1500,
        price: 2000,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/VegetaD.png",
        moves: [
            { name: "GOLPE ORGULHOSO", dmg: 105, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "GALICK GUN", dmg: 310, type: "beam", cost: 40 },
            { name: "BIG BANG ATTACK", dmg: 730, type: "sphere", cost: 90 }
        ],
        transList: ["VegetaDSSJ","VegetaDSSj2","VegetaDSSJ3"],
        costumes: ["VegetaD2"]
    },

    "VegetaDSSJ": {
        baseChar: "VegetaDSSJ",
        name: "VEGETA (D) SSJ",
        isTransformation: true,
        hp: 1950,
        maxHp: 1950,
        price: 2000,
        kiCost: 40,
        scale: 4.8,
        path: "Personagens/VegetaDSSJ.png",
        moves: [
            { name: "COMBO SSJ", dmg: 130, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "SUPER GALICK GUN", dmg: 380, type: "beam", cost: 45 },
            { name: "FINAL FLASH", dmg: 850, type: "beam", cost: 95 }
        ],
        transList: ["VegetaDSSJ2"],
        costumes: []
    },

    "VegetaDSSJ2": {
        baseChar: "VegetaDSSJ2",
        name: "VEGETA (D) SSJ2",
        isTransformation: true,
        hp: 2500,
        maxHp: 2500,
        price: 2500,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/VegetaDSSJ2.png",
        moves: [
            { name: "ATAQUE FURIOSO", dmg: 150, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "FINAL IMPACT", dmg: 440, type: "beam", cost: 50 },
            { name: "FINAL EXPLOSION", dmg: 950, type: "sphere", cost: 100 }
        ],
        transList: ["VegetaDSSJ3"],
        costumes: []
    },

    "VegetaDSSJ3": {
        baseChar: "VegetaDSSJ3",
        name: "VEGETA (D) SSJ3",
        isTransformation: true,
        hp: 3000,
        maxHp: 3000,
        price: 3500,
        kiCost: 70,
        scale: 4.8,
        path: "Personagens/VegetaDSSJ3.png",
        moves: [
            { name: "IMPACTO DO PR√çNCIPE", dmg: 175, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "ATOMIC BLAST", dmg: 500, type: "beam", cost: 55 },
            { name: "FINAL GALICK GUN", dmg: 1050, type: "beam", cost: 100 }
        ],
        transList: [],
        costumes: []
    },

    "VegetaD2": { 
        baseChar: "VegetaD2",
        name: "VEGETA (D) T2", 
        isCostume: true, 
        hp: 1500,
        maxHp: 1500,
        price: 1500,
        kiCost: 50,
        scale: 4.8, 
        path: "Personagens/VegetaD2.png",
        moves: [
            { name: "GOLPE ORGULHOSO", dmg: 105, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "GALICK GUN", dmg: 310, type: "beam", cost: 40 },
            { name: "BIG BANG ATTACK", dmg: 730, type: "sphere", cost: 90 }
        ],
        transList: ["VegetaD2SSJ","VegetaD2SSJ3"],
        costumes: []
    },

    "VegetaD2SSJ": { 
        baseChar: "VegetaD2SSJ",
        name: "VEGETA (D2) SSJ", 
        isTransformation: true, 
        hp: 1950,
        maxHp: 1950,
        price: 2000,
        kiCost: 40,
        scale: 4.8, 
        path: "Personagens/VegetaD2SSJ.png",
        moves: [
            { name: "COMBO SSJ", dmg: 130, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "SUPER GALICK GUN", dmg: 380, type: "beam", cost: 45 },
            { name: "FINAL FLASH", dmg: 850, type: "beam", cost: 95 }
        ],
        transList: ["VegetaD2SSJ3"],
        costumes: []
    },

    "VegetaD2SSJ3": { 
        baseChar: "VegetaD2SSJ3",
        name: "VEGETA (D2) SSJ3", 
        isTransformation: true, 
        hp: 3000,
        maxHp: 3000,
        price: 3500,
        kiCost: 70,
        scale: 4.8, 
        path: "Personagens/VegetaD2SSJ3.png",
        moves: [
            { name: "IMPACTO DO PR√çNCIPE", dmg: 175, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "ATOMIC BLAST", dmg: 500, type: "beam", cost: 55 },
            { name: "FINAL GALICK GUN", dmg: 1050, type: "beam", cost: 100 }
        ],
        transList: [],
        costumes: []
    },
    // ==========================================
    // VEGETA GT E SUAS FORMAS
    // ==========================================
    "VegetaGt": {
        baseChar: "VegetaGt",
        name: "Vegeta (GT)",
        isCostume: false,
        isTransformation: false,
        hp: 1000,
        maxHp: 1000,
        price: 4500,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/VegetaGt.png",
        moves: [
            { name: "Sequ√™ncia R√°pida", dmg: 25, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Galick Gun", dmg: 90, type: "beam", cost: 50 },
            { name: "Chute Impiedoso", dmg: 130, type: "physical", cost: 100 }
        ],
        transList: ["VegetaGtSSJ","VegetaGtSSJ4"],
        costumes: []
    },
    "VegetaGtSSJ": {
        name: "Vegeta Super Saiyajin (GT)",
        isCostume: false,
        isTransformation: true,
        baseChar: "VegetaGt",
        hp: 1400,
        maxHp: 1400,
        price: 3000,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/VegetaGtSSJ.png",
        moves: [
            { name: "Soco Pesado", dmg: 35, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Final Flash", dmg: 130, type: "beam", cost: 50 },
            { name: "Big Bang Attack", dmg: 180, type: "physical", cost: 100 }
        ],
        transList: ["VegetaGtSSJ4"],
        costumes: []
    },
    "VegetaGtSSJ4": {
        name: "Vegeta Super Saiyajin 4",
        isCostume: false,
        isTransformation: true,
        baseChar: "VegetaGt",
        hp: 3000,
        maxHp: 3000,
        price: 12000,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/VegetaGtSSJ4.png",
        moves: [
            { name: "Carga do Pr√≠ncipe", dmg: 85, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Final Shine Attack", dmg: 280, type: "beam", cost: 50 },
            { name: "Ataque M√°ximo", dmg: 420, type: "physical", cost: 100 }
        ],
        transList: [],
        costumes: []
    },
// ==========================================
    // VEGETA DBS
    // ==========================================
    "VegetaDBS": {
        baseChar: "VegetaDBS",
        name: "VEGETA (DBS)",
        hp: 2500,
        maxHp: 2500,
        price: 3500,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/VegetaDBS.png",
        moves: [
            { name: "COMBO DEUS", dmg: 125, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "BIG BANG ATTACK", dmg: 350, type: "sphere", cost: 45 },
            { name: "GAMMA BURST", dmg: 800, type: "beam", cost: 90 }
        ],
        transList: ["VegetaDBSSSJ","VegetaDBSSSJ2","VegetaDBSGod","VegetaDBSBlue","VegetaDBSBlueEvo"],
        costumes: ["VegetaDBS2","VegetaDBS(BROLY)","VegetaDBS(BROLY)(T2)",  "VegetaDBS(BROLY)(T3)"]
    },

    "VegetaDBSSSJ": {
        baseChar: "VegetaDBSSSJ",
        name: "VEGETA DBS SSJ",
        isTransformation: true,
        hp: 3000,
        maxHp: 3000,
        price: 4000,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/VegetaDBSSSJ.png",
        moves: [
            { name: "IMPACTO SSJ", dmg: 150, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "GALICK GUN AUMENTADO", dmg: 400, type: "beam", cost: 45 },
            { name: "FINAL FLASH", dmg: 900, type: "beam", cost: 95 }
        ],
        transList: ["VegetaDBSSSJ2"],
        costumes: []
    },

    "VegetaDBSSSJ2": {
        baseChar: "VegetaDBSSSJ2",
        name: "VEGETA DBS SSJ2",
        isTransformation: true,
        hp: 3000,
        maxHp: 3000,
        price: 4500,
        kiCost: 60,
        scale: 4.8,
        path: "Personagens/VegetaDBSSSJ2.png",
        moves: [
            { name: "F√öRIA DO PR√çNCIPE", dmg: 165, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "MAXIMUM FLACTUATION", dmg: 450, type: "sphere", cost: 50 },
            { name: "EXPLOS√ÉO FINAL", dmg: 950, type: "sphere", cost: 100 }
        ],
        transList: ["VegetaDBSGod"],
        costumes: []
    },

    "VegetaDBSGod": {
        baseChar: "VegetaDBSGod",
        name: "VEGETA DBS GOD",
        isTransformation: true,
        hp: 3000,
        maxHp: 3000,
        price: 5000,
        kiCost: 75,
        scale: 4.8,
        path: "Personagens/VegetaDBSGod.png",
        moves: [
            { name: "SABRE DIVINO", dmg: 185, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "GOD BIG BANG", dmg: 500, type: "sphere", cost: 50 },
            { name: "PROMINENCE FLASH", dmg: 1050, type: "beam", cost: 100 }
        ],
        transList: ["VegetaDBSBlue"],
        costumes: []
    },

    "VegetaDBSBlue": {
        baseChar: "VegetaDBSBlue",
        name: "VEGETA DBS BLUE",
        isTransformation: true,
        hp: 3000,
        maxHp: 3000,
        price: 6000,
        kiCost: 90,
        scale: 4.8,
        path: "Personagens/VegetaDBSBlue.png",
        moves: [
            { name: "RUSH ORGULHOSO", dmg: 210, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "GOD GALICK GUN", dmg: 600, type: "beam", cost: 50 },
            { name: "FINAL FLASH DIVINO", dmg: 1200, type: "beam", cost: 100 }
        ],
        transList: ["VegetaDBSBlueEvo"],
        costumes: []
    },

    "VegetaDBS2": { 
        baseChar: "VegetaDBS2",
        name: "VEGETA (DBS) T2", 
        isCostume: true, 
        hp: 2500,
        maxHp: 2500,
        price: 1500,
        kiCost: 50,
        scale: 4.8, 
        path: "Personagens/VegetaDBS2.png",
        moves: [
            { name: "COMBO DEUS", dmg: 125, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "BIG BANG ATTACK", dmg: 350, type: "sphere", cost: 45 },
            { name: "GAMMA BURST", dmg: 800, type: "beam", cost: 90 }
        ],
        transList: ["VegetaDBS2SSJ","VegetaDBS2Blue"],
        costumes: []
    },

    "VegetaDBS2SSJ": { 
        baseChar: "VegetaDBS2SSJ",
        name: "VEGETA (DBS2) SSJ", 
        isTransformation: true, 
        hp: 3000,
        maxHp: 3000,
        price: 4000,
        kiCost: 50,
        scale: 4.8, 
        path: "Personagens/VegetaDBS2SSJ.png",
        moves: [
            { name: "IMPACTO SSJ", dmg: 150, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "GALICK GUN AUMENTADO", dmg: 400, type: "beam", cost: 45 },
            { name: "FINAL FLASH", dmg: 900, type: "beam", cost: 95 }
        ],
        transList: ["VegetaDBS2Blue"],
        costumes: []
    },

    "VegetaDBS2Blue": { 
        baseChar: "VegetaDBS2Blue",
        name: "VEGETA (DBS2) BLUE", 
        isTransformation: true, 
        hp: 3000, 
        maxHp: 3000, 
        price: 6000,
        kiCost: 90,
        scale: 4.8, 
        path: "Personagens/VegetaDBS2Blue.png",
        moves: [
            { name: "RUSH ORGULHOSO", dmg: 210, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "GOD GALICK GUN", dmg: 600, type: "beam", cost: 50 },
            { name: "FINAL FLASH DIVINO", dmg: 1200, type: "beam", cost: 100 }
        ],
        transList: [],
        costumes: []
    },
    "VegetaDBSBlueEvo": {
        name: "Vegeta SSJ Blue Evolution",
        isCostume: false,
        isTransformation: true,
        baseChar: "VegetaDBS",
        hp: 3000,
        maxHp: 3000,
        price: 12000,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/VegetaDBSBlueEvo.png",
        moves: [
            { name: "Orgulho Saiyajin", dmg: 90, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Final Explosion", dmg: 300, type: "beam", cost: 50 },
            { name: "Gamma Burst Flash", dmg: 450, type: "physical", cost: 100 }
        ],
        transList: [],
        costumes: []
    },
    // ==========================================
    // VEGETA DBS (BROLY) E SUAS FORMAS
    // ==========================================
    "VegetaDBS(BROLY)": {
        baseChar: "VegetaDBS(BROLY)",
        name: "Vegeta (DBS Broly)",
        isCostume: true,
        isTransformation: false,
        hp: 1000,
        maxHp: 1000,
        price: 5000,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/VegetaDBS(BROLY).png",
        moves: [
            { name: "Rajada de Socos", dmg: 30, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Galick Gun", dmg: 100, type: "beam", cost: 50 },
            { name: "Chute Esmagador", dmg: 150, type: "physical", cost: 100 }
        ],
        transList: ["VegetaDBS(BROLY)SSJ","VegetaDBS(BROLY)God","VegetaDBS(BROLY)Blue"],
        costumes: []
    },
"VegetaDBS(BROLY)SSJ": {
        name: "Vegeta Super Saiyajin (DBS)",
        isCostume: false,
        isTransformation: true,
        baseChar: "VegetaDBS(BROLY)",
        hp: 1500,
        maxHp: 1500,
        price: 3000,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/VegetaDBS(BROLY)SSJ.png",
        moves: [
            { name: "Soco Explosivo", dmg: 45, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Big Bang Attack", dmg: 160, type: "beam", cost: 50 },
            { name: "Final Flash", dmg: 220, type: "physical", cost: 100 }
        ],
        transList: ["VegetaDBS(BROLY)God",],
        costumes: []
    },
    "VegetaDBS(BROLY)God": {
        name: "Vegeta Super Saiyajin God",
        isCostume: false,
        isTransformation: true,
        baseChar: "VegetaDBS(BROLY)",
        hp: 2000,
        maxHp: 2000,
        price: 5000,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/VegetaDBS(BROLY)God.png",
        moves: [
            { name: "Ataque Flamejante", dmg: 60, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Prominence Flash", dmg: 190, type: "beam", cost: 50 },
            { name: "Chute Divino", dmg: 270, type: "physical", cost: 100 }
        ],
        transList: ["VegetaDBS(BROLY)Blue"],
        costumes: []
    },
    "VegetaDBS(BROLY)Blue": {
        name: "Vegeta Super Saiyajin Blue",
        isCostume: false,
        isTransformation: true,
        baseChar: "VegetaDBS(BROLY)",
        hp: 2800,
        maxHp: 2800,
        price: 8000,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/VegetaDBS(BROLY)Blue.png",
        moves: [
            { name: "Press√£o Esmagadora", dmg: 75, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Niagara Pummel", dmg: 230, type: "beam", cost: 50 },
            { name: "Final Flash Blue", dmg: 330, type: "physical", cost: 100 }
        ],
        transList: [],
        costumes: []
    },
"VegetaDBS(BROLY)(T2)": {
        name: "Vegeta (DBS) - Casaco",
        isCostume: true,
        isTransformation: false,
        baseChar: "VegetaDBS(BROLY)",
        hp: 1000,
        maxHp: 1000,
        price: 2000,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/VegetaDBS(BROLY)(T2).png",
        moves: [
            { name: "Soco Frio", dmg: 30, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Galick Gun", dmg: 100, type: "beam", cost: 50 },
            { name: "Joelada Cruel", dmg: 150, type: "physical", cost: 100 }
        ],
        transList: ["VegetaDBS(BROLY)(T2)Blue"],
        costumes: []
    },
    "VegetaDBS(BROLY)(T2)Blue": {
        name: "Vegeta SSB (Casaco)",
        isCostume: false,
        isTransformation: true,
        baseChar: "VegetaDBS(BROLY)",
        hp: 2800,
        maxHp: 2800,
        price: 2000,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/VegetaDBS(BROLY)(T2)Blue.png",
        moves: [
            { name: "Combo Frio Blue", dmg: 75, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Galick Gun Supremo", dmg: 230, type: "beam", cost: 50 },
            { name: "Impacto Absoluto", dmg: 330, type: "physical", cost: 100 }
        ],
        transList: [],
        costumes: []
    },
    "VegetaDBS(BROLY)(T3)": {
        name: "Vegeta (DBS) - Armadura Destru√≠da",
        isCostume: true,
        isTransformation: false,
        baseChar: "VegetaDBS(BROLY)",
        hp: 1000,
        maxHp: 1000,
        price: 1500,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/VegetaDBS(BROLY)(T3).png",
        moves: [
            { name: "Golpe de F√∫ria", dmg: 35, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Lucora Gun", dmg: 110, type: "beam", cost: 50 },
            { name: "Assalto Selvagem", dmg: 160, type: "physical", cost: 100 }
        ],
        transList: [],
        costumes: []
    },
    // ---- PERSONAGENS CL√ÅSSICOS (C) ----

    "BulmaC": {
        baseChar: "BulmaC",
        name: "BULMA (C)",
        hp: 1000,
        maxHp: 1000,
        price: 0,
        kiCost: 50,
        scale: 4.0,
        path: "Personagens/BulmaC.png",
        moves: [
            { name: "TIRO DE METRALHADORA", dmg: 40, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "TIRO CARREGADO", dmg: 120, type: "beam", cost: 40 },
            { name: "C√ÅPSULA EXPLOSIVA", dmg: 200, type: "sphere", cost: 80 }
        ],
        transList: [],
        costumes: ["BulmaC2", "BulmaC3", "BulmaC4"]
    },

    "BulmaC2": {
        baseChar: "BulmaC2",
        name: "BULMA (C) TRAJE 2",
        isCostume: true,
        hp: 1000,
        maxHp: 1000,
        price: 1500,
        kiCost: 50,
        scale: 4.0,
        path: "Personagens/BulmaC2.png",
        moves: [
            { name: "TIRO DE METRALHADORA", dmg: 40, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "TIRO CARREGADO", dmg: 120, type: "beam", cost: 40 },
            { name: "C√ÅPSULA EXPLOSIVA", dmg: 200, type: "sphere", cost: 80 }
        ],
        transList: [],
        costumes: []
    },

    "BulmaC3": {
        baseChar: "BulmaC3",
        name: "BULMA (C) TRAJE 3",
        isCostume: true,
        hp: 1000,
        maxHp: 1000,
        price: 1500,
        kiCost: 50,
        scale: 4.0,
        path: "Personagens/BulmaC3.png",
        moves: [
            { name: "TIRO DE METRALHADORA", dmg: 40, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "TIRO CARREGADO", dmg: 120, type: "beam", cost: 40 },
            { name: "C√ÅPSULA EXPLOSIVA", dmg: 200, type: "sphere", cost: 80 }
        ],
        transList: [],
        costumes: []
    },

    "BulmaC4": {
        baseChar: "BulmaC4",
        name: "BULMA (C) TRAJE 4",
        isCostume: true,
        hp: 1000,
        maxHp: 1000,
        price: 1500,
        kiCost: 50,
        scale: 4.0,
        path: "Personagens/BulmaC4.png",
        moves: [
            { name: "TIRO DE METRALHADORA", dmg: 40, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "TIRO CARREGADO", dmg: 120, type: "beam", cost: 40 },
            { name: "C√ÅPSULA EXPLOSIVA", dmg: 200, type: "sphere", cost: 80 }
        ],
        transList: [],
        costumes: []
    },

    "Oolong": {
        baseChar: "Oolong",
        name: "OOLONG",
        hp: 1000,
        maxHp: 1000,
        price: 0,
        kiCost: 50,
        scale: 3.8,
        path: "Personagens/Oolong.png",
        moves: [
            { name: "ATAQUE DESAJEITADO", dmg: 30, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "M√çSSIL MORCEGO", dmg: 100, type: "beam", cost: 40 },
            { name: "PANELA QUENTE", dmg: 150, type: "physical", cost: 80 }
        ],
        transList: ["OolongTransformed"],
        costumes: ["Oolong2", "Oolong3", "Oolong4", "Oolong5"]
    },

    "Oolong2": {
        baseChar: "Oolong2",
        name: "OOLONG TRAJE 2",
        isCostume: true,
        hp: 1000,
        maxHp: 1000,
        price: 1500,
        kiCost: 50,
        scale: 3.8,
        path: "Personagens/Oolong2.png",
        moves: [
            { name: "ATAQUE DESAJEITADO", dmg: 30, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "M√çSSIL MORCEGO", dmg: 100, type: "beam", cost: 40 },
            { name: "PANELA QUENTE", dmg: 150, type: "physical", cost: 80 }
        ],
        transList: ["OolongTransformed"],
        costumes: []
    },

    "Oolong3": {
        baseChar: "Oolong3",
        name: "OOLONG TRAJE 3",
        isCostume: true,
        hp: 1000,
        maxHp: 1000,
        price: 1500,
        kiCost: 50,
        scale: 3.8,
        path: "Personagens/Oolong3.png",
        moves: [
            { name: "ATAQUE DESAJEITADO", dmg: 30, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "M√çSSIL MORCEGO", dmg: 100, type: "beam", cost: 40 },
            { name: "PANELA QUENTE", dmg: 150, type: "physical", cost: 80 }
        ],
        transList: ["OolongTransformed"],
        costumes: []
    },

    "Oolong4": {
        baseChar: "Oolong4",
        name: "OOLONG TRAJE 4",
        isCostume: true,
        hp: 1000,
        maxHp: 1000,
        price: 1500,
        kiCost: 50,
        scale: 3.8,
        path: "Personagens/Oolong4.png",
        moves: [
            { name: "ATAQUE DESAJEITADO", dmg: 30, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "M√çSSIL MORCEGO", dmg: 100, type: "beam", cost: 40 },
            { name: "PANELA QUENTE", dmg: 150, type: "physical", cost: 80 }
        ],
        transList: ["OolongTransformed"],
        costumes: []
    },

    "Oolong5": {
        baseChar: "Oolong5",
        name: "OOLONG TRAJE 5",
        isCostume: true,
        hp: 1000,
        maxHp: 1000,
        price: 1500,
        kiCost: 50,
        scale: 3.8,
        path: "Personagens/Oolong5.png",
        moves: [
            { name: "ATAQUE DESAJEITADO", dmg: 30, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "M√çSSIL MORCEGO", dmg: 100, type: "beam", cost: 40 },
            { name: "PANELA QUENTE", dmg: 150, type: "physical", cost: 80 }
        ],
        transList: ["OolongTransformed"],
        costumes: []
    },

    "OolongTransformed": {
        baseChar: "OolongTransformed",
        name: "OOLONG (ROB√î)",
        isTransformation: true,
        hp: 1000,
        maxHp: 1000,
        price: 1000,
        kiCost: 50,
        scale: 3.5,
        path: "Personagens/OolongTransformed.png",
        moves: [
            { name: "MORDIDA COVARDE", dmg: 30, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "G√ÅS FEDORENTO", dmg: 80, type: "beam", cost: 30 },
            { name: "INVESTIDA CEGA", dmg: 120, type: "physical", cost: 50 }
        ],
        transList: [],
        costumes: []
    },

    // ---- MESTRE KAME ----
    "MestreKame": {
        baseChar: "MestreKame",
        name: "MESTRE KAME",
        hp: 1100,
        maxHp: 1100,
        price: 1000,
        kiCost: 50,
        scale: 4.2,
        path: "Personagens/MestreKame.png",
        moves: [
            { name: "GOLPE DE BENGALA", dmg: 60, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "KAMEHAMEHA", dmg: 180, type: "beam", cost: 45 },
            { name: "ATAQUE DAS PALMEIRAS", dmg: 300, type: "physical", cost: 90 }
        ],
        transList: ["KameFP"],
        costumes: ["MestreKame2", "Mestrekame3", "MestreKame4", "MestreKame5"]
    },

    "MestreKame2": {
        baseChar: "MestreKame2",
        name: "MESTRE KAME T2",
        isCostume: true,
        hp: 1100,
        maxHp: 1100,
        price: 1500,
        kiCost: 50,
        scale: 4.2,
        path: "Personagens/MestreKame2.png",
        moves: [
            { name: "GOLPE DE BENGALA", dmg: 60, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "KAMEHAMEHA", dmg: 180, type: "beam", cost: 45 },
            { name: "ATAQUE DAS PALMEIRAS", dmg: 300, type: "physical", cost: 90 }
        ],
        transList: ["Kame2FP"],
        costumes: []
    },

    "Mestrekame3": {
        baseChar: "Mestrekame3",
        name: "MESTRE KAME T3",
        isCostume: true,
        hp: 1100,
        maxHp: 1100,
        price: 1500,
        kiCost: 50,
        scale: 4.2,
        path: "Personagens/Mestrekame3.png",
        moves: [
            { name: "GOLPE DE BENGALA", dmg: 60, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "KAMEHAMEHA", dmg: 180, type: "beam", cost: 45 },
            { name: "ATAQUE DAS PALMEIRAS", dmg: 300, type: "physical", cost: 90 }
        ],
        transList: ["KameFP"],
        costumes: []
    },

    "MestreKame4": {
        baseChar: "MestreKame4",
        name: "MESTRE KAME T4",
        isCostume: true,
        hp: 1100,
        maxHp: 1100,
        price: 1500,
        kiCost: 50,
        scale: 4.2,
        path: "Personagens/MestreKame4.png",
        moves: [
            { name: "GOLPE DE BENGALA", dmg: 60, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "KAMEHAMEHA", dmg: 180, type: "beam", cost: 45 },
            { name: "ATAQUE DAS PALMEIRAS", dmg: 300, type: "physical", cost: 90 }
        ],
        transList: [],
        costumes: []
    },

    "MestreKame5": {
        baseChar: "MestreKame5",
        name: "MESTRE KAME T5",
        isCostume: true,
        hp: 1100,
        maxHp: 1100,
        price: 1500,
        kiCost: 50,
        scale: 4.2,
        path: "Personagens/MestreKame5.png",
        moves: [
            { name: "GOLPE DE BENGALA", dmg: 60, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "KAMEHAMEHA", dmg: 180, type: "beam", cost: 45 },
            { name: "ATAQUE DAS PALMEIRAS", dmg: 300, type: "physical", cost: 90 }
        ],
        transList: [],
        costumes: []
    },

    "KameFP": {
        baseChar: "KameFP",
        name: "KAME FULL POWER",
        isTransformation: true,
        hp: 1600,
        maxHp: 1600,
        price: 2500,
        kiCost: 60,
        scale: 4.5,
        path: "Personagens/MestreKameFullPower.png",
        moves: [
            { name: "SOCO DESTRUTIVO", dmg: 110, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "KAMEHAMEHA M√ÅXIMO", dmg: 380, type: "beam", cost: 50 },
            { name: "ONDA DE CHOQUE", dmg: 600, type: "physical", cost: 100 }
        ],
        transList: [],
        costumes: []
    },

    "Kame2FP": {
        baseChar: "Kame2FP",
        name: "KAME T2 FULL POWER",
        isTransformation: true,
        hp: 1600,
        maxHp: 1600,
        price: 2500,
        kiCost: 60,
        scale: 4.5,
        path: "Personagens/MestreKame2FullPower.png",
        moves: [
            { name: "SOCO DESTRUTIVO", dmg: 110, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "KAMEHAMEHA M√ÅXIMO", dmg: 380, type: "beam", cost: 50 },
            { name: "ONDA DE CHOQUE", dmg: 600, type: "physical", cost: 100 }
        ],
        transList: [],
        costumes: []
    },

    // ---- KURIRIN ----
    "KuririnC": {
        baseChar: "KuririnC",
        name: "KURIRIN (CL√ÅSSICO)",
        hp: 1000,
        maxHp: 1000,
        price: 1000,
        kiCost: 50,
        scale: 3.8,
        path: "Personagens/KuririnC.png",
        moves: [
            { name: "SOCO R√ÅPIDO", dmg: 60, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "KAMEHAMEHA", dmg: 180, type: "beam", cost: 40 },
            { name: "CABE√áADA", dmg: 250, type: "physical", cost: 80 }
        ],
        transList: [],
        costumes: ["KuririnC2"]
    },

    "KuririnC2": {
        baseChar: "KuririnC2",
        name: "KURIRIN (C) TRAJE 2",
        isCostume: true,
        hp: 1000,
        maxHp: 1000,
        price: 1500,
        kiCost: 50,
        scale: 3.8,
        path: "Personagens/KuririnC2.png",
        moves: [
            { name: "SOCO R√ÅPIDO", dmg: 60, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "KAMEHAMEHA", dmg: 180, type: "beam", cost: 40 },
            { name: "CABE√áADA", dmg: 250, type: "physical", cost: 80 }
        ],
        transList: [],
        costumes: []
    },

    "KuririnZ": {
        baseChar: "KuririnZ",
        name: "KURIRIN (Z)",
        hp: 1300,
        maxHp: 1300,
        price: 1500,
        kiCost: 50,
        scale: 3.8,
        path: "Personagens/KuririnZ.png",
        moves: [
            { name: "COMBO MARCIAL", dmg: 80, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "KIENZAN", dmg: 280, type: "beam", cost: 50 },
            { name: "TAIYOUKEN", dmg: 450, type: "sphere", cost: 90 }
        ],
        transList: [],
        costumes: ["KuririnZ2"]
    },

    "KuririnZ2": {
        baseChar: "KuririnZ2",
        name: "KURIRIN (Z) TRAJE 2",
        isCostume: true,
        hp: 1300,
        maxHp: 1300,
        price: 1500,
        kiCost: 50,
        scale: 3.8,
        path: "Personagens/KuririnZ2.png",
        moves: [
            { name: "COMBO MARCIAL", dmg: 80, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "KIENZAN", dmg: 280, type: "beam", cost: 50 },
            { name: "TAIYOUKEN", dmg: 450, type: "sphere", cost: 90 }
        ],
        transList: [],
        costumes: []
    },

// ---- YAMCHA ----
    "YamchaClassic": {
        baseChar: "YamchaClassic",
        name: "YAMCHA (CL√ÅSSICO)",
        hp: 1200,
        maxHp: 1200,
        price: 800,
        kiCost: 50,
        scale: 4.5,
        path: "Personagens/Yamcha(C).png",
        moves: [
            { name: "SOCO DE RUA", dmg: 50, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "KAMEHAMEHA", dmg: 150, type: "beam", cost: 40 },
            { name: "ROGA FUFU KEN", dmg: 250, type: "physical", cost: 60 }
        ],
        transList: [],
        costumes: ["YamchaC2", "YamchaC3"]
    },

    "YamchaC2": {
        baseChar: "YamchaC2",
        name: "YAMCHA (C) TRAJE 2",
        isCostume: true,
        hp: 1200,
        maxHp: 1200,
        price: 1500,
        kiCost: 50,
        scale: 4.5,
        path: "Personagens/Yamcha(C2).png",
        moves: [
            { name: "SOCO DE RUA", dmg: 50, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "KAMEHAMEHA", dmg: 150, type: "beam", cost: 40 },
            { name: "ROGA FUFU KEN", dmg: 250, type: "physical", cost: 60 }
        ],
        transList: [],
        costumes: []
    },

    "YamchaC3": {
        baseChar: "YamchaC3",
        name: "YAMCHA (C) TRAJE 3",
        isCostume: true,
        hp: 1200,
        maxHp: 1200,
        price: 1500,
        kiCost: 50,
        scale: 4.5,
        path: "Personagens/Yamcha(C3).png",
        moves: [
            { name: "SOCO DE RUA", dmg: 50, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "KAMEHAMEHA", dmg: 150, type: "beam", cost: 40 },
            { name: "ROGA FUFU KEN", dmg: 250, type: "physical", cost: 60 }
        ],
        transList: [],
        costumes: []
    },

    "YamchaZ": {
        baseChar: "YamchaZ",
        name: "YAMCHA (Z)",
        hp: 1400,
        maxHp: 1400,
        price: 1200,
        kiCost: 50,
        scale: 4.5,
        path: "Personagens/YamchaZ.png",
        moves: [
            { name: "COMBO Z", dmg: 70, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "SOKIDAN", dmg: 300, type: "sphere", cost: 50 },
            { name: "SUPER ROGA FUFU KEN", dmg: 400, type: "physical", cost: 90 }
        ],
        transList: [],
        costumes: ["YamchaZ2"]
    },
    "YamchaZ2": {
        baseChar: "YamchaZ2",
        name: "Yamcha (Z2)",
        IsCostume: true,
        hp: 1500,
        maxHp: 1500,
        price: 1000,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/YamchaZ2.png",
        moves: [
            { name: "Rogafufuken", dmg: 90, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Kamehameha", dmg: 140, type: "beam", cost: 50 },
            { name: "Sokidan", dmg: 200, type: "beam", cost: 100 }
        ],
        transList: [],
        costumes: []
    },

    // ---- TIEN SHINHAN ----
    "TienClassic": {
        baseChar: "TienClassic",
        name: "TIEN (CL√ÅSSICO)",
        hp: 1200,
        maxHp: 1200,
        price: 1000,
        kiCost: 50,
        scale: 4.6,
        path: "Personagens/Tien(C).png",
        moves: [
            { name: "ARTES MARCIAIS", dmg: 60, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "DODON RAY", dmg: 180, type: "beam", cost: 35 },
            { name: "TRI-BEAM", dmg: 400, type: "sphere", cost: 80 }
        ],
        transList: [],
        costumes: ["TienC2"]
    },

    "TienC2": {
        baseChar: "TienC2",
        name: "TIEN (C) TRAJE 2",
        isCostume: true,
        hp: 1200,
        maxHp: 1200,
        price: 1500,
        kiCost: 50,
        scale: 4.6,
        path: "Personagens/Tien(C2).png",
        moves: [
            { name: "ARTES MARCIAIS", dmg: 60, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "DODON RAY", dmg: 180, type: "beam", cost: 35 },
            { name: "TRI-BEAM", dmg: 400, type: "sphere", cost: 80 }
        ],
        transList: [],
        costumes: []
    },

    "TienZ": {
        baseChar: "TienZ",
        name: "TIEN (Z)",
        hp: 1500,
        maxHp: 1500,
        price: 1500,
        kiCost: 50,
        scale: 4.6,
        path: "Personagens/TienZ.png",
        moves: [
            { name: "COMBO M√ÅXIMO", dmg: 90, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "NEO TRI-BEAM", dmg: 600, type: "sphere", cost: 60 },
            { name: "DODON RAY", dmg: 350, type: "beam", cost: 40 }
        ],
        transList: [],
        costumes: ["TienZ2", "TienZ3"]
    },

    "TienZ2": {
        baseChar: "TienZ2",
        name: "TIEN (Z) TRAJE 2",
        isCostume: true,
        hp: 1500,
        maxHp: 1500,
        price: 1500,
        kiCost: 50,
        scale: 4.6,
        path: "Personagens/TienZ2.png",
        moves: [
            { name: "COMBO M√ÅXIMO", dmg: 90, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "NEO TRI-BEAM", dmg: 600, type: "sphere", cost: 60 },
            { name: "DODON RAY", dmg: 350, type: "beam", cost: 40 }
        ],
        transList: [],
        costumes: []
    },

    "TienZ3": {
        baseChar: "TienZ3",
        name: "TIEN (Z) TRAJE 3",
        isCostume: true,
        hp: 1500,
        maxHp: 1500,
        price: 1500,
        kiCost: 50,
        scale: 4.6,
        path: "Personagens/TienZ3.png",
        moves: [
            { name: "COMBO M√ÅXIMO", dmg: 90, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "NEO TRI-BEAM", dmg: 600, type: "sphere", cost: 60 },
            { name: "DODON RAY", dmg: 350, type: "beam", cost: 40 }
        ],
        transList: [],
        costumes: []
    },

    // ---- OUTROS ----
    "MestreTsuru": {
        baseChar: "MestreTsuru",
        name: "MESTRE TSURU",
        hp: 1000,
        maxHp: 1000,
        price: 1200,
        isEvil: true,
        kiCost: 50,
        scale: 4.2,
        path: "Personagens/MestreTsuru.png",
        moves: [
            { name: "GOLPE CRUEL", dmg: 50, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "DODON RAY", dmg: 200, type: "beam", cost: 50 },
            { name: "VOO MORTAL", dmg: 300, type: "physical", cost: 90 }
        ],
        transList: [],
        costumes: []
    },

    "Chaos": {
        baseChar: "Chaos",
        name: "CHAOS",
        hp: 1000,
        maxHp: 1000,
        price: 800,
        kiCost: 50,
        scale: 3.5,
        path: "Personagens/Chaos.png",
        moves: [
            { name: "PODER PS√çQUICO", dmg: 40, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "DODON PA", dmg: 150, type: "beam", cost: 40 },
            { name: "AUTODESTRUI√á√ÉO", dmg: 500, type: "physical", cost: 100 }
        ],
        transList: [],
        costumes: ["Chaos2"]
    },

    "Chaos2": {
        baseChar: "Chaos2",
        name: "CHAOS TRAJE 2",
        isCostume: true,
        hp: 1000,
        maxHp: 1000,
        price: 1500,
        kiCost: 50,
        scale: 3.5,
        path: "Personagens/Chaos2.png",
        moves: [
            { name: "PODER PS√çQUICO", dmg: 40, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "DODON PA", dmg: 150, type: "beam", cost: 40 },
            { name: "AUTODESTRUI√á√ÉO", dmg: 500, type: "physical", cost: 100 }
        ],
        transList: [],
        costumes: []
    },

    // ---- GOHAN (KID) ----
    "GohanZKid": {
        baseChar: "GohanZKid",
        name: "GOHAN (KID)",
        hp: 1000,
        maxHp: 1000,
        price: 1000,
        kiCost: 50,
        scale: 3.8,
        path: "Personagens/GohanZKid.png",
        moves: [
            { name: "CABE√áADA FURIA", dmg: 100, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "MASENKO", dmg: 200, type: "beam", cost: 40 },
            { name: "ATAQUE SELVAGEM", dmg: 300, type: "physical", cost: 80 }
        ],
        transList: [],
        costumes: ["GohanZKid2", "GohanZKid3", "GohanZKid4"]
    },

    "GohanZKid2": {
        baseChar: "GohanZKid2",
        name: "GOHAN (KID) TRAJE 2",
        isCostume: true,
        hp: 1000,
        maxHp: 1000,
        price: 1500,
        kiCost: 50,
        scale: 3.8,
        path: "Personagens/GohanZKid2.png",
        moves: [
            { name: "CABE√áADA FURIA", dmg: 100, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "MASENKO", dmg: 200, type: "beam", cost: 40 },
            { name: "ATAQUE SELVAGEM", dmg: 300, type: "physical", cost: 80 }
        ],
        transList: [],
        costumes: []
    },

    "GohanZKid3": {
        baseChar: "GohanZKid3",
        name: "GOHAN (KID) TRAJE 3",
        isCostume: true,
        hp: 1000,
        maxHp: 1000,
        price: 1500,
        kiCost: 50,
        scale: 3.8,
        path: "Personagens/GohanZKid3.png",
        moves: [
            { name: "CABE√áADA FURIA", dmg: 100, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "MASENKO", dmg: 200, type: "beam", cost: 40 },
            { name: "ATAQUE SELVAGEM", dmg: 300, type: "physical", cost: 80 }
        ],
        transList: [],
        costumes: []
    },

    "GohanZKid4": {
        baseChar: "GohanZKid4",
        name: "GOHAN (KID) TRAJE 4",
        isCostume: true,
        hp: 1000,
        maxHp: 1000,
        price: 1500,
        kiCost: 50,
        scale: 3.8,
        path: "Personagens/GohanZKid4.png",
        moves: [
            { name: "CABE√áADA FURIA", dmg: 100, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "MASENKO", dmg: 200, type: "beam", cost: 40 },
            { name: "ATAQUE SELVAGEM", dmg: 300, type: "physical", cost: 80 }
        ],
        transList: ["OozaruC"],
        costumes: []
    },
    "GohanDoFuturo": {
        baseChar: "GohanDoFuturo",
        name: "Gohan (Futuro)",
        hp: 2100,
        maxHp: 2100,
        price: 1800,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/GohanDoFuturo.png",
        moves: [
            { name: "Combo Sobrevivente", dmg: 110, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Masenko", dmg: 160, type: "beam", cost: 50 },
            { name: "Fierce Combination", dmg: 210, type: "physical", cost: 100 }
        ],
        transList: ["GohanDoFuturoSSJ"],
        costumes: []
    },
    "GohanDoFuturoSSJ": {
        baseChar: "GohanDoFuturoSSJ",
        name: "Gohan (Futuro) SSJ",
        isTransformation: true,
        hp: 3100,
        maxHp: 3100,
        price: 3000,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/GohanDoFuturoSSJ.png",
        moves: [
            { name: "Ataque da Esperan√ßa", dmg: 150, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Super Masenko", dmg: 210, type: "beam", cost: 50 },
            { name: "One-Handed Kamehameha", dmg: 300, type: "beam", cost: 100 }
        ],
        transList: [],
        costumes: []
    },
    "GohanZTeen": {
        baseChar: "GohanZTeen",
        name: "Gohan Jovem",
        hp: 2000,
        maxHp: 2000,
        price: 1700,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/GohanZTeen.png",
        moves: [
            { name: "Soco R√°pido", dmg: 100, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Masenko", dmg: 150, type: "beam", cost: 50 },
            { name: "Kamehameha", dmg: 200, type: "beam", cost: 100 }
        ],
        transList: ["GohanZTeenSSJ", "GohanZTeenSSJ2"],
        costumes: ["GohanZTeen2"]
    },
    "GohanZTeen2": {
        baseChar: "GohanZTeen2",
        name: "Gohan Jovem",
        isCostume: true,
        hp: 2000,
        maxHp: 2000,
        price: 1700,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/GohanZTeen2.png",
        moves: [
            { name: "Soco R√°pido", dmg: 100, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Masenko", dmg: 150, type: "beam", cost: 50 },
            { name: "Kamehameha", dmg: 200, type: "beam", cost: 100 }
        ],
        transList: ["GohanZTeen2SSJ"],
        costumes: []
    },
    "GohanZTeen2SSJ": {
        baseChar: "GohanZTeen2SSJ",
        name: "Gohan Jovem SSJ",
        isCostume: true,
        isTransformation: true,
        hp: 2800,
        maxHp: 2800,
        price: 2500,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/GohanZTeen2SSJ.png",
        moves: [
            { name: "Soco Furioso", dmg: 130, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Super Masenko", dmg: 190, type: "beam", cost: 50 },
            { name: "Super Kamehameha", dmg: 260, type: "beam", cost: 100 }
        ],
        transList: [],
        costumes: []
    },
    "GohanZTeenSSJ": {
        baseChar: "GohanZTeenSSJ",
        name: "Gohan Jovem SSJ",
        isTransformation: true,
        hp: 2800,
        maxHp: 2800,
        price: 2500,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/GohanZTeenSSJ.png",
        moves: [
            { name: "Soco Furioso", dmg: 130, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Super Masenko", dmg: 190, type: "beam", cost: 50 },
            { name: "Super Kamehameha", dmg: 260, type: "beam", cost: 100 }
        ],
        transList: ["GohanZTeenSSJ2"],
        costumes: []
    },
    "GohanZTeenSSJ2": {
        baseChar: "GohanZTeenSSJ2",
        name: "Gohan Jovem SSJ2",
        isTransformation: true,
        hp: 3800,
        maxHp: 3800,
        price: 3500,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/GohanZTeenSSJ2.png",
        moves: [
            { name: "Golpe Impiedoso", dmg: 170, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Super Kamehameha", dmg: 250, type: "beam", cost: 50 },
            { name: "Father-Son Kamehameha", dmg: 380, type: "beam", cost: 100 }
        ],
        transList: [],
        costumes: []
    },
    "TrunksZ": {
        baseChar: "TrunksZ",
        name: "Trunks (Z)",
        hp: 1900,
        maxHp: 1900,
        price: 1600,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/TrunksZ.png",
        moves: [
            { name: "Golpe de Espada", dmg: 105, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Burning Attack", dmg: 160, type: "beam", cost: 50 },
            { name: "Shining Sword Attack", dmg: 210, type: "physical", cost: 100 }
        ],
        transList: ["TrunksZSSJ"],
        costumes: ["TrunksZT2", "TrunksZT3", "TrunksZT4", "TrunksZT5", "TrunksZT6"]
    },
    "TrunksZSSJ": {
        baseChar: "TrunksZSSJ",
        name: "Trunks SSJ",
        isTransformation: true,
        hp: 2700,
        maxHp: 2700,
        price: 2400,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/TrunksZSSJ.png",
        moves: [
            { name: "Corte Veloz", dmg: 130, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Burning Attack", dmg: 190, type: "beam", cost: 50 },
            { name: "Heat Dome Attack", dmg: 270, type: "beam", cost: 100 }
        ],
        transList: [],
        costumes: []
    },
    "TrunksZT2": {
        baseChar: "TrunksZT2",
        name: "Trunks",
        isCostume: true,
        hp: 1900,
        maxHp: 1900,
        price: 1600,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/TrunksZT2.png",
        moves: [
            { name: "Golpe de Espada", dmg: 105, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Burning Attack", dmg: 160, type: "beam", cost: 50 },
            { name: "Shining Sword Attack", dmg: 210, type: "physical", cost: 100 }
        ],
        transList: [],
        costumes: []
    },
    "TrunksZT3": {
        baseChar: "TrunksZT3",
        name: "Trunks",
        isCostume: true,
        hp: 1900,
        maxHp: 1900,
        price: 1600,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/TrunksZT3.png",
        moves: [
            { name: "Golpe de Espada", dmg: 105, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Burning Attack", dmg: 160, type: "beam", cost: 50 },
            { name: "Shining Sword Attack", dmg: 210, type: "physical", cost: 100 }
        ],
        transList: ["TrunksZT3SSJ"],
        costumes: []
    },
    "TrunksZT3SSJ": {
        baseChar: "TrunksZT3SSJ",
        name: "Trunks SSJ",
        isCostume: true,
        isTransformation: true,
        hp: 2700,
        maxHp: 2700,
        price: 2400,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/TrunksZT3SSJ.png",
        moves: [
            { name: "Corte Veloz", dmg: 130, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Burning Attack", dmg: 190, type: "beam", cost: 50 },
            { name: "Heat Dome Attack", dmg: 270, type: "beam", cost: 100 }
        ],
        transList: [],
        costumes: []
    },
    "TrunksZT4": {
        baseChar: "TrunksZT4",
        name: "Trunks",
        isCostume: true,
        hp: 1900,
        maxHp: 1900,
        price: 1600,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/TrunksZT4.png",
        moves: [
            { name: "Soco R√°pido", dmg: 105, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Finish Buster", dmg: 160, type: "beam", cost: 50 },
            { name: "Burning Attack", dmg: 210, type: "beam", cost: 100 }
        ],
        transList: ["TrunksZT4SSJ", "TrunksZT4SSJGrau2", "TrunksZT4SSJGrau3"],
        costumes: []
    },
    "TrunksZT4SSJ": {
        baseChar: "TrunksZT4SSJ",
        name: "Trunks SSJ",
        isCostume: true,
        isTransformation: true,
        hp: 2700,
        maxHp: 2700,
        price: 2400,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/TrunksZT4SSJ.png",
        moves: [
            { name: "Soco Poderoso", dmg: 130, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Finish Buster", dmg: 190, type: "beam", cost: 50 },
            { name: "Heat Dome Attack", dmg: 270, type: "beam", cost: 100 }
        ],
        transList: ["TrunksZT4SSJGrau2"],
        costumes: []
    },
    "TrunksZT4SSJGrau2": {
        baseChar: "TrunksZT4SSJGrau2",
        name: "Trunks SSJ Grau 2",
        isCostume: true,
        isTransformation: true,
        hp: 3100,
        maxHp: 3100,
        price: 3000,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/TrunksZT4SSJGrau2.png",
        moves: [
            { name: "Golpe Esmagador", dmg: 150, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Super Buster Cannon", dmg: 220, type: "beam", cost: 50 },
            { name: "Heat Dome Attack", dmg: 310, type: "beam", cost: 100 }
        ],
        transList: ["TrunksZT4SSJGrau3"],
        costumes: []
    },
    "TrunksZT4SSJGrau3": {
        baseChar: "TrunksZT4SSJGrau3",
        name: "Super Trunks",
        isCostume: true,
        isTransformation: true,
        hp: 3600,
        maxHp: 3600,
        price: 3400,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/TrunksZT4SSJGrau3.png",
        moves: [
            { name: "Soco Lento Destruidor", dmg: 200, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Blaster Meteor", dmg: 260, type: "beam", cost: 50 },
            { name: "Super Buster Cannon", dmg: 350, type: "beam", cost: 100 }
        ],
        transList: [],
        costumes: []
    },
    "TrunksZT5": {
        baseChar: "TrunksZT5",
        name: "Trunks",
        isCostume: true,
        hp: 1900,
        maxHp: 1900,
        price: 1600,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/TrunksZT5.png",
        moves: [
            { name: "Golpe de Espada", dmg: 105, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Burning Attack", dmg: 160, type: "beam", cost: 50 },
            { name: "Shining Sword Attack", dmg: 210, type: "physical", cost: 100 }
        ],
        transList: ["TrunksZT5SSJ"],
        costumes: []
    },
    "TrunksZT5SSJ": {
        baseChar: "TrunksZT5SSJ",
        name: "Trunks SSJ",
        isCostume: true,
        isTransformation: true,
        hp: 2700,
        maxHp: 2700,
        price: 2400,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/TrunksZT5SSJ.png",
        moves: [
            { name: "Corte Veloz", dmg: 130, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Burning Attack", dmg: 190, type: "beam", cost: 50 },
            { name: "Heat Dome Attack", dmg: 270, type: "beam", cost: 100 }
        ],
        transList: [],
        costumes: []
    },
    "TrunksZT6": {
        baseChar: "TrunksZT6",
        name: "Trunks",
        isCostume: true,
        hp: 1900,
        maxHp: 1900,
        price: 1600,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/TrunksZT6.png",
        moves: [
            { name: "Soco R√°pido", dmg: 105, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Burning Attack", dmg: 160, type: "beam", cost: 50 },
            { name: "Shining Sword Attack", dmg: 210, type: "physical", cost: 100 }
        ],
        transList: ["TrunksZT6SSJ", "TrunksZT6SSJGrau2"],
        costumes: []
    },
    "TrunksZT6SSJ": {
        baseChar: "TrunksZT6SSJ",
        name: "Trunks SSJ",
        isCostume: true,
        isTransformation: true,
        hp: 2700,
        maxHp: 2700,
        price: 2400,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/TrunksZT6SSJ.png",
        moves: [
            { name: "Soco Poderoso", dmg: 130, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Burning Attack", dmg: 190, type: "beam", cost: 50 },
            { name: "Heat Dome Attack", dmg: 270, type: "beam", cost: 100 }
        ],
        transList: ["TrunksZT6SSJGrau2"],
        costumes: []
    },
    "TrunksZT6SSJGrau2": {
        baseChar: "TrunksZT6SSJGrau2",
        name: "Trunks SSJ Grau 2",
        isCostume: true,
        isTransformation: true,
        hp: 3100,
        maxHp: 3100,
        price: 3000,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/TrunksZT6SSJGrau2.png",
        moves: [
            { name: "Golpe Esmagador", dmg: 150, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Super Buster Cannon", dmg: 220, type: "beam", cost: 50 },
            { name: "Heat Dome Attack", dmg: 310, type: "beam", cost: 100 }
        ],
        transList: [],
        costumes: []

    },
    // ‚îÄ‚îÄ TRUNKS CRIAN√áA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    "TrunksZKid": {
        baseChar: "TrunksZKid",
        name: "TRUNKS (CRIAN√áA)",
        isTransformation: false,
        isEvil: false,
        hp: 900,
        maxHp: 900,
        price: 3000,
        kiCost: 0,
        scale: 4.8,
        canFuse: true,
        path: "Personagens/TrunksZKid.png",
        moves: [
            { name: "SWIFT KICK", dmg: 65, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "DOUBLE BUSTER", dmg: 130, type: "beam", cost: 45 },
            { name: "ENERGY BLAST", dmg: 160, type: "sphere", cost: 85 }
        ],
        transList: ["TrunksZSSJKid"],
        costumes: []
    },

    "TrunksZSSJKid": {
        baseChar: "TrunksZKid",
        name: "TRUNKS (CRIAN√áA SUPER SAIAJIN)",
        isTransformation: true,
        isEvil: false,
        hp: 1100,
        maxHp: 1100,
        price: 4500,
        kiCost: 80,
        scale: 4.8,
        path: "Personagens/TrunksZSSJKid.png",
        moves: [
            { name: "METEOR STRIKE", dmg: 90, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "VICTORY CANNON", dmg: 170, type: "beam", cost: 60 },
            { name: "SUPER DOUBLE BUSTER", dmg: 240, type: "sphere", cost: 110 }
        ],
        transList: [],
        costumes: []
    },

    // ‚îÄ‚îÄ GOTEN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    "GotenZ": {
        baseChar: "GotenZ",
        name: "GOTEN",
        isTransformation: false,
        isEvil: false,
        hp: 850,
        maxHp: 850,
        price: 2500,
        kiCost: 0,
        scale: 4.8,
        canFuse: true,
        path: "Personagens/GotenZ.png",
        moves: [
            { name: "ASSAULT TACKLE", dmg: 60, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "KAMEKAMEHA", dmg: 120, type: "beam", cost: 40 },
            { name: "ENERGY BLAST", dmg: 150, type: "sphere", cost: 80 }
        ],
        transList: ["GotenZSSJ"],
        costumes: []
    },

    "GotenZSSJ": {
        baseChar: "GotenZ",
        name: "GOTEN (SUPER SAIAJIN)",
        isTransformation: true,
        isEvil: false,
        hp: 1050,
        maxHp: 1050,
        price: 4000,
        kiCost: 80,
        scale: 4.8,
        path: "Personagens/GotenZSSJ.png",
        moves: [
            { name: "SUPER ASSAULT", dmg: 80, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "SUPER KAMEKAMEHA", dmg: 160, type: "beam", cost: 50 },
            { name: "BROS KAMEHAMEHA", dmg: 220, type: "sphere", cost: 100 }
        ],
        transList: [],
        costumes: []
    },

    

    // ‚îÄ‚îÄ GOTENKS (RESULTADO DA FUS√ÉO GOTEN+TRUNKS) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    "GotenksZ": {
        baseChar: "GotenksZ",
        name: "GOTENKS",
        isTransformation: false,
        isEvil: false,
        hp: 1100,
        maxHp: 1100,
        price: 5000,
        kiCost: 0,
        scale: 4.8,
        hidden: false,
        path: "Personagens/GotenksZ.png",
        moves: [
            { name: "DYNAMITE KICK", dmg: 80, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "GALACTIC DONUT", dmg: 140, type: "beam", cost: 50 },
            { name: "SUPER GHOST KAMIKAZE", dmg: 200, type: "sphere", cost: 100 }
        ],
        transList: ["GotenksZSSJ", "GotenksZSSJ3"],
        costumes: []
    },

    "GotenksZSSJ": {
        baseChar: "GotenksZ",
        name: "GOTENKS (SUPER SAIAJIN)",
        isTransformation: true,
        isEvil: false,
        hp: 1300,
        maxHp: 1300,
        price: 7000,
        kiCost: 60,
        scale: 4.8,
        path: "Personagens/GotenksZSSJ.png",
        moves: [
            { name: "WILD BOAR ATTACK", dmg: 100, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "DIE DIE MISSILE BARRAGE", dmg: 160, type: "beam", cost: 60 },
            { name: "SUPER GHOST KAMIKAZE", dmg: 240, type: "sphere", cost: 120 }
        ],
        transList: ["GotenksZSSJ3"],
        costumes: []
    },

    "GotenksZSSJ3": {
        baseChar: "GotenksZ",
        name: "GOTENKS (SUPER SAIAJIN 3)",
        isTransformation: true,
        isEvil: false,
        hp: 1500,
        maxHp: 1500,
        price: 10000,
        kiCost: 100,
        scale: 4.8,
        path: "Personagens/GotenksZSSJ3.png",
        moves: [
            { name: "BUU BUU VOLLEYBALL", dmg: 150, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "VICTORY CANNON", dmg: 200, type: "beam", cost: 80 },
            { name: "SUPER GHOST KAMIKAZE X10", dmg: 350, type: "sphere", cost: 150 }
        ],
        transList: [],
        costumes: []
    },

    // ---- ALIADOS ----
    "Yajirobe": {
        baseChar: "Yajirobe",
        name: "YAJIROBE",
        hp: 1100,
        maxHp: 1100,
        price: 800,
        kiCost: 50,
        scale: 4.2,
        path: "Personagens/Yajirobe.png",
        moves: [
            { name: "CORTE DE KATANA", dmg: 80, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "GOLPE COVARDE", dmg: 150, type: "physical", cost: 50 },
            { name: "CORTE SURPRESA", dmg: 350, type: "physical", cost: 90 }
        ],
        transList: [],
        costumes: []
    },

    "Dende": {
        baseChar: "Dende",
        name: "DEND√ä",
        hp: 1000,
        maxHp: 1000,
        price: 500,
        kiCost: 50,
        scale: 3.5,
        path: "Personagens/Dend√™.png",
        moves: [
            { name: "CURA", dmg: 0, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "BARREIRA", dmg: 0, type: "beam", cost: 50 },
            { name: "PEDRA", dmg: 50, type: "physical", cost: 20 }
        ],
        transList: [],
        costumes: []
    },

    "Nail": {
        baseChar: "Nail",
        name: "NAIL",
        hp: 1800,
        maxHp: 1800,
        price: 2000,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/Nail.png",
        moves: [
            { name: "GOLPE NAMEKUSEIJIN", dmg: 100, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "CANH√ÉO DE ENERGIA", dmg: 300, type: "beam", cost: 50 },
            { name: "ATAQUE M√çSTICO", dmg: 500, type: "physical", cost: 100 }
        ],
        transList: [],
        costumes: []
    },
// ==========================================
    // PICCOLO DAIMAOH
    // ==========================================
    "PiccoloDaimaohOld": {
        baseChar: "PiccoloDaimaohOld",
        name: "DAIMAOH (VELHO)",
        hp: 1200,
        maxHp: 1200,
        isEvil: true,
        price: 1500,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/PiccoloDaimaohOld.png",
        moves: [
            { name: "GOLPE MALIGNO", dmg: 80, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "ONDA DEMON√çACA", dmg: 200, type: "beam", cost: 40 },
            { name: "EXPLOS√ÉO MAKOU", dmg: 450, type: "sphere", cost: 85 }
        ],
        transList: ["PiccoloDaimaoh"],
        costumes: []
    },

    "PiccoloDaimaoh": {
        baseChar: "PiccoloDaimaoh",
        name: "DAIMAOH (JOVEM)",
        isTransformation: true,
        hp: 1600,
        maxHp: 1600,
        isEvil: true,
        kiCost: 50,
        price: 1800,
        scale: 4.8,
        path: "Personagens/PiccoloDaimaoh.png",
        moves: [
            { name: "FURIA DEMON√çACA", dmg: 110, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "MAKOUHOU", dmg: 300, type: "beam", cost: 40 },
            { name: "EXPLOS√ÉO FINAL", dmg: 600, type: "sphere", cost: 90 }
        ],
        transList: [],
        costumes: []
    },

    // ==========================================
    // PICCOLO JR / Z
    // ==========================================
    "PiccoloJr": {
        baseChar: "PiccoloJr",
        name: "PICCOLO JR",
        hp: 1800,
        maxHp: 1800,
        price: 2000,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/PiccoloJr.png",
        moves: [
            { name: "COMBO PESADO", dmg: 100, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "CANNON ANTENA", dmg: 250, type: "beam", cost: 40 },
            { name: "MAKANKOSAPPO", dmg: 650, type: "beam", cost: 95 }
        ],
        transList: ["PiccoloJrGiant"],
        costumes: ["PiccoloJr2", "PiccoloJr3"]
    },

    "PiccoloJr2": {
        baseChar: "PiccoloJr2",
        name: "PICCOLO JR T2",
        isCostume: true,
        hp: 1800,
        maxHp: 1800,
        price: 1500,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/PiccoloJr2.png",
        moves: [
            { name: "COMBO", dmg: 100, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "CHOU MAKOUHOU", dmg: 350, type: "beam", cost: 50 },
            { name: "MAKANKOSAPPO", dmg: 750, type: "beam", cost: 100 }
        ],
        transList: ["PiccoloJrGiant"],
        costumes: []
    },

    "PiccoloJr3": {
        baseChar: "PiccoloJr3",
        name: "PICCOLO JR T3",
        isCostume: true,
        hp: 1800,
        maxHp: 1800,
        price: 1500,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/PiccoloJr3.png",
        moves: [
            { name: "COMBO", dmg: 100, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "MASENKO", dmg: 350, type: "beam", cost: 50 },
            { name: "MAKANKOSAPPO", dmg: 750, type: "beam", cost: 100 }
        ],
        transList: ["PiccoloJrGiant"],
        costumes: []
    },

    "PiccoloZ": {
        baseChar: "PiccoloZ",
        name: "PICCOLO (Z)",
        hp: 1200,
        maxHp: 1200,
        price: 1500,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/PiccoloZ.png",
        moves: [
            { name: "COMBO PESADO", dmg: 120, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "CANNON ANTENA", dmg: 280, type: "beam", cost: 40 },
            { name: "MAKANKOSAPPO", dmg: 700, type: "beam", cost: 95 }
        ],
        transList: ["PiccoloZallOut"],
        costumes: ["PiccoloZ2"]
    },
    "PiccoloZ2": {
        name: "Piccolo (Z2)",
        isCostume: true,
        baseChar: "PiccoloZ",
        hp: 2200,
        maxHp: 2200,
        price: 1800,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/PiccoloZ2.png",
        moves: [
            { name: "Soco T√°tico", dmg: 110, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Makankosappo", dmg: 180, type: "beam", cost: 50 },
            { name: "Hellzone Grenade", dmg: 240, type: "beam", cost: 100 }
        ],
        transList: ["PiccoloZ2AllOut", "PiccoloZ2Assimilation"],
        costumes: []
    },
    "PiccoloZ2AllOut": {
        baseChar: "PiccoloZ2AllOut",
        name: "Piccolo All Out",
        isTransformation: true,
        hp: 2600,
        maxHp: 2600,
        price: 2200,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/PiccoloZ2AllOut.png",
        moves: [
            { name: "Ataque Feroz", dmg: 130, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Super Makankosappo", dmg: 210, type: "beam", cost: 50 },
            { name: "Light Grenade", dmg: 280, type: "beam", cost: 100 }
        ],
        transList: ["PiccoloZ2Assimilation"],
        costumes: []
    },
    "PiccoloZ2Assimilation": {
        baseChar: "PiccoloZ2Assimilation",
        name: "Piccolo (Fundido)",
        isTransformation: true,
        hp: 3000,
        maxHp: 3000,
        price: 2800,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/PiccoloZ2Assimilation.png",
        moves: [
            { name: "Golpe Pesado Namek", dmg: 140, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Hellzone Grenade", dmg: 240, type: "beam", cost: 50 },
            { name: "Special Beam Cannon", dmg: 320, type: "beam", cost: 100 }
        ],
        transList: [],
        costumes: []
    },
    "KamiSama": {
        baseChar: "KamiSama",
        name: "Kami-Sama",
        hp: 1200,
        maxHp: 1200,
        price: 800,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/KamiSama.png",
        moves: [
            { name: "Golpe M√≠stico", dmg: 80, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "God Shock", dmg: 120, type: "beam", cost: 50 },
            { name: "Explos√£o Divina", dmg: 160, type: "beam", cost: 100 }
        ],
        transList: [],
        costumes: []
    },

    "PiccoloJrGiant": {
        baseChar: "PiccoloJrGiant",
        name: "PICCOLO GIGANTE",
        isTransformation: true,
        hp: 3000,
        maxHp: 3000,
        kiCost: 80,
        price: 2000,
        scale: 3.5,
        previewScale: 2.5,
        shopScale: 1.3,
        path: "Personagens/PiccoloJrGiant.png",
        moves: [
            { name: "PIS√ÉO TIT√ÇNICO", dmg: 180, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "ONDA BUCAL", dmg: 400, type: "beam", cost: 50 },
            { name: "DESTRUI√á√ÉO MASSIVA", dmg: 800, type: "sphere", cost: 100 }
        ],
        transList: [],
        costumes: []
    },

    "PiccoloZallOut": {
        baseChar: "PiccoloZallOut",
        name: "PICCOLO Z (ALL OUT)",
        isTransformation: true,
        hp: 3000,
        maxHp: 3000,
        kiCost: 60,
        price: 2500,
        scale: 4.8,
        path: "Personagens/PiccoloZallOut.png",
        moves: [
            { name: "F√öRIA NAMEKUSEIJIN", dmg: 150, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "LIGHT GRENADE", dmg: 400, type: "sphere", cost: 50 },
            { name: "MAKANKOSAPPO MAX", dmg: 850, type: "beam", cost: 100 }
        ],
        transList: [],
        costumes: []
    },

    // ==========================================
    // VIL√ïES (SAGA SAIYAJIN)
    // ==========================================
    "Raditz": {
        baseChar: "Raditz",
        name: "RADITZ",
        hp: 1500,
        maxHp: 1500,
        price: 2200,
        isEvil: true,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/Raditz.png",
        moves: [
            { name: "CHUTE TRAI√áOEIRO", dmg: 90, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "SATURDAY CRASH", dmg: 260, type: "sphere", cost: 40 },
            { name: "DOUBLE SUNDAY", dmg: 550, type: "beam", cost: 85 }
        ],
        transList: [],
        costumes: []
    },

    "Saibaman": {
        baseChar: "Saibaman",
        name: "SAIBAMAN",
        hp: 1000,
        maxHp: 1000,
        price: 800,
        isEvil: true,
        kiCost: 50,
        scale: 3.8,
        path: "Personagens/Saibaman.png",
        moves: [
            { name: "GARRAS S√ÅDICAS", dmg: 60, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "√ÅCIDO", dmg: 150, type: "beam", cost: 30 },
            { name: "AUTODESTRUI√á√ÉO", dmg: 800, type: "sphere", cost: 100 }
        ],
        transList: [],
        costumes: ["Saibaman2"]
    },

    "Saibaman2": {
        baseChar: "Saibaman2",
        name: "SAIBAMAN",
        isCostume: true,
        hp: 1000,
        maxHp: 1000,
        price: 1500,
        kiCost: 50,
        scale: 3.8,
        path: "Personagens/Saibaman2.png",
        moves: [
            { name: "GARRAS S√ÅDICAS", dmg: 65, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "√ÅCIDO VERMELHO", dmg: 160, type: "beam", cost: 30 },
            { name: "AUTODESTRUI√á√ÉO", dmg: 850, type: "sphere", cost: 100 }
        ],
        transList: [],
        costumes: []
    },

    "Nappa": {
        baseChar: "Nappa",
        name: "NAPPA",
        hp: 2200,
        maxHp: 2200,
        price: 2800,
        isEvil: true,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/Nappa.png",
        moves: [
            { name: "QUEBRA OSSOS", dmg: 120, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "BOMBER DX", dmg: 320, type: "sphere", cost: 45 },
            { name: "VOLCANO EXPLOSION", dmg: 700, type: "beam", cost: 90 }
        ],
        transList: ["NappaOozaru"],
        costumes: ["Nappa2"]
    },

    "Nappa2": {
        baseChar: "Nappa2",
        name: "NAPPA (SEM ARMADURA)",
        isCostume: true,
        hp: 2100,
        maxHp: 2100,
        price: 1500,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/Nappa2.png",
        moves: [
            { name: "F√öRIA CEGA", dmg: 140, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "BOMBER DX", dmg: 350, type: "sphere", cost: 45 },
            { name: "VOLCANO EXPLOSION", dmg: 750, type: "beam", cost: 90 }
        ],
        transList: ["NappaOozaru"],
        costumes: []
    },

    "NappaOozaru": {
        baseChar: "NappaOozaru",
        name: "NAPPA (OOZARU)",
        isTransformation: true,
        isEvil: true,
        hp: 3000,
        maxHp: 3000,
        price: 4000,
        kiCost: 50,
        scale: 3.5,
        previewScale: 2.5,
        shopScale: 1.3,
        path: "Personagens/Oozaru.png",
        moves: [
            { name: "PIS√ÉO DESTRUTIVO", dmg: 210, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "CHOU MAKOHOU", dmg: 480, type: "beam", cost: 50 },
            { name: "DESTRUI√á√ÉO GIGANTE", dmg: 950, type: "sphere", cost: 100 }
        ],
        transList: [],
        costumes: []
    },

    // ==========================================
    // EX√âRCITO DE FREEZA
    // ==========================================
    "Cui": {
        baseChar: "Cui",
        name: "CUI",
        hp: 1300,
        maxHp: 1300,
        price: 1500,
        isEvil: true,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/Cui.png",
        moves: [
            { name: "COMBO", dmg: 80, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "AH, LORD FREEZA!", dmg: 220, type: "beam", cost: 35 },
            { name: "BOMBARDEIO DE KI", dmg: 480, type: "sphere", cost: 80 }
        ],
        transList: [],
        costumes: []
    },

    "Raspberry": {
        baseChar: "Raspberry",
        name: "RASPBERRY",
        hp: 1000,
        maxHp: 1000,
        price: 500,
        isEvil: true,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/Raspberry.png",
        moves: [
            { name: "CORONHADA", dmg: 50, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "TIRO DE BLASTER", dmg: 130, type: "beam", cost: 30 },
            { name: "RAJADA CONT√çNUA", dmg: 300, type: "sphere", cost: 70 }
        ],
        transList: [],
        costumes: []
    },

    "SoldadoDoFreeza": {
        baseChar: "SoldadoDoFreeza",
        name: "SOLDADO DE FREEZA",
        hp: 1000,
        maxHp: 1000,
        price: 500,
        isEvil: true,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/SoldadoDoFreeza.png",
        moves: [
            { name: "SOCO SOLDADO", dmg: 55, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "RAIO DE ENERGIA", dmg: 140, type: "beam", cost: 30 },
            { name: "ONDA EXPLOSIVA", dmg: 320, type: "sphere", cost: 70 }
        ],
        transList: [],
        costumes: []
    },

    "Dodoria": {
        baseChar: "Dodoria",
        name: "DODORIA",
        hp: 1700,
        maxHp: 1700,
        price: 2500,
        isEvil: true,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/Dodoria.png",
        moves: [
            { name: "CABE√áADA PESADA", dmg: 100, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "DODORIA BEAM", dmg: 300, type: "beam", cost: 45 },
            { name: "MAXIMUM BUSTER", dmg: 600, type: "sphere", cost: 90 }
        ],
        transList: [],
        costumes: []
    },

    "Appule": {
        baseChar: "Appule",
        name: "APPULE",
        hp: 1000,
        maxHp: 1000,
        price: 500,
        isEvil: true,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/Appule.png",
        moves: [
            { name: "TIRO DE BLASTER", dmg: 40, type: "beam" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "SOCO REBELDE", dmg: 80, type: "physical", cost: 30 },
            { name: "BOMBA DE ENERGIA", dmg: 150, type: "sphere", cost: 50 }
        ],
        transList: [],
        costumes: []
    },

    "Zarbon": {
        baseChar: "Zarbon",
        name: "ZARBON",
        hp: 1600,
        maxHp: 1600,
        price: 2500,
        isEvil: true,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/Zarbon.png",
        moves: [
            { name: "CHUTE ELEGANTE", dmg: 95, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "ELEGANT BLASTER", dmg: 280, type: "beam", cost: 40 },
            { name: "SHOOTING STAR ARROW", dmg: 580, type: "sphere", cost: 85 }
        ],
        transList: ["ZarbonMonster"],
        costumes: []
    },

    "ZarbonMonster": {
        baseChar: "ZarbonMonster",
        name: "ZARBON MONSTRO",
        isTransformation: true,
        hp: 2000,
        maxHp: 2000,
        isEvil: true,
        price: 2000,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/ZarbonMonster.png",
        moves: [
            { name: "AGARR√ÉO BRUTAL", dmg: 140, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "MONSTER CRASH", dmg: 350, type: "sphere", cost: 50 },
            { name: "ELEGANT BLASTER M√ÅX.", dmg: 700, type: "beam", cost: 95 }
        ],
        transList: [],
        costumes: []
    },
// ==========================================
    // FOR√áAS ESPECIAIS GINYU
    // ==========================================
    "Ginyu": {
        baseChar: "Ginyu",
        name: "CAPIT√ÉO GINYU",
        hp: 1800,
        maxHp: 1800,
        price: 2500,
        isEvil: true,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/Ginyu.png",
        moves: [
            { name: "ATAQUE GINYU", dmg: 120, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "MILKY CANNON", dmg: 300, type: "beam", cost: 40 },
            { name: "TROCA DE CORPO", dmg: 0, type: "bodyChange", cost: 100 }
        ],
        transList: [],
        costumes: ["Ginyu2", "Ginyu3"]
    },

    "Ginyu2": {
        baseChar: "Ginyu2",
        name: "GINYU TRAJE 2",
        isCostume: true,
        hp: 1800,
        maxHp: 1800,
        price: 1500,
        isEvil: true,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/Ginyu2.png",
        moves: [
            { name: "ATAQUE GINYU", dmg: 120, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "MILKY CANNON", dmg: 300, type: "beam", cost: 40 },
            { name: "TROCA DE CORPO", dmg: 0, type: "bodyChange", cost: 100 }
        ],
        transList: [],
        costumes: []
    },

    "Ginyu3": {
        baseChar: "Ginyu3",
        name: "GINYU TRAJE 3",
        isCostume: true,
        hp: 1800,
        maxHp: 1800,
        price: 1500,
        isEvil: true,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/Ginyu3.png",
        moves: [
            { name: "ATAQUE GINYU", dmg: 120, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "MILKY CANNON", dmg: 300, type: "beam", cost: 40 },
            { name: "TROCA DE CORPO", dmg: 0, type: "bodyChange", cost: 100 }
        ],
        transList: [],
        costumes: []
    },

    "Gurdo": {
        baseChar: "Gurdo",
        name: "GURDO",
        hp: 1000,
        maxHp: 1000,
        price: 1000,
        isEvil: true,
        kiCost: 50,
        scale: 3.8,
        path: "Personagens/Gurdo.png",
        moves: [
            { name: "GOLPE FRACO", dmg: 60, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "ROCHA TELECIN√âTICA", dmg: 200, type: "sphere", cost: 40 },
            { name: "TRONCO EMPALADOR", dmg: 450, type: "beam", cost: 85 }
        ],
        transList: [],
        costumes: []
    },

    "Jeice": {
        baseChar: "Jeice",
        name: "JEICE",
        hp: 1600,
        maxHp: 1600,
        price: 1800,
        isEvil: true,
        kiCost: 50,
        scale: 4.6,
        path: "Personagens/Jeice.png",
        moves: [
            { name: "COMBO VERMELHO", dmg: 100, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "CRUSHER BALL", dmg: 300, type: "sphere", cost: 45 },
            { name: "CRUSHER VOLCANO", dmg: 620, type: "beam", cost: 90 }
        ],
        transList: [],
        costumes: []
    },
"Recoome": {
        baseChar: "Recoome",
        name: "Recoome",
        isEvil: true,
        hp: 1800,
        maxHp: 1800,
        price: 1300,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/Recoome.png",
        moves: [
            { name: "Recoome Kick", dmg: 110, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Recoome Eraser Gun", dmg: 160, type: "beam", cost: 50 },
            { name: "Recoome Bomber", dmg: 220, type: "physical", cost: 100 }
        ],
        transList: [],
        costumes: ["RecoomeT2"]
    },
    "RecoomeT2": {
        baseChar: "RecoomeT2",
        name: "Recoome",
        isCostume: true,
        isEvil: true,
        hp: 1800,
        maxHp: 1800,
        price: 1300,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/RecoomeT2.png",
        moves: [
            { name: "Recoome Kick", dmg: 110, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Recoome Eraser Gun", dmg: 160, type: "beam", cost: 50 },
            { name: "Recoome Bomber", dmg: 220, type: "physical", cost: 100 }
        ],
        transList: [],
        costumes: []
    },
    "Boter": {
        baseChar: "Boter",
        name: "Burter",
        isEvil: true,
        hp: 1500,
        maxHp: 1500,
        price: 1000,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/Boter.png",
        moves: [
            { name: "Mach Kick", dmg: 100, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Blue Hurricane", dmg: 140, type: "beam", cost: 50 },
            { name: "Purple Comet Crash", dmg: 190, type: "physical", cost: 100 }
        ],
        transList: [],
        costumes: []
    
    },
    // ==========================================
    // FAM√çLIA DO FREEZA
    // ==========================================
    "KingCold": {
        baseChar: "KingCold",
        name: "KING COLD",
        hp: 3000,
        maxHp: 3000,
        price: 4500,
        isEvil: true,
        kiCost: 50,
        scale: 5.5,
        path: "Personagens/KingCold.png",
        moves: [
            { name: "GOLPE DO IMPERADOR", dmg: 140, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "RAIO PENETRANTE", dmg: 350, type: "beam", cost: 45 },
            { name: "SUPERNOVA IMPERIAL", dmg: 800, type: "sphere", cost: 95 }
        ],
        transList: [],
        costumes: ["KingCold2"]
    },

    "KingCold2": {
        baseChar: "KingCold2",
        name: "KING COLD TRAJE 2",
        isCostume: true,
        hp: 3000,
        maxHp: 3000,
        price: 1500,
        isEvil: true,
        kiCost: 50,
        scale: 5.5,
        path: "Personagens/KingCold2.png",
        moves: [
            { name: "GOLPE DO IMPERADOR", dmg: 140, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "RAIO PENETRANTE", dmg: 350, type: "beam", cost: 45 },
            { name: "SUPERNOVA IMPERIAL", dmg: 800, type: "sphere", cost: 95 }
        ],
        transList: [],
        costumes: []
    },

    "FreezaF1": {
        baseChar: "FreezaF1",
        name: "FREEZA (F1)",
        hp: 2000,
        maxHp: 2000,
        price: 4000,
        isEvil: true,
        kiCost: 50,
        scale: 4.2,
        path: "Personagens/FreezaF1.png",
        moves: [
            { name: "RAIO OCULAR", dmg: 100, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "DEATH BEAM", dmg: 250, type: "beam", cost: 40 },
            { name: "SUPERNOVA", dmg: 600, type: "sphere", cost: 90 }
        ],
        transList: ["FreezaF2", "FreezaF3", "FreezaF4"],
        costumes: ["FreezaF1(T2)", "FreezaF1DBS", "FreezaF1DBS2"]
    },

    "FreezaF1(T2)": {
        baseChar: "FreezaF1(T2)",
        name: "FREEZA (F1)(Traje2)",
        isCostume: true,
        hp: 2000,
        maxHp: 2000,
        price: 4000,
        isEvil: true,
        kiCost: 50,
        scale: 4.2,
        path: "Personagens/FreezaF12.png",
        moves: [
            { name: "RAIO OCULAR", dmg: 100, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "DEATH BEAM", dmg: 250, type: "beam", cost: 40 },
            { name: "SUPERNOVA", dmg: 600, type: "sphere", cost: 90 }
        ],
        transList: ["FreezaF2", "FreezaF3", "FreezaF4"],
        costumes: []
    },

    "FreezaF2": {
        baseChar: "FreezaF2",
        name: "FREEZA (F2)",
        isTransformation: true,
        hp: 2500,
        maxHp: 2500,
        price: 1200,
        isEvil: true,
        kiCost: 40,
        scale: 5.5,
        path: "Personagens/FreezaF2.png",
        moves: [
            { name: "CHIFRADA", dmg: 140, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "DEATH STORM", dmg: 350, type: "sphere", cost: 45 },
            { name: "HAIL TO THE KING", dmg: 750, type: "beam", cost: 90 }
        ],
        transList: ["FreezaF3"],
        costumes: []
    },

    "FreezaF3": {
        baseChar: "FreezaF3",
        name: "FREEZA (F3)",
        isTransformation: true,
        hp: 3000,
        maxHp: 3000,
        price: 1800,
        isEvil: true,
        kiCost: 50,
        scale: 5.0,
        path: "Personagens/FreezaF3.png",
        moves: [
            { name: "ATAQUE SELVAGEM", dmg: 160, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "CRAZY FINGER", dmg: 400, type: "beam", cost: 50 },
            { name: "DEATH BEAM BARRAGE", dmg: 850, type: "beam", cost: 95 }
        ],
        transList: ["FreezaF4"],
        costumes: []
    },

    "FreezaF4": {
        baseChar: "FreezaF4",
        name: "FREEZA (F4)",
        isTransformation: true,
        hp: 3000,
        maxHp: 3000,
        price: 2500,
        isEvil: true,
        kiCost: 60,
        scale: 4.5,
        path: "Personagens/FreezaF4.png",
        moves: [
            { name: "GOLPE CRUEL", dmg: 180, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "DEATH BEAM", dmg: 450, type: "beam", cost: 40 },
            { name: "DEATH BALL", dmg: 950, type: "sphere", cost: 100 }
        ],
        transList: ["MechaFreeza","FreezaF4FULLPOWER"],
        costumes: []
    },
    // ‚îÄ‚îÄ FREEZA F4 FULL POWER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    "FreezaF4FULLPOWER": {
        baseChar: "FreezaF4",
        name: "FREEZA (100% DE PODER)",
        isTransformation: true,
        isEvil: true,
        hp: 1400,
        maxHp: 1400,
        price: 8000,
        kiCost: 150,
        scale: 4.8,
        path: "Personagens/FreezaF4FULLPOWER.png",
        moves: [
            { name: "NOVA STRIKE", dmg: 120, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "DEATH CANNON", dmg: 180, type: "beam", cost: 60 },
            { name: "DEATH SAUCER", dmg: 250, type: "sphere", cost: 120 }
        ],
        transList: [],
        costumes: []
    },

    "MechaFreeza": {
        baseChar: "MechaFreeza",
        name: "MECHA FREEZA",
        isTransformation: true,
        hp: 3000,
        maxHp: 3000,
        price: 3000,
        isEvil: true,
        kiCost: 60,
        scale: 4.5,
        path: "Personagens/MechaFreeza.png",
        moves: [
            { name: "GOLPE MET√ÅLICO", dmg: 190, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "DEATH BEAM DUPLO", dmg: 500, type: "beam", cost: 40 },
            { name: "SUPERNOVA CIBERN√âTICA", dmg: 1000, type: "sphere", cost: 100 }
        ],
        transList: [],
        costumes: []
    },
// ==========================================
    // FREEZA F1 DBS E TRAJES
    // ==========================================
    "FreezaF1DBS": {
        baseChar: "FreezaF1DBS",
        name: "FREEZA (DBS F1)",
        hp: 2500,
        maxHp: 2500,
        price: 3500,
        isCostume: true,
        isEvil: true,
        kiCost: 50,
        scale: 4.2,
        path: "Personagens/FreezaF1DBS.png",
        moves: [
            { name: "RAIO DA MORTE", dmg: 120, type: "beam", cost: 35 },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "TELECNESE", dmg: 250, type: "sphere", cost: 45 },
            { name: "SUPERNOVA", dmg: 700, type: "sphere", cost: 95 }
        ],
        transList: ["FreezaF2DBS"],
        costumes: []
    },

    "FreezaF2DBS": {
        baseChar: "FreezaF2DBS",
        name: "FREEZA (DBS F2)",
        isTransformation: true,
        hp: 3000,
        maxHp: 3000,
        price: 1500,
        isEvil: true,
        kiCost: 50,
        scale: 5.5,
        path: "Personagens/FreezaF2DBS.png",
        moves: [
            { name: "CHIFRADA BRUTAL", dmg: 140, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "DEATH STORM", dmg: 300, type: "sphere", cost: 40 },
            { name: "CRAZY FINGER BEAM", dmg: 750, type: "beam", cost: 90 }
        ],
        transList: ["FreezaF3DBS"],
        costumes: []
    },

    "FreezaF3DBS": {
        baseChar: "FreezaF3DBS",
        name: "FREEZA (DBS F3)",
        isTransformation: true,
        hp: 3000,
        maxHp: 3000,
        price: 2000,
        isEvil: true,
        kiCost: 60,
        scale: 5.0,
        path: "Personagens/FreezaF3DBS.png",
        moves: [
            { name: "ATAQUE SELVAGEM", dmg: 160, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "DEATH BEAM BARRAGE", dmg: 400, type: "beam", cost: 50 },
            { name: "CRAZY FINGER", dmg: 850, type: "beam", cost: 95 }
        ],
        transList: ["FreezaF4"],
        costumes: []
    },

    "FreezaF1DBS2": {
        baseChar: "FreezaF1DBS2",
        name: "FREEZA (DBS F1) T2",
        isCostume: true,
        hp: 2500,
        maxHp: 2500,
        price: 1500,
        isEvil: true,
        kiCost: 50,
        scale: 4.2,
        path: "Personagens/FreezaF1DBS2.png",
        moves: [
            { name: "RAIO DA MORTE", dmg: 120, type: "beam", cost: 35 },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "TELECNESE", dmg: 250, type: "sphere", cost: 45 },
            { name: "SUPERNOVA", dmg: 700, type: "sphere", cost: 95 }
        ],
        transList: ["FreezaF2DBS"],
        costumes: []
    },

    // ==========================================
    // FREEZA DBS (FORMA FINAL E DOURADA)
    // ==========================================
    "FreezaDBS": {
        baseChar: "FreezaDBS",
        name: "FREEZA (DBS)",
        hp: 3000,
        maxHp: 3000,
        price: 4500,
        isEvil: true,
        kiCost: 50,
        scale: 4.5,
        path: "Personagens/FreezaDBS.png",
        moves: [
            { name: "GOLPE IMPERIAL", dmg: 140, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "DEATH BEAM", dmg: 380, type: "beam", cost: 45 },
            { name: "DEATH BALL", dmg: 800, type: "sphere", cost: 90 }
        ],
        transList: ["FreezaDBSgolden"],
        costumes: []
    },

    "FreezaDBSgolden": {
        baseChar: "FreezaDBSgolden",
        name: "GOLDEN FREEZA",
        isTransformation: true,
        hp: 3000,
        maxHp: 3000,
        price: 3000,
        isEvil: true,
        kiCost: 80,
        scale: 4.5,
        path: "Personagens/FreezaDBSgolden.png",
        moves: [
            { name: "RUSH DOURADO", dmg: 180, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "EMPEROR'S DEATH BEAM", dmg: 500, type: "beam", cost: 50 },
            { name: "GOLDEN DEATH BALL", dmg: 1000, type: "sphere", cost: 100 }
        ],
        transList: ["FreezaDBSTrueGolden"],
        costumes: []
    },

    "FreezaDBSTrueGolden": {
        baseChar: "FreezaDBSTrueGolden",
        name: "TRUE GOLDEN FREEZA",
        isTransformation: true,
        hp: 3000,
        maxHp: 3000,
        price: 4000,
        isEvil: true,
        kiCost: 100,
        scale: 4.5,
        path: "Personagens/FreezaDBSTrueGolden.png",
        moves: [
            { name: "F√öRIA DO IMPERADOR", dmg: 220, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "TRUE DEATH BEAM", dmg: 600, type: "beam", cost: 50 },
            { name: "CAGE OF LIGHT", dmg: 1200, type: "sphere", cost: 100 }
        ],
        transList: [],
        costumes: []
    },
// ==========================================
    // ANDROIDES (UPDATE SAGA CELL)
    // ==========================================
    "Android16": {
        baseChar: "Android16",
        name: "Android 16",
        hp: 2500,
        maxHp: 2500,
        price: 2000,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/Android16.png",
        moves: [
            { name: "Rocket Punch", dmg: 120, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Hell's Flash", dmg: 180, type: "beam", cost: 50 },
            { name: "Hell's Impact", dmg: 250, type: "physical", cost: 100 }
        ],
        transList: [],
        costumes: []
    },
    "android17": {
        baseChar: "android17",
        name: "Android 17",
        isEvil: true,
        hp: 2200,
        maxHp: 2200,
        price: 1800,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/android17.png",
        moves: [
            { name: "Chute Acrob√°tico", dmg: 110, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Power Blitz", dmg: 170, type: "beam", cost: 50 },
            { name: "Super Electric Strike", dmg: 220, type: "physical", cost: 100 }
        ],
        transList: [],
        costumes: []
    },
    
    "android18": {
        baseChar: "android18",
        name: "Android 18",
        isEvil: true,
        hp: 2200,
        maxHp: 2200,
        price: 1800,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/android18.png",
        moves: [
            { name: "Chute Destruidor", dmg: 110, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "High-Pressure Wave", dmg: 160, type: "beam", cost: 50 },
            { name: "Kienzan", dmg: 240, type: "beam", cost: 100 }
        ],
        transList: [],
        costumes: ["android18T2", "android18T3"]
    },
    "android18T2": {
        baseChar: "android18T2",
        name: "Android 18",
        isCostume: true,
        isEvil: true,
        hp: 2200,
        maxHp: 2200,
        price: 1500,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/android18T2.png",
        moves: [
            { name: "Chute Destruidor", dmg: 110, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "High-Pressure Wave", dmg: 160, type: "beam", cost: 50 },
            { name: "Kienzan", dmg: 240, type: "beam", cost: 100 }
        ],
        transList: [],
        costumes: []
    },
    "android18T3": {
        baseChar: "android18T3",
        name: "Android 18",
        isCostume: true,
        isEvil: true,
        hp: 2200,
        maxHp: 2200,
        price: 1500,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/android18T3.png",
        moves: [
            { name: "Chute Destruidor", dmg: 110, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "High-Pressure Wave", dmg: 160, type: "beam", cost: 50 },
            { name: "Kienzan", dmg: 240, type: "beam", cost: 100 }
        ],
        transList: [],
        costumes: []
    },
    "Android19": {
        baseChar: "Android19",
        name: "Android 19",
        isEvil: true,
        hp: 1800,
        maxHp: 1800,
        price: 1200,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/Android19.png",
        moves: [
            { name: "Soco Pesado", dmg: 90, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Eye Laser", dmg: 130, type: "beam", cost: 50 },
            { name: "Energy Absorption", dmg: 200, type: "physical", cost: 100 }
        ],
        transList: [],
        costumes: []
    },
    "Android20DrGero": {
        baseChar: "Android20DrGero",
        name: "Dr. Gero (A20)",
        isEvil: true,
        hp: 1900,
        maxHp: 1900,
        price: 1400,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/Android20.png",
        moves: [
            { name: "Golpe Estrat√©gico", dmg: 95, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Photon Wave", dmg: 140, type: "beam", cost: 50 },
            { name: "Energy Drain", dmg: 210, type: "physical", cost: 100 }
        ],
        transList: [],
        costumes: []
    },
    // ==========================================
    // ANDROIDES / CELL
    // ==========================================
    "CellImperfect": {
        baseChar: "CellImperfect",
        name: "CELL (IMPERFEITO)",
        hp: 2200,
        maxHp: 2200,
        price: 2500,
        isEvil: true,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/CellImperfect.png",
        moves: [
            { name: "DRENAR ENERGIA", dmg: 110, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "KAMEHAMEHA", dmg: 300, type: "beam", cost: 40 },
            { name: "MAKANKOSAPPO", dmg: 650, type: "beam", cost: 85 }
        ],
        transList: ["CellSemiimperfeito", "CellPerfeito"],
        costumes: []
    },

    "CellSemiimperfeito": {
        baseChar: "CellSemiimperfeito",
        name: "CELL (SEMI-PERF.)",
        isTransformation: true,
        hp: 2800,
        maxHp: 2800,
        price: 1500,
        isEvil: true,
        kiCost: 50,
        scale: 5.0,
        path: "Personagens/CellSemiimperfeito.png",
        moves: [
            { name: "ESMAGAMENTO", dmg: 130, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "BIG BANG CRASH", dmg: 380, type: "sphere", cost: 45 },
            { name: "AUTODESTRUI√á√ÉO", dmg: 800, type: "sphere", cost: 95 }
        ],
        transList: ["CellPerfeito"],
        costumes: []
    },

    "CellPerfeito": {
        baseChar: "CellPerfeito",
        name: "CELL (PERFEITO)",
        isTransformation: true,
        hp: 3000,
        maxHp: 3000,
        price: 2500,
        isEvil: true,
        kiCost: 60,
        scale: 4.6,
        path: "Personagens/CellPerfeito.png",
        moves: [
            { name: "COMBO PERFEITO", dmg: 160, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "PERFECT BARRIER", dmg: 450, type: "sphere", cost: 50 },
            { name: "PERFECT KAMEHAMEHA", dmg: 900, type: "beam", cost: 100 }
        ],
        transList: ["CellSuperPerfeito"],
        costumes: []
    },

    "CellSuperPerfeito": {
        baseChar: "CellSuperPerfeito",
        name: "CELL (SUPER PERF.)",
        isTransformation: true,
        hp: 3000,
        maxHp: 3000,
        price: 3500,
        isEvil: true,
        kiCost: 80,
        scale: 4.6,
        path: "Personagens/CellSuperPerfeito.png",
        moves: [
            { name: "PODER M√ÅXIMO", dmg: 180, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "SOLAR KAMEHAMEHA", dmg: 500, type: "beam", cost: 50 },
            { name: "FIM DO MUNDO", dmg: 1000, type: "sphere", cost: 100 }
        ],
        transList: ["GoldenCell"],
        costumes: []
    },

    "CellJr": {
        baseChar: "CellJr",
        name: "Cell Jr.",
        isEvil: true,
        hp: 1700,
        maxHp: 1700,
        price: 1500,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/CellJr.png",
        moves: [
            { name: "Ataque R√°pido", dmg: 110, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Kamehameha", dmg: 160, type: "beam", cost: 50 },
            { name: "Makankosappo", dmg: 200, type: "beam", cost: 100 }
        ],
        transList: [],
        costumes: []
    },
    "CellMax": {
        baseChar: "CellMax",
        name: "Cell Max",
        isEvil: true,
        hp: 6000,
        maxHp: 6000,
        price: 6000,
        kiCost: 50,
        scale: 3.5,
        previewScale: 2.8,
        shopScale: 0.5,
        path: "Personagens/CellMax.png",
        moves: [
            { name: "Pis√£o Esmagador", dmg: 200, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Explosive Scream", dmg: 300, type: "beam", cost: 50 },
            { name: "Disaster Ray", dmg: 450, type: "beam", cost: 100 }
        ],
        transList: [],
        costumes: []
    },

    "GoldenCell": {
        baseChar: "GoldenCell",
        name: "GOLDEN CELL",
        isTransformation: true,
        hp: 3000,
        maxHp: 3000,
        price: 5000,
        isEvil: true,
        kiCost: 100,
        scale: 4.8,
        path: "Personagens/GoldenCell.png",
        moves: [
            { name: "COMBO FRENETICO", dmg: 240, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "RAIO DA MORTE PERFEITO", dmg: 650, type: "beam", cost: 50 },
            { name: "GENKIDAMA", dmg: 1200, type: "sphere", cost: 100 }
        ],
        transList: [],
        costumes: []
    },

// ---- MAJIN BUU ----
 "MajinBuu": {
        baseChar: "MajinBuu",
        name: "MAJIN BUU",
        hp: 3000,
        maxHp: 3000,
        price: 3000,
        isEvil: true,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/MajinBuu.png",
        moves: [
            { name: "GOLPE EL√ÅSTICO", dmg: 120, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "RAIO DE CHOCOLATE", dmg: 350, type: "beam", cost: 40 },
            { name: "EXPLOS√ÉO DE F√öRIA", dmg: 700, type: "sphere", cost: 90 }
        ],
        transList: [],
        costumes: []
    },

    "EvilBuu": {
        baseChar: "EvilBuu",
        name: "EVIL BUU",
        hp: 3000,
        maxHp: 3000,
        price: 3200,
        isEvil: true,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/EvilBuu.png",
        moves: [
            { name: "COMBO CRUEL", dmg: 140, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "FLAME SHOWER", dmg: 380, type: "beam", cost: 45 },
            { name: "GUILTY FLASH", dmg: 750, type: "sphere", cost: 90 }
        ],
        absorbList: [{ target: "MajinBuu", result: "SuperBuu" }],
        transList: [],
        costumes: []
    },

    "SuperBuu": {
        baseChar: "SuperBuu",
        name: "SUPER BUU",
        hp: 3000,
        maxHp: 3000,
        price: 4000,
        isEvil: true,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/SuperBuu.png",
        moves: [
            { name: "CHICOTE MAJIN", dmg: 160, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "ILL FLASH", dmg: 400, type: "beam", cost: 45 },
            { name: "REVENGE DEATH BOMBER", dmg: 850, type: "sphere", cost: 95 }
        ],
        transList: ["KidBuu"],
        costumes: ["SuperBuu2"],
        absorbList: [
            { target: "SuperBuuGohan", result: "SuperBuuGohan" },
            { target: "SuperBuuGotenks", result: "SuperBuuGotenks" },
            { target: "SuperBuuPiccolo", result: "SuperBuuPiccolo" },
            { target: "HiperBuu", result: "HiperBuu" }
        ]
    },

    "SuperBuu2": {
        baseChar: "SuperBuu2",
        name: "SUPER BUU (TRAJE)",
        isCostume: true,
        hp: 3000,
        maxHp: 3000,
        price: 1500,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/SuperBuu2.png",
        moves: [
            { name: "CHICOTE MAJIN", dmg: 160, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "ILL FLASH", dmg: 400, type: "beam", cost: 45 },
            { name: "REVENGE DEATH BOMBER", dmg: 850, type: "sphere", cost: 95 }
        ],
        transList: ["KidBuu"],
        costumes: ["SuperBuu2"],
        absorbList: [
            { target: "SuperBuuGohan", result: "SuperBuuGohan" },
            { target: "SuperBuuGotenks", result: "SuperBuuGotenks" },
            { target: "SuperBuuPiccolo", result: "SuperBuuPiccolo" },
            { target: "HiperBuu", result: "HiperBuu" }
        ]
    },

    "HiperBuu": {
        baseChar: "HiperBuu",
        name: "HIPER BUU",
        isTransformation: true,
        hp: 3000,
        maxHp: 3000,
        price: 4500,
        kiCost: 60,
        scale: 4.8,
        path: "Personagens/HiperBuu.png",
        moves: [
            { name: "GOLPE HIPER", dmg: 180, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "SUPER KAMEHAMEHA", dmg: 450, type: "beam", cost: 50 },
            { name: "DIMENSION BREAKER", dmg: 900, type: "sphere", cost: 100 }
        ],
        transList: [],
        costumes: []
    },

    "KidBuu": {
        baseChar: "KidBuu",
        name: "KID BUU",
        isTransformation: true,
        hp: 3000,
        maxHp: 3000,
        price: 5000,
        kiCost: 80,
        scale: 4.2,
        path: "Personagens/KidBuu.png",
        moves: [
            { name: "ATAQUE SELVAGEM", dmg: 200, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "PEARL FLASH", dmg: 500, type: "beam", cost: 50 },
            { name: "PLANET BURST", dmg: 1000, type: "sphere", cost: 100 }
        ],
        transList: [],
        costumes: []
    },

    "SuperBuuGohan": {
        baseChar: "SuperBuuGohan",
        name: "BUU (GOHAN ABS.)",
        isTransformation: true,
        hp: 3000,
        maxHp: 3000,
        price: 6000,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/SuperBuuGohan.png",
        moves: [
            { name: "GOLPE M√çSTICO", dmg: 200, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "SUPER KAMEHAMEHA", dmg: 550, type: "beam", cost: 50 },
            { name: "SUPER GHOST KAMIKAZE", dmg: 1000, type: "sphere", cost: 100 }
        ],
        transList: [],
        costumes: [],
        absorbList: []
    },

"SuperBuuGotenks": {
    baseChar: "SuperBuuGotenks",
    name: "BUU (GOTENKS ABS.)",
    isTransformation: true,
    hp: 3000,
    maxHp: 3000,
    price: 6000,
    kiCost: 0,
    scale: 4.8,
    path: "Personagens/SuperBuuGotenks.png",
    moves: [
        { name: "ATAQUE GAL√ÅCTICO", dmg: 180, type: "physical" },
        { name: "CARREGAR KI", dmg: 0, type: "charge" },
        { name: "DIE DIE MISSILE", dmg: 500, type: "sphere", cost: 50 },
        { name: "DONUT VOLLEY", dmg: 950, type: "beam", cost: 100 }
    ],
        transList: [],
        costumes: [],
        absorbList: [{ target: "SuperBuuGohan", result: "SuperBuuGohan" },
        ]
},

"SuperBuuPiccolo": {
    baseChar: "SuperBuuPiccolo",
    name: "BUU (PICCOLO ABS.)",
    isTransformation: true,
    price: 6000,
    hp: 3000,
    maxHp: 3000,
    kiCost: 0,
    scale: 4.8,
    path: "Personagens/SuperBuuPiccolo.png",
    moves: [
        { name: "ESTRATEGISTA MAJIN", dmg: 150, type: "physical" },
        { name: "CARREGAR KI", dmg: 0, type: "charge" },
        { name: "MAKANKOSAPPO", dmg: 450, type: "beam", cost: 45 },
        { name: "HELLZONE GRENADE", dmg: 800, type: "sphere", cost: 95 }
   ],
        transList: [],
        costumes: [],
        absorbList: [{ target: "SuperBuuGotenks", result: "SuperBuuGotenks" },
        ]
},

    // ==========================================
    // BROLY Z
    // ==========================================
    "BrolyZ": {
        baseChar: "BrolyZ",
        name: "BROLY (Z)",
        hp: 2000,
        maxHp: 2000,
        price: 3500,
        isEvil: true,
        kiCost: 50,
        scale: 5.0,
        path: "Personagens/BrolyZ.png",
        moves: [
            { name: "SOCO BRUTAL", dmg: 120, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "ERASER CANNON", dmg: 300, type: "sphere", cost: 45 },
            { name: "OMEGA BLASTER", dmg: 750, type: "sphere", cost: 90 }
        ],
        transList: ["BrolyZSSJ","BrolyZLSSJ"],
        costumes: ["BrolyZ2"]
    },

    "BrolyZSSJ": {
        baseChar: "BrolyZSSJ",
        name: "BROLY (Z) SSJ",
        isTransformation: true,
        hp: 2800,
        maxHp: 2800,
        price: 4000,
        kiCost: 50,
        scale: 5.2,
        path: "Personagens/BrolyZSSJ.png",
        moves: [
            { name: "INVESTIDA FURIOSA", dmg: 150, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "ERASER CANNON", dmg: 350, type: "sphere", cost: 45 },
            { name: "OMEGA BLASTER", dmg: 800, type: "sphere", cost: 90 }
        ],
        transList: ["BrolyZLSSJ"],
        costumes: []
    },

    "BrolyZLSSJ": {
        baseChar: "BrolyZLSSJ",
        name: "BROLY LSSJ",
        isTransformation: true,
        hp: 3000,
        maxHp: 3000,
        price: 6000,
        kiCost: 80,
        scale: 5.5,
        path: "Personagens/BrolyZLSSJ.png",
        moves: [
            { name: "ESMAGAMENTO", dmg: 200, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "ERASER BLOW", dmg: 450, type: "beam", cost: 50 },
            { name: "GIGANTIC METEOR", dmg: 1000, type: "sphere", cost: 100 }
        ],
        transList: [],
        costumes: []
    },
    "BrolyZ2": {
        baseChar: "BrolyZ2",
        name: "BROLY (Z)(T2)",
        hp: 2000,
        maxHp: 2000,
        isCostume: true,
        price: 3500,
        isEvil: true,
        kiCost: 50,
        scale: 5.0,
        path: "Personagens/BrolyZ2.png",
        moves: [
            { name: "SOCO BRUTAL", dmg: 120, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "ERASER CANNON", dmg: 300, type: "sphere", cost: 45 },
            { name: "OMEGA BLASTER", dmg: 750, type: "sphere", cost: 90 }
        ],
        transList: ["BrolyZ2SSJ","BrolyZ2LSSJ"],
        costumes: []
    },

    "BrolyZ2SSJ": {
        baseChar: "BrolyZ2SSJ",
        name: "BROLY (Z) SSJ",
        isTransformation: true,
        hp: 2800,
        maxHp: 2800,
        price: 4000,
        kiCost: 50,
        scale: 5.2,
        path: "Personagens/BrolyZ2SSJ.png",
        moves: [
            { name: "INVESTIDA FURIOSA", dmg: 150, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "ERASER CANNON", dmg: 350, type: "sphere", cost: 45 },
            { name: "OMEGA BLASTER", dmg: 800, type: "sphere", cost: 90 }
        ],
        transList: ["BrolyZ2LSSJ"],
        costumes: []
    },

    "BrolyZ2LSSJ": {
        baseChar: "BrolyZ2LSSJ",
        name: "BROLY LSSJ",
        isTransformation: true,
        hp: 3000,
        maxHp: 3000,
        price: 6000,
        kiCost: 80,
        scale: 5.5,
        path: "Personagens/BrolyZ2LSSJ.png",
        moves: [
            { name: "ESMAGAMENTO", dmg: 200, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "ERASER BLOW", dmg: 450, type: "beam", cost: 50 },
            { name: "GIGANTIC METEOR", dmg: 1000, type: "sphere", cost: 100 }
        ],
        transList: [],
        costumes: []
    },
    // ==========================================
    // BROLY Fusion
    // ==========================================
    "Brooly": {
        baseChar: "Brooly",
        isTransformation: true,
        name: "BROOLY",
        hidden: true,
        hp: 2000,
        maxHp: 2000,
        price: 3500,
        isEvil: true,
        kiCost: 50,
        scale: 5.0,
        path: "Personagens/Brooly.png",
        moves: [
            { name: "SOCO BRUTAL", dmg: 240, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Gigantic Roar", dmg: 600, type: "beam", cost: 45 },
            { name: "OMEGA BLASTER", dmg: 140, type: "sphere", cost: 90 }
        ],
        transList: [],
        costumes: []
    },


    // ==========================================
    // BROLY DBS E SUAS FORMAS
    // ==========================================
    "BrolyDBS": {
        baseChar: "BrolyDBS",
        name: "Broly (Base)",
        isCostume: false,
        isTransformation: false,
        hp: 1500,
        maxHp: 1500,
        price: 6000,
        kiCost: 50,
        scale: 5.0, // Broly √© maior
        path: "Personagens/BrolyDBS.png",
        moves: [
            { name: "Soco Selvagem", dmg: 40, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Eraser Cannon", dmg: 120, type: "beam", cost: 50 },
            { name: "Agarr√£o Bruto", dmg: 180, type: "physical", cost: 100 }
        ],
        transList: ["BrolyDBSIkary","BrolyDBSSSJ","BrolyDBSSSJFULLPOWER"],
        costumes: ["BrolyDBS(T2)", "BrolyDBS(T3)"]
    },
"BrolyDBSIkary": {
        name: "Broly (Ikari / F√∫ria)",
        isCostume: false,
        isTransformation: true,
        baseChar: "BrolyDBS",
        hp: 2200,
        maxHp: 2200,
        price: 4000,
        kiCost: 50,
        scale: 5.1,
        path: "Personagens/BrolyDBSIkary.png",
        moves: [
            { name: "Pis√£o Oozaru", dmg: 60, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Sopro Gigante", dmg: 160, type: "beam", cost: 50 },
            { name: "Gigantic Meteor", dmg: 240, type: "physical", cost: 100 }
        ],
        transList: ["BrolyDBSSSJ"],
        costumes: []
    },
    "BrolyDBSSSJ": {
        name: "Broly Super Saiyajin",
        isCostume: false,
        isTransformation: true,
        baseChar: "BrolyDBS",
        hp: 3000,
        maxHp: 3000,
        price: 7000,
        kiCost: 50,
        scale: 5.2,
        path: "Personagens/BrolyDBSSSJ.png",
        moves: [
            { name: "Carga Incontrol√°vel", dmg: 80, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Blaster Meteor", dmg: 220, type: "beam", cost: 50 },
            { name: "Omega Blaster", dmg: 320, type: "physical", cost: 100 }
        ],
        transList: ["BrolyDBSSSJFULLPOWER"],
        costumes: []
    },
    "BrolyDBSSSJFULLPOWER": {
        name: "Broly SSJ Full Power",
        isCostume: false,
        isTransformation: true,
        baseChar: "BrolyDBS",
        hp: 3000,
        maxHp: 3000,
        price: 15000,
        kiCost: 50,
        scale: 5.5,
        path: "Personagens/BrolyDBSSSJFULLPOWER.png",
        moves: [
            { name: "Massacre Lend√°rio", dmg: 120, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Gigantic Roar", dmg: 350, type: "beam", cost: 50 },
            { name: "Gigantic Catastrophe", dmg: 600, type: "physical", cost: 100 }
        ],
        transList: [],
        costumes: []
    },
    "BrolyDBS(T2)": {
        name: "Broly (Sem Armadura)",
        isCostume: true,
        isTransformation: false,
        baseChar: "BrolyDBS",
        hp: 1500,
        maxHp: 1500,
        price: 2000,
        kiCost: 50,
        scale: 5.0,
        path: "Personagens/BrolyDBS(T2).png",
        moves: [
            { name: "Porrada Destrutiva", dmg: 45, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Eraser Cannon", dmg: 120, type: "beam", cost: 50 },
            { name: "F√∫ria Crescente", dmg: 180, type: "physical", cost: 100 }
        ],
        transList: ["BrolyDBSSSJFULLPOWER"],
        costumes: []
    },
    "BrolyDBS(T3)": {
        name: "Broly (Pele Animal)",
        isCostume: true,
        isTransformation: false,
        baseChar: "BrolyDBS",
        hp: 1500,
        maxHp: 1500,
        price: 1500,
        kiCost: 50,
        scale: 5.0,
        path: "Personagens/BrolyDBS(T3).png",
        moves: [
            { name: "Soco Bestial", dmg: 45, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Rajada Verde", dmg: 120, type: "beam", cost: 50 },
            { name: "Atropelamento", dmg: 180, type: "physical", cost: 100 }
        ],
        transList: ["BrolyDBS(T3)SSJFullPower"],
        costumes: []
    },
    
    "BrolyDBS(T3)SSJFullPower": {
        name: "Broly SSJ FP (Pele Animal)",
        isCostume: false,
        isTransformation: true,
        baseChar: "BrolyDBS",
        hp: 3000,
        maxHp: 3000,
        price: 2000,
        kiCost: 50,
        scale: 5.5,
        path: "Personagens/BrolyDBS(T3)SSJFullPower.png",
        moves: [
            { name: "Grito Selvagem", dmg: 120, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Gigantic Roar", dmg: 350, type: "beam", cost: 50 },
            { name: "Destrui√ß√£o Absoluta", dmg: 600, type: "physical", cost: 100 }
        ],
        transList: [],
        costumes: []
    },


    // ==========================================
    // FUS√ïES E OUTROS
    // ==========================================
    "Gogeta": {
        baseChar: "Gogeta",
        name: "GOGETAZ",
        isTransformation: false,
        hp: 3000,
        maxHp: 3000,
        price: 5000,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/Gogeta.png",
        moves: [
            { name: "STARDUST BREAKER", dmg: 200, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "BIG BANG KAME", dmg: 500, type: "beam", cost: 50 },
            { name: "SOUL PUNISHER", dmg: 1000, type: "sphere", cost: 100 }
        ],
        transList: [],
        costumes: []
    },

    "Vegetto": {
        baseChar: "Vegetto",
        name: "VEGETTO",
        isTransformation: false,
        hp: 3000,
        maxHp: 3000,
        price: 5000,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/Vegetto.png",
        moves: [
            { name: "COMBO FINAL", dmg: 210, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "FINAL KAME", dmg: 520, type: "beam", cost: 50 },
            { name: "SPIRIT SWORD", dmg: 950, type: "physical", cost: 100 }
        ],
        transList: ["VegettoSS"],
        costumes: []
    },
    "VegettoSS":{ 
        baseChar: "VegettoSS",
        name: "SUPERVEGETTO",
        isTransformation: true,
        hp: 3000,
        maxHp: 3000,
        price: 5500,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/VegettoSSJ.png",
        moves: [
            { name: "COMBO FINAL", dmg: 320, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "FINAL KAME", dmg: 780, type: "beam", cost: 50 },
            { name: "SPIRIT SWORD", dmg: 100, type: "physical", cost: 100 }
        ],
        transList: [],
        costumes: []
    },
    // ==========================================
    // VEGETTO (ITEM POTARA)
    // ==========================================
    "VegettoDBS": {
        baseChar: "VegettoDBS",
        name: "VegettoDBS",
        isCostume: false,
        isTransformation: false,
        hp: 2500,
        maxHp: 2500,
        price: 15000, // Pre√ßo alto por ser fus√£o
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/VegettoDBS.png",
        moves: [
            { name: "Chute Perfeito", dmg: 60, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Big Bang Attack", dmg: 180, type: "beam", cost: 50 },
            { name: "Espada Espiritual", dmg: 550, type: "physical", cost: 100 }
        ],
        transList: ["VegettoDBSBlue"],
        costumes: []
    },
    "VegettoDBSBlue": {
        name: "Vegetto Super Saiyajin Blue",
        isCostume: false,
        isTransformation: true,
        baseChar: "VegettoDBS",
        hp: 3000,
        maxHp: 3000,
        price: 10000,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/VegettoDBSBlue.png",
        moves: [
            { name: "Combo Divino", dmg: 210, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Final Kamehameha", dmg: 950, type: "beam", cost: 50 },
            { name: "Omega Finishing Blow", dmg: 2050, type: "physical", cost: 100 }
        ],
        transList: [],
        costumes: []
    },

    "Black": {
        baseChar: "Black",
        name: "GOKU BLACK",
        hp: 2800,
        maxHp: 2800,
        price: 4500,
        isEvil: true,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/Black.png",
        moves: [
            { name: "GOLPE SOMBRIO", dmg: 140, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "BLACK KAMEHAMEHA", dmg: 380, type: "beam", cost: 45 },
            { name: "L√ÇMINA DIVINA", dmg: 800, type: "physical", cost: 90 }
        ],
        transList: ["BlackSSJ","BlackRos√©"],
        costumes: []
    },
     "BlackSSJ": {
        baseChar: "BlackSSJ",
        name: "GOKU BLACKSSJ",
        isTransformation: true,
        hp: 3000,
        maxHp: 3000,
        price: 4500,
        isEvil: true,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/BlackSSJ.png",
        moves: [
            { name: "GOLPE SOMBRIO", dmg: 180, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "BLACK KAMEHAMEHA", dmg:480, type: "beam", cost: 45 },
            { name: "CHICOTE DIVINO", dmg: 850, type: "physical", cost: 90 }
        ],
        transList: ["BlackRos√©"],
        costumes: []
    },

    "BlackRos√©": {
        baseChar: "BlackRos√©",
        name: "GOKU BLACK ROS√â",
        isTransformation: true,
        hp: 3000,
        maxHp: 3000,
        price: 6000,
        kiCost: 80,
        scale: 4.8,
        path: "Personagens/BlackRos√©.png",
        moves: [
            { name: "FOICE DA DOR", dmg: 200, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "SUPER BLACK KAME", dmg: 500, type: "beam", cost: 50 },
            { name: "DAN√áA DAS SOMBRAS", dmg: 1000, type: "sphere", cost: 100 }
        ],
        transList: [],
        costumes: []
    },
    // ==========================================
    // BABY (GT) E SUAS FORMAS E ABSOR√á√ïES
    // ==========================================
    "Baby": {
        baseChar: "Baby",
        name: "Baby",
        isCostume: false,
        isTransformation: false,
        hp: 1000,
        maxHp: 1000,
        price: 4500,
        kiCost: 50,
        scale: 4.6,
        path: "Personagens/Baby.png",
        moves: [
            { name: "Ataque Parasita", dmg: 25, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Revenge Blast", dmg: 90, type: "beam", cost: 50 },
            { name: "Infec√ß√£o", dmg: 140, type: "physical", cost: 100 }
        ],
        transList: ["BabyVegeta","BabySuperVegeta","BabySuperVegeta2","BabyOozaru"],
        costumes: ["BabyAdulto"],
        absorbList: [
            { target: "CellPerfeito", result: "BabyCell" },
            { target: "FreezaF1", result: "BabyFreeza" },
            { target: "GokuGt", result: "BabyGoku" },
        ],
    },
    "BabyAdulto": {
        name: "Baby (Adulto)",
        isCostume: true,
        isTransformation: false,
        baseChar: "Baby",
        hp: 1100,
        maxHp: 1100,
        price: 2000,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/BabyAdulto.png",
        moves: [
            { name: "Golpe Mutante", dmg: 35, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Revenge Blast", dmg: 100, type: "beam", cost: 50 },
            { name: "Investida Parasita", dmg: 150, type: "physical", cost: 100 }
        ],
        transList: [],
        costumes: []
    },
    "BabyVegeta": {
        name: "Baby Vegeta",
        isCostume: false,
        isTransformation: true,
        baseChar: "Baby",
        hp: 1500,
        maxHp: 1500,
        price: 3500,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/BabyVegeta.png",
        moves: [
            { name: "Combo Corrompido", dmg: 45, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Final Flash Tuffle", dmg: 140, type: "beam", cost: 50 },
            { name: "Big Bang Attack", dmg: 200, type: "physical", cost: 100 }
        ],
        transList: ["BabySuperVegeta"],
        costumes: []
    },
    "BabySuperVegeta": {
        name: "Super Baby 1",
        isCostume: false,
        isTransformation: true,
        baseChar: "Baby",
        hp: 2100,
        maxHp: 2100,
        price: 5000,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/BabySuperVegeta.png",
        moves: [
            { name: "Golpe de Vingan√ßa", dmg: 60, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Revenge Death Ball (Mini)", dmg: 180, type: "beam", cost: 50 },
            { name: "Carnificina Saiyajin", dmg: 250, type: "physical", cost: 100 }
        ],
        transList: ["BabySuperVegeta2"],
        costumes: []
    },
    "BabySuperVegeta2": {
        name: "Super Baby 2",
        isCostume: false,
        isTransformation: true,
        baseChar: "Baby",
        hp: 2800,
        maxHp: 2800,
        price: 8000,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/BabySuperVegeta2.png",
        moves: [
            { name: "Assalto Tsufurujin", dmg: 75, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Revenge Death Ball", dmg: 240, type: "beam", cost: 50 },
            { name: "Final Revenge Flash", dmg: 350, type: "physical", cost: 100 }
        ],
        transList: ["BabyOozaru"],
        costumes: []
    },
    "BabyOozaru": {
        name: "Baby Oozaru Dourado",
        isCostume: false,
        isTransformation: true,
        baseChar: "Baby",
        hp: 3000,
        maxHp: 3000,
        price: 15000,
        kiCost: 50,
        scale: 3.3, // Gigante
        previewScale: 2.5,
        shopScale: 1.3,
        path: "Personagens/BabyOozaru.png",
        moves: [
            { name: "Esmagamento Maci√ßo", dmg: 100, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Super Galick Gun", dmg: 300, type: "beam", cost: 50 },
            { name: "Onda Explosiva", dmg: 500, type: "physical", cost: 100 }
        ],
        transList: [],
        costumes: []
    },
    "BabyCell": {
        name: "Baby Cell (Absor√ß√£o)",
        isCostume: false, // Tratei as absor√ß√µes como costumes (variantes de base) para caber no fluxo do Baby base
        isTransformation: true,
        baseChar: "Baby",
        hp: 1300,
        maxHp: 1300,
        price: 3000,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/BabyCell.png",
        moves: [
            { name: "Soco Perfeito", dmg: 40, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Kamehameha Sombrio", dmg: 130, type: "beam", cost: 50 },
            { name: "Agulha de Drenagem", dmg: 180, type: "physical", cost: 100 }
        ],
        transList: [],
        costumes: []
    },
    "BabyFreeza": {
        name: "Baby Freeza (Absor√ß√£o)",
        isCostume: false,
        isTransformation: true,
        baseChar: "Baby",
        hp: 1300,
        maxHp: 1300,
        price: 3000,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/BabyFreeza.png",
        moves: [
            { name: "Chicote Cauda", dmg: 40, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Death Beam Corrompido", dmg: 130, type: "beam", cost: 50 },
            { name: "Death Ball Vingativa", dmg: 180, type: "physical", cost: 100 }
        ],
        transList: [],
        costumes: []
    },
    "BabyGoku": {
        name: "Baby Goku (Absor√ß√£o)",
        isCostume: false,
        isTransformation: true,
        baseChar: "Baby",
        hp: 1400,
        maxHp: 1400,
        price: 3500,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/BabyGoku.png",
        moves: [
            { name: "Combo do Macaco", dmg: 45, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Revenge Kamehameha", dmg: 140, type: "beam", cost: 50 },
            { name: "Punho do Drag√£o Sombrio", dmg: 190, type: "physical", cost: 100 }
        ],
        transList: [],
        costumes: []
    },
    // ==========================================
    // BILLS (DEUS DA DESTRUI√á√ÉO)
    // ==========================================
    "Bills": {
        baseChar: "Bills",
        name: "BILLS",
        hp: 3000,
        maxHp: 3000,
        price: 10000,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/Bills.png",
        moves: [
            { name: "COMBATE DIVINO", dmg: 200, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "DEDO DA DESTRUI√á√ÉO", dmg: 550, type: "beam", cost: 50 },
            { name: "ESFERA DA DESTRUI√á√ÉO", dmg: 1100, type: "sphere", cost: 100 }
        ],
        transList: ["BillsFullPower"],
        costumes: ["Bills2"]
    },

    "Bills2": {
        baseChar: "Bills2",
        name: "BILLS (TRAJE 2)",
        isCostume: true,
        hp: 3000,
        maxHp: 3000,
        price: 2000,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/Bills2.png",
        moves: [
            { name: "COMBATE DIVINO", dmg: 200, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "DEDO DA DESTRUI√á√ÉO", dmg: 550, type: "beam", cost: 50 },
            { name: "ESFERA DA DESTRUI√á√ÉO", dmg: 1100, type: "sphere", cost: 100 }
        ],
        transList: ["BillsFullPower"],
        costumes: []
    },

    "BillsFullPower": {
        baseChar: "BillsFullPower",
        name: "BILLS (PODER TOTAL)",
        isTransformation: true,
        hp: 3000,
        maxHp: 3000,
        price: 5000,
        kiCost: 80,
        scale: 4.8,
        path: "Personagens/BillsFullPower.png",
        moves: [
            { name: "HAKAI DIVINO", dmg: 250, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "IRA DO DEUS DA DESTRUI√á√ÉO", dmg: 650, type: "beam", cost: 50 },
            { name: "HAKAI", dmg: 2800, type: "sphere", cost: 100 }
        ],
        transList: [],
        costumes: []
    },

    
    

    "FreellDance": {
        baseChar: "FreellDance",
        name: "Freell (Dance)",
        hidden: true,
        isEvil: true,
        hp: 4000,
        maxHp: 4000,
        price: 4500,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/FreellDance.png",
        moves: [
            { name: "Golpe H√≠brido", dmg: 150, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Death Beam", dmg: 220, type: "beam", cost: 50 },
            { name: "Perfect Death Ball", dmg: 350, type: "beam", cost: 100 }
        ],
        transList: [],
        costumes: []
    },
    "FreellPotara": {
        baseChar: "FreellPotara",
        hidden: true,
        name: "Freell (Potara)",
        isEvil: true,
        hp: 4500,
        maxHp: 4500,
        price: 5000,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/FreellPotara.png",
        moves: [
            { name: "Golpe Perfeito", dmg: 160, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Death Saucer", dmg: 240, type: "beam", cost: 50 },
            { name: "Super Perfect Kamehameha", dmg: 380, type: "beam", cost: 100 }
        ],
        transList: [],
        costumes: []
    },
    
    
    "MajinDuu": {
        baseChar: "MajinDuu",
        name: "Majin Duu",
        isEvil: true,
        hp: 3500,
        maxHp: 3500,
        price: 3000,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/MajinDuu.png",
        moves: [
            { name: "Golpe Majin", dmg: 130, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Innocence Cannon", dmg: 190, type: "beam", cost: 50 },
            { name: "Chocolate Beam", dmg: 250, type: "beam", cost: 100 }
        ],
        transList: ["MajinDuuFullPower"],
        costumes: []
    },
    "MajinDuuFullPower": {
        baseChar: "MajinDuuFullPower",
        name: "Majin Duu Full Power",
        isTransformation: true,
        isEvil: true,
        hp: 4500,
        maxHp: 4500,
        price: 4000,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/MajinDuuFullPower.png",
        moves: [
            { name: "Destrui√ß√£o Majin", dmg: 160, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Angry Explosion", dmg: 240, type: "beam", cost: 50 },
            { name: "Planet Burst", dmg: 350, type: "beam", cost: 100 }
        ],
        transList: [],
        costumes: []
    },
    "MajinKuu": {
        baseChar: "MajinKuu",
        name: "Majin Kuu",
        isEvil: true,
        hp: 4800,
        maxHp: 4800,
        price: 4500,
        kiCost: 50,
        scale: 4.8,
        path: "Personagens/MajinKuu.png",
        moves: [
            { name: "Ataque Ca√≥tico", dmg: 170, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "Majin Kamehameha", dmg: 250, type: "beam", cost: 50 },
            { name: "Super Planet Burst", dmg: 380, type: "beam", cost: 100 }
        ],
        transList: [],
        costumes: []
    }

    

};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ñ∂  ITENS Z  ‚Äî edite para adicionar novos itens √† loja.
//    Para adicionar um item novo:
//    1. Adicione aqui: "chave": { name, price, path, desc }
//    2. Adicione o case em useItem() mais abaixo com o efeito
//    path pode ser URL online ou caminho local (C:\...)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const itemsDB = {
    "blutzray":   { name:"BLUTZ RAY",          price:3000,  path:"itens/blutzray.png",   desc:"For√ßa transforma√ß√£o Oozaru p/ personagens c/ cauda."      },
    "fullpower":  { name:"FULL POWER CORE",     price:1000,  path:"itens/fullpower.png",  desc:"Poder +25% na batalha."                                   },
    "kaioken":    { name:"KAIOKEN",             price:2000,  path:"itens/kaioken.png",    desc:"Aumenta poder em 20% temporariamente."                    },
    "space":      { name:"SPACE CHIP",          price:8000,  path:"itens/space.png",      desc:"Sincronia Mecha exclusiva p/ Freeza F4."                  },
    "godki":      { name:"KI DIVINO",           price:15000, path:"itens/godki.png",      desc:"Transforma√ß√£o Deus exclusiva p/ Goku/Vegeta."             },
    "golden_evo": { name:"EVOLU√á√ÉO DOURADA",    price:50000, path:"itens/golden_evo.png", desc:"Exclusivo: Eleva o Cell Perfeito."                        },
    "senzubeam":  { name:"SENZU BEAM",          price:1000,  path:"itens/senzubeam.png",  desc:"Recupera instantaneamente 50% do seu HP total."           },
    "marcamajin": { name:"MARCA MAJIN",         price:10000, path:"itens/marcamajin.png", desc:"Exclusivo p/ vil√µes: +30% Poder. Transforma VegetaZ3."    },
    "dance":      { name:"T√âCNICA DE DAN√áA",    price:20000, path:"itens/dance.png",      desc:"Permite fus√£o por dan√ßa entre personagens compat√≠veis."   },
    "potara":     { name:"BRINCOS POTARA",      price:25000, path:"itens/potara.png",     desc:"Permite fus√£o potara entre personagens compat√≠veis."      },
    "dragonballs": { name:"DRAGON BALLS", price:0, path:"itens/dragonballs.png", desc:"As 7 Esferas do Drag√£o. Apenas do modo hist√≥ria.", storyOnly:true, maxStack:7 },
    // ‚îÄ‚îÄ ADICIONE NOVOS ITENS ABAIXO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // "meu_item": { name:"NOME", price:5000, path:"itens/meu_item.png", desc:"Descri√ß√£o." },
};
// Autogerar costumesDB a partir do charactersDB para garantir que TODOS os trajes est√£o na loja
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ñ∂  TRAJES ‚Äî s√£o gerados automaticamente a partir do charactersDB.
//    Para adicionar um traje novo, v√° ao charactersDB e adicione um
//    personagem com: isCostume:true, baseChar:"ChaveDaBase", price:XXXX
//    Exemplo m√≠nimo:
//    "GokuZ_Traje2": { name:"GOKU Z (TRAJE 2)", isCostume:true,
//      baseChar:"GokuZ", price:3000, path:"sprites/goku_z2.png", ... }
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const costumesDB = {};
Object.keys(charactersDB).forEach(k => {
    if(charactersDB[k].isCostume) {
        costumesDB[k] = { 
            name: charactersDB[k].name, 
            price: charactersDB[k].price || 2000,
            baseChar: charactersDB[k].baseChar, 
            path: charactersDB[k].path 
        };
    }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ñ∂  MISS√ïES DO MODO HIST√ìRIA  ‚Äî edite aqui para adicionar/remover
//    campos: enemy (chave do DB), title (opcional), zeniReward,
//    expReward, stage (√≠ndice do cen√°rio, opcional)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const STORY_SEQUENCE = [
    // ‚îÄ‚îÄ SAGA ORIGEM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    { enemy:"BulmaC",           title:"SAGA ORIGEM",  zeniReward:300,  expReward:20, stage:0 },
    { enemy:"OolongTransformed",                       zeniReward:350,  expReward:25, stage:0 },
    { enemy:"YamchaClassic",                           zeniReward:400,  expReward:30, stage:0 },
    { enemy:"MestreKame",                              zeniReward:500,  expReward:40, stage:0 },
    { enemy:"KuririnC",                                zeniReward:500,  expReward:40, stage:0 },
    { enemy:"Chaos",                                   zeniReward:600,  expReward:50, stage:2 },
    { enemy:"TienClassic",                             zeniReward:600,  expReward:50, stage:2 },
    // ‚îÄ‚îÄ SAGA PICCOLO DAIMAOH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    { enemy:"MestreKame2",      title:"SAGA DAIMAOH", zeniReward:700,  expReward:60, stage:2 },
    { enemy:"Kame2FP",                                 zeniReward:750,  expReward:65, stage:2 },
    { enemy:"PiccoloDaimaohOld",                       zeniReward:800,  expReward:70, stage:0 },
    { enemy:"PiccoloDaimaoh",                          zeniReward:900,  expReward:80, stage:0 },
    // ‚îÄ‚îÄ SAGA PICCOLO JR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    { enemy:"PiccoloJr",        title:"SAGA PICCOLO", zeniReward:900,  expReward:80, stage:0 },
    { enemy:"PiccoloJr3",                              zeniReward:1000, expReward:90, stage:0 },
    { enemy:"PiccoloJrGiant",                          zeniReward:1100, expReward:100, stage:0 },
    // ‚îÄ‚îÄ SAGA SAIYAJIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    { enemy:"Raditz",           title:"SAGA SAIYAJIN",zeniReward:1200, expReward:110, stage:0 },
    { enemy:"Saibaman",                                zeniReward:800,  expReward:60,  stage:0 },
    { enemy:"Saibaman2",                               zeniReward:800,  expReward:60,  stage:0 },
    { enemy:"Nappa",                                   zeniReward:1400, expReward:130, stage:0 },
    { enemy:"Nappa2",                                  zeniReward:1400, expReward:130, stage:0 },
    { enemy:"VegetaScouter",                           zeniReward:1800, expReward:160, stage:0 },
    { enemy:"VegetaScouterOozaru",                     zeniReward:2000, expReward:180, stage:0 },
    // ‚îÄ‚îÄ SAGA Namek ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    { enemy:"SoldadoDoFreeza",  title:"SAGA NAMEK",  zeniReward:1000, expReward:90,  stage:1 },
    { enemy:"Appule",                                  zeniReward:1100, expReward:100, stage:1 },
    { enemy:"VegetaScouter2",                          zeniReward:1200, expReward:110, stage:1 },
    { enemy:"Cui",                                     zeniReward:1300, expReward:120, stage:1},
    { enemy:"Dodoria",                                 zeniReward:1500, expReward:140, stage:1 },
    { enemy:"VegetaScouter3",                          zeniReward:1600, expReward:150, stage:1 },
    { enemy:"Gurdo",                                   zeniReward:1700, expReward:160, stage:1 },
    { enemy:"Boter",                                   zeniReward:1700, expReward:160, stage:1 },
    { enemy:"Recoome",                                   zeniReward:1700, expReward:160, stage:1 },
    { enemy:"RecoomeT2",                                   zeniReward:1700, expReward:160, stage:1 },
    // ‚îÄ‚îÄ SAGA FREEZA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    { enemy:"Ginyu",  title:"SAGA FREEZA",         zeniReward:1700, expReward:160, stage:1 },
    { enemy:"Jeice",                                   zeniReward:1700, expReward:160, stage:1 },
    { enemy:"Ginyu3",                                   zeniReward:1700, expReward:160, stage:1 },
    { enemy:"FreezaF1",                                   zeniReward:1800, expReward:360, stage:1 },
    { enemy:"FreezaF1(T2)",                                   zeniReward:1800, expReward:360, stage:1 },
    { enemy:"FreezaF2",                                   zeniReward:2500, expReward:660, stage:1 },
    { enemy:"FreezaF3",                                   zeniReward:2500, expReward:660, stage:1 },
    { enemy:"FreezaF4",                                   zeniReward:2500, expReward:660, stage:1 },
    // ‚îÄ‚îÄ SAGA ANDROID ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    { enemy:"Appule",  title:"SAGA ANDROID",         zeniReward:1700, expReward:400, stage:0 },
    { enemy:"SoldadoDoFreeza",                                   zeniReward:1700, expReward:400, stage:0 },
    { enemy:"MechaFreeza",                                   zeniReward:1700, expReward:400, stage:0 },
    { enemy:"KingCold",                                   zeniReward:1800, expReward:400, stage:0 },
    { enemy:"Android19",                                   zeniReward:1800, expReward:360, stage:0 },
    { enemy:"Android20DrGero",                                   zeniReward:2500, expReward:660, stage:0 },
    { enemy:"android18",                                   zeniReward:2500, expReward:660, stage:0 },
    { enemy:"android17",                                   zeniReward:2500, expReward:660, stage:0 },
    { enemy:"android18",                                   zeniReward:2500, expReward:660, stage:0 },
    { enemy:"CellImperfect",                                   zeniReward:2500, expReward:660, stage:0 },
    { enemy:"Android16",                                   zeniReward:2500, expReward:660, stage:0 },
    { enemy:"CellSemiimperfeito",                                   zeniReward:2500, expReward:660, stage:0 },
    { enemy:"VegetaZ2SV",                                   zeniReward:2500, expReward:660, stage:0 },
    { enemy:"CellPerfeito",                                   zeniReward:3000, expReward:800, stage:0 },
    { enemy:"CellJr",                                   zeniReward:3000, expReward:800, stage:2 },
    { enemy:"CellJr",                                   zeniReward:3000, expReward:800, stage:2 },
    { enemy:"CellPerfeito",                                   zeniReward:3000, expReward:800, stage:2 },
    { enemy:"CellSemiimperfeito",                                   zeniReward:2500, expReward:800, stage:2 },
    { enemy:"CellSuperPerfeito",                                   zeniReward:3000, expReward:1000, stage:2 },
    // ‚îÄ‚îÄ SAGA DO FUTURO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    { enemy:"android18",      title:"SAGA DO FUTURO",          zeniReward:3000, expReward:1000, stage:17 },
    { enemy:"android17",                                   zeniReward:3000, expReward:1000, stage:17 },
    { enemy:"CellImperfect",                                   zeniReward:3000, expReward:1000, stage:17 },
    // ‚îÄ‚îÄ ADICIONE NOVAS MISS√ïES ABAIXO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // { enemy:"NomeChaveDB", title:"SAGA X", zeniReward:2000, expReward:200, stage:2 },
    // 0=terra, 1=namek, 2=torneio, 3=espa√ßo, 4=inferno, 5=cidade, 6=c√¢mara do tempo,
    // 7=planeta vegeta, 8=nave do freeza, 9=mundo do beerus, 10=arena cell games, 11=mundo dos kais, 12=c√¢mara dark
    // 13=deserto, 14=lab dr.gero, 15=mundo saiyajin, 16=dimens√£o zeno, 17=campo destru√≠do
];

// Constantes de Layout da Grelha
const LAYOUT = {
    gridX: 60, gridY: 180, portraitSize: 90, gap: 20,
    shopX: 60, shopY: 180, itemW: 220, itemH: 280
};

// ==========================================
// 2. SISTEMA DE √ÅUDIO
// ==========================================
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playSound(freq, type, duration, volume = 0.05) {
    try {
        if(audioCtx.state === 'suspended') return;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gain.gain.setValueAtTime(volume, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + duration);
    } catch(e) {}
}

// ==========================================
// 3. ESTADO GLOBAL E SCROLLING
// ==========================================
const mouse = { x: 0, y: 0 };
const STATES = { MENU: 0, SHOP: 1, CHAR_SELECT: 2, BATTLE: 3, AUTH: 4, STORY_MENU: 5, STATS: 6, RANKING: 7, NEWS: 8, DAILY_REWARD: 9, DAILY_MISSIONS: 10, STAGE_SELECT: 11, BATTLE_RESULT: 12, ACHIEVEMENTS: 13, SUMMON: 14 };
let dailyRewardPending = null;
let currentState = STATES.AUTH;

let charSelectionStep = 0; 
let tempPlayerKey = null;
let shopTab = "CHARS"; 
let isStoryMode = false;
let isSurvivalMode = false;
let charFilter = "TODOS";
let charHoverKey = null;

// Vari√°veis de Modos
let selectedMissionIndex = 0;
let currentMissionPlaying = 0;
let storyScrollY = 0, targetStoryScrollY = 0;
let rankingScrollY = 0, targetRankingScrollY = 0;
let survivalWave = 1;

let subMenuPhase = null; // 'COSTUME' ou 'TRANS'
let subMenuOptions = [];

let shopScrollY = 0, targetShopScrollY = 0;
let summonPhase = "MAIN", summonWishCharScrollY = 0, summonWishItemScrollY = 0, summonSelectedWish = null;
let charScrollY = 0, targetCharScrollY = 0;
let dailyRewardScrollY = 0, targetDailyRewardScrollY = 0;
let achScrollY = 0, targetAchScrollY = 0;

// ‚îÄ‚îÄ NOVAS VARI√ÅVEIS: MEC√ÇNICAS DE BATALHA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let battleComboCount = 0; // Contador de combos consecutivos
let battleComboTimer = 0; // Timer para reset do combo
let battleStatusEffects = { player: [], enemy: [] }; // Status effects ativos
let battleUltimateCharge = 0; // Carga de ultimate (0-100)
let battleCounterWindow = false; // Janela de contra-ataque
let battleCounterTimer = 0;

// ‚îÄ‚îÄ ATB (Active Time Battle) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let atbPlayer = 0;         // 0-100: barra de ac√ß√£o do jogador
let atbEnemy  = 0;         // 0-100: barra de ac√ß√£o do inimigo
let atbPlayerSpeed = 1.1;  // mais lento = combate mais ponderado
let atbEnemySpeed  = 0.95; // inimigo um pouco mais lento que o jogador
let atbPaused = false;     // pausa durante HUDs/menus internos
let atbReady  = false;     // true quando atbPlayer >= 100

// ‚îÄ‚îÄ COOLDOWNS por move (√≠ndice 0-6 dos bot√µes) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let moveCooldowns = [0, 0, 0, 0, 0, 0, 0]; // [atq1,charge,esp1,esp2,def,itens,ultimate]

// ‚îÄ‚îÄ QTE (Quick Time Events) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let qteActive    = false;
let qteTimer     = 0;
let qteMaxTime   = 110;   // janela mais generosa (~1.8s) ‚Äî menos fren√©tico
let qteSuccess   = false;
let qtePending   = null;
let qteType      = "DODGE";
let qteFlash     = 0;

// ‚îÄ‚îÄ ECR√É DE RESULTADO DE BATALHA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let battleResult = {
    won:        false,
    zeniGained: 0,
    expGained:  0,
    levelUp:    false,
    newTitle:   null,    // t√≠tulo desbloqueado nesta batalha
    newAchievs: [],      // conquistas desbloqueadas nesta batalha
    timer:      0,       // anima√ß√£o
    playerName: "",
    enemyName:  "",
    mode:       "",
};

// ‚îÄ‚îÄ LIMITE DE ESQUIVAS/BLOQUEIOS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let qteUsesLeft  = 3;     // jogador pode esquivar/bloquear 3x por partida
let qteUsesMax   = 3;

// ‚îÄ‚îÄ ANIMA√á√ÉO DE TRANSFORMA√á√ÉO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let transAnim = {
    active:     false,
    phase:      0,       // 0=flash, 1=silhueta, 2=energia, 3=reveal, 4=fim
    timer:      0,
    char:       null,
    isPlayer:   true,
    pendingFn:  null,    // callback executado no inicio do reveal
    color:      "#fff",
    x: 0, y: 0,
};

// ‚îÄ‚îÄ IA INTELIGENTE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let aiPhase            = "NEUTRAL";   // "NEUTRAL"|"AGGRESSIVE"|"DEFENSIVE"|"POWERING"|"BERSERK"
let aiActionCount      = 0;
let aiConsecutiveHits  = 0;
let aiTransformCooldown = 0;          // frames at√© poder transformar novamente
let aiTransformIndex   = 0;          // qual transforma√ß√£o usar a seguir
let aiMemory = {
    playerUsedDefense:     0,
    playerUsedSpecial:     0,
    playerMissedQTE:       0,
    consecutiveQTESuccess: 0,
};
let stageSelectHover = -1; // Stage selecionado no hover
let selectedFreeBattleStage = 0; // Cen√°rio escolhido no modo livre

// ‚îÄ‚îÄ PART√çCULAS DO MENU (KI ‚Äî laranja/dourado/vermelho) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let menuParticles = [];
for(let i=0;i<60;i++) {
    const rnd = Math.random();
    menuParticles.push({
        x: Math.random()*1100, y: Math.random()*650,
        vx: (Math.random()-0.5)*0.4, vy: -Math.random()*0.9-0.15,
        size: Math.random()*2.5+0.8,
        color: rnd > 0.6 ? "#ff8c00" : (rnd > 0.3 ? "#f5c518" : "#e53935"),
        alpha: Math.random()
    });
}

let player = { 
    name: "", zeni: 0, level: 1, exp: 0, expToNext: 100, storyProgress: 0, statPoints: 0,
    stats: { hp: 0, atk: 0, ki: 0 },
    maxSurvivalWave: 0,
    unlockedChars: ["GokuZ","GokuC","BulmaC","Oolong"], unlockedCostumes: [], unlockedTransformations: [], inventory: {}, pass: "" 
};

let particles = [], floatingTexts = [], images = {}, activeBeam = null;
let selectedPlayerChar = null, selectedEnemyChar = null;
let battleTurn = "PLAYER", battleLog = "SINCRO INICIADA";
let shakeIntensity = 0, screenFlash = 0, uiPulse = 0, timeEnv = 0;
let enemyShieldFlash = 0, enemyDodgeFlash = 0; // Efeitos visuais de bloqueio/esquiva inimigo
let showItemHUD = false, showFusionHUD = false;

function isUnlocked(key, type="CHAR") {
    if(type === "CHAR") {
        const charData = charactersDB[key];
        
        // ‚úÖ Verifica√ß√£o 1: Est√° na lista de desbloqueados?
        if (player.unlockedChars.includes(key)) {
            return true;
        }

        // ‚úÖ Verifica√ß√£o 1b: √â uma transforma√ß√£o comprada na loja de Transforma√ß√µes?
        if (player.unlockedTransformations && player.unlockedTransformations.includes(key)) {
            return true;
        }
        
        // ‚úÖ Verifica√ß√£o 2: √â um personagem gratuito?
        if (charData && (charData.price === undefined || charData.price === 0)) {
            return true;
        }
        
        // ‚úÖ Verifica√ß√£o 3: √â um traje/transforma√ß√£o? Verifica baseChar
        if (charData && charData.isCostume && charData.baseChar) {
            // Se √© traje, verifica se a vers√£o base est√° desbloqueada
            return player.unlockedChars.includes(charData.baseChar) ||
                   (player.unlockedTransformations && player.unlockedTransformations.includes(charData.baseChar));
        }
        if (charData && charData.isTransformation && charData.baseChar) {
            // Se √© transforma√ß√£o, verifica se a vers√£o base est√° desbloqueada
            // baseChar diferente de si mesmo = depende do pai; caso contr√°rio j√° foi verificado acima
            if (charData.baseChar !== key) {
                return player.unlockedChars.includes(charData.baseChar) ||
                       (player.unlockedTransformations && player.unlockedTransformations.includes(charData.baseChar));
            }
        }
        
        return false;
    }
    
    if(type === "COSTUME") {
        const p = costumesDB[key] && costumesDB[key].price;
        return player.unlockedCostumes.includes(key) || p === undefined || p === 0;
    }
    
    if(type === "TRANS") {
        const p = charactersDB[key] && charactersDB[key].price;
        return player.unlockedTransformations.includes(key) || p === undefined || p === 0;
    }
    
    return false;
}

// ‚îÄ‚îÄ FUN√á√ÉO DEBUG: Ver estado de desbloqueio ‚îÄ‚îÄ
function debugCheckUnlock(charKey) {
    const charData = charactersDB[charKey];
    const inList = player.unlockedChars.includes(charKey);
    const isUnlockedResult = isUnlocked(charKey, "CHAR");
    
    console.log(`=== DEBUG UNLOCK: ${charKey} ===`);
    console.log(`Est√° em unlockedChars? ${inList}`);
    console.log(`Pre√ßo: ${charData?.price}`);
    console.log(`isCostume? ${charData?.isCostume}`);
    console.log(`isTransformation? ${charData?.isTransformation}`);
    console.log(`baseChar: ${charData?.baseChar}`);
    console.log(`isUnlocked() retorna: ${isUnlockedResult}`);
    console.log(`Player unlockedChars: ${JSON.stringify(player.unlockedChars)}`);
    console.log(`===============================`);
    
    return isUnlockedResult;
}

// ‚îÄ‚îÄ FUN√á√ÉO: Desbloquear personagem manualmente (para testes) ‚îÄ‚îÄ
function manualUnlockChar(charKey) {
    if (!player.unlockedChars.includes(charKey)) {
        player.unlockedChars.push(charKey);
        save();
        console.log(`‚úÖ Personagem ${charKey} desbloqueado!`);
        return true;
    } else {
        console.log(`‚ÑπÔ∏è Personagem ${charKey} j√° estava desbloqueado!`);
        return false;
    }
}

// ‚îÄ‚îÄ FUN√á√ÉO: Dar item manualmente (para testes) ‚îÄ‚îÄ
function manualGiveItem(itemKey, quantity = 1) {
    player.inventory[itemKey] = (player.inventory[itemKey] || 0) + quantity;
    save();
    console.log(`‚úÖ Adicionado ${quantity}x ${itemKey}!`);
}

// ‚îÄ‚îÄ FUN√á√ÉO: Ver invent√°rio completo ‚îÄ‚îÄ
function debugInventory() {
    console.log("=== INVENT√ÅRIO ===");
    console.log(JSON.stringify(player.inventory, null, 2));
    console.log("===================");
}

// ‚îÄ‚îÄ FUN√á√ÉO: Ver personagens desbloqueados ====
function debugUnlockedChars() {
    console.log("=== PERSONAGENS DESBLOQUEADOS ===");
    console.log(player.unlockedChars);
    console.log("==================================");
}

// ‚îÄ‚îÄ NOVA FUN√á√ÉO: Verificar se uma fus√£o √© poss√≠vel ‚îÄ‚îÄ
function canPerformFusion(userCharKey, partnerCharKey, itemKey) {
    // ‚úÖ Verifica√ß√£o 1: Receita existe?
    const recipe = FUSION_RECIPES.find(r => 
        r.user === userCharKey && 
        r.partner === partnerCharKey && 
        r.item === itemKey
    );
    if (!recipe) {
        return { possible: false, reason: "RECEITA N√ÉO EXISTE" };
    }
    
    // ‚úÖ Verifica√ß√£o 2: Resultado do personagem existe?
    if (!charactersDB[recipe.result]) {
        return { possible: false, reason: "PERSONAGEM RESULTADO N√ÉO CONFIGURADO" };
    }
    
    // ‚úÖ Verifica√ß√£o 3: Usu√°rio tem o item?
    const itemCount = player.inventory[itemKey] || 0;
    if (itemCount <= 0) {
        return { possible: false, reason: "ITEM N√ÉO DISPON√çVEL" };
    }
    
    // ‚úÖ Verifica√ß√£o 4: Parceiro est√° desbloqueado?
    const partnerUnlocked = isUnlocked(partnerCharKey, "CHAR");
    if (!partnerUnlocked) {
        // Debug: mostrar por que n√£o est√° desbloqueado
        const partnerData = charactersDB[partnerCharKey];
        const inList = player.unlockedChars.includes(partnerCharKey);
        const isFree = partnerData && (partnerData.price === undefined || partnerData.price === 0);
        
        console.warn(`Debug Fus√£o - Parceiro "${partnerCharKey}" bloqueado:`, {
            inUnlockedChars: inList,
            isFreeCharacter: isFree,
            price: partnerData?.price,
            playerUnlockedChars: player.unlockedChars
        });
        
        return { possible: false, reason: "PARCEIRO BLOQUEADO" };
    }
    
    // Todas as verifica√ß√µes passaram!
    return { possible: true, recipe: recipe };
}

// ‚îÄ‚îÄ NOVA FUN√á√ÉO: Retorna parceiros dispon√≠veis ‚îÄ‚îÄ
function getAvailableFusionPartners(userCharKey, itemKey) {
    const availablePartners = [];
    const userRecipes = FUSION_RECIPES.filter(r => r.user === userCharKey && r.item === itemKey);
    
    for (let recipe of userRecipes) {
        const check = canPerformFusion(userCharKey, recipe.partner, itemKey);
        
        if (check.possible) {
            availablePartners.push({
                partnerKey:  recipe.partner,
                partnerName: charactersDB[recipe.partner]?.name || recipe.partner,
                resultKey:   recipe.result,
                resultName:  charactersDB[recipe.result]?.name || recipe.result,
                userCharKey: userCharKey, // chave efetiva da receita
                unlocked: true,
                reason: "DISPON√çVEL"
            });
        } else {
            availablePartners.push({
                partnerKey:  recipe.partner,
                partnerName: charactersDB[recipe.partner]?.name || recipe.partner,
                resultKey:   recipe.result,
                resultName:  charactersDB[recipe.result]?.name || recipe.result,
                userCharKey: userCharKey,
                unlocked: false,
                reason: check.reason
            });
        }
    }
    
    return availablePartners;
}



function loadAllAssets() {
    let toLoad = {...charactersDB, ...itemsDB, ...costumesDB};
    Object.keys(toLoad).forEach(k => {
        if (!images[k]) { 
            images[k] = new Image(); 
            // Prote√ß√£o extra caso o path n√£o esteja definido
            if (toLoad[k] && toLoad[k].path) {
                images[k].src = toLoad[k].path; 
            } else {
                images[k].failed = true;
            }
            images[k].onerror = () => { images[k].failed = true; };
        }
    });
    // Carregar imagem avulsa da aura
    // Procure por esta parte e ajuste o caminho para a pasta correta
if (!images["kaiokenaura"]) {
    images["kaiokenaura"] = new Image();
    // Ajustado para a mesma pasta dos personagens
    images["kaiokenaura"].src = "itens/kaiokenaura.png";
}
}
loadAllAssets();

function showMessage(text) {
    const modal = document.getElementById('game-modal');
    modal.innerText = text.toUpperCase();
    modal.style.display = 'block';
    if (text.includes("INSUFICIENTE") || text.includes("BLOQUEADO") || text.includes("INCORRETO") || text.includes("INCOMPLETOS") || text.includes("INCOMPAT√çVEL") || text.includes("M√ÅXIMO") || text.includes("DERROTA")) {
        playSound(150, 'sawtooth', 0.3, 0.1);
    } else {
        playSound(600, 'sine', 0.1, 0.05);
    }
    setTimeout(() => { modal.style.display = 'none'; }, 2000);
}

// ==========================================
// L√ìGICA DE SCROLLING
// ==========================================
function getMaxScroll(itemCount, cols, itemHeight, gap, visibleHeight) {
    let rows = Math.ceil(itemCount / cols);
    let totalHeight = rows * (itemHeight + gap);
    return totalHeight > visibleHeight ? -(totalHeight - visibleHeight + gap) : 0;
}

function drawScrollbar(x, y, h, currentScroll, maxScroll) {
    if (maxScroll >= 0) return;
    let scrollRatio = currentScroll / maxScroll;
    let thumbH = Math.max(30, h * (h / (h - maxScroll)));
    let thumbY = y + scrollRatio * (h - thumbH);
    ctx.fillStyle = "rgba(0, 210, 255, 0.1)"; ctx.fillRect(x, y, 6, h);
    ctx.fillStyle = UI_COLORS.accent; ctx.fillRect(x, thumbY, 6, thumbH);
}

canvas.addEventListener('wheel', (e) => {
    let scrollSpeed = 60;
    if (currentState === STATES.SHOP) {
        targetShopScrollY -= Math.sign(e.deltaY) * scrollSpeed;
    } else if (currentState === STATES.CHAR_SELECT && !subMenuPhase) {
        targetCharScrollY -= Math.sign(e.deltaY) * scrollSpeed;
    } else if (currentState === STATES.STORY_MENU) {
        targetStoryScrollY -= Math.sign(e.deltaY) * scrollSpeed;
    } else if (currentState === STATES.RANKING) {
        targetRankingScrollY -= Math.sign(e.deltaY) * scrollSpeed;
    } else if (currentState === STATES.DAILY_REWARD) {
        targetDailyRewardScrollY -= Math.sign(e.deltaY) * scrollSpeed;
    } else if (currentState === STATES.ACHIEVEMENTS) {
        targetAchScrollY -= Math.sign(e.deltaY) * scrollSpeed;
    } else if (currentState === STATES.SUMMON) {
        if(summonPhase === "WISH1") summonWishCharScrollY -= Math.sign(e.deltaY) * scrollSpeed;
        else if(summonPhase === "WISH3") summonWishItemScrollY -= Math.sign(e.deltaY) * scrollSpeed;
    }
});

// ==========================================
// 4. L√ìGICA DE NEG√ìCIO B√ÅSICA
// ==========================================
window.handleAuth = function() {
    const user = document.getElementById('user').value.trim();
    const pass = document.getElementById('pass').value.trim();
    if(!user || !pass) return showMessage("DADOS INCOMPLETOS");
    
    let saved = localStorage.getItem('dd_v2_' + user);
    if(saved) {
        try {
            let p = JSON.parse(saved);
            if(p.pass === pass) { 
                player = normalizePlayer({...player, ...p});
                showMessage("ACESSO AUTORIZADO"); 
            } else return showMessage("C√ìDIGO INCORRETO");
        } catch(e) {
             showMessage("ERRO LENDO DADOS ANTIGOS");
        }
    } else {
        player = normalizePlayer({
            name: user, pass: pass, zeni: 5000, level: 1, exp: 0, expToNext: 100,
            statPoints: 0, stats: {hp:0, atk:0, ki:0}, maxSurvivalWave: 0,
            inventory: {}, storyProgress: 0, unlockedCostumes: [], unlockedTransformations: [],
            unlockedChars: ["GokuZ","GokuC"], victories: 0, defeats: 0
        });
        save();
        showMessage("GUERREIRO REGISTADO");
    }
    document.getElementById('auth-overlay').style.display = 'none';
    currentState = STATES.MENU;
    if(audioCtx.state === 'suspended') audioCtx.resume();
    playSound(400, 'square', 0.2);
}

function normalizePlayer(p) {
    if(!p.unlockedCostumes)         p.unlockedCostumes = [];
    if(!p.unlockedTransformations)  p.unlockedTransformations = [];
    if(!p.unlockedChars || p.unlockedChars.length === 0) p.unlockedChars = ["GokuZ","GokuC"];
    if(p.storyProgress === undefined) p.storyProgress = 0;
    if(p.statPoints === undefined)    p.statPoints = 0;
    if(!p.stats)                      p.stats = {hp:0, atk:0, ki:0};
    if(p.maxSurvivalWave === undefined) p.maxSurvivalWave = 0;
    if(p.victories === undefined)     p.victories = 0;
    if(p.defeats === undefined)       p.defeats = 0;
    if(!p.inventory)                  p.inventory = {};
    if(!p.expToNext || p.expToNext <= 0) p.expToNext = 100;
    if(!p.level || p.level <= 0) p.level = 1;
    if(!p.exp || p.exp < 0) p.exp = 0;
    if(!p.lastDailyReward)             p.lastDailyReward = "";
    if(p.dailyStreak === undefined)    p.dailyStreak = 0;
    if(!p.dailyMissions)              p.dailyMissions = { date: "", missions: [], progress: [] };
    return p;
}

function save() { 
    if(player.name) {
        localStorage.setItem('dd_v2_' + player.name, JSON.stringify(player));
        saveCloud();
    }
}

function finalizeCharSelection(key) {
    if(charSelectionStep === 0) {
        tempPlayerKey = key;
        if(isStoryMode) { 
            currentStageIndex = STORY_SEQUENCE[currentMissionPlaying].stage !== undefined ? STORY_SEQUENCE[currentMissionPlaying].stage : Math.floor(Math.random() * BATTLE_STAGES.length);
            startBattle(tempPlayerKey, STORY_SEQUENCE[currentMissionPlaying].enemy); 
        } else if (isSurvivalMode) {
            let keys = Object.keys(charactersDB).filter(k => !charactersDB[k].isCostume);
            let randomEnemy = keys[Math.floor(Math.random() * keys.length)];
            currentStageIndex = Math.floor(Math.random() * BATTLE_STAGES.length);
            startBattle(tempPlayerKey, randomEnemy); 
        } else { 
            charSelectionStep = 1; 
        }
    } else {
        currentStageIndex = selectedFreeBattleStage; // Usa o cen√°rio escolhido
        startBattle(tempPlayerKey, key);
    }
    subMenuPhase = null;
}

function startBattle(pKey, eKey) {
    selectedPlayerChar = createBattleChar(pKey, true);
    selectedEnemyChar = createBattleChar(eKey, false);
    selectedPlayerChar.showTransHUD = false;
    selectedPlayerChar.showAbsorbHUD = false;
    showItemHUD = false; showFusionHUD = false;
    battleTurn = "PLAYER"; battleLog = isSurvivalMode ? `ONDA ${survivalWave} INICIADA!` : "COMBATE INICIADO!";
    // Reset mec√¢nicas de batalha
    battleComboCount = 0; battleComboTimer = 0;
    battleStatusEffects = { player: [], enemy: [] };
    battleUltimateCharge = 0;
    battleCounterWindow = false; battleCounterTimer = 0;
    // Reset ATB
    atbPlayer = 0; atbEnemy = 0; atbReady = false; atbPaused = false;
    atbPlayerSpeed = 1.1 + (player.stats.ki || 0) * 0.04;
    atbEnemySpeed  = 0.85 + (Math.random() * 0.25); // 0.85‚Äì1.10
    // Reset cooldowns
    moveCooldowns = [0, 0, 0, 0, 0, 0, 0];
    // Reset QTE
    qteActive = false; qteTimer = 0; qtePending = null; qteSuccess = false; qteFlash = 0;
    qteUsesLeft = qteUsesMax; // reset limite de esquivas
    transAnim = { active:false, phase:0, timer:0, char:null, isPlayer:true, pendingFn:null, color:"#fff", x:0, y:0 };
    // Reset IA
    aiPhase = "NEUTRAL"; aiActionCount = 0; aiConsecutiveHits = 0;
    aiTransformCooldown = 0; aiTransformIndex = 0;
    aiMemory = { playerUsedDefense:0, playerUsedSpecial:0, playerMissedQTE:0, consecutiveQTESuccess:0 };
    currentState = STATES.BATTLE;
    playSound(300, 'sawtooth', 0.5);
}

function createBattleChar(key, isPlayer = false) {
    let base = charactersDB[key];

    // Seguran√ßa: Caso a chave n√£o exista
    if (!base) {
        console.error("Personagem n√£o encontrado:", key);
        return null;
    }

    // Heran√ßa de trajes
    if (base.isCostume && base.baseChar) {
        const originalBase = charactersDB[base.baseChar];
        base = { ...originalBase, ...base };
    }

    // Clonagem e Inicializa√ß√£o
    let c = { 
        ...JSON.parse(JSON.stringify(base)), 
        originalKey: key, 
        currentSkin: key, 
        ki: 0, 
        animX: 0, 
        hp: base.hp || 1000, 
        maxHp: base.maxHp || 1000, 
        dmgMod: 1.0, 
        isCharging: false, 
        kaiokenAuraTimer: 0, 
        isDefending: false 
    };

    // Garante que o personagem tenha moves
    if (!c.moves || c.moves.length === 0) {
        c.moves = [
            { name: "ATAQUE B√ÅSICO", dmg: 60, type: "physical" },
            { name: "CARREGAR KI", dmg: 0, type: "charge" },
            { name: "ONDA DE KI", dmg: 150, type: "beam", cost: 30 },
            { name: "GOLPE M√ÅXIMO", dmg: 400, type: "sphere", cost: 80 }
        ];
    }

    if (isPlayer) {
        // Aplica√ß√£o de B√¥nus de Atributos do Player
        if (player.stats.hp > 0) {
            let bonus = 1 + (player.stats.hp * 0.05);
            c.maxHp = Math.floor(c.maxHp * bonus);
        }
        if (player.stats.ki > 0) {
            c.ki = player.stats.ki * 10;
        }
    } else {
        // L√≥gica de Dificuldade dos Inimigos
        let enemyScale = 1.0;

        if (isStoryMode) {
            enemyScale = 1.2 + (currentMissionPlaying * 0.08);
        } else if (isSurvivalMode) {
            enemyScale = 1.2 + (survivalWave * 0.15);
        } else {
            // MODO LIVRE ‚Äî bot espelha exatamente os stats do jogador
            if (player.stats.hp > 0) {
                enemyScale = 1 + (player.stats.hp * 0.05);
            } else {
                enemyScale = 1.0;
            }
            if (player.stats.ki > 0) {
                c.ki = player.stats.ki * 10;
            }
            c.mirrorPlayerStats = true;
        }

        c.maxHp = Math.floor(c.maxHp * enemyScale);
        c.enemyPowerScale = enemyScale;
    }
    
    // Sincroniza HP atual com o m√°ximo calculado
    c.hp = c.maxHp;
    c.displayHp = c.hp; 
    c.displayKi = c.ki;

    return c;
}

// ‚îÄ‚îÄ Aplica a forma imediatamente (l√≥gica core, sem anima√ß√£o) ‚îÄ‚îÄ
function applyTransformCore(char, finalKey, isPlayer) {
    const newForm = charactersDB[finalKey];
    if (!newForm) return;
    char.ki -= (newForm.kiCost || 0);
    let currentHp = char.hp, currentMax = char.maxHp;
    let kDmg = char.dmgMod, kTimer = char.kaiokenAuraTimer;
    Object.assign(char, JSON.parse(JSON.stringify(newForm)));
    char.currentSkin = finalKey;
    char.originalKey = finalKey;
    char.showTransHUD = false;
    char.showAbsorbHUD = false;
    if (isPlayer && player.stats.hp > 0)
        char.maxHp = Math.floor(char.maxHp * (1 + player.stats.hp * 0.05));
    char.hp = Math.floor((currentHp / currentMax) * char.maxHp);
    char.displayHp = char.hp;
    char.dmgMod = kDmg;
    char.kaiokenAuraTimer = kTimer;
}

function executeTransform(char, targetKey, isPlayer) {
    // --- L√ìGICA DE HERAN√áA DE TRAJE ---
    let finalKey = targetKey;
    if (char.isCostume) {
        let costumeNumber = char.originalKey.match(/\d+$/);
        if (costumeNumber) {
            let specificTransKey = targetKey + "T" + costumeNumber[0];
            if (charactersDB[specificTransKey]) finalKey = specificTransKey;
        }
    }

    const newForm = charactersDB[finalKey];
    if (!newForm) return;
    if (char.ki < (newForm.kiCost || 0)) {
        if (isPlayer) showMessage("KI INSUFICIENTE");
        return;
    }

    // S√≥ anima se estiver numa batalha activa
    if (currentState === STATES.BATTLE) {
        startTransformAnim(char, finalKey, isPlayer);
    } else {
        applyTransformCore(char, finalKey, isPlayer);
        battleLog = `${char.name} ATIVADO!`;
        screenFlash = 15;
        spawnParticles(isPlayer ? 300 : 800, 450, char.color || "#fff", 120, "explode");
        playSound(800, 'sine', 0.6);
    }
}

// ‚îÄ‚îÄ Inicia anima√ß√£o de transforma√ß√£o ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startTransformAnim(char, finalKey, isPlayer) {
    const col = charactersDB[finalKey]?.color || char.color || "#fff";
    transAnim = {
        active:    true,
        phase:     0,
        timer:     0,
        char:      char,
        isPlayer:  isPlayer,
        pendingFn: () => applyTransformCore(char, finalKey, isPlayer),
        color:     col,
        x:         isPlayer ? 300 : 800,
        y:         550,
    };
    // Pausar ATB durante a anima√ß√£o
    atbPaused = true;
    char.showTransHUD = false;
    char.showAbsorbHUD = false;
    playSound(isPlayer ? 600 : 700, 'sine', 0.3);
}

// ‚îÄ‚îÄ Atualiza e desenha anima√ß√£o de transforma√ß√£o ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Fases: 0=acumular(30f) 1=flash branco(20f) 2=silhueta+energia(50f) 3=reveal(25f)
function updateTransformAnim() {
    if (!transAnim.active) return;
    const t = transAnim;
    t.timer++;

    const cx = t.x, cy = t.y;
    const charKey = t.char ? t.char.currentSkin : null;
    const img = charKey ? images[charKey] : null;
    const scale = (t.char && t.char.scale) ? t.char.scale : 1.0;
    const iw = (img && img.naturalWidth)  ? img.naturalWidth  * scale : 80;
    const ih = (img && img.naturalHeight) ? img.naturalHeight * scale : 130;

    ctx.save();

    if (t.phase === 0) {
        // FASE 0 ‚Äî acumula√ß√£o de energia (30 frames)
        const prog = t.timer / 30;
        // Aura pulsante crescente
        ctx.shadowBlur = 20 + prog * 60; ctx.shadowColor = t.color;
        ctx.globalAlpha = 0.15 + prog * 0.45;
        ctx.fillStyle = t.color;
        ctx.beginPath(); ctx.ellipse(cx, cy - ih/2, iw * (0.6 + prog * 0.8), ih * (0.6 + prog * 0.8), 0, 0, Math.PI*2); ctx.fill();
        ctx.globalAlpha = 1; ctx.shadowBlur = 0;
        // Part√≠culas ascendentes
        if (t.timer % 3 === 0) spawnParticles(cx, cy - 20, t.color, 4, "charge");

        if (t.timer >= 30) { t.phase = 1; t.timer = 0; playSound(900, 'sine', 0.5); }

    } else if (t.phase === 1) {
        // FASE 1 ‚Äî flash branco total (20 frames)
        const prog = t.timer / 20;
        const alpha = prog < 0.4 ? prog / 0.4 : 1 - (prog - 0.4) / 0.6;
        ctx.fillStyle = `rgba(255,255,255,${alpha * 0.92})`;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        // Aplicar transforma√ß√£o no meio do flash (frame 10)
        if (t.timer === 10 && t.pendingFn) {
            t.pendingFn();
            t.pendingFn = null;
            playSound(1200, 'sine', 0.6);
            spawnParticles(cx, cy - 40, t.color, 80, "explode");
        }
        if (t.timer >= 20) { t.phase = 2; t.timer = 0; }

    } else if (t.phase === 2) {
        // FASE 2 ‚Äî silhueta com energia irradiante (50 frames)
        const prog = t.timer / 50;
        const pulse = 1 + Math.sin(t.timer * 0.4) * 0.12;
        // Glow expandindo
        ctx.shadowBlur = 50 - prog * 20; ctx.shadowColor = t.color;
        ctx.globalAlpha = 0.7 - prog * 0.5;
        ctx.fillStyle = t.color;
        ctx.beginPath(); ctx.ellipse(cx, cy - ih/2, iw * pulse * (1.2 - prog * 0.2), ih * pulse * (1.1 - prog * 0.1), 0, 0, Math.PI*2); ctx.fill();
        ctx.globalAlpha = 1; ctx.shadowBlur = 0;
        // Silhueta escura do novo char
        const newKey = t.char ? t.char.currentSkin : null;
        const newImg = newKey ? images[newKey] : null;
        if (newImg && newImg.complete && !newImg.failed) {
            ctx.save();
            ctx.globalCompositeOperation = "source-atop";
            ctx.globalAlpha = 0.25 + prog * 0.55;
            ctx.drawImage(newImg, cx - iw/2, cy - ih, iw, ih);
            ctx.restore();
        }
        if (t.timer % 4 === 0) spawnParticles(cx + (Math.random()-0.5)*iw, cy - Math.random()*ih, t.color, 3, "charge");
        if (t.timer >= 50) { t.phase = 3; t.timer = 0; playSound(800, 'sine', 0.4); }

    } else if (t.phase === 3) {
        // FASE 3 ‚Äî reveal com aura residual (25 frames)
        const prog = t.timer / 25;
        const glowAlpha = 1 - prog;
        ctx.shadowBlur = 30 * glowAlpha; ctx.shadowColor = t.color;
        ctx.globalAlpha = glowAlpha * 0.6;
        ctx.fillStyle = t.color;
        ctx.beginPath(); ctx.ellipse(cx, cy - ih/2, iw * 1.1, ih * 1.1, 0, 0, Math.PI*2); ctx.fill();
        ctx.globalAlpha = 1; ctx.shadowBlur = 0;
        if (t.timer >= 25) { t.phase = 4; t.timer = 0; }

    } else {
        // FIM da anima√ß√£o
        t.active = false;
        atbPaused = false;
        const name = t.char ? t.char.name : "?";
        battleLog = `‚ö° ${name} ATIVADO!`;
        screenFlash = 18;
        spawnParticles(cx, cy - 40, t.color, 50, "explode");
        playSound(600, 'sine', 0.3);
    }

    ctx.restore();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ñ∂  EFEITOS DOS ITENS ‚Äî para cada item em itemsDB, adicione um
//    case aqui com o efeito desejado. Vari√°veis √∫teis:
//      selectedPlayerChar  ‚Üí personagem do jogador
//      executeTransform(char, "ChaveDestino", isPlayer) ‚Üí transforma
//      selectedPlayerChar.dmgMod += X  ‚Üí aumenta dano (1.0 = base)
//      selectedPlayerChar.hp = ...     ‚Üí modifica HP
//      showMessage("TEXTO")            ‚Üí mostra mensagem no ecr√£
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function useItem(itemId) {
    if (!player.inventory[itemId] || player.inventory[itemId] <= 0) return;
    let used = false;
    
    switch(itemId) {
        case "blutzray":
            if (selectedPlayerChar.currentSkin === "VegetaScouter") { executeTransform(selectedPlayerChar, "VegetaScouterOozaru", true); used = true; }
            else if (selectedPlayerChar.currentSkin === "Nappa" || selectedPlayerChar.currentSkin === "Nappa2") { executeTransform(selectedPlayerChar, "NappaOozaru", true); used = true; }
            else if (selectedPlayerChar.currentSkin === "GokuC" || selectedPlayerChar.currentSkin === "GokuC") { executeTransform(selectedPlayerChar, "OozaruC", true); used = true; }
            else showMessage("S√ì P/ PERSONAGENS C/ CAUDA"); break;
        case "fullpower": 
            selectedPlayerChar.dmgMod += 0.25; battleLog = "PODER AUMENTADO (+25%)"; used = true; break;
        case "space":
            if (selectedPlayerChar.currentSkin === "FreezaF4") { executeTransform(selectedPlayerChar, "MechaFreeza", true); used = true; } else showMessage("S√ì P/ FREEZA F4"); break;
        case "kaioken":
            selectedPlayerChar.dmgMod += 0.20; battleLog = "KAIOKEN ATIVADO! (+20%)";
            selectedPlayerChar.kaiokenAuraTimer = 300; used = true; break;
        case "godki":
            if (selectedPlayerChar.originalKey === "GokuZ") { executeTransform(selectedPlayerChar, "GokuGod", true); used = true; }
            else if (selectedPlayerChar.originalKey === "VegetaZ") { executeTransform(selectedPlayerChar, "VegetaGod", true); used = true; }
            else showMessage("INCOMPAT√çVEL"); break;
        case "senzubeam":
            let healAmount = Math.floor(selectedPlayerChar.maxHp * 0.5);
            selectedPlayerChar.hp = Math.min(selectedPlayerChar.maxHp, selectedPlayerChar.hp + healAmount);
            battleLog = `REGENERADO +${healAmount} HP!`; used = true; break;
        case "golden_evo":
            if (selectedPlayerChar.currentSkin === "CellPerfeito") { executeTransform(selectedPlayerChar, "GoldenCell", true); used = true; } 
            else { showMessage("APENAS CELL PERFEITO PODE USAR!"); } break;
        case "marcamajin":
            if (selectedPlayerChar.isEvil) {
                if (selectedPlayerChar.originalKey === "VegetaZ3" || selectedPlayerChar.currentSkin === "VegetaZ3") {
                    executeTransform(selectedPlayerChar, "MajinVegeta", true);
                    // transforma√ß√£o j√° traz power-up, n√£o aplicar b√≥nus extra
                } else {
                    selectedPlayerChar.dmgMod += 0.30;
                }
                battleLog = "PODER MAJIN DESPERTADO!"; used = true;
            } else { showMessage("APENAS PARA SERES MALIGNOS!"); } break;
        case "dance":
        case "potara": {
            // Monta lista de chaves candidatas: skin atual ‚Üí originalKey ‚Üí toda a cadeia baseChar
            // Isso resolve o bug de fus√£o quebrar ap√≥s transforma√ß√£o e permite qualquer personagem fundir
            const skinKey = selectedPlayerChar.currentSkin;
            const origKey = selectedPlayerChar.originalKey;

            // Fun√ß√£o para percorrer a cadeia de baseChar at√© √† raiz
            function getBaseChain(key, visited = new Set()) {
                if (!key || visited.has(key)) return [];
                visited.add(key);
                const chain = [key];
                const base = charactersDB[key]?.baseChar;
                if (base && base !== key) chain.push(...getBaseChain(base, visited));
                return chain;
            }

            const candidateSet = new Set([
                ...getBaseChain(skinKey),
                ...getBaseChain(origKey)
            ]);
            const candidates = [...candidateSet].filter(Boolean);

            let partners = [];
            for (const k of candidates) {
                const p = getAvailableFusionPartners(k, itemId);
                if (p.length > 0) { partners = p; break; }
            }
            
            if (!partners || partners.length === 0) {
                showMessage("NENHUMA FUS√ÉO DISPON√çVEL");
                break;
            }
            
            const unlockedPartners = partners.filter(p => p.unlocked);
            if (unlockedPartners.length === 0) {
                const firstBlockedReason = partners[0]?.reason || "BLOQUEADO";
                showMessage(firstBlockedReason);
                break;
            }
            
            // Guarda a userCharKey efetiva (a que bateu na receita)
            const effectiveUserKey = partners[0]?.userCharKey || skinKey;
            
            showFusionHUD = {
                itemKey: itemId,
                userCharKey: effectiveUserKey,
                partners: partners,
                unlockedPartners: unlockedPartners
            };
            showItemHUD = false;
            break;
        }
        // ‚îÄ‚îÄ ADICIONE NOVOS EFEITOS ABAIXO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // case "meu_item":
        //     selectedPlayerChar.dmgMod += 0.5; battleLog = "ITEM ATIVADO!"; used = true; break;
    }
    if (used) { player.inventory[itemId]--; showItemHUD = false; save(); playSound(1000, 'sine', 0.2); }
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ñ∂  FUS√ïES ‚Äî edite para adicionar novas fus√µes.
//    Cada fus√£o precisa de 2 entradas (A+B e B+A) para funcionar
//    nos dois sentidos. Campos:
//      user:    chave do personagem que usa o item
//      item:    "dance" ou "potara" (chave do itemsDB)
//      partner: chave do parceiro de fus√£o
//      result:  chave do personagem resultante (no charactersDB)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const FUSION_RECIPES = [
    // ‚îÄ‚îÄ FUS√ïES DE DAN√áA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    { user: "GokuZ8",    partner: "VegetaZ3",  item: "dance",   result: "Gogeta" },
    { user: "VegetaZ3",  partner: "GokuZ8",    item: "dance",   result: "Gogeta" },

    // ‚îÄ‚îÄ FUS√ïES DE POTARA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    { user: "GokuZ8",    partner: "VegetaZ3",  item: "potara",  result: "Vegetto" },
    { user: "VegetaZ3",  partner: "GokuZ8",    item: "potara",  result: "Vegetto" },
    // ‚îÄ‚îÄ FBroly ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    { user: "BrolyZLSSJ",    partner: "BrolyDBSSSJFULLPOWER",  item: "potara",  result: "Brooly" },
    { user: "BrolyDBSSSJFULLPOWER",  partner: "BrolyZLSSJ",    item: "potara",  result: "Brooly" },
    // Freell Potara
    { user: "FreezaF4",  partner: "CellPerfeito", item: "potara", result: "FreellPotara" },
    { user: "CellPerfeito", partner: "FreezaF4",  item: "potara", result: "FreellPotara" },
    // Freell Dance
    { user: "FreezaF4",  partner: "CellPerfeito", item: "dance",  result: "FreellDance" },
    { user: "CellPerfeito", partner: "FreezaF4",  item: "dance",  result: "FreellDance" },
    // ‚îÄ‚îÄ GOTENKS: FUS√ÉO DE DAN√áA (GOTEN + TRUNKS) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    { user: "GotenZ",     partner: "TrunksZKid", item: "dance", result: "GotenksZ" },
    { user: "TrunksZKid", partner: "GotenZ",     item: "dance", result: "GotenksZ" },
    // ‚îÄ‚îÄ ADICIONE NOVAS FUS√ïES ABAIXO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // { user: "CharA", partner: "CharB", item: "dance"|"potara", result: "FusedChar" },
];

function executeFusion(partnerKey) {
    if (!showFusionHUD || typeof showFusionHUD !== 'object') {
        showMessage("ERRO: DADOS DE FUS√ÉO INV√ÅLIDOS");
        return;
    }

    // Usa a userCharKey guardada no partner (pode diferir da skin atual ap√≥s transforma√ß√£o)
    const partnerEntry = (showFusionHUD.partners || []).find(p => p.partnerKey === partnerKey);
    const userCharKey  = partnerEntry?.userCharKey || showFusionHUD.userCharKey;
    const itemKey = showFusionHUD.itemKey;

    const check = canPerformFusion(userCharKey, partnerKey, itemKey);
    if (!check.possible) {
        showMessage(check.reason || "FUS√ÉO IMPOSS√çVEL");
        return;
    }

    const recipe = check.recipe;
    
    if (!charactersDB[recipe.result]) {
        showMessage("PERSONAGEM RESULTADO N√ÉO EXISTE");
        return;
    }

    if ((player.inventory[itemKey] || 0) <= 0) {
        showMessage("ITEM J√Å FOI CONSUMIDO");
        return;
    }

    playSound(700, 'sine', 0.3);
    setTimeout(() => playSound(900, 'sine', 0.6), 300);
    
    executeTransform(selectedPlayerChar, recipe.result, true);
    
    player.inventory[itemKey]--;
    
    showFusionHUD = false;
    save();
    
    battleLog = "FUS√ÉO COMPLETA: " + charactersDB[recipe.result].name + "!";
    playSound(1200, 'sine', 0.3);
}

function dealDamage(attacker, target, moveIndex, isPlayerAtk) {
    const move = attacker.moves[moveIndex];
    if (move.type === "bodyChange") {
        battleLog = "CHANGE NOW!!!"; screenFlash = 30;
        let tempSkin = attacker.currentSkin; attacker.currentSkin = target.currentSkin; target.currentSkin = tempSkin;
        let tempMoves = [...attacker.moves]; attacker.moves = [...target.moves]; target.moves = tempMoves;
        let tempHp = attacker.hp; attacker.hp = target.hp; target.hp = tempHp;
        let tempMaxHp = attacker.maxHp; attacker.maxHp = target.maxHp; target.maxHp = tempMaxHp;
        playSound(900, 'sawtooth', 0.8); spawnParticles(canvas.width/2, canvas.height/2, "#fff", 100, "explode");
        return;
    }

    let atkScale = isPlayerAtk
        ? (1 + (player.stats.atk * 0.05))
        : (isSurvivalMode
            ? (1 + survivalWave * 0.08) + (attacker.enemyPowerScale ? (attacker.enemyPowerScale - 1) * 0.3 : 0)
            : attacker.mirrorPlayerStats
                ? (1 + (player.stats.atk * 0.05))   // modo livre: mesmo atk que jogador
                : (1 + (attacker.enemyPowerScale ? (attacker.enemyPowerScale - 1) * 0.3 : 0)));

    let levelScale = isPlayerAtk
        ? (1 + player.level * 0.05)
        : (attacker.mirrorPlayerStats
            ? (1 + player.level * 0.05)              // modo livre: mesmo level que jogador
            : 1);

    let baseAmount = move.dmg * levelScale * atkScale * attacker.dmgMod;
    
    // ¬±15% damage variance
    let variance = 0.85 + Math.random() * 0.30;
    baseAmount *= variance;
    
    // ‚îÄ‚îÄ SISTEMA DE COMBO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if(isPlayerAtk && move.type !== "charge") {
        if(battleComboTimer > 0) {
            battleComboCount++;
        } else {
            battleComboCount = 1;
        }
        battleComboTimer = 90; // ~1.5 segundos para manter o combo
        // B√¥nus de combo: cada golpe consecutivo adiciona 5% dano
        let comboBonus = 1 + (battleComboCount - 1) * 0.05;
        if(battleComboCount >= 3) comboBonus += 0.1; // +10% a partir do 3¬∫
        if(battleComboCount >= 5) comboBonus += 0.15; // +15% extra a partir do 5¬∫
        baseAmount *= comboBonus;
        if(battleComboCount >= 3) {
            spawnFloatingText(canvas.width/2, 180, `COMBO x${battleComboCount}!`, "#f1c40f", 36);
        }
        // Carregar ultimate com ataques
        battleUltimateCharge = Math.min(100, battleUltimateCharge + (move.type === "physical" ? 8 : 12));
    }
    
    // ‚îÄ‚îÄ EVAS√ÉO (8% chance de esquivar ataques f√≠sicos) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if (move.type === "physical" && !isPlayerAtk) {
        let evadeChance = 0.08 + (selectedPlayerChar.ki >= 60 ? 0.04 : 0); // b√≥nus com ki alto
        if (Math.random() < evadeChance) {
            battleLog = "‚ö° ESQUIVOU!";
            spawnFloatingText(250, 280, "ESQUIVOU!", "#00ffcc", 38);
            spawnParticles(300, 420, "#00ffcc", 20, "hit");
            playSound(700, 'sine', 0.15);
            return;
        }
    }

    // ‚îÄ‚îÄ ESCUDO DE KI (se ki >= 80 e for turno inimigo, absorve 20% do dano) ‚îÄ
    if (!isPlayerAtk && selectedPlayerChar.ki >= 80) {
        baseAmount *= 0.80;
        selectedPlayerChar.ki = Math.max(0, selectedPlayerChar.ki - 15);
        spawnFloatingText(250, 310, "ESCUDO KI! -20%", "#3498db", 24);
    }    if(!isPlayerAtk && battleCounterWindow) {
        if(Math.random() < 0.3) {
            baseAmount *= 0.1; // quase nulo
            battleLog = "‚ö° CONTRA-ATAQUE!";
            // O jogador contra-ataca automaticamente
            let counterDmg = Math.floor(selectedPlayerChar.moves[0].dmg * 0.8);
            target.hp = Math.max(0, target.hp - counterDmg);
            spawnFloatingText(850, 200, `COUNTER! -${counterDmg}`, "#00ffaa", 42);
            spawnParticles(800, 400, "#00ffaa", 30, "hit");
            playSound(800, 'sine', 0.3);
            battleCounterWindow = false;
            battleCounterTimer = 0;
        }
    }
    
    // ‚îÄ‚îÄ ESQUIVA / BLOQUEIO DO INIMIGO (apenas quando jogador ataca) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if(isPlayerAtk && move.type !== "charge") {
        const hpRatioEnemy = target.hp / target.maxHp;

        // Chance de esquiva: base 8%, sobe se inimigo est√° em fase agressiva/berserk e tem ki alto
        let enemyDodgeChance = 0;
        let enemyBlockChance = 0;

        if(aiPhase === "BERSERK") {
            // Berserk: esquiva r√°pida com 18% de chance, sem bloquear (vai na bruta)
            enemyDodgeChance = 0.18;
            enemyBlockChance = 0.00;
        } else if(aiPhase === "AGGRESSIVE") {
            enemyDodgeChance = 0.12;
            enemyBlockChance = 0.10;
        } else if(aiPhase === "DEFENSIVE") {
            // Defensivo: bloqueia muito, esquiva pouco
            enemyDodgeChance = 0.06;
            enemyBlockChance = 0.28;
        } else if(aiPhase === "POWERING") {
            // Carregando KI: bloqueia para n√£o ser interrompido
            enemyDodgeChance = 0.04;
            enemyBlockChance = 0.20;
        } else {
            // Neutro
            enemyDodgeChance = 0.08;
            enemyBlockChance = 0.12;
        }

        // B√¥nus se o inimigo tem KI alto (reatividade sobrenatural)
        if(target.ki >= 70) {
            enemyDodgeChance += 0.06;
            enemyBlockChance += 0.05;
        }

        // HP baixo aumenta instinto de sobreviv√™ncia
        if(hpRatioEnemy < 0.25) {
            enemyDodgeChance += 0.08;
        }

        // Beams/esferas n√£o podem ser bloqueadas, s√≥ esquivadas (com penalidade)
        if(move.type === "beam" || move.type === "sphere") {
            enemyBlockChance = 0;
            enemyDodgeChance *= 0.6; // Mais dif√≠cil esquivar de proj√©til
        }

        const roll = Math.random();

        if(roll < enemyDodgeChance) {
            // INIMIGO ESQUIVOU
            battleLog = "üí® INIMIGO ESQUIVOU!";
            spawnFloatingText(870, 230, "ESQUIVOU!", "#00e5ff", 40);
            spawnParticles(900, 380, "#00e5ff", 18, "hit");
            playSound(750, 'sine', 0.15);
            enemyDodgeFlash = 14;
            target.animX = -30; // Recuo r√°pido do inimigo (efeito visual de esquiva)
            if(aiPhase === "BERSERK" || aiPhase === "AGGRESSIVE") {
                // Contra-ataque imediato se estava em modo agressivo
                const counterDmg = Math.floor(target.moves[0].dmg * 0.5 * (1 + (target.mirrorPlayerStats ? player.stats.atk * 0.05 : 0)));
                selectedPlayerChar.hp = Math.max(0, selectedPlayerChar.hp - counterDmg);
                spawnFloatingText(250, 200, `CONTRA! -${counterDmg}`, "#ff4444", 36);
                spawnParticles(250, 380, "#ff4444", 20, "hit");
                playSound(500, 'sawtooth', 0.25);
                shakeIntensity = 18;
            }
            atbPaused = false;
            return; // Dano cancelado
        } else if(roll < enemyDodgeChance + enemyBlockChance) {
            // INIMIGO BLOQUEOU ‚Äî reduz 65% do dano
            battleLog = "üõ° INIMIGO BLOQUEOU! -65% DANO";
            spawnFloatingText(870, 230, "BLOQUEOU!", "#f39c12", 40);
            spawnParticles(900, 380, "#f39c12", 15, "hit");
            playSound(180, 'square', 0.25);
            enemyShieldFlash = 18;
            baseAmount *= 0.35; // Passa apenas 35% do dano
        }
    }

    // 7% critical hit chance (2x damage)
    let isCritical = Math.random() < 0.07;
    if (isCritical) { baseAmount *= 2; }
    
    // ‚îÄ‚îÄ STATUS EFFECTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let statusKey = isPlayerAtk ? "enemy" : "player";
    let burnEffect = battleStatusEffects[statusKey].find(e=>e.type==="burn");
    if(burnEffect) baseAmount *= 1.15; // Queimado toma 15% mais dano
    
    if(target.isDefending) {
        baseAmount *= 0.3; battleLog = "DEFESA BEM SUCEDIDA! -70% DANO"; playSound(150, 'square', 0.2); target.isDefending = false;
        spawnParticles(isPlayerAtk ? 900 : 250, 380, "#2ecc71", 25, "hit");
    } else {
        battleLog = isCritical ? "‚ö° CR√çTICO! " + move.name : move.name;
        // Chance de aplicar burn em ataques de feixe
        if(move.type === "beam" && Math.random() < 0.15 && isPlayerAtk) {
            battleStatusEffects.enemy.push({type:"burn", duration:3, dmgPerTurn:Math.floor(baseAmount*0.1)});
            spawnFloatingText(900, 160, "üî• QUEIMADURA!", "#ff4500", 28);
        }
        // Chance de aplicar veneno em ataques esfera
        if(move.type === "sphere" && Math.random() < 0.20 && isPlayerAtk) {
            battleStatusEffects.enemy.push({type:"poison", duration:3});
            spawnFloatingText(900, 140, "‚ò† VENENO!", "#9b59b6", 28);
        }
        // Chance de atordoar em ataques f√≠sicos fortes
        if(move.type === "physical" && move.dmg > 100 && Math.random() < 0.1 && isPlayerAtk) {
            battleStatusEffects.enemy.push({type:"stun", duration:1});
            spawnFloatingText(900, 145, "‚ö° ATORDOADO!", "#f1c40f", 28);
        }
    }

    let amount = Math.floor(baseAmount);
    target.hp = Math.max(0, target.hp - amount);
    shakeIntensity = amount > 150 ? 40 : (amount > 60 ? 25 : 12);
    target.animX = isPlayerAtk ? 40 : -40;
    
    if(move.type === 'physical') attacker.animX = isPlayerAtk ? 150 : -150;
    let dmgColor = isCritical ? "#f1c40f" : (isPlayerAtk ? "#ff4757" : "#ff6b6b");
    if(battleComboCount >= 5 && isPlayerAtk) dmgColor = "#ff8c00"; // Combo alto = laranja
    spawnFloatingText(isPlayerAtk ? 850 : 250, isCritical ? 220 : 250, isCritical ? `‚ö°-${amount}!` : `-${amount}`, dmgColor, 60);
    
    // Part√≠culas melhoradas por tipo
    if (move.type === "beam") { 
        activeBeam = { isPlayer: isPlayerAtk, color: attacker.color, type: "beam", life: 28 }; 
        playSound(200, 'sawtooth', 0.4); 
        spawnParticles(isPlayerAtk ? 700 : 400, 380, attacker.color || "#00d2ff", 15, "charge");
    } else if (move.type === "sphere") { 
        activeBeam = { isPlayer: isPlayerAtk, color: attacker.color, type: "sphere", life: 38 }; 
        playSound(100, 'square', 0.5); 
        spawnParticles(canvas.width/2, 350, attacker.color || "#f1c40f", 30, "charge");
    } else { 
        playSound(isCritical ? 400 : 150, isCritical?'sine':'triangle', isCritical?0.3:0.1); 
        spawnParticles(isPlayerAtk ? 800 : 300, 400, isCritical?"#f1c40f":"#fff", isCritical?35:20, "hit"); 
    }
    
    // Flash de impacto cr√≠tico
    if(isCritical) { screenFlash = Math.max(screenFlash, 15); }
}

// Processar status effects no in√≠cio de cada turno
function processStatusEffects() {
    ["player","enemy"].forEach(side => {
        let char = side === "player" ? selectedPlayerChar : selectedEnemyChar;
        if(!char) return;
        let effects = battleStatusEffects[side];
        for(let i = effects.length-1; i >= 0; i--) {
            let e = effects[i];
            if(e.type === "burn") {
                char.hp = Math.max(0, char.hp - e.dmgPerTurn);
                spawnFloatingText(side==="enemy"?850:250, 270, `üî•-${e.dmgPerTurn}`, "#ff4500", 28);
            }
            if(e.type === "poison") {
                let poisonDmg = Math.floor(char.maxHp * 0.04);
                char.hp = Math.max(0, char.hp - poisonDmg);
                spawnFloatingText(side==="enemy"?850:250, 290, `‚ò†-${poisonDmg}`, "#9b59b6", 26);
            }
            if(e.type === "stun") {
                spawnFloatingText(side==="enemy"?850:250, 310, "‚ö°ATORDOADO", "#f1c40f", 24);
            }
            if(e.type === "boost") {
                // boost j√° foi aplicado, apenas indicador visual
            }
            e.duration--;
            if(e.duration <= 0) effects.splice(i, 1);
        }
    });
    // Decrementar combo timer
    if(battleComboTimer > 0) {
        battleComboTimer--;
        if(battleComboTimer === 0) battleComboCount = 0;
    }
    // ‚îÄ‚îÄ REGENERA√á√ÉO PASSIVA DE KI (+5 por turno para o jogador) ‚îÄ‚îÄ
    if(selectedPlayerChar) {
        let kiRegen = 5 + Math.floor(player.stats.ki * 0.5);
        selectedPlayerChar.ki = Math.min(100, selectedPlayerChar.ki + kiRegen);
    }
}

// ==========================================
// 5. RENDERIZA√á√ÉO
// ==========================================
function draw() {
    ctx.save();
    if(shakeIntensity > 0) { ctx.translate((Math.random()-0.5)*shakeIntensity, (Math.random()-0.5)*shakeIntensity); shakeIntensity *= 0.9; }
    ctx.imageSmoothingEnabled = false;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    uiPulse += 0.05; timeEnv += 0.01;

    switch(currentState) {
        case STATES.MENU: drawMenu(); break;
        case STATES.STORY_MENU: drawStoryMenu(); break;
        case STATES.SHOP: drawShop(); break;
        case STATES.CHAR_SELECT: drawCharSelect(); break;
        case STATES.BATTLE:
            // ‚îÄ‚îÄ ATB Update ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            if(!atbPaused && !qteActive && currentState === STATES.BATTLE && selectedPlayerChar && selectedEnemyChar
               && !showItemHUD && !showFusionHUD && !selectedPlayerChar.showTransHUD && !selectedPlayerChar.showAbsorbHUD) {
                // Avan√ßar barras
                if(!atbReady) {
                    atbPlayer = Math.min(100, atbPlayer + atbPlayerSpeed);
                    if(atbPlayer >= 100) { atbReady = true; battleLog = "‚ö° PRONTO PARA AGIR!"; playSound(600,'sine',0.08); }
                }
                atbEnemy = Math.min(100, atbEnemy + atbEnemySpeed);
                if(atbEnemy >= 100 && battleTurn === "PLAYER" && !qteActive) {
                    aiAction();
                }
                // Decrementar cooldowns (por frame)
                for(let i=0; i<moveCooldowns.length; i++) {
                    if(moveCooldowns[i] > 0) moveCooldowns[i]--;
                }
                if(aiTransformCooldown > 0) aiTransformCooldown--;
            }
            // ‚îÄ‚îÄ QTE Timeout ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            if(qteActive) {
                qteTimer--;
                if(qteTimer <= 0) resolveQTE(false); // tempo esgotado = falha
            }
            drawBattle();
            break;
        case STATES.STATS: drawStats(); break;
        case STATES.RANKING: drawRanking(); break;
        case STATES.NEWS: drawNews(); break;
        case STATES.DAILY_REWARD: drawDailyReward(); break;
        case STATES.DAILY_MISSIONS: drawDailyMissions(); break;
        case STATES.STAGE_SELECT: drawStageSelect(); break;
        case STATES.BATTLE_RESULT: drawBattleResult(); break;
        case STATES.ACHIEVEMENTS: drawAchievements(); break;
        case STATES.SUMMON: drawSummon(); break;
    }

    if (screenFlash > 0) { ctx.fillStyle = `rgba(255,255,255,${screenFlash*0.05})`; ctx.fillRect(0,0,canvas.width,canvas.height); screenFlash--; }
    updateEffects(); ctx.restore(); requestAnimationFrame(draw);
}

// PAINEL TEM√ÅTICO DRAGON BALL ‚Äî bordas douradas/laranja
function drawSparkPanel(x, y, w, h, color = UI_COLORS.panel, borderColor = UI_COLORS.border) {
    ctx.save(); 
    ctx.fillStyle = color; 
    const cut = 12;
    ctx.beginPath();
    ctx.moveTo(x + cut, y);
    ctx.lineTo(x + w - cut, y);
    ctx.lineTo(x + w, y + cut);
    ctx.lineTo(x + w, y + h - cut);
    ctx.lineTo(x + w - cut, y + h);
    ctx.lineTo(x + cut, y + h);
    ctx.lineTo(x, y + h - cut);
    ctx.lineTo(x, y + cut);
    ctx.closePath();
    ctx.fill();
    
    // Borda principal
    ctx.strokeStyle = borderColor; 
    ctx.lineWidth = 1.5; 
    ctx.stroke();
    
    // Gradiente interno sutil com tom quente
    let innerGrad = ctx.createLinearGradient(x, y, x, y+h);
    innerGrad.addColorStop(0, "rgba(255,140,0,0.06)"); 
    innerGrad.addColorStop(0.5, "rgba(0,0,0,0)");
    innerGrad.addColorStop(1, "rgba(0,0,0,0.55)");
    ctx.fillStyle = innerGrad; 
    ctx.fill(); 
    
    // Acento dourado nas bordas horizontais
    ctx.fillStyle = borderColor;
    ctx.globalAlpha = 0.8;
    ctx.fillRect(x + w/2 - 18, y, 36, 2);
    ctx.fillRect(x + w/2 - 18, y + h - 2, 36, 2);
    ctx.globalAlpha = 1;
    
    ctx.restore();
}

function drawMenu() {
    // Fundo com gradiente quente Dragon Ball
    let bgGrad = ctx.createRadialGradient(canvas.width*0.65, canvas.height*0.5, 30, canvas.width*0.65, canvas.height*0.5, 700);
    bgGrad.addColorStop(0, "#1a0800");
    bgGrad.addColorStop(0.4, "#100500");
    bgGrad.addColorStop(1, "#050200");
    ctx.fillStyle = bgGrad; ctx.fillRect(0,0,canvas.width,canvas.height);

    // Grid quente animada
    ctx.save();
    let gridOffset = (timeEnv * 18) % 50;
    ctx.strokeStyle = "rgba(255, 120, 0, 0.04)"; ctx.lineWidth = 1;
    for(let i=-50; i<canvas.width+50; i+=50) {
        ctx.beginPath(); ctx.moveTo(i+gridOffset*0.4, 0); ctx.lineTo(i+gridOffset*0.4, canvas.height); ctx.stroke();
    }
    for(let i=0; i<canvas.height; i+=50) {
        ctx.beginPath(); ctx.moveTo(0, i); ctx.lineTo(canvas.width, i); ctx.stroke();
    }
    ctx.restore();

    // Part√≠culas de energia Ki (laranja/dourado)
    ctx.save();
    for(let p of menuParticles) {
        p.x += p.vx; p.y += p.vy;
        p.alpha += 0.008;
        if(p.y < -5) { p.y = canvas.height + 5; p.x = Math.random()*canvas.width; p.alpha = 0; }
        if(p.alpha > 1) p.alpha = 0;
        let pulse = Math.abs(Math.sin(timeEnv * 2.5 + p.x * 0.008));
        ctx.globalAlpha = pulse * 0.65;
        ctx.shadowBlur = 10; ctx.shadowColor = p.color;
        ctx.fillStyle = p.color;
        ctx.beginPath(); ctx.arc(p.x, p.y, p.size * 1.2, 0, Math.PI*2); ctx.fill();
    }
    ctx.globalAlpha = 1; ctx.shadowBlur = 0;
    ctx.restore();

    // Esfera do Drag√£o ‚Äî decora√ß√£o central-direita
    ctx.save();
    ctx.translate(canvas.width - 240, canvas.height/2 - 10);
    // Orbe de Ki pulsante
    let orbPulse = 0.7 + Math.abs(Math.sin(timeEnv * 1.5)) * 0.3;
    let orbGrad = ctx.createRadialGradient(0, -20, 10, 0, 0, 200);
    orbGrad.addColorStop(0, `rgba(255,200,50,${orbPulse * 0.12})`);
    orbGrad.addColorStop(0.4, `rgba(255,120,0,${orbPulse * 0.07})`);
    orbGrad.addColorStop(1, "transparent");
    ctx.fillStyle = orbGrad; ctx.fillRect(-220, -230, 440, 460);
    // An√©is rotativos
    for(let ring = 0; ring < 3; ring++) {
        ctx.rotate(timeEnv * (0.15 + ring*0.08) * (ring%2===0?1:-1));
        let ringAlpha = 0.06 + ring * 0.025;
        ctx.strokeStyle = `rgba(245, 197, 24, ${ringAlpha})`;
        ctx.lineWidth = 12 - ring * 2;
        ctx.beginPath();
        ctx.arc(0, 0, 175 + ring * 38, 0, Math.PI * (1.3 + ring * 0.25));
        ctx.stroke();
        // Bolinha dourada na ponta
        ctx.fillStyle = `rgba(245, 197, 24, ${ringAlpha * 3})`;
        ctx.beginPath(); ctx.arc(175 + ring*38, 0, 5, 0, Math.PI*2); ctx.fill();
    }
    ctx.restore();

    // Linha decorativa lateral esquerda (quente)
    let lineGrad = ctx.createLinearGradient(58, 70, 58, canvas.height - 70);
    lineGrad.addColorStop(0, "transparent");
    lineGrad.addColorStop(0.3, "#ff8c00");
    lineGrad.addColorStop(0.7, "#f5c518");
    lineGrad.addColorStop(1, "transparent");
    ctx.fillStyle = lineGrad; ctx.fillRect(56, 70, 3, canvas.height - 140);
    // Linha fina paralela
    ctx.fillStyle = lineGrad; ctx.globalAlpha = 0.3; ctx.fillRect(62, 70, 1, canvas.height - 140); ctx.globalAlpha = 1;

    // ‚îÄ‚îÄ T√çTULO DRAGON DELUGE (grande, direita) ‚îÄ‚îÄ
    ctx.save();
    ctx.textAlign = "right";

    // "DRAGON" ‚Äî laranja de fogo
    ctx.font = "italic 92px Bangers";
    ctx.shadowBlur = 50; ctx.shadowColor = "rgba(255,100,0,0.5)";
    ctx.fillStyle = "rgba(255,80,0,0.1)";
    ctx.fillText("DRAGON", canvas.width - 72, 256);
    ctx.shadowBlur = 0;

    let t1 = ctx.createLinearGradient(canvas.width-580, 0, canvas.width-72, 0);
    t1.addColorStop(0, "#ff6600"); t1.addColorStop(0.5, "#ff9000"); t1.addColorStop(1, "#ffb040");
    ctx.fillStyle = t1;
    ctx.shadowBlur = 28; ctx.shadowColor = "#ff6600";
    ctx.fillText("DRAGON", canvas.width - 76, 252);

    // "DELUGE" ‚Äî dourado
    let t2 = ctx.createLinearGradient(canvas.width-580, 0, canvas.width-72, 0);
    t2.addColorStop(0, "#c08000"); t2.addColorStop(0.5, "#f5c518"); t2.addColorStop(1, "#ffe066");
    ctx.fillStyle = t2;
    ctx.shadowBlur = 32; ctx.shadowColor = "#f5c518";
    ctx.fillText("DELUGE", canvas.width - 76, 344);
    ctx.shadowBlur = 0;

    // Linha decorativa dourada
    ctx.fillStyle = "#f5c518";
    ctx.shadowBlur = 10; ctx.shadowColor = "#f5c518";
    ctx.fillRect(canvas.width - 510, 358, 430, 2);
    ctx.shadowBlur = 0;

    // Subt√≠tulo
    ctx.font = "bold 12px Rajdhani";
    ctx.fillStyle = "rgba(245,197,24,0.55)";
    ctx.fillText("‚óà PATRULHA DO TEMPO  ‚óà  CENTRO DE COMBATE ‚óà", canvas.width - 76, 382);
    ctx.restore();

    // ‚îÄ‚îÄ BOT√ïES DO MENU (2 colunas) ‚îÄ‚îÄ
    const btnW = 222, btnH = 46, btnGap = 9, colGap = 16;
    const col1X = 74, col2X = col1X + btnW + colGap;
    let c1y = 148, c2y = 148;

    // COLUNA 1: modos de jogo
    _drawMenuBtn(col1X, c1y, btnW, btnH, "‚öî  MODO HIST√ìRIA", UI_COLORS.success, "STORY"); c1y += btnH + btnGap;
    _drawMenuBtn(col1X, c1y, btnW, btnH, "ü•ä  MODO LIVRE", UI_COLORS.accent, "FREE"); c1y += btnH + btnGap;
    _drawMenuBtn(col1X, c1y, btnW, btnH, "üåä  SOBREVIV√äNCIA", "#e67e22", "SURV"); c1y += btnH + btnGap;
    _drawMenuBtn(col1X, c1y, btnW, btnH, "üèÜ  RANKING GLOBAL", "#9b59b6", "RANK"); c1y += btnH + btnGap;
    _drawMenuBtn(col1X, c1y, btnW, btnH, "üõí  LOJA Z", UI_COLORS.secondary, "SHOP", "#000"); c1y += btnH + btnGap;

    // Bot√£o SUMMON - Esferas do Drag√£o
    const dbCount = player.inventory["dragonballs"] || 0;
    const canSummon = dbCount >= 7;
    if(canSummon) {
        ctx.save(); ctx.shadowBlur = 28; ctx.shadowColor = "#f39c12";
        ctx.globalAlpha = 0.85 + 0.15 * Math.abs(Math.sin(timeEnv * 4));
        _drawMenuBtn(col1X, c1y, btnW, btnH, "üêâ  INVOCAR SHENLONG", "#f39c12", "SUMMON", "#000");
        ctx.globalAlpha = 1; ctx.shadowBlur = 0; ctx.restore();
    } else {
        const dbLabel = "‚≠ï ESFERAS: " + dbCount + "/7";
        _drawMenuBtn(col1X, c1y, btnW, btnH, dbLabel, "rgba(255,255,255,0.05)", "SUMMON_LOCKED");
    }
    c1y += btnH + btnGap;

    // COLUNA 2: utilit√°rios
    if(player.statPoints > 0) {
        ctx.save(); ctx.shadowBlur = 22; ctx.shadowColor = "#f5c518";
        _drawMenuBtn(col2X, c2y, btnW, btnH, `‚ö°  ATRIBUTOS  (+${player.statPoints})`, UI_COLORS.secondary, "STATS", "#000");
        ctx.globalAlpha = 0.5 + 0.5*Math.abs(Math.sin(timeEnv*5));
        ctx.fillStyle="#ff8c00"; ctx.font="bold 10px Rajdhani"; ctx.textAlign="left";
        ctx.fillText("NOVO!", col2X+btnW+8, c2y+28);
        ctx.globalAlpha=1; ctx.shadowBlur=0; ctx.restore();
    } else {
        _drawMenuBtn(col2X, c2y, btnW, btnH, "üìä  ATRIBUTOS", "rgba(255,255,255,0.08)", "STATS");
    }
    c2y += btnH + btnGap;

    // Miss√µes di√°rias
    const todayStr2 = new Date().toDateString();
    const dm = player.dailyMissions;
    const hasDM = dm && dm.date === todayStr2 && dm.missions && dm.missions.length > 0;
    const allDone = hasDM && dm.progress && dm.progress.filter(Boolean).length === dm.missions.length;
    if(hasDM && !allDone) {
        ctx.save(); ctx.shadowBlur = 18; ctx.shadowColor = UI_COLORS.ki;
        _drawMenuBtn(col2X, c2y, btnW, btnH, "üìã  MISS√ïES DI√ÅRIAS", UI_COLORS.ki, "DAILYM");
        ctx.restore();
    } else {
        _drawMenuBtn(col2X, c2y, btnW, btnH, "üìã  MISS√ïES DI√ÅRIAS", "rgba(255,255,255,0.08)", "DAILYM");
    }
    c2y += btnH + btnGap;

    // Conquistas
    _drawMenuBtn(col2X, c2y, btnW, btnH, "üèÖ  CONQUISTAS", "rgba(255,255,255,0.08)", "ACH");
    c2y += btnH + btnGap;

    // Recompensa di√°ria com destaque
    const today = new Date().toDateString();
    const hasReward = player.lastDailyReward !== today;
    if(hasReward) {
        ctx.save(); ctx.shadowBlur=24; ctx.shadowColor=UI_COLORS.secondary;
        _drawMenuBtn(col2X, c2y, btnW, btnH, "‚≠ê  RECOMPENSA DI√ÅRIA", UI_COLORS.secondary, "REWARD", "#000");
        ctx.globalAlpha=0.5+0.5*Math.abs(Math.sin(timeEnv*6));
        ctx.fillStyle="#ff8c00"; ctx.font="bold 10px Rajdhani"; ctx.textAlign="left";
        ctx.fillText("NOVO!", col2X+btnW+8, c2y+28);
        ctx.globalAlpha=1; ctx.shadowBlur=0; ctx.restore();
    } else {
        _drawMenuBtn(col2X, c2y, btnW, btnH, "RECOMPENSA DI√ÅRIA", "rgba(255,255,255,0.06)", "REWARD");
    }

    // ‚îÄ‚îÄ BARRA DE EXP ‚îÄ‚îÄ
    let expBarW = 415, expBarX = 38, expBarY = canvas.height - 96;
    ctx.fillStyle = "rgba(0,0,0,0.55)"; ctx.fillRect(expBarX-2, expBarY-2, expBarW+4, 16);
    ctx.fillStyle = "rgba(255,255,255,0.04)"; ctx.fillRect(expBarX, expBarY, expBarW, 12);

    let expPct = Math.min(1, player.exp / player.expToNext);
    let expGrad = ctx.createLinearGradient(expBarX, 0, expBarX+expBarW, 0);
    expGrad.addColorStop(0, "#c06000");
    expGrad.addColorStop(expPct, "#f5c518");
    expGrad.addColorStop(1, "rgba(245,197,24,0.08)");
    ctx.fillStyle = expGrad;
    ctx.shadowBlur = 10; ctx.shadowColor = "#f5c518";
    ctx.fillRect(expBarX, expBarY, expBarW * expPct, 12);
    ctx.shadowBlur = 0;
    // Brilho
    ctx.fillStyle="rgba(255,255,255,0.25)"; ctx.fillRect(expBarX, expBarY, expBarW*expPct, 4);

    ctx.font = "700 15px Rajdhani"; ctx.fillStyle = "#f5c518"; ctx.textAlign = "left";
    ctx.fillText(`N√çV ${player.level}  EXP: ${Math.floor(player.exp)} / ${Math.floor(player.expToNext)}`, expBarX, expBarY - 6);

    // Rodap√©
    const _footTitle = getPlayerTitle();
    ctx.fillStyle = "#ff8c00";
    ctx.fillText(`GUERREIRO: ${player.name.toUpperCase()}`, 38, canvas.height - 24);
    ctx.font = "italic bold 12px Oswald"; ctx.fillStyle = _footTitle.color;
    ctx.shadowBlur = 6; ctx.shadowColor = _footTitle.color;
    ctx.fillText(`[ ${_footTitle.name.toUpperCase()} ]`, 38, canvas.height - 9);
    ctx.shadowBlur = 0;
    ctx.textAlign = "right";
    ctx.fillStyle = UI_COLORS.secondary;
    ctx.font = "700 15px Rajdhani";
    ctx.fillText(`üí∞ ${player.zeni.toLocaleString()} ZENI`, canvas.width - 38, canvas.height - 24);
    ctx.font="11px Rajdhani"; ctx.fillStyle="rgba(255,255,255,0.18)";
    ctx.fillText("DRAGON DELUGE  v1.5.0", canvas.width-38, canvas.height-9);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SELE√á√ÉO DE CEN√ÅRIO ‚Äî MODO LIVRE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const STAGE_NAMES = ["TERRA","NAMEK","TORNEIO","ESPA√áO","INFERNO","CIDADE","C√ÇMARA DO TEMPO","PLANETA VEGETA","NAVE DO FREEZA","MUNDO DE BEERUS","CELL GAMES","MUNDO DOS KAIS","C√ÇMARA DARK","DESERTO","LAB DR.GERO","MUNDO SAIYAJIN","DIMENS√ÉO ZENO","CAMPO DESTRU√çDO"];
const STAGE_COLORS = ["#e67e22","#2ecc71","#95a5a6","#9b59b6","#e74c3c","#00d2ff","#4a90e2","#c0392b","#8e44ad","#f1c40f","#3498db","#27ae60","#1a1a2e","#d4a060","#3399ff","#aa44ff","#ff44aa","#ff8844"];
const STAGE_ICONS = ["üåç","üåø","üèü","üåå","üî•","üèô","‚è≥","üí¢","üöÄ","‚ö°","‚ò†","üåü","üåë","üèú","üî¨","ü™ê","üëë","üí•"];

function drawStageSelect() {
    // Fundo quente
    let bg = ctx.createRadialGradient(canvas.width/2, canvas.height/2, 50, canvas.width/2, canvas.height/2, 700);
    bg.addColorStop(0, "#120500"); bg.addColorStop(1, "#040100");
    ctx.fillStyle = bg; ctx.fillRect(0,0,canvas.width,canvas.height);

    // Grid quente
    ctx.strokeStyle = "rgba(255, 140, 0, 0.04)"; ctx.lineWidth = 1;
    for(let i=0;i<canvas.width;i+=50){ctx.beginPath();ctx.moveTo(i,0);ctx.lineTo(i,canvas.height);ctx.stroke();}
    for(let i=0;i<canvas.height;i+=50){ctx.beginPath();ctx.moveTo(0,i);ctx.lineTo(canvas.width,i);ctx.stroke();}

    // T√≠tulo
    ctx.font = "italic 46px Bangers"; ctx.fillStyle = "#f5c518"; ctx.textAlign = "center";
    ctx.shadowBlur = 18; ctx.shadowColor = "#ff8c00";
    ctx.fillText("üåç SELECIONAR CEN√ÅRIO DE BATALHA", canvas.width/2, 62);
    ctx.shadowBlur = 0;
    ctx.fillStyle = "#ff8c00"; ctx.fillRect(canvas.width/2 - 240, 72, 480, 2);
    ctx.font = "bold 13px Rajdhani"; ctx.fillStyle = "rgba(245,197,24,0.55)";
    ctx.fillText("ESCOLHA O PALCO ANTES DE SELECIONAR OS LUTADORES", canvas.width/2, 92);

    // Pr√©-render do cen√°rio selecionado (thumbnail)
    const stages = BATTLE_STAGES.length;
    const cols = 5;
    const cardW = 180, cardH = 120, gapX = 24, gapY = 18;
    const totalW = Math.min(stages, cols) * (cardW + gapX) - gapX;
    const startX = (canvas.width - totalW) / 2;
    const startY = 115;

    for(let i = 0; i < stages; i++) {
        const col = i % cols;
        const row = Math.floor(i / cols);
        const cx = startX + col * (cardW + gapX);
        const cy = startY + row * (cardH + gapY);
        const hov = mouse.x > cx && mouse.x < cx+cardW && mouse.y > cy && mouse.y < cy+cardH;
        const selected = selectedFreeBattleStage === i;
        stageSelectHover = hov ? i : (hov ? i : stageSelectHover);

        const stageColor = STAGE_COLORS[i] || "#00d2ff";

        // Card background
        ctx.save();
        if(selected || hov) {
            ctx.shadowBlur = 20; ctx.shadowColor = stageColor;
        }
        ctx.fillStyle = selected ? `${stageColor}33` : (hov ? "rgba(30,12,0,0.95)" : "rgba(12,4,0,0.92)");
        const cut2 = 8;
        ctx.beginPath();
        ctx.moveTo(cx+cut2,cy); ctx.lineTo(cx+cardW-cut2,cy); ctx.lineTo(cx+cardW,cy+cut2);
        ctx.lineTo(cx+cardW,cy+cardH-cut2); ctx.lineTo(cx+cardW-cut2,cy+cardH);
        ctx.lineTo(cx+cut2,cy+cardH); ctx.lineTo(cx,cy+cardH-cut2); ctx.lineTo(cx,cy+cut2);
        ctx.closePath(); ctx.fill();
        ctx.strokeStyle = selected ? stageColor : (hov ? `${stageColor}99` : "rgba(245,197,24,0.22)");
        ctx.lineWidth = selected ? 2.5 : 1.2; ctx.stroke();
        ctx.shadowBlur = 0;

        // Mini preview do cen√°rio (desenha num offscreen)
        ctx.save();
        ctx.beginPath();
        ctx.moveTo(cx+cut2,cy); ctx.lineTo(cx+cardW-cut2,cy); ctx.lineTo(cx+cardW,cy+cut2);
        ctx.lineTo(cx+cardW,cy+cardH-40); ctx.lineTo(cx+cardW-cut2,cy+cardH-40);
        ctx.lineTo(cx+cut2,cy+cardH-40); ctx.lineTo(cx,cy+cardH-40); ctx.lineTo(cx,cy+cut2);
        ctx.closePath(); ctx.clip();
        ctx.save();
        ctx.translate(cx, cy);
        ctx.scale(cardW/canvas.width, (cardH-40)/canvas.height);
        BATTLE_STAGES[i] && BATTLE_STAGES[i]();
        ctx.restore();
        ctx.restore();

        // Nome do cen√°rio
        ctx.fillStyle = "rgba(0,0,0,0.7)";
        ctx.fillRect(cx, cy+cardH-38, cardW, 38);
        ctx.fillStyle = selected ? stageColor : (hov ? "#fff" : "rgba(255,255,255,0.75)");
        ctx.font = "bold 13px Rajdhani"; ctx.textAlign = "center";
        ctx.fillText((STAGE_ICONS[i]||"") + "  " + (STAGE_NAMES[i] || `CEN√ÅRIO ${i+1}`), cx+cardW/2, cy+cardH-20);

        // Badge selecionado
        if(selected) {
            ctx.fillStyle = stageColor;
            ctx.font = "bold 11px Rajdhani";
            ctx.fillText("‚ñº SELECIONADO", cx+cardW/2, cy+cardH-6);
        }
        ctx.restore();
    }

    // Painel de info do cen√°rio selecionado
    const infoY = startY + Math.ceil(stages/cols) * (cardH+gapY) + 10;
    if(infoY < canvas.height - 90) {
        const selColor = STAGE_COLORS[selectedFreeBattleStage] || "#00d2ff";
        drawSparkPanel(canvas.width/2 - 250, infoY, 500, 55, `${selColor}22`, selColor);
        ctx.font = "bold 20px Oswald"; ctx.fillStyle = selColor; ctx.textAlign = "center";
        ctx.fillText(`${STAGE_ICONS[selectedFreeBattleStage]||""}  ${STAGE_NAMES[selectedFreeBattleStage]||"CEN√ÅRIO"}  ‚Äî  SELECIONADO`, canvas.width/2, infoY+34);
    }

    // Bot√µes de a√ß√£o
    const btnY2 = canvas.height - 68;
    drawSparkBtn(20, btnY2, 180, 48, "‚óÄ VOLTAR", UI_COLORS.danger);
    ctx.save(); ctx.shadowBlur=15; ctx.shadowColor=UI_COLORS.accent;
    drawSparkBtn(canvas.width/2 - 130, btnY2, 260, 48, "CONFIRMAR CEN√ÅRIO ‚ñ∂", UI_COLORS.accent);
    ctx.shadowBlur=0; ctx.restore();
}

// Bot√£o de menu ‚Äî estilo Dragon Ball com borda quente
function _drawMenuBtn(x, y, w, h, txt, bg, id, textCol = "#fff") {
    let hov = mouse.x > x && mouse.x < x + w && mouse.y > y && mouse.y < y + h;
    ctx.save();
    if(hov) { ctx.shadowBlur = 22; ctx.shadowColor = bg === "rgba(255,255,255,0.1)" || bg === "rgba(255,255,255,0.08)" || bg === "rgba(255,255,255,0.06)" ? "#ff8c00" : bg; }

    const cut = 14;
    if(hov) {
        let hg = ctx.createLinearGradient(x, y, x+w, y+h);
        hg.addColorStop(0, "#fff8e0"); hg.addColorStop(1, "#ffe060");
        ctx.fillStyle = hg;
    } else {
        let bg2 = ctx.createLinearGradient(x, y, x, y+h);
        bg2.addColorStop(0, bg);
        bg2.addColorStop(1, "rgba(0,0,0,0.65)");
        ctx.fillStyle = bg2;
    }

    ctx.beginPath();
    ctx.moveTo(x+cut, y); ctx.lineTo(x+w, y);
    ctx.lineTo(x+w-cut, y+h); ctx.lineTo(x, y+h);
    ctx.closePath(); ctx.fill();
    ctx.shadowBlur = 0;

    // Reflexo quente no topo
    if(!hov && bg !== "rgba(255,255,255,0.1)" && bg !== "rgba(255,255,255,0.08)" && bg !== "rgba(255,255,255,0.06)") {
        ctx.fillStyle = "rgba(255,255,255,0.16)";
        ctx.beginPath();
        ctx.moveTo(x+cut, y); ctx.lineTo(x+w, y);
        ctx.lineTo(x+w-5, y+h/2); ctx.lineTo(x+5, y+h/2);
        ctx.closePath(); ctx.fill();
    }

    ctx.strokeStyle = hov ? "rgba(180,130,0,0.5)" : "rgba(255,200,100,0.15)";
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(x+cut, y); ctx.lineTo(x+w, y);
    ctx.lineTo(x+w-cut, y+h); ctx.lineTo(x, y+h);
    ctx.closePath(); ctx.stroke();

    ctx.font = "bold 19px Rajdhani"; ctx.textAlign = "center";
    ctx.fillStyle = hov ? "#3a1800" : textCol;
    ctx.fillText(txt.toUpperCase(), x+w/2, y+h/2+7);

    if(hov) {
        ctx.fillStyle = bg === "rgba(255,255,255,0.1)" || bg === "rgba(255,255,255,0.08)" || bg === "rgba(255,255,255,0.06)" ? "#ff8c00" : bg;
        ctx.fillRect(x+cut+5, y+h-4, w-cut*2-10, 2);
    }

    ctx.restore();
}


function drawRanking() {
    ctx.fillStyle = "#080300"; ctx.fillRect(0,0,canvas.width,canvas.height);
    
    // Grelha quente
    ctx.strokeStyle = "rgba(245, 197, 24, 0.04)"; ctx.lineWidth = 1;
    for(let i=0; i<canvas.height; i+=40) { ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(canvas.width,i); ctx.stroke(); }

    ctx.font = "italic 46px Bangers"; ctx.fillStyle = "#f5c518"; ctx.textAlign = "center";
    ctx.shadowBlur = 20; ctx.shadowColor = "#ff8c00";
    ctx.fillText("üèÜ RANKING GLOBAL ‚Äî MELHORES GUERREIROS", canvas.width/2, 76);
    ctx.shadowBlur = 0;
    ctx.fillStyle = "#ff8c00"; ctx.fillRect(canvas.width/2 - 300, 84, 600, 2);

    if(!leaderboardData || leaderboardData.length === 0) {
        ctx.font = "bold 24px Rajdhani"; ctx.fillStyle = UI_COLORS.accent;
        ctx.fillText("A CARREGAR DADOS DA REDE...", canvas.width/2, canvas.height/2);
    } else {
        let listX = 150, listY = 120, itemW = 800, itemH = 60, gap = 15;
        let maxS = getMaxScroll(leaderboardData.length, 1, itemH, gap, canvas.height - 250);
        targetRankingScrollY = Math.max(maxS, Math.min(0, targetRankingScrollY));

        ctx.save();
        ctx.beginPath(); ctx.rect(listX, listY, itemW + 40, canvas.height - 250); ctx.clip();

        leaderboardData.forEach((entry, i) => {
            let y = listY + i * (itemH + gap) + rankingScrollY;
            let isMe = fbUser && entry.id === fbUser.uid;
            
            let bgColor = isMe ? "rgba(46, 204, 113, 0.2)" : UI_COLORS.panel;
            let borderColor = isMe ? UI_COLORS.success : UI_COLORS.accent;
            
            drawSparkPanel(listX, y, itemW, itemH, bgColor, borderColor);
            
            let rankColor = i === 0 ? "#f1c40f" : (i === 1 ? "#bdc3c7" : (i === 2 ? "#cd7f32" : (isMe ? UI_COLORS.success : "#fff")));
            ctx.font = "bold 26px Rajdhani"; ctx.fillStyle = rankColor; ctx.textAlign = "left";
            ctx.fillText(`#${i + 1}  ${entry.name.toUpperCase()}`, listX + 20, y + 38);
            
            ctx.font = "bold 22px Rajdhani"; ctx.fillStyle = UI_COLORS.secondary; ctx.textAlign = "center";
            ctx.fillText(`LVL ${entry.level}`, listX + 450, y + 38);
            
            ctx.fillStyle = UI_COLORS.danger; ctx.textAlign = "right";
            ctx.fillText(`ONDA M√ÅX: ${entry.maxSurvival || 0}`, listX + itemW - 20, y + 38);
        });
        drawScrollbar(listX + itemW + 10, listY, canvas.height - 250, rankingScrollY, maxS);
        ctx.restore();
    }

    drawSparkBtn(canvas.width/2 - 100, canvas.height - 80, 200, 50, "VOLTAR", UI_COLORS.danger);
}

function drawStats() {
    ctx.fillStyle = "#080300"; ctx.fillRect(0,0,canvas.width,canvas.height);
    
    // Grelha quente
    ctx.strokeStyle = "rgba(255, 140, 0, 0.04)"; ctx.lineWidth = 1;
    for(let i=0; i<canvas.height; i+=40) { ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(canvas.width,i); ctx.stroke(); }

    ctx.font = "italic 46px Bangers"; ctx.fillStyle = "#f5c518"; ctx.textAlign = "center";
    ctx.shadowBlur = 15; ctx.shadowColor = "#ff8c00";
    ctx.fillText("‚ö° DISTRIBUI√á√ÉO DE ATRIBUTOS", canvas.width/2, 76);
    ctx.shadowBlur = 0;
    ctx.fillStyle = "#ff8c00"; ctx.fillRect(canvas.width/2 - 250, 84, 500, 2);
    
    ctx.font = "bold 22px Rajdhani"; ctx.fillStyle = UI_COLORS.secondary;
    ctx.fillText(`PONTOS DISPON√çVEIS: ${player.statPoints}`, canvas.width/2, 128);

    let sx = canvas.width/2 - 300;
    
    // Fios Condutores (Sci-Fi) entre pain√©is
    ctx.strokeStyle = "rgba(255,255,255,0.1)"; ctx.lineWidth = 4;
    ctx.beginPath(); ctx.moveTo(sx + 90, 280); ctx.lineTo(sx + 510, 280); ctx.stroke();

    // HP Panel
    drawSparkPanel(sx, 180, 180, 200, "rgba(46, 204, 113, 0.1)", UI_COLORS.success);
    ctx.fillStyle = UI_COLORS.success; ctx.fillText("VITALIDADE (HP)", sx+90, 220);
    ctx.fillStyle = "#fff"; ctx.font = "bold 40px Oswald"; ctx.fillText(player.stats.hp, sx+90, 280);
    ctx.font = "16px Rajdhani"; ctx.fillStyle = "#aaa"; ctx.fillText("+5% Vida M√°xima", sx+90, 310);
    drawSparkBtn(sx+20, 330, 140, 40, "MELHORAR", player.statPoints > 0 ? UI_COLORS.success : "#555");

    // ATK Panel
    drawSparkPanel(sx+210, 180, 180, 200, "rgba(255, 71, 87, 0.1)", UI_COLORS.danger);
    ctx.fillStyle = UI_COLORS.danger; ctx.font = "bold 24px Rajdhani"; ctx.fillText("FOR√áA (ATK)", sx+300, 220);
    ctx.fillStyle = "#fff"; ctx.font = "bold 40px Oswald"; ctx.fillText(player.stats.atk, sx+300, 280);
    ctx.font = "16px Rajdhani"; ctx.fillStyle = "#aaa"; ctx.fillText("+5% Dano Base", sx+300, 310);
    drawSparkBtn(sx+230, 330, 140, 40, "MELHORAR", player.statPoints > 0 ? UI_COLORS.danger : "#555");

    // KI Panel
    drawSparkPanel(sx+420, 180, 180, 200, "rgba(52, 152, 219, 0.1)", UI_COLORS.ki);
    ctx.fillStyle = UI_COLORS.ki; ctx.font = "bold 24px Rajdhani"; ctx.fillText("ENERGIA (KI)", sx+510, 220);
    ctx.fillStyle = "#fff"; ctx.font = "bold 40px Oswald"; ctx.fillText(player.stats.ki, sx+510, 280);
    ctx.font = "16px Rajdhani"; ctx.fillStyle = "#aaa"; ctx.fillText("+10 Ki Inicial", sx+510, 310);
    drawSparkBtn(sx+440, 330, 140, 40, "MELHORAR", player.statPoints > 0 ? UI_COLORS.ki : "#555");

    drawSparkBtn(canvas.width/2 - 100, 480, 200, 50, "VOLTAR", UI_COLORS.danger);
}

function drawStoryMenu() {
    ctx.fillStyle = "#060200"; ctx.fillRect(0,0,canvas.width,canvas.height);
    
    // Fundo com grelha quente
    ctx.strokeStyle = "rgba(255,140,0,0.03)"; ctx.lineWidth = 1;
    for(let i=0; i<canvas.width; i+=50){ ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,canvas.height); ctx.stroke(); }
    for(let i=0; i<canvas.height; i+=50){ ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(canvas.width,i); ctx.stroke(); }

    // Header
    ctx.font = "italic 44px Bangers"; ctx.fillStyle = "#f5c518"; ctx.textAlign = "left";
    ctx.shadowBlur = 12; ctx.shadowColor = "#ff8c00";
    ctx.fillText("‚öî MODO HIST√ìRIA", 28, 58);
    ctx.shadowBlur = 0;
    ctx.fillStyle = UI_COLORS.success; ctx.fillRect(28, 66, 340, 2);

    let availableMissions = Math.min(player.storyProgress + 1, STORY_SEQUENCE.length);
    ctx.font = "bold 14px Rajdhani"; ctx.fillStyle = "#aaa"; ctx.textAlign = "left";
    ctx.fillText(`MISS√ïES DESBLOQUEADAS: ${availableMissions} / ${STORY_SEQUENCE.length}   ¬∑   PROGRESSO: ${player.storyProgress}/${STORY_SEQUENCE.length}`, 30, 90);
    
    // ‚îÄ‚îÄ LISTA DE MISS√ïES (esquerda) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const listX = 20, listY = 110, listW = 440, listH = canvas.height - 200;
    const itemH = 56, gap = 8;
    
    // Calcular total de itens (miss√µes + cabe√ßalhos de saga)
    // Agrupar por saga para calcular alturas corretas
    let listItems = []; // { type: 'mission'|'saga', index, title, y }
    let lastSaga = null;
    for(let i = 0; i < availableMissions; i++) {
        let m = STORY_SEQUENCE[i];
        if(m.title && m.title !== lastSaga) {
            lastSaga = m.title;
            listItems.push({ type:'saga', label: m.title });
        }
        listItems.push({ type:'mission', missionIndex: i });
    }
    
    const sagaH = 36;
    let totalListH = listItems.reduce((s,item) => s + (item.type==='saga' ? sagaH+4 : itemH+gap), 0);
    let maxS = totalListH > listH ? -(totalListH - listH + gap) : 0;
    targetStoryScrollY = Math.max(maxS, Math.min(0, targetStoryScrollY));

    // Painel de fundo da lista
    ctx.fillStyle = "rgba(0,15,8,0.85)";
    ctx.fillRect(listX, listY, listW, listH);
    ctx.strokeStyle = "rgba(46,204,113,0.3)"; ctx.lineWidth = 1;
    ctx.strokeRect(listX, listY, listW, listH);

    ctx.save();
    ctx.beginPath(); ctx.rect(listX, listY, listW, listH); ctx.clip();
    
    let curY = listY + storyScrollY;
    listItems.forEach(item => {
        if(item.type === 'saga') {
            // Cabe√ßalho de saga
            let vy = curY;
            ctx.fillStyle = "rgba(46,204,113,0.12)";
            ctx.fillRect(listX + 2, vy, listW - 4, sagaH);
            ctx.fillStyle = "#2ecc71"; ctx.font = "bold 13px Rajdhani"; ctx.textAlign = "left";
            ctx.fillText("‚ñ∏ " + item.label, listX + 14, vy + sagaH/2 + 5);
            ctx.fillStyle = "rgba(46,204,113,0.4)";
            ctx.fillRect(listX + 2, vy + sagaH - 1, listW - 4, 1);
            curY += sagaH + 4;
        } else {
            let i = item.missionIndex;
            let m = STORY_SEQUENCE[i];
            let isSelected = (i === selectedMissionIndex);
            let inClip = curY + itemH > listY && curY < listY + listH;
            
            if(inClip) {
                // Fundo do item
                if(isSelected) {
                    let sg = ctx.createLinearGradient(listX+2, curY, listX+listW-2, curY);
                    sg.addColorStop(0, "rgba(46,204,113,0.35)");
                    sg.addColorStop(1, "rgba(46,204,113,0.08)");
                    ctx.fillStyle = sg;
                } else {
                    ctx.fillStyle = "rgba(255,255,255,0.03)";
                }
                ctx.fillRect(listX+2, curY, listW-4, itemH);
                
                if(isSelected) {
                    ctx.fillStyle = UI_COLORS.success; ctx.fillRect(listX+2, curY, 4, itemH);
                }
                
                // N√∫mero da miss√£o
                ctx.font = "bold 11px Rajdhani"; ctx.fillStyle = isSelected ? "#2ecc71" : "#555"; ctx.textAlign = "right";
                ctx.fillText(`#${i+1}`, listX + 38, curY + itemH/2 + 4);
                
                // Nome do inimigo
                let eChar = charactersDB[m.enemy];
                ctx.font = (isSelected ? "bold " : "") + "18px Rajdhani"; 
                ctx.fillStyle = isSelected ? "#fff" : "#ccc"; ctx.textAlign = "left";
                ctx.fillText(eChar ? eChar.name : m.enemy, listX + 48, curY + 22);
                
                // Recompensas mini
                ctx.font = "12px Rajdhani"; ctx.fillStyle = "#f1c40f";
                ctx.fillText(`${m.zeniReward||0}Z`, listX + 48, curY + 42);
                ctx.fillStyle = "#9b59b6";
                ctx.fillText(`${m.expReward||0}EXP`, listX + 100, curY + 42);
                
                // HP do inimigo
                ctx.font = "12px Rajdhani"; ctx.fillStyle = "#e74c3c"; ctx.textAlign = "right";
                ctx.fillText(`HP: ${eChar ? eChar.maxHp : '?'}`, listX + listW - 12, curY + 42);
                
                // Status de conclus√£o
                if(i < player.storyProgress) {
                    ctx.fillStyle = "#2ecc71"; ctx.font = "bold 18px Rajdhani"; ctx.textAlign = "right";
                    ctx.fillText("‚úì", listX + listW - 12, curY + 24);
                }
                
                // Separador
                ctx.fillStyle = "rgba(255,255,255,0.05)";
                ctx.fillRect(listX+2, curY + itemH, listW-4, 1);
            }
            curY += itemH + gap;
        }
    });
    
    drawScrollbar(listX + listW - 8, listY + 4, listH - 8, storyScrollY, maxS);
    ctx.restore();

    // ‚îÄ‚îÄ PAINEL DE DETALHES (direita) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const detX = listX + listW + 20, detW = canvas.width - detX - 20;
    let mission = STORY_SEQUENCE[selectedMissionIndex];
    let enemyKey = mission ? mission.enemy : null;
    let enemyChar = enemyKey ? charactersDB[enemyKey] : null;
    
    // Fundo do painel
    drawSparkPanel(detX, listY, detW, listH, "rgba(0,20,10,0.85)", UI_COLORS.success);
    
    if(enemyChar && enemyKey) {
        // Sprite grande do inimigo (fundo)
        ctx.save(); ctx.globalAlpha = 0.18;
        let basePScale = (enemyChar.previewScale || 6.0) * 1.1;
        drawSprite({ originalKey: enemyKey, aura: enemyChar.aura }, detX + detW/2 + 60, listY + listH - 20, true, basePScale, enemyKey, true);
        ctx.globalAlpha = 1; ctx.restore();
        
        // Sprite vis√≠vel
        drawSprite({ originalKey: enemyKey, aura: enemyChar.aura }, detX + detW/2 + 60, listY + listH - 20, true, basePScale * 0.85, enemyKey, true);
        
        // Info da miss√£o
        ctx.textAlign = "left";
        
        // Saga / N√∫mero
        let sagaLabel = mission.title || "";
        if(sagaLabel) {
            ctx.font = "bold 12px Rajdhani"; ctx.fillStyle = "#2ecc71";
            ctx.fillText("‚óà " + sagaLabel.toUpperCase(), detX + 20, listY + 38);
        }
        ctx.font = "italic 32px Oswald"; ctx.fillStyle = "#fff";
        ctx.fillText("MISS√ÉO " + (selectedMissionIndex+1), detX + 20, listY + 72);
        
        // Nome do inimigo
        ctx.font = "bold 22px Rajdhani"; ctx.fillStyle = "#fff";
        ctx.fillText(enemyChar.name, detX + 20, listY + 102);
        
        // Linha decorativa
        ctx.fillStyle = "#2ecc71"; ctx.fillRect(detX + 20, listY + 110, detW - 40, 2);
        
        // Stats do inimigo
        let sy = listY + 132;
        const statLine = (label, val, color) => {
            ctx.font = "14px Rajdhani"; ctx.fillStyle = "#777"; ctx.fillText(label, detX+20, sy);
            ctx.font = "bold 18px Rajdhani"; ctx.fillStyle = color; ctx.fillText(val, detX+150, sy);
            sy += 26;
        };
        statLine("VITALIDADE:", enemyChar.maxHp + " HP", "#e74c3c");
        statLine("RECOMPENSA:", (mission.zeniReward||800) + " ZENI", "#f1c40f");
        statLine("EXPERI√äNCIA:", "+" + (mission.expReward||50) + " EXP", "#9b59b6");
        
        let stageNames = ['TERRA','NAMEK','TORNEIO','ESPA√áO','INFERNO','CIDADE','C√ÇMARA DO TEMPO','PLANETA VEGETA','NAVE DO FREEZA','MUNDO DO BEERUS','ARENA CELL GAMES','MUNDO DOS KAIS','C√ÇMARA DARK','DESERTO','LAB DR.GERO','MUNDO SAIYAJIN','DIMENS√ÉO ZENO','CAMPO DESTRU√çDO'];
        let stageIdx = mission.stage !== undefined ? mission.stage : 0;
        statLine("CEN√ÅRIO:", stageNames[stageIdx] || "ALEAT√ìRIO", "#00d2ff");
        
        // Status
        let statusText = selectedMissionIndex < player.storyProgress ? "‚úì CONCLU√çDA" : selectedMissionIndex === player.storyProgress ? "DISPON√çVEL" : "BLOQUEADA";
        let statusColor = selectedMissionIndex < player.storyProgress ? "#2ecc71" : selectedMissionIndex === player.storyProgress ? "#f1c40f" : "#555";
        statLine("STATUS:", statusText, statusColor);
        
        // Movimentos do inimigo
        sy += 8;
        ctx.font = "bold 12px Rajdhani"; ctx.fillStyle = "#2ecc71"; ctx.textAlign = "left";
        ctx.fillText("HABILIDADES DO ADVERS√ÅRIO:", detX + 20, sy); sy += 20;
        (enemyChar.moves || []).slice(0,4).forEach(mv => {
            ctx.font = "12px Rajdhani"; ctx.fillStyle = "#aaa";
            ctx.fillText(`¬∑ ${mv.name} (${mv.dmg} DMG)`, detX + 24, sy); sy += 18;
        });
        
        // Bot√£o INICIAR (sempre vis√≠vel no rodap√© do painel)
        const btnY = listY + listH - 80;
        drawSparkBtn(detX + 20, btnY, detW - 40, 55, "‚ñ∂  INICIAR MISS√ÉO", UI_COLORS.success);
    }
    
    // Progresso total
    let progPct = STORY_SEQUENCE.length > 0 ? player.storyProgress / STORY_SEQUENCE.length : 0;
    ctx.fillStyle = "rgba(255,255,255,0.08)";
    ctx.fillRect(listX, listY + listH + 12, listW + detW + 20, 16);
    ctx.fillStyle = UI_COLORS.success;
    ctx.fillRect(listX, listY + listH + 12, (listW + detW + 20) * progPct, 16);
    ctx.font = "bold 12px Rajdhani"; ctx.fillStyle = "#aaa"; ctx.textAlign = "center";
    ctx.fillText(`PROGRESSO GERAL: ${player.storyProgress}/${STORY_SEQUENCE.length} MISS√ïES`, canvas.width/2, listY + listH + 44);
    
    drawSparkBtn(20, canvas.height - 68, 180, 48, "VOLTAR", UI_COLORS.danger);
}

function drawShop() {
    const W = canvas.width, H = canvas.height;

    // Fundo gradiente premium
    let shopBg = ctx.createRadialGradient(W/2, H/2, 50, W/2, H/2, 700);
    shopBg.addColorStop(0, "#0a0500"); shopBg.addColorStop(1, "#020100");
    ctx.fillStyle = shopBg; ctx.fillRect(0, 0, W, H);

    // Grade sutil dourada
    ctx.strokeStyle = "rgba(245,197,24,0.025)"; ctx.lineWidth = 1;
    for(let i=0; i<W; i+=50) { ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,H); ctx.stroke(); }
    for(let i=0; i<H; i+=50) { ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(W,i); ctx.stroke(); }

    // === √ÅREA DE CONTE√öDO (com clip) ===
    ctx.save();
    ctx.beginPath(); ctx.rect(0, 158, W, H - 255); ctx.clip();

    if (shopTab === "CHARS") {
        // Personagens como cards ‚Äî igual √†s outras abas
        let keys = Object.keys(charactersDB).filter(k => !charactersDB[k].isTransformation && !charactersDB[k].isCostume && !charactersDB[k].hidden);
        let color = UI_COLORS.accent; // cyan para personagens

        const iCols = 4, iW = 240, iH = 195, iGapX = 20, iGapY = 20;
        const iStartX = (W - (iCols * iW + (iCols-1)*iGapX)) / 2;
        const iStartY = 168;

        let maxS = getMaxScroll(keys.length, iCols, iH, iGapY, H - 255);
        targetShopScrollY = Math.max(maxS, Math.min(0, targetShopScrollY));

        keys.forEach((key, i) => {
            let col = i % iCols; let row = Math.floor(i / iCols);
            let x = iStartX + col * (iW + iGapX);
            let y = iStartY + row * (iH + iGapY) + shopScrollY;
            let inClip = mouse.y > 158 && mouse.y < H - 97;
            let hov = inClip && mouse.x > x && mouse.x < x+iW && mouse.y > y && mouse.y < y+iH;

            let char = charactersDB[key];
            let price = char?.price;
            let name = char?.name;
            let isOwned = isUnlocked(key, "CHAR");
            let canAfford = !isOwned && price !== undefined && player.zeni >= price;
            let isFree = price === undefined || price === 0;

            ctx.save();

            if(hov) { ctx.shadowBlur = 25; ctx.shadowColor = isOwned ? "#2ecc71" : color; }

            // Fundo do card
            let cGrad = ctx.createLinearGradient(x, y, x, y+iH);
            if(isOwned) {
                cGrad.addColorStop(0, "rgba(0,210,255,0.12)");
                cGrad.addColorStop(1, "rgba(0,80,120,0.95)");
            } else if(hov) {
                cGrad.addColorStop(0, "rgba(0,210,255,0.18)");
                cGrad.addColorStop(1, "rgba(5,10,15,0.96)");
            } else {
                cGrad.addColorStop(0, "rgba(8,12,18,0.97)");
                cGrad.addColorStop(1, "rgba(3,5,8,0.99)");
            }
            ctx.fillStyle = cGrad;
            ctx.strokeStyle = isOwned ? color : (hov ? color : `${color}44`);
            ctx.lineWidth = isOwned || hov ? 2 : 1;
            ctx.beginPath(); ctx.roundRect(x, y, iW, iH, 8); ctx.fill(); ctx.stroke();
            ctx.shadowBlur = 0;

            // Linha de acento no topo
            let topAcc = ctx.createLinearGradient(x, 0, x+iW, 0);
            topAcc.addColorStop(0, "transparent"); topAcc.addColorStop(0.5, isOwned ? color : `${color}88`); topAcc.addColorStop(1, "transparent");
            ctx.fillStyle = topAcc; ctx.fillRect(x+8, y, iW-16, isOwned || hov ? 3 : 2);

            // Sprite do personagem
            let baseShopScale = char?.shopScale || 2.2;
            let charScale = baseShopScale * (hov ? 1.12 : 1.0);
            drawSprite({ originalKey: key }, x + iW/2, y + 118, false, charScale, key);

            // === RODAP√â DO CARD ===
            ctx.fillStyle = "rgba(0,0,0,0.55)";
            ctx.beginPath(); ctx.roundRect(x+2, y+iH-66, iW-4, 64, [0,0,7,7]); ctx.fill();
            ctx.fillStyle = isOwned ? `${color}66` : `${color}44`;
            ctx.fillRect(x+2, y+iH-67, iW-4, 1);

            // Nome
            ctx.font = "bold 14px Rajdhani"; ctx.fillStyle = isOwned ? color : (hov ? "#fff" : color);
            ctx.textAlign = "center";
            if(name && name.length > 22) ctx.font = "bold 12px Rajdhani";
            ctx.fillText(name || "?", x + iW/2, y + iH - 44);

            // Pre√ßo ou Status
            if (isOwned || isFree) {
                ctx.font = "bold 14px Rajdhani"; ctx.fillStyle = color;
                ctx.shadowBlur = 8; ctx.shadowColor = color;
                ctx.fillText(isOwned ? "‚úì SELECIONADO" : "‚úì DISPON√çVEL", x + iW/2, y + iH - 14);
                ctx.shadowBlur = 0;
            } else {
                const colorAfford = canAfford ? "#f1c40f" : "#e74c3c";
                ctx.font = `bold 16px Rajdhani`; ctx.fillStyle = colorAfford;
                ctx.shadowBlur = canAfford ? 8 : 0; ctx.shadowColor = "#f1c40f";
                ctx.fillText(`${price} Z`, x + iW/2, y + iH - 14);
                ctx.shadowBlur = 0;
            }

            ctx.restore();
        });
        drawScrollbar(W - 15, 158, H - 255, shopScrollY, maxS);
    } else if (shopTab === "COSTUMES" || shopTab === "TRANS" || shopTab === "ITEMS") {
        let keys = []; let color = UI_COLORS.secondary; let unlockList = [];
        if (shopTab === "COSTUMES") { keys = Object.keys(costumesDB); color = UI_COLORS.success; unlockList = player.unlockedCostumes; }
        else if (shopTab === "TRANS") {
            keys = Object.keys(charactersDB).filter(k => charactersDB[k].isTransformation && charactersDB[k].price !== undefined);
            color = "#9b59b6"; unlockList = player.unlockedTransformations;
        }
        else { keys = Object.keys(itemsDB); unlockList = null; }

        const iCols = 4, iW = 240, iH = 195, iGapX = 20, iGapY = 20;
        const iStartX = (W - (iCols * iW + (iCols-1)*iGapX)) / 2;
        const iStartY = 168;

        let maxS = getMaxScroll(keys.length, iCols, iH, iGapY, H - 255);
        targetShopScrollY = Math.max(maxS, Math.min(0, targetShopScrollY));

        keys.forEach((key, i) => {
            let col = i % iCols; let row = Math.floor(i / iCols);
            let x = iStartX + col * (iW + iGapX);
            let y = iStartY + row * (iH + iGapY) + shopScrollY;
            let inClip = mouse.y > 158 && mouse.y < H - 97;
            let hov = inClip && mouse.x > x && mouse.x < x+iW && mouse.y > y && mouse.y < y+iH;

            let price = shopTab === "COSTUMES" ? costumesDB[key]?.price : (shopTab === "TRANS" ? charactersDB[key]?.price : itemsDB[key]?.price);
            let name = shopTab === "COSTUMES" ? costumesDB[key]?.name : (shopTab === "TRANS" ? charactersDB[key]?.name : itemsDB[key]?.name);
            let isOwned = shopTab === "ITEMS" ? false : isUnlocked(key, shopTab === "COSTUMES" ? "COSTUME" : "TRANS");
            let canAfford = !isOwned && price !== undefined && player.zeni >= price;

            ctx.save();

            // Sombra do card no hover
            if(hov) { ctx.shadowBlur = 25; ctx.shadowColor = isOwned ? "#2ecc71" : color; }

            // Fundo do card
            let cGrad = ctx.createLinearGradient(x, y, x, y+iH);
            if(isOwned) {
                cGrad.addColorStop(0, "rgba(46,204,113,0.12)");
                cGrad.addColorStop(1, "rgba(20,60,30,0.95)");
            } else if(hov) {
                cGrad.addColorStop(0, `rgba(${color === UI_COLORS.secondary ? "245,197,24" : color === UI_COLORS.success ? "46,204,113" : color === "#9b59b6" ? "155,89,182" : "245,197,24"},0.18)`);
                cGrad.addColorStop(1, "rgba(5,10,15,0.96)");
            } else {
                cGrad.addColorStop(0, "rgba(8,12,18,0.97)");
                cGrad.addColorStop(1, "rgba(3,5,8,0.99)");
            }
            ctx.fillStyle = cGrad;
            ctx.strokeStyle = isOwned ? "#2ecc71" : (hov ? color : `${color}44`);
            ctx.lineWidth = isOwned || hov ? 2 : 1;
            ctx.beginPath(); ctx.roundRect(x, y, iW, iH, 8); ctx.fill(); ctx.stroke();
            ctx.shadowBlur = 0;

            // Linha de acento no topo
            let topAcc = ctx.createLinearGradient(x, 0, x+iW, 0);
            topAcc.addColorStop(0, "transparent"); topAcc.addColorStop(0.5, isOwned ? "#2ecc71" : color); topAcc.addColorStop(1, "transparent");
            ctx.fillStyle = topAcc; ctx.fillRect(x+8, y, iW-16, isOwned || hov ? 3 : 2);

            // Sprite / Imagem do item
            if (shopTab === "ITEMS") {
                let img = images[key];
                if(img && img.complete && !img.failed) {
                    let iSize = hov ? 72 : 64;
                    ctx.drawImage(img, x + iW/2 - iSize/2, y+14, iSize, iSize);
                } else {
                    ctx.font = "40px serif"; ctx.textAlign = "center";
                    ctx.fillText("üì¶", x + iW/2, y+58);
                }
            } else {
                let baseCharKey = shopTab === "COSTUMES" ? costumesDB[key]?.baseChar : key;
                let baseShopScale = (charactersDB[key]?.shopScale) || (charactersDB[baseCharKey]?.shopScale) || 2.2;
                let charScale = baseShopScale * (hov ? 1.12 : 1.0);
                drawSprite({ originalKey: key }, x + iW/2, y + 118, false, charScale, key);
            }

            // === RODAP√â DO CARD ===
            ctx.fillStyle = "rgba(0,0,0,0.55)";
            ctx.beginPath(); ctx.roundRect(x+2, y+iH-66, iW-4, 64, [0,0,7,7]); ctx.fill();
            ctx.fillStyle = isOwned ? "#2ecc71" : `${color}66`;
            ctx.fillRect(x+2, y+iH-67, iW-4, 1);

            // Nome
            ctx.font = "bold 14px Rajdhani"; ctx.fillStyle = isOwned ? "#2ecc71" : (hov ? "#fff" : color);
            ctx.textAlign = "center";
            if(name && name.length > 22) {
                ctx.font = "bold 12px Rajdhani";
            }
            ctx.fillText(name || "?", x + iW/2, y + iH - 44);

            // Pre√ßo ou Status
            if (shopTab === "ITEMS") {
                // Para itens, mostrar quantidade no invent√°rio e pre√ßo
                const owned = player.inventory[key] || 0;
                const isStoryOnly = itemsDB[key]?.storyOnly;
                ctx.font = "bold 15px Rajdhani";
                if(isStoryOnly) {
                    ctx.fillStyle = "#f39c12";
                    ctx.fillText("‚≠ï MODO HIST√ìRIA", x + iW/2, y + iH - 16);
                } else {
                    ctx.fillStyle = color;
                    ctx.fillText(`${price} Z`, x + iW/2 - 35, y + iH - 16);
                    ctx.font = "12px Rajdhani"; ctx.fillStyle = "rgba(255,255,255,0.4)";
                    ctx.fillText(`Tens: ${owned}`, x + iW/2 + 40, y + iH - 16);
                }
            } else if (isOwned) {
                ctx.font = "bold 14px Rajdhani"; ctx.fillStyle = "#2ecc71";
                ctx.shadowBlur = 8; ctx.shadowColor = "#2ecc71";
                ctx.fillText("‚úì ADQUIRIDO", x + iW/2, y + iH - 14);
                ctx.shadowBlur = 0;
            } else {
                const colorAfford = canAfford ? "#f1c40f" : "#e74c3c";
                ctx.font = `bold 16px Rajdhani`; ctx.fillStyle = colorAfford;
                ctx.shadowBlur = canAfford ? 8 : 0; ctx.shadowColor = "#f1c40f";
                ctx.fillText(`${price} Z`, x + iW/2, y + iH - 14);
                ctx.shadowBlur = 0;
            }

            // Descri√ß√£o para itens (se espa√ßo)
            if(shopTab === "ITEMS" && itemsDB[key]?.desc) {
                ctx.font = "11px Rajdhani"; ctx.fillStyle = "rgba(200,200,200,0.5)";
                let descWords = itemsDB[key].desc.split(' '), dLine = '', dly = y+96;
                descWords.forEach(w => {
                    let test = dLine + w + ' ';
                    if(ctx.measureText(test).width > iW-20 && dLine !== '') {
                        ctx.fillText(dLine.trim(), x+iW/2, dly); dLine = w + ' '; dly += 14;
                    } else dLine = test;
                });
                ctx.fillText(dLine.trim(), x+iW/2, dly);
            }

            ctx.restore();
        });
        drawScrollbar(W - 15, 158, H - 255, shopScrollY, maxS);
    }
    ctx.restore();

    // === HEADER DA LOJA (OVERLAY) ===
    ctx.save();
    let hdrBg = ctx.createLinearGradient(0,0,0,155);
    hdrBg.addColorStop(0,"rgba(4,2,0,0.99)"); hdrBg.addColorStop(1,"rgba(4,2,0,0.92)");
    ctx.fillStyle = hdrBg; ctx.fillRect(0,0,W,155);
    ctx.fillStyle = "rgba(245,197,24,0.25)"; ctx.fillRect(0, 154, W, 1);

    // T√≠tulo
    ctx.font = "italic 40px Bangers"; ctx.fillStyle = "#f5c518"; ctx.textAlign = "left";
    ctx.shadowBlur = 15; ctx.shadowColor = "#ff8c00";
    ctx.fillText("üõí LOJA Z", 22, 54);
    ctx.shadowBlur = 0;
    ctx.font = "bold 13px Rajdhani"; ctx.fillStyle = "rgba(245,197,24,0.5)";
    ctx.fillText("TERMINAL DE AQUISI√á√ÉO", 22, 70);

    // Saldo do jogador
    ctx.textAlign = "right";
    ctx.font = "bold 22px Rajdhani"; ctx.fillStyle = "#f5c518";
    ctx.shadowBlur = 10; ctx.shadowColor = "#f5c518";
    ctx.fillText(`üí∞ ${player.zeni.toLocaleString()} Z`, W - 22, 50);
    ctx.shadowBlur = 0;
    ctx.font = "12px Rajdhani"; ctx.fillStyle = "rgba(255,255,255,0.3)";
    ctx.fillText("SEU SALDO", W - 22, 64);
    ctx.restore();

    // Linha separadora do saldo
    let balanceLine = ctx.createLinearGradient(W-200, 0, W-20, 0);
    balanceLine.addColorStop(0,"transparent"); balanceLine.addColorStop(1,"rgba(245,197,24,0.3)");
    ctx.fillStyle = balanceLine; ctx.fillRect(W-200, 70, 178, 1);

    // === ABAS MELHORADAS ===
    const tabs = [
        { key:"CHARS",    label:"PERSONAGENS", icon:"üë§", color: UI_COLORS.accent },
        { key:"COSTUMES", label:"TRAJES",       icon:"üëï", color: UI_COLORS.success },
        { key:"TRANS",    label:"TRANSF.",      icon:"‚ö°", color: "#9b59b6" },
        { key:"ITEMS",    label:"ITENS Z",      icon:"üì¶", color: UI_COLORS.secondary },
    ];
    const tabTotalW = W - 44, tabH2 = 52, tabGap = 8;
    const tabW = (tabTotalW - tabGap * (tabs.length-1)) / tabs.length;

    tabs.forEach((t, ti) => {
        const tx = 22 + ti * (tabW + tabGap), ty = 96;
        const isActive = shopTab === t.key;
        const isHov = mouse.x > tx && mouse.x < tx+tabW && mouse.y > ty && mouse.y < ty+tabH2;

        ctx.save();
        if(isActive) { ctx.shadowBlur = 20; ctx.shadowColor = t.color; }

        // Fundo da aba
        let tabGrd = ctx.createLinearGradient(tx, ty, tx, ty+tabH2);
        if(isActive) {
            tabGrd.addColorStop(0, t.color + "55"); tabGrd.addColorStop(1, t.color + "22");
        } else if(isHov) {
            tabGrd.addColorStop(0, "rgba(255,255,255,0.10)"); tabGrd.addColorStop(1, "rgba(255,255,255,0.04)");
        } else {
            tabGrd.addColorStop(0, "rgba(255,255,255,0.04)"); tabGrd.addColorStop(1, "rgba(0,0,0,0.3)");
        }
        ctx.fillStyle = tabGrd;
        ctx.strokeStyle = isActive ? t.color : (isHov ? `${t.color}66` : "rgba(255,255,255,0.1)");
        ctx.lineWidth = isActive ? 2 : 1;
        ctx.beginPath(); ctx.roundRect(tx, ty, tabW, tabH2, [6,6,0,0]); ctx.fill(); ctx.stroke();
        ctx.shadowBlur = 0;

        // Indicador ativo (barra no topo)
        if(isActive) {
            ctx.fillStyle = t.color;
            ctx.beginPath(); ctx.roundRect(tx+4, ty, tabW-8, 3, [3,3,0,0]); ctx.fill();
        }

        // √çcone + Label
        ctx.font = "16px serif"; ctx.textAlign = "center";
        ctx.fillText(t.icon, tx+tabW/2, ty+22);
        ctx.font = `bold 11px Rajdhani`; ctx.fillStyle = isActive ? t.color : (isHov ? "#ddd" : "#888");
        ctx.fillText(t.label, tx+tabW/2, ty+40);

        ctx.restore();
    });

    // === BOT√ÉO SAIR ===
    drawSparkBtn(W - 175, H - 70, 155, 50, "‚úï  SAIR", UI_COLORS.danger);
}

function drawCharSelect() {
    const W = canvas.width, H = canvas.height;
    
    // Fundo gradiente profundo
    let bgGrad = ctx.createRadialGradient(W/2, H/2, 0, W/2, H/2, 750);
    bgGrad.addColorStop(0, "#080408"); bgGrad.addColorStop(1, "#020102");
    ctx.fillStyle = bgGrad; ctx.fillRect(0, 0, W, H);
    
    // Grade sutil
    ctx.strokeStyle = "rgba(0,210,255,0.03)"; ctx.lineWidth = 1;
    for(let i=0; i<W; i+=55){ ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,H); ctx.stroke(); }
    for(let i=0; i<H; i+=55){ ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(W,i); ctx.stroke(); }
    
    if (subMenuPhase) {
        // === SUBMENU DE TRAJE / TRANSFORMA√á√ÉO ===
        ctx.fillStyle = "rgba(0,0,0,0.92)"; ctx.fillRect(0,0,W,H);

        // Faixa de topo
        let topBar = ctx.createLinearGradient(0,0,0,110);
        topBar.addColorStop(0, "rgba(0,210,255,0.12)"); topBar.addColorStop(1, "transparent");
        ctx.fillStyle = topBar; ctx.fillRect(0, 0, W, 110);

        ctx.font = "italic 42px Oswald"; ctx.fillStyle = "#fff"; ctx.textAlign = "center";
        let titleText = subMenuPhase === 'COSTUME' ? "‚óà CONFIGURAR TRAJE" : "‚óà CONFIGURAR FORMA INICIAL";
        ctx.shadowBlur = 20; ctx.shadowColor = UI_COLORS.accent;
        ctx.fillText(titleText, W/2, 68);
        ctx.shadowBlur = 0;

        // Linha decorativa
        let lineGrad = ctx.createLinearGradient(W*0.2, 0, W*0.8, 0);
        lineGrad.addColorStop(0,"transparent"); lineGrad.addColorStop(0.5,UI_COLORS.accent); lineGrad.addColorStop(1,"transparent");
        ctx.strokeStyle = lineGrad; ctx.lineWidth = 2;
        ctx.beginPath(); ctx.moveTo(W*0.2, 80); ctx.lineTo(W*0.8, 80); ctx.stroke();

        ctx.font = "bold 13px Rajdhani"; ctx.fillStyle = "rgba(0,210,255,0.5)";
        ctx.fillText(subMenuPhase === 'COSTUME' ? "Escolha o traje para este personagem" : "Selecione a forma de entrada em batalha", W/2, 96);

        let cols = Math.min(subMenuOptions.length, 5);
        let cW = 155, cH = 205, cGap = 18;
        let totalSubW = cols * cW + (cols-1)*cGap;
        let startX = (W - totalSubW) / 2;

        subMenuOptions.forEach((optKey, i) => {
            let col = i % 5; let row = Math.floor(i / 5);
            let x = startX + col * (cW + cGap); let y = 115 + row * (cH + 16);
            let hov = mouse.x > x && mouse.x < x+cW && mouse.y > y && mouse.y < y+cH;
            let isBase = i === 0;

            // Fundo do card
            ctx.save();
            if(hov) { ctx.shadowBlur = 20; ctx.shadowColor = UI_COLORS.accent; }
            let cGrd = ctx.createLinearGradient(x, y, x, y+cH);
            cGrd.addColorStop(0, hov ? "rgba(0,210,255,0.22)" : isBase ? "rgba(0,150,180,0.12)" : "rgba(0,15,28,0.95)");
            cGrd.addColorStop(1, hov ? "rgba(0,100,150,0.18)" : "rgba(0,5,10,0.98)");
            ctx.fillStyle = cGrd;
            ctx.strokeStyle = hov ? UI_COLORS.accent : isBase ? "rgba(0,210,255,0.35)" : "rgba(0,210,255,0.18)";
            ctx.lineWidth = hov ? 2 : 1;
            ctx.beginPath(); ctx.roundRect(x, y, cW, cH, 8); ctx.fill(); ctx.stroke();
            ctx.shadowBlur = 0;

            // Acento colorido no topo
            ctx.fillStyle = hov ? UI_COLORS.accent : `rgba(0,210,255,${isBase ? 0.5 : 0.25})`;
            ctx.fillRect(x+8, y, cW-16, hov ? 3 : 2);

            // Badge de tipo (Base / Traje / Transforma√ß√£o)
            const badgeLabel = isBase ? "BASE" : subMenuPhase === 'COSTUME' ? "TRAJE" : "TRANSF.";
            const badgeColor = isBase ? "#00d2ff" : subMenuPhase === 'COSTUME' ? "#2ecc71" : "#9b59b6";
            ctx.fillStyle = badgeColor + "33"; ctx.strokeStyle = badgeColor; ctx.lineWidth = 1;
            ctx.beginPath(); ctx.roundRect(x+6, y+8, 60, 18, 3); ctx.fill(); ctx.stroke();
            ctx.font = "bold 10px Rajdhani"; ctx.fillStyle = badgeColor; ctx.textAlign = "center";
            ctx.fillText(badgeLabel, x+36, y+20);

            // Nome do personagem
            let charName = charactersDB[optKey] ? charactersDB[optKey].name : "?";
            ctx.font = `bold 12px Rajdhani`; ctx.fillStyle = hov ? UI_COLORS.accent : "#d0d0d0";
            if(charName.length > 16) {
                let parts = charName.split(' ');
                ctx.fillText(parts[0], x + cW/2, y + 38);
                if(parts.length > 1) ctx.fillText(parts.slice(1).join(' '), x + cW/2, y + 52);
            } else {
                ctx.fillText(charName, x + cW/2, y + 46);
            }

            // Sprite do personagem
            let baseShopScale = (charactersDB[optKey] && charactersDB[optKey].shopScale) || 1.8;
            drawSprite({ originalKey: optKey }, x + cW/2, y + cH - 22, false, baseShopScale * (hov ? 1.12 : 1.0), optKey);

            // Indicador hover "SELECIONAR"
            if(hov) {
                ctx.fillStyle = UI_COLORS.accent + "22";
                ctx.beginPath(); ctx.roundRect(x+2, y+cH-28, cW-4, 26, [0,0,7,7]); ctx.fill();
                ctx.font = "bold 12px Rajdhani"; ctx.fillStyle = UI_COLORS.accent;
                ctx.fillText("‚ñ∂ SELECIONAR", x+cW/2, y+cH-10);
            }

            ctx.restore();
        });

        drawSparkBtn(W/2 - 130, H - 72, 260, 52, "‚úï  CANCELAR", UI_COLORS.danger);
        return;
    }
    
    drawCharSelectLayout(false);
    
    // === HEADER MELHORADO ===
    ctx.save();
    // Fundo do header
    let headerGrad = ctx.createLinearGradient(0, 0, 0, 105);
    headerGrad.addColorStop(0, "rgba(0,3,8,0.98)"); headerGrad.addColorStop(1, "rgba(0,3,8,0.85)");
    ctx.fillStyle = headerGrad; ctx.fillRect(0, 0, W, 105);
    // Borda inferior suave
    ctx.fillStyle = "rgba(0,210,255,0.2)"; ctx.fillRect(0, 104, W, 1);

    // T√≠tulo com efeito de brilho
    ctx.font = "italic 40px Oswald"; ctx.textAlign = "left";
    ctx.shadowBlur = 20; ctx.shadowColor = UI_COLORS.accent;
    ctx.fillStyle = "#fff";
    const headTitle = charSelectionStep === 0 ? "‚óà SELECIONAR GUERREIRO" : "‚óà SELECIONAR ADVERS√ÅRIO";
    ctx.fillText(headTitle, 28, 58);
    ctx.shadowBlur = 0;

    // Linha decorativa com gradiente
    let headerLineGrad = ctx.createLinearGradient(28, 0, 550, 0);
    headerLineGrad.addColorStop(0, UI_COLORS.accent); headerLineGrad.addColorStop(1, "transparent");
    ctx.fillStyle = headerLineGrad; ctx.fillRect(28, 66, 500, 2);

    // Badge de progresso
    let totalChars = Object.keys(charactersDB).filter(k => !charactersDB[k].isTransformation && !charactersDB[k].isCostume && !charactersDB[k].hidden).length;
    let unlockedCount = Object.keys(charactersDB).filter(k => !charactersDB[k].isTransformation && !charactersDB[k].isCostume && !charactersDB[k].hidden && isUnlocked(k,"CHAR")).length;
    
    // Barra de progresso de desbloqueio
    const progBarX = 28, progBarY = 75, progBarW = 280, progBarH = 8;
    ctx.fillStyle = "rgba(255,255,255,0.06)"; ctx.fillRect(progBarX, progBarY, progBarW, progBarH);
    let progGrad = ctx.createLinearGradient(progBarX, 0, progBarX+progBarW, 0);
    progGrad.addColorStop(0, "#00d2ff"); progGrad.addColorStop(1, "#0070ff");
    ctx.fillStyle = progGrad; ctx.fillRect(progBarX, progBarY, progBarW*(unlockedCount/totalChars), progBarH);

    ctx.font = "bold 12px Rajdhani"; ctx.fillStyle = "rgba(0,210,255,0.7)"; ctx.textAlign = "left";
    ctx.fillText(`${unlockedCount} / ${totalChars} DESBLOQUEADOS`, progBarX, progBarY + 22);
    ctx.restore();

    // Bot√£o VOLTAR melhorado
    drawSparkBtn(18, H - 68, 185, 50, "‚óÄ  VOLTAR", UI_COLORS.danger);
}

function drawCharSelectLayout(isShop) {
    // ‚îÄ‚îÄ FILTROS DE CATEGORIA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const CHAR_FILTERS = [
        { key: "TODOS",  label: "TODOS",   color: "#00d2ff" },
        { key: "Z",      label: "DBZ",     color: "#e74c3c" },
        { key: "DBS",    label: "DBS",     color: "#3498db" },
        { key: "GT",     label: "DBGT",    color: "#e67e22" },
        { key: "FILM",   label: "FILMES",  color: "#9b59b6" },
        { key: "C",      label: "CL√ÅSSIC", color: "#2ecc71" },
        { key: "VIL√ÉO",  label: "VIL√ïES",  color: "#e74c3c" },
    ];

    // Detectar categoria de cada personagem pelo nome/key
    function getCharCategory(key, data) {
        if(data.isEvil) return "VIL√ÉO";
        let k = key.toLowerCase();
        if(k.includes('gt') || k.includes('baby') || k.includes('oozaruss4')) return "GT";
        if(k.includes('dbs') || k.includes('blue') || k.includes('ultra') || k.includes('broly') || k.includes('beerus') || k.includes('jiren') || k.includes('toppo') || k.includes('merged') || k.includes('berserker')) return "DBS";
        if(k.endsWith('c') || k.includes('classic') || k.includes('oozaruC') || key === 'GokuC' || key === 'GokuC2' || key === 'GokuC3' || key === 'GokuC4') return "C";
        if(k.includes('freeza') || k.includes('cell') || k.includes('boo') || k.includes('dabura') || k.includes('turles') || k.includes('slug') || k.includes('cooler') || k.includes('android') || k.includes('piccolo') || k.includes('raditz') || k.includes('nappa') || k.includes('vegeta') || k.includes('ginyu') || k.includes('dodoria') || k.includes('zarbon') || k.includes('recoome') || k.includes('burter') || k.includes('jeice') || k.includes('cui') || k.includes('saibaman') || k.includes('tullece') || k.includes('janemba')) return "VIL√ÉO";
        return "Z";
    }

    let allKeys = Object.keys(charactersDB).filter(k => !charactersDB[k].isTransformation && !charactersDB[k].isCostume && !charactersDB[k].hidden);
    let keys = charFilter === "TODOS" ? allKeys : allKeys.filter(k => getCharCategory(k, charactersDB[k]) === charFilter);
    
    let hoveredKey = null;
    let scrollY = isShop ? shopScrollY : charScrollY;
    
    // Layout da grelha: lado direito agora tem o preview maior
    const GRID_X = 20;
    const GRID_START_Y = 115;
    const GRID_CLIP_H = canvas.height - 200;
    const PORTRAIT = 95;
    const GAP = 10;
    const COLS = 5;
    const GRID_W = COLS * (PORTRAIT + GAP) - GAP;
    
    let maxS = getMaxScroll(keys.length, COLS, PORTRAIT, GAP, GRID_CLIP_H);
    if (isShop) targetShopScrollY = Math.max(maxS, Math.min(0, targetShopScrollY));
    else targetCharScrollY = Math.max(maxS, Math.min(0, targetCharScrollY));

    // ‚îÄ‚îÄ GRELHA DE PERSONAGENS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    ctx.save();
    ctx.beginPath(); ctx.rect(GRID_X, GRID_START_Y, GRID_W + 20, GRID_CLIP_H); ctx.clip();

    keys.forEach((key, i) => {
        let col = i % COLS; let row = Math.floor(i / COLS);
        let x = GRID_X + col * (PORTRAIT + GAP);
        let y = GRID_START_Y + row * (PORTRAIT + GAP) + scrollY;
        
        let inClip = mouse.y > GRID_START_Y && mouse.y < GRID_START_Y + GRID_CLIP_H && mouse.x < GRID_X + GRID_W + 20;
        let hov = !subMenuPhase && inClip && mouse.x > x && mouse.x < x + PORTRAIT && mouse.y > y && mouse.y < y + PORTRAIT;
        if(hov) { hoveredKey = key; charHoverKey = key; }
        
        let unlocked = isUnlocked(key, "CHAR");
        let isPlayerSelected = !isShop && charSelectionStep === 1 && tempPlayerKey === key;
        
        ctx.save();
        
        // Borda e fundo com chanfro
        const c = 6;
        ctx.beginPath();
        ctx.moveTo(x+c,y); ctx.lineTo(x+PORTRAIT,y); ctx.lineTo(x+PORTRAIT,y+PORTRAIT-c);
        ctx.lineTo(x+PORTRAIT-c,y+PORTRAIT); ctx.lineTo(x,y+PORTRAIT); ctx.lineTo(x,y+c);
        ctx.closePath();
        
        if(isPlayerSelected) ctx.fillStyle = "rgba(46,204,113,0.35)";
        else if(hov && unlocked) ctx.fillStyle = "rgba(0,210,255,0.2)";
        else if(unlocked) ctx.fillStyle = "rgba(255,255,255,0.05)";
        else ctx.fillStyle = "rgba(0,0,0,0.85)";
        ctx.fill();
        
        ctx.strokeStyle = isPlayerSelected ? "#2ecc71" : (hov && unlocked ? UI_COLORS.accent : (unlocked ? "rgba(255,255,255,0.15)" : "rgba(255,255,255,0.04)"));
        ctx.lineWidth = (hov || isPlayerSelected) ? 2 : 1;
        ctx.stroke();
        
        if(unlocked) {
            // Sprite
            let charScale = (charactersDB[key].shopScale || 1.2) * (hov ? 1.1 : 1.0);
            drawSprite({ originalKey: key }, x + PORTRAIT/2, y + PORTRAIT - 8, false, charScale, key);
            
            // Glow no hover
            if(hov) {
                ctx.shadowBlur = 15; ctx.shadowColor = UI_COLORS.accent;
                ctx.strokeStyle = UI_COLORS.accent; ctx.lineWidth = 2; ctx.stroke();
                ctx.shadowBlur = 0;
            }
            if(isPlayerSelected) {
                ctx.fillStyle = "#2ecc71"; ctx.font = "bold 18px Rajdhani"; ctx.textAlign = "center";
                ctx.fillText("‚úì", x + PORTRAIT/2, y + 16);
            }
        } else {
            // Locked
            ctx.fillStyle = "rgba(0,0,0,0.5)"; ctx.fill();
            ctx.font = "bold 22px Rajdhani"; ctx.fillStyle = "#333"; ctx.textAlign = "center";
            ctx.fillText("üîí", x + PORTRAIT/2, y + PORTRAIT/2 + 8);
            if(charactersDB[key].price !== undefined) {
                ctx.font = "bold 11px Rajdhani"; ctx.fillStyle = "#555";
                ctx.fillText(charactersDB[key].price+"Z", x + PORTRAIT/2, y + PORTRAIT - 8);
            }
        }
        
        // Nome mini na parte de baixo do card (sempre vis√≠vel)
        ctx.fillStyle = "rgba(0,0,0,0.7)"; ctx.fillRect(x, y + PORTRAIT - 20, PORTRAIT, 20);
        ctx.font = "bold 10px Rajdhani"; ctx.fillStyle = unlocked ? (hov ? UI_COLORS.accent : "#bbb") : "#444";
        ctx.textAlign = "center";
        let shortName = charactersDB[key].name.replace(/\(.*?\)/g,'').trim();
        if(shortName.length > 12) shortName = shortName.substring(0,11)+"‚Ä¶";
        ctx.fillText(shortName, x + PORTRAIT/2, y + PORTRAIT - 6);
        
        ctx.restore();
    });
    
    drawScrollbar(GRID_X + GRID_W + 4, GRID_START_Y, GRID_CLIP_H, scrollY, maxS);
    ctx.restore();

    // ‚îÄ‚îÄ FILTROS (abaixo do header) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if(!isShop) {
        const filterY = 75;
        const filterH = 30;
        let fx = GRID_X;
        CHAR_FILTERS.forEach(f => {
            let fw = ctx.measureText(f.label).width + 24;
            let fActive = charFilter === f.key;
            let fHov = mouse.x > fx && mouse.x < fx+fw && mouse.y > filterY && mouse.y < filterY+filterH;
            
            ctx.fillStyle = fActive ? f.color : (fHov ? "rgba(255,255,255,0.1)" : "rgba(255,255,255,0.04)");
            ctx.beginPath(); ctx.roundRect(fx, filterY, fw, filterH, 2); ctx.fill();
            if(fActive || fHov) { ctx.strokeStyle = f.color; ctx.lineWidth = 1; ctx.stroke(); }
            
            ctx.font = "bold 12px Rajdhani"; ctx.textAlign = "center";
            ctx.fillStyle = fActive ? "#000" : (fHov ? f.color : "#888");
            ctx.fillText(f.label, fx + fw/2, filterY + filterH/2 + 4);
            fx += fw + 6;
        });
    }

    // ‚îÄ‚îÄ PAINEL DE PREVIEW (direita) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const prevX = GRID_X + GRID_W + 30;
    const prevW = canvas.width - prevX - 20;
    let previewKey = hoveredKey || charHoverKey || (charSelectionStep === 1 ? tempPlayerKey : keys[0]);
    
    if(previewKey && !subMenuPhase) {
        let char = charactersDB[previewKey];
        if(!char) return;
        
        // Gradiente de fundo
        ctx.save();
        let grad = ctx.createLinearGradient(prevX, 0, canvas.width, 0);
        grad.addColorStop(0, "transparent");
        grad.addColorStop(0.3, char.aura ? char.aura+"22" : "rgba(0,210,255,0.08)");
        grad.addColorStop(1, char.aura ? char.aura+"18" : "rgba(0,210,255,0.15)");
        ctx.fillStyle = grad; ctx.fillRect(prevX, 0, prevW+20, canvas.height);
        
        // Sprite grande
        let basePScale = (char.previewScale || 7.0) * 0.9;
        drawSprite({ originalKey: previewKey, aura: char.aura }, prevX + prevW/2 + 20, canvas.height - 40, false, basePScale, previewKey, true);
        
        // Painel de informa√ß√µes
        let infoY = 115;
        drawSparkPanel(prevX, infoY, prevW, 280, "rgba(0,10,20,0.88)", char.aura || UI_COLORS.accent);
        
        // Nome
        ctx.font = "italic 32px Oswald"; ctx.fillStyle = "#fff"; ctx.textAlign = "left";
        ctx.fillText(char.name.toUpperCase(), prevX + 18, infoY + 44);
        ctx.fillStyle = char.aura || UI_COLORS.accent;
        ctx.fillRect(prevX+18, infoY+52, prevW-36, 2);
        
        let unlocked = isUnlocked(previewKey, "CHAR");
        let iy = infoY + 76;
        const infoLine = (label, val, color) => {
            ctx.font = "13px Rajdhani"; ctx.fillStyle = "#666"; ctx.textAlign = "left";
            ctx.fillText(label, prevX+18, iy);
            ctx.font = "bold 16px Rajdhani"; ctx.fillStyle = color;
            ctx.fillText(val, prevX+130, iy);
            iy += 24;
        };
        
        if(unlocked) {
            infoLine("VITALIDADE:", char.maxHp+" HP", "#e74c3c");
            infoLine("CUSTO KI:", (char.kiCost||50)+" KI", "#3498db");
            infoLine("STATUS:", "DESBLOQUEADO", "#2ecc71");
            iy += 4;
            // Movimentos
            ctx.font = "bold 12px Rajdhani"; ctx.fillStyle = "#2ecc71";
            ctx.fillText("MOVIMENTOS:", prevX+18, iy); iy += 18;
            (char.moves || []).slice(0,4).forEach(mv => {
                ctx.font = "12px Rajdhani"; ctx.fillStyle = "#aaa";
                ctx.fillText(`¬∑ ${mv.name}  ${mv.dmg>0?mv.dmg+" DMG":""}`, prevX+22, iy); iy += 17;
            });
        } else {
            infoLine("CUSTO:", (char.price||"?")+" ZENI", "#f1c40f");
            infoLine("ZENI ATUAL:", player.zeni+" Z", player.zeni>=(char.price||0) ? "#2ecc71" : "#e74c3c");
            infoLine("STATUS:", "BLOQUEADO", "#e74c3c");
        }
        
        // Transforma√ß√µes dispon√≠veis
        if(char.transList && char.transList.length > 0) {
            iy += 6;
            ctx.font = "bold 11px Rajdhani"; ctx.fillStyle = "#9b59b6"; ctx.textAlign = "left";
            ctx.fillText(`TRANSFORMA√á√ïES: ${char.transList.length}`, prevX+18, iy);
        }
        
        // Bot√£o SELECIONAR (somente na sele√ß√£o de char, n√£o na loja)
        if(!isShop && unlocked) {
            drawSparkBtn(prevX, canvas.height - 68, prevW, 50, 
                charSelectionStep === 0 ? "‚ñ∂  SELECIONAR" : "‚öî  COMBATER", 
                char.aura || UI_COLORS.accent);
        } else if(!isShop && !unlocked) {
            drawSparkBtn(prevX, canvas.height - 68, prevW, 50, "üîí  IR √Ä LOJA", UI_COLORS.secondary, "#000");
        }
        
        ctx.restore();
    }
}

// BOT√ÉO ESTILO DRAGON BALL (para a√ß√µes de batalha especiais)
function drawDBBtn(x, y, w, h, txt, bg, textCol = "#fff") {
    let hov = mouse.x > x && mouse.x < x + w && mouse.y > y && mouse.y < y + h;
    ctx.save();
    if (hov) { ctx.shadowBlur = 20; ctx.shadowColor = bg; }
    let grad = ctx.createLinearGradient(x, y, x, y + h);
    grad.addColorStop(0, hov ? bg : bg + "cc");
    grad.addColorStop(1, "rgba(0,0,0,0.9)");
    ctx.fillStyle = grad;
    ctx.beginPath();
    ctx.moveTo(x + 10, y); ctx.lineTo(x + w, y);
    ctx.lineTo(x + w - 10, y + h); ctx.lineTo(x, y + h);
    ctx.closePath(); ctx.fill();
    ctx.shadowBlur = 0;
    ctx.strokeStyle = hov ? "#fff" : bg + "88"; ctx.lineWidth = hov ? 2 : 1; ctx.stroke();
    ctx.font = "italic bold 16px Oswald"; ctx.textAlign = "center";
    ctx.fillStyle = hov ? (textCol === "#000" ? "#000" : "#fff") : textCol;
    ctx.fillText(txt.toUpperCase(), x + w/2, y + h/2 + 6);
    ctx.restore();
}

// BOT√ÉO TEM√ÅTICO DRAGON BALL ‚Äî parallelogram quente
function drawSparkBtn(x, y, w, h, txt, bg, textCol = "#fff") {
    let hov = mouse.x > x && mouse.x < x + w && mouse.y > y && mouse.y < y + h;
    ctx.save(); 
    
    if (hov) { 
        ctx.shadowBlur = 22; 
        ctx.shadowColor = bg === "rgba(255,255,255,0.1)" || bg === "rgba(255,255,255,0.08)" ? "#ff8c00" : bg; 
    }
    
    const cut = 10;
    
    // Fundo com gradiente quente
    if(hov) {
        let hg = ctx.createLinearGradient(x, y, x, y+h);
        hg.addColorStop(0, "#fff8e0");
        hg.addColorStop(1, "#ffe080");
        ctx.fillStyle = hg;
    } else {
        let bg2 = ctx.createLinearGradient(x, y, x, y+h);
        bg2.addColorStop(0, bg);
        bg2.addColorStop(1, "rgba(0,0,0,0.65)");
        ctx.fillStyle = bg2;
    }
    
    ctx.beginPath();
    ctx.moveTo(x + cut, y); ctx.lineTo(x + w, y); 
    ctx.lineTo(x + w - cut, y + h); ctx.lineTo(x, y + h);
    ctx.closePath(); ctx.fill();
    ctx.shadowBlur = 0;

    // Reflexo no topo
    if(!hov && bg !== "rgba(255,255,255,0.1)" && bg !== "rgba(255,255,255,0.08)") {
        ctx.fillStyle = "rgba(255,255,255,0.14)";
        ctx.beginPath(); 
        ctx.moveTo(x + cut, y); ctx.lineTo(x + w, y); 
        ctx.lineTo(x + w - 4, y + h/2); ctx.lineTo(x + 4, y + h/2);
        ctx.closePath(); ctx.fill();
    }
    
    // Borda
    ctx.strokeStyle = hov ? "rgba(200,160,0,0.6)" : "rgba(255,255,255,0.18)"; 
    ctx.lineWidth = 1; 
    ctx.beginPath();
    ctx.moveTo(x + cut, y); ctx.lineTo(x + w, y); 
    ctx.lineTo(x + w - cut, y + h); ctx.lineTo(x, y + h);
    ctx.closePath(); ctx.stroke();

    // Texto
    ctx.font = "bold 19px Rajdhani"; ctx.textAlign = "center"; 
    ctx.fillStyle = hov ? "#4a2800" : textCol;
    ctx.fillText(txt.toUpperCase(), x + w/2, y + h/2 + 7);
    
    // Sublinhado animado ao hover
    if(hov) { 
        ctx.fillStyle = "#ff8c00"; 
        ctx.fillRect(x + cut + 5, y + h - 4, w - cut*2 - 10, 2); 
    }
    ctx.restore();
}

// GEST√ÉO DE CEN√ÅRIOS (STAGES)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ñ∂  CEN√ÅRIOS DE BATALHA ‚Äî adicione novas fun√ß√µes ao array.
//    Cada cen√°rio √© uma fun√ß√£o que desenha o fundo (canvas 1100√ó650).
//    O ch√£o deve ficar em y‚âà450. Vari√°veis dispon√≠veis: ctx, canvas,
//    timeEnv (tempo para anima√ß√£o). √çndices:
//    0=Terra  1=Namek  2=Torneio  3=Espa√ßo  4=Inferno  5=Cidade  6=C√¢mara
//    7=Planeta Vegeta  8=Nave do Freeza  9=Mundo Beerus  10=Cell Games
//    11=Mundo dos Kais  12=C√¢mara Dark  13=Deserto  14=Lab Dr.Gero
//    15=Mundo Saiyajin  16=Dimens√£o Zeno  17=Campo Destru√≠do
//    Para usar num miss√£o: { enemy:"X", stage:3 }
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const BATTLE_STAGES = [
    // ‚îÄ‚îÄ CEN√ÅRIO 0: TERRA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function drawEarth() {
        let sky = ctx.createLinearGradient(0, 0, 0, 400);
        sky.addColorStop(0, "#ff7e5f"); sky.addColorStop(0.5, "#feb47b"); sky.addColorStop(1, "#f2a65a");
        ctx.fillStyle = sky; ctx.fillRect(0, 0, canvas.width, 450);

        ctx.fillStyle = "rgba(255, 255, 255, 0.8)"; ctx.shadowBlur = 50; ctx.shadowColor = "#ffeb3b";
        ctx.beginPath(); ctx.arc(canvas.width/2, 250, 80, 0, Math.PI*2); ctx.fill(); ctx.shadowBlur = 0;

        ctx.fillStyle = "#8d6e63"; ctx.beginPath(); ctx.moveTo(0, 450); ctx.lineTo(0, 300); ctx.lineTo(150, 200); ctx.lineTo(250, 320); 
        ctx.lineTo(400, 150); ctx.lineTo(600, 350); ctx.lineTo(800, 100); ctx.lineTo(1000, 280); ctx.lineTo(1100, 220); ctx.lineTo(1100, 450); ctx.closePath(); ctx.fill();
        
        ctx.fillStyle = "rgba(0,0,0,0.3)";
        ctx.beginPath(); ctx.moveTo(0, 450); ctx.lineTo(0, 300); ctx.lineTo(150, 200); ctx.lineTo(150, 450); ctx.closePath(); ctx.fill();
        ctx.beginPath(); ctx.moveTo(400, 150); ctx.lineTo(600, 350); ctx.lineTo(600, 450); ctx.lineTo(400, 450); ctx.closePath(); ctx.fill();

        let ground = ctx.createLinearGradient(0, 450, 0, canvas.height);
        ground.addColorStop(0, "#5d4037"); ground.addColorStop(1, "#3e2723");
        ctx.fillStyle = ground; ctx.fillRect(0, 450, canvas.width, canvas.height - 450);

        ctx.strokeStyle = "rgba(255, 200, 150, 0.1)"; ctx.lineWidth = 2; let offset = (timeEnv * 50) % 60;
        for(let i = -canvas.width; i < canvas.width * 2; i += 80) { ctx.beginPath(); ctx.moveTo(canvas.width/2, 450); ctx.lineTo(i + offset, canvas.height); ctx.stroke(); }
    },
    function drawNamek() {
        let sky = ctx.createLinearGradient(0, 0, 0, 400);
        sky.addColorStop(0, "#2ecc71"); sky.addColorStop(0.5, "#a8e6cf"); sky.addColorStop(1, "#dcedc1");
        ctx.fillStyle = sky; ctx.fillRect(0, 0, canvas.width, 450);

        ctx.fillStyle = "rgba(255, 255, 255, 0.9)"; ctx.shadowBlur = 40; ctx.shadowColor = "#fff";
        ctx.beginPath(); ctx.arc(200, 150, 40, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(800, 200, 25, 0, Math.PI*2); ctx.fill(); ctx.shadowBlur = 0;

        ctx.fillStyle = "#2980b9"; ctx.beginPath(); ctx.moveTo(0, 450); ctx.lineTo(100, 250); ctx.lineTo(300, 350); 
        ctx.lineTo(500, 180); ctx.lineTo(700, 380); ctx.lineTo(900, 200); ctx.lineTo(1100, 300); ctx.lineTo(1100, 450); ctx.closePath(); ctx.fill();

        let ground = ctx.createLinearGradient(0, 450, 0, canvas.height);
        ground.addColorStop(0, "#3498db"); ground.addColorStop(1, "#2c3e50");
        ctx.fillStyle = ground; ctx.fillRect(0, 450, canvas.width, canvas.height - 450);
        
        ctx.strokeStyle = "rgba(255, 255, 255, 0.1)"; ctx.lineWidth = 2; let offset = (timeEnv * 40) % 60;
        for(let i = -canvas.width; i < canvas.width * 2; i += 80) { ctx.beginPath(); ctx.moveTo(canvas.width/2, 450); ctx.lineTo(i + offset, canvas.height); ctx.stroke(); }
    },
    function drawTournament() {
        let sky = ctx.createLinearGradient(0, 0, 0, 400);
        sky.addColorStop(0, "#34495e"); sky.addColorStop(1, "#2c3e50");
        ctx.fillStyle = sky; ctx.fillRect(0, 0, canvas.width, 450);

        // Bancada ao fundo
        ctx.fillStyle = "rgba(0,0,0,0.5)";
        for(let i = 0; i < 20; i++) {
            let h = 20 + Math.random()*30;
            ctx.fillRect(i*60, 450 - h, 40, h);
            ctx.beginPath(); ctx.arc(i*60 + 20, 450 - h, 15, 0, Math.PI*2); ctx.fill();
        }

        let ground = ctx.createLinearGradient(0, 450, 0, canvas.height);
        ground.addColorStop(0, "#95a5a6"); ground.addColorStop(1, "#7f8c8d");
        ctx.fillStyle = ground; ctx.fillRect(0, 450, canvas.width, canvas.height - 450);

        // Piso com grelha do ringue
        ctx.strokeStyle = "rgba(0, 0, 0, 0.2)"; ctx.lineWidth = 2; 
        for(let i = 0; i <= canvas.width + 200; i += 100) { ctx.beginPath(); ctx.moveTo(i, 450); ctx.lineTo(i - 300, canvas.height); ctx.stroke(); }
        for(let j = 450; j <= canvas.height; j += 40) { ctx.beginPath(); ctx.moveTo(0, j); ctx.lineTo(canvas.width, j); ctx.stroke(); }
    }
,
    // ‚îÄ‚îÄ CEN√ÅRIO 3: ESPA√áO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function drawSpace() {
        ctx.fillStyle = "#000010"; ctx.fillRect(0,0,canvas.width,canvas.height);
        // Estrelas
        ctx.fillStyle = "#fff";
        for(let i=0;i<120;i++){
            let sx=(Math.sin(i*137.5)*0.5+0.5)*canvas.width;
            let sy=(Math.cos(i*97.3)*0.5+0.5)*450;
            let sr=0.5+Math.abs(Math.sin(i+timeEnv*0.5))*1.5;
            ctx.beginPath(); ctx.arc(sx,sy,sr,0,Math.PI*2); ctx.fill();
        }
        // Nebulosa
        let neb = ctx.createRadialGradient(800,200,0,800,200,300);
        neb.addColorStop(0,"rgba(100,0,200,0.15)"); neb.addColorStop(0.5,"rgba(0,100,255,0.08)"); neb.addColorStop(1,"transparent");
        ctx.fillStyle = neb; ctx.fillRect(0,0,canvas.width,canvas.height);
        let neb2 = ctx.createRadialGradient(200,300,0,200,300,250);
        neb2.addColorStop(0,"rgba(200,0,100,0.12)"); neb2.addColorStop(1,"transparent");
        ctx.fillStyle = neb2; ctx.fillRect(0,0,canvas.width,canvas.height);
        // Planeta de fundo
        ctx.save(); ctx.globalAlpha=0.4;
        let pg = ctx.createRadialGradient(900,350,0,900,350,120);
        pg.addColorStop(0,"#e67e22"); pg.addColorStop(0.6,"#c0392b"); pg.addColorStop(1,"#7f0000");
        ctx.fillStyle=pg; ctx.beginPath(); ctx.arc(900,350,120,0,Math.PI*2); ctx.fill();
        ctx.globalAlpha=1; ctx.restore();
        // Ch√£o met√°lico (plataforma)
        let gnd = ctx.createLinearGradient(0,450,0,canvas.height);
        gnd.addColorStop(0,"#1a1a2e"); gnd.addColorStop(1,"#0d0d1a");
        ctx.fillStyle=gnd; ctx.fillRect(0,450,canvas.width,canvas.height-450);
        ctx.strokeStyle="rgba(0,100,255,0.3)"; ctx.lineWidth=1;
        for(let i=0;i<canvas.width;i+=80){ ctx.beginPath(); ctx.moveTo(i,450); ctx.lineTo(i,canvas.height); ctx.stroke(); }
        ctx.strokeStyle="rgba(0,100,255,0.15)";
        for(let j=450;j<canvas.height;j+=40){ ctx.beginPath(); ctx.moveTo(0,j); ctx.lineTo(canvas.width,j); ctx.stroke(); }
    },
    // ‚îÄ‚îÄ CEN√ÅRIO 4: INFERNO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function drawHell() {
        let sky = ctx.createLinearGradient(0,0,0,450);
        sky.addColorStop(0,"#1a0000"); sky.addColorStop(0.5,"#4a0000"); sky.addColorStop(1,"#8b0000");
        ctx.fillStyle=sky; ctx.fillRect(0,0,canvas.width,450);
        // Lava brilhante pulsante
        let lp = 0.5+Math.abs(Math.sin(timeEnv*2))*0.5;
        ctx.shadowBlur=40; ctx.shadowColor="rgba(255,100,0,"+lp+")";
        let lv = ctx.createLinearGradient(0,450,0,canvas.height);
        lv.addColorStop(0,"#ff4500"); lv.addColorStop(0.3,"#ff6a00"); lv.addColorStop(1,"#cc2200");
        ctx.fillStyle=lv; ctx.fillRect(0,450,canvas.width,canvas.height-450);
        ctx.shadowBlur=0;
        // Ondas de lava
        ctx.fillStyle="rgba(255,140,0,0.5)";
        for(let i=0;i<canvas.width;i+=60){
            let wh=5+Math.abs(Math.sin(i*0.05+timeEnv*3))*12;
            ctx.fillRect(i,450-wh,50,wh);
        }
        // Forma√ß√µes rochosas
        ctx.fillStyle="#1a0000";
        [[0,350,120,100],[200,300,100,150],[600,380,80,70],[900,320,130,130],[1050,360,50,90]].forEach(([rx,ry,rw,rh])=>{
            ctx.beginPath(); ctx.moveTo(rx,450); ctx.lineTo(rx,ry); ctx.lineTo(rx+rw/2,ry-40); ctx.lineTo(rx+rw,ry); ctx.lineTo(rx+rw,450); ctx.closePath(); ctx.fill();
        });
        // Fa√≠scas de fogo
        for(let i=0;i<8;i++){
            let fx=(Math.sin(i*173+timeEnv*2)*0.5+0.5)*canvas.width;
            let fy=430+Math.sin(i+timeEnv*4)*15;
            ctx.fillStyle="rgba(255,"+(100+Math.floor(Math.random()*155))+",0,0.8)";
            ctx.beginPath(); ctx.arc(fx,fy,2+Math.random()*3,0,Math.PI*2); ctx.fill();
        }
    },
    // ‚îÄ‚îÄ CEN√ÅRIO 5: CIDADE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function drawCity() {
        let sky = ctx.createLinearGradient(0,0,0,400);
        sky.addColorStop(0,"#0d1b2a"); sky.addColorStop(0.7,"#1b2838"); sky.addColorStop(1,"#232f3e");
        ctx.fillStyle=sky; ctx.fillRect(0,0,canvas.width,400);
        // Lua
        ctx.fillStyle="rgba(230,230,255,0.9)"; ctx.shadowBlur=30; ctx.shadowColor="#aaaaff";
        ctx.beginPath(); ctx.arc(900,80,50,0,Math.PI*2); ctx.fill(); ctx.shadowBlur=0;
        // Pr√©dios ao fundo (silhueta)
        ctx.fillStyle="#0a0f14";
        const buildings=[[0,320,80,130],[90,280,60,170],[160,300,90,150],[260,250,70,200],[340,270,100,180],[450,290,80,160],[540,240,60,210],[610,270,100,180],[720,260,80,190],[810,300,90,150],[910,280,70,170],[990,310,110,140]];
        buildings.forEach(([bx,by,bw,bh])=>{
            ctx.fillRect(bx,by,bw,bh);
            // Janelas
            ctx.fillStyle="rgba(255,255,180,0.4)";
            for(let wy=by+10;wy<450;wy+=20){ for(let wx=bx+8;wx<bx+bw-8;wx+=14){ if(Math.random()>0.3) ctx.fillRect(wx,wy,8,10); } }
            ctx.fillStyle="#0a0f14";
        });
        // Ch√£o cal√ßada
        let road = ctx.createLinearGradient(0,450,0,canvas.height);
        road.addColorStop(0,"#2c2c2c"); road.addColorStop(1,"#1a1a1a");
        ctx.fillStyle=road; ctx.fillRect(0,450,canvas.width,canvas.height-450);
        // Linhas da estrada
        ctx.strokeStyle="rgba(255,255,0,0.4)"; ctx.lineWidth=3; ctx.setLineDash([40,30]);
        ctx.beginPath(); ctx.moveTo(0,480); ctx.lineTo(canvas.width,480); ctx.stroke();
        ctx.setLineDash([]);
        // Luz n√©on no ch√£o
        ctx.fillStyle="rgba(0,200,255,0.06)"; ctx.fillRect(0,448,canvas.width,4);
    },
    // ‚îÄ‚îÄ CEN√ÅRIO 6: C√ÇMARA DO TEMPO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function drawHyperbolicChamber() {
        // Fundo branco infinito
        ctx.fillStyle="#f0f4ff"; ctx.fillRect(0,0,canvas.width,canvas.height);
        // Grade 3D perspectiva
        ctx.strokeStyle="rgba(0,100,200,0.15)"; ctx.lineWidth=1;
        // Linhas horizontais convergentes
        for(let i=0;i<=20;i++){
            let t=i/20;
            let y=canvas.height*t;
            let xStart=canvas.width/2*(1-t)*0.8; let xEnd=canvas.width-xStart;
            ctx.beginPath(); ctx.moveTo(xStart,y); ctx.lineTo(xEnd,y); ctx.stroke();
        }
        // Linhas verticais convergentes
        for(let i=0;i<=20;i++){
            let t=i/20;
            let x=canvas.width*t;
            let yStart=canvas.height/2*(1-Math.abs(t-0.5)*2)*0.5;
            ctx.beginPath(); ctx.moveTo(x,yStart); ctx.lineTo(canvas.width/2,canvas.height/2); ctx.stroke();
        }
        // Horizonte brilhante
        ctx.fillStyle="rgba(0,100,255,0.08)"; ctx.fillRect(0,canvas.height/2-2,canvas.width,4);
        // Ch√£o s√≥lido
        let floor = ctx.createLinearGradient(0,450,0,canvas.height);
        floor.addColorStop(0,"#d0d8f0"); floor.addColorStop(1,"#b0b8e0");
        ctx.fillStyle=floor; ctx.fillRect(0,450,canvas.width,canvas.height-450);
        // Reflexo no ch√£o
        ctx.strokeStyle="rgba(0,100,200,0.1)"; ctx.lineWidth=1;
        for(let i=0;i<canvas.width;i+=60){ ctx.beginPath(); ctx.moveTo(canvas.width/2,450); ctx.lineTo(i,canvas.height); ctx.stroke(); }
        for(let j=450;j<canvas.height;j+=30){ ctx.beginPath(); ctx.moveTo(0,j); ctx.lineTo(canvas.width,j); ctx.stroke(); }
    },
    // ‚îÄ‚îÄ CEN√ÅRIO 7: PLANETA VEGETA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function drawPlanetVegeta() {
        // C√©u roxo-avermelhado
        let sky = ctx.createLinearGradient(0,0,0,450);
        sky.addColorStop(0,"#1a0030"); sky.addColorStop(0.4,"#3d0050"); sky.addColorStop(1,"#6b0020");
        ctx.fillStyle=sky; ctx.fillRect(0,0,canvas.width,450);
        // Planeta gigante no fundo (Planeta Vegeta a explodir)
        let pv = ctx.createRadialGradient(canvas.width/2-100,200,0,canvas.width/2-100,200,220);
        pv.addColorStop(0,"rgba(255,120,0,0.9)"); pv.addColorStop(0.4,"rgba(180,30,0,0.7)");
        pv.addColorStop(0.8,"rgba(80,0,40,0.4)"); pv.addColorStop(1,"transparent");
        ctx.fillStyle=pv; ctx.fillRect(0,0,canvas.width,canvas.height);
        // Lua / sat√©lite pequeno
        ctx.fillStyle="rgba(200,180,160,0.85)"; ctx.shadowBlur=20; ctx.shadowColor="#e0c080";
        ctx.beginPath(); ctx.arc(850,90,38,0,Math.PI*2); ctx.fill(); ctx.shadowBlur=0;
        // Crateras na lua
        ctx.fillStyle="rgba(0,0,0,0.2)";
        [[835,80,7],[860,100,5],[845,105,4],[870,80,3]].forEach(([lx,ly,lr])=>{
            ctx.beginPath(); ctx.arc(lx,ly,lr,0,Math.PI*2); ctx.fill();
        });
        // Estrelas
        for(let i=0;i<80;i++){
            let sx=(Math.sin(i*179.3)*0.5+0.5)*canvas.width;
            let sy=(Math.cos(i*113.7)*0.5+0.5)*420;
            let ss=0.5+Math.abs(Math.sin(i+timeEnv*0.3))*1.2;
            ctx.fillStyle="rgba(255,220,255,"+(0.4+ss*0.3)+")";
            ctx.beginPath(); ctx.arc(sx,sy,ss,0,Math.PI*2); ctx.fill();
        }
        // Explos√µes ao fundo
        for(let i=0;i<5;i++){
            let ex=(Math.sin(i*200+timeEnv)*0.5+0.5)*canvas.width;
            let ey=50+Math.abs(Math.cos(i*150+timeEnv*0.5))*300;
            let er=10+Math.abs(Math.sin(i+timeEnv*2))*20;
            let eg = ctx.createRadialGradient(ex,ey,0,ex,ey,er);
            eg.addColorStop(0,"rgba(255,255,100,0.9)"); eg.addColorStop(0.5,"rgba(255,80,0,0.5)"); eg.addColorStop(1,"transparent");
            ctx.fillStyle=eg; ctx.fillRect(ex-er,ey-er,er*2,er*2);
        }
        // Montanhas escuras
        ctx.fillStyle="#1a0015";
        ctx.beginPath(); ctx.moveTo(0,450);
        ctx.lineTo(0,280); ctx.lineTo(80,200); ctx.lineTo(160,320); ctx.lineTo(300,140);
        ctx.lineTo(420,300); ctx.lineTo(580,180); ctx.lineTo(700,340); ctx.lineTo(850,160);
        ctx.lineTo(1000,300); ctx.lineTo(1100,200); ctx.lineTo(1100,450);
        ctx.closePath(); ctx.fill();
        // Brilho vermelho nas bordas das montanhas
        ctx.strokeStyle="rgba(255,50,0,0.3)"; ctx.lineWidth=2;
        ctx.beginPath(); ctx.moveTo(0,280); ctx.lineTo(80,200); ctx.lineTo(160,320); ctx.lineTo(300,140);
        ctx.lineTo(420,300); ctx.lineTo(580,180); ctx.lineTo(700,340); ctx.lineTo(850,160);
        ctx.lineTo(1000,300); ctx.lineTo(1100,200); ctx.stroke();
        // Ch√£o rochoso
        let gnd = ctx.createLinearGradient(0,450,0,canvas.height);
        gnd.addColorStop(0,"#2a0010"); gnd.addColorStop(1,"#0f0008");
        ctx.fillStyle=gnd; ctx.fillRect(0,450,canvas.width,canvas.height-450);
        // Fissuras no ch√£o com brilho
        ctx.strokeStyle="rgba(255,60,0,0.5)"; ctx.lineWidth=2;
        [[100,460,250,510],[300,480,400,465],[600,455,750,500],[800,470,950,490],[50,510,150,520]].forEach(([x1,y1,x2,y2])=>{
            ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
            ctx.fillStyle="rgba(255,80,0,0.15)"; ctx.fillRect(Math.min(x1,x2)-2,Math.min(y1,y2)-2,Math.abs(x2-x1)+4,Math.abs(y2-y1)+4);
        });
    },
    // ‚îÄ‚îÄ CEN√ÅRIO 8: NAVE DO FREEZA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function drawFriezaShip() {
        // Fundo: espa√ßo escuro com tom roxo
        let sky = ctx.createLinearGradient(0,0,0,canvas.height);
        sky.addColorStop(0,"#050010"); sky.addColorStop(1,"#0a0020");
        ctx.fillStyle=sky; ctx.fillRect(0,0,canvas.width,canvas.height);
        // Estrelas
        for(let i=0;i<100;i++){
            let sx=(Math.sin(i*193)*0.5+0.5)*canvas.width;
            let sy=(Math.cos(i*107)*0.5+0.5)*420;
            ctx.fillStyle="rgba(255,255,255,"+(0.3+Math.abs(Math.sin(i+timeEnv))*0.5)+")";
            ctx.beginPath(); ctx.arc(sx,sy,0.8,0,Math.PI*2); ctx.fill();
        }
        // Parede de metal da nave ao fundo
        ctx.fillStyle="#1a1a2e";
        ctx.fillRect(0,0,canvas.width,450);
        // Painel tecnol√≥gico de fundo
        ctx.strokeStyle="rgba(180,0,255,0.2)"; ctx.lineWidth=1;
        for(let x=0;x<canvas.width;x+=80){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,450); ctx.stroke(); }
        for(let y=0;y<450;y+=60){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(canvas.width,y); ctx.stroke(); }
        // M√≥dulos de parede (placas met√°licas)
        const panels=[
            [20,20,200,120],[240,20,200,120],[460,20,200,120],[680,20,200,120],[900,20,180,120],
            [20,160,200,100],[460,160,360,100],[880,160,200,100],
            [20,280,340,120],[380,280,200,120],[600,280,480,120]
        ];
        panels.forEach(([px,py,pw,ph])=>{
            let pg = ctx.createLinearGradient(px,py,px,py+ph);
            pg.addColorStop(0,"rgba(60,40,80,0.8)"); pg.addColorStop(1,"rgba(30,20,50,0.9)");
            ctx.fillStyle=pg; ctx.fillRect(px,py,pw,ph);
            ctx.strokeStyle="rgba(180,0,255,0.4)"; ctx.lineWidth=1.5;
            ctx.strokeRect(px+2,py+2,pw-4,ph-4);
            // Luzes de painel
            ctx.fillStyle="rgba(180,0,255,0.8)"; ctx.shadowBlur=6; ctx.shadowColor="#b400ff";
            ctx.fillRect(px+pw-15,py+10,8,4); ctx.fillRect(px+pw-15,py+18,8,4);
            ctx.shadowBlur=0;
        });
        // Janela redonda com vista para o espa√ßo
        let win = ctx.createRadialGradient(canvas.width/2,120,0,canvas.width/2,120,100);
        win.addColorStop(0,"rgba(0,20,60,1)"); win.addColorStop(0.7,"rgba(0,10,30,1)"); win.addColorStop(1,"rgba(50,0,80,0.8)");
        ctx.fillStyle=win; ctx.beginPath(); ctx.arc(canvas.width/2,120,100,0,Math.PI*2); ctx.fill();
        ctx.strokeStyle="rgba(180,0,255,0.8)"; ctx.lineWidth=4;
        ctx.beginPath(); ctx.arc(canvas.width/2,120,100,0,Math.PI*2); ctx.stroke();
        // Planeta dentro da janela
        let wp=ctx.createRadialGradient(canvas.width/2+30,140,0,canvas.width/2+30,140,55);
        wp.addColorStop(0,"#4a90d9"); wp.addColorStop(0.5,"#2c6096"); wp.addColorStop(1,"#0a2040");
        ctx.save(); ctx.beginPath(); ctx.arc(canvas.width/2,120,96,0,Math.PI*2); ctx.clip();
        ctx.fillStyle=wp; ctx.beginPath(); ctx.arc(canvas.width/2+30,140,55,0,Math.PI*2); ctx.fill();
        ctx.restore();
        // Ch√£o met√°lico
        let floor = ctx.createLinearGradient(0,450,0,canvas.height);
        floor.addColorStop(0,"#1e1030"); floor.addColorStop(1,"#0a0818");
        ctx.fillStyle=floor; ctx.fillRect(0,450,canvas.width,canvas.height-450);
        // Luz n√©on roxa no ch√£o
        ctx.shadowBlur=20; ctx.shadowColor="#b400ff";
        ctx.fillStyle="rgba(180,0,255,0.15)"; ctx.fillRect(0,449,canvas.width,5);
        ctx.shadowBlur=0;
        // Grade do ch√£o
        ctx.strokeStyle="rgba(180,0,255,0.12)"; ctx.lineWidth=1;
        for(let i=0;i<canvas.width;i+=80){ ctx.beginPath(); ctx.moveTo(i,450); ctx.lineTo(i,canvas.height); ctx.stroke(); }
        for(let j=450;j<canvas.height;j+=30){ ctx.beginPath(); ctx.moveTo(0,j); ctx.lineTo(canvas.width,j); ctx.stroke(); }
    },
    // ‚îÄ‚îÄ CEN√ÅRIO 9: MUNDO DO BEERUS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function drawBeerusWorld() {
        // C√©u c√≥smico dourado-roxo
        let sky = ctx.createLinearGradient(0,0,0,450);
        sky.addColorStop(0,"#0a0520"); sky.addColorStop(0.3,"#1a0840"); sky.addColorStop(0.7,"#2a1060"); sky.addColorStop(1,"#3a1a50");
        ctx.fillStyle=sky; ctx.fillRect(0,0,canvas.width,450);
        // Nebulosas coloridas
        [[300,150,200,"rgba(100,0,200,0.15)"],[700,200,180,"rgba(200,100,0,0.12)"],[100,250,150,"rgba(0,150,200,0.1)"]].forEach(([nx,ny,nr,nc])=>{
            let ng = ctx.createRadialGradient(nx,ny,0,nx,ny,nr);
            ng.addColorStop(0,nc); ng.addColorStop(1,"transparent");
            ctx.fillStyle=ng; ctx.fillRect(0,0,canvas.width,450);
        });
        // Via L√°ctea
        ctx.save(); ctx.globalAlpha=0.15;
        let mw = ctx.createLinearGradient(0,0,canvas.width,350);
        mw.addColorStop(0,"transparent"); mw.addColorStop(0.4,"rgba(255,255,255,0.8)"); mw.addColorStop(0.6,"rgba(255,255,255,0.8)"); mw.addColorStop(1,"transparent");
        ctx.fillStyle=mw; ctx.fillRect(0,60,canvas.width,80);
        ctx.restore();
        // Estrelas douradas
        for(let i=0;i<130;i++){
            let sx=(Math.sin(i*167.5)*0.5+0.5)*canvas.width;
            let sy=(Math.cos(i*89.3)*0.5+0.5)*420;
            let ss=0.5+Math.abs(Math.sin(i+timeEnv*0.4))*1.5;
            let sc=i%5===0?"rgba(255,200,0,"+(0.6+ss*0.3)+")":"rgba(255,255,255,"+(0.3+ss*0.2)+")";
            ctx.fillStyle=sc; ctx.beginPath(); ctx.arc(sx,sy,ss*0.8,0,Math.PI*2); ctx.fill();
        }
        // Planeta do Beerus (gigante dourado)
        ctx.save(); ctx.globalAlpha=0.55;
        let bp = ctx.createRadialGradient(canvas.width/2,250,0,canvas.width/2,250,320);
        bp.addColorStop(0,"rgba(255,220,80,0.9)"); bp.addColorStop(0.4,"rgba(220,140,20,0.7)");
        bp.addColorStop(0.75,"rgba(100,50,0,0.4)"); bp.addColorStop(1,"transparent");
        ctx.fillStyle=bp; ctx.beginPath(); ctx.arc(canvas.width/2,250,320,0,Math.PI*2); ctx.fill();
        // An√©is do planeta
        ctx.strokeStyle="rgba(255,200,50,0.3)"; ctx.lineWidth=8;
        ctx.save(); ctx.translate(canvas.width/2,250); ctx.scale(1,0.3); ctx.rotate(0.3);
        ctx.beginPath(); ctx.arc(0,0,360,0,Math.PI*2); ctx.stroke();
        ctx.strokeStyle="rgba(255,180,30,0.2)"; ctx.lineWidth=4;
        ctx.beginPath(); ctx.arc(0,0,390,0,Math.PI*2); ctx.stroke();
        ctx.restore(); ctx.restore();
        // Templo no fundo
        ctx.fillStyle="rgba(255,200,80,0.5)"; ctx.shadowBlur=15; ctx.shadowColor="#ffd700";
        // Degraus
        [[350,390,400,20],[360,370,380,20],[370,350,360,20],[380,330,340,20],[390,310,320,20]].forEach(([tx,ty,tw,th])=>{
            ctx.fillRect(tx,ty,tw,th);
        });
        // Colunas
        [[400,220,20,110],[530,220,20,110],[660,220,20,110]].forEach(([cx,cy,cw,ch])=>{ ctx.fillRect(cx,cy,cw,ch); });
        // Teto
        ctx.fillRect(380,210,340,15);
        ctx.shadowBlur=0;
        // Ch√£o de pedra dourada
        let gnd = ctx.createLinearGradient(0,450,0,canvas.height);
        gnd.addColorStop(0,"#3a2800"); gnd.addColorStop(1,"#1a1000");
        ctx.fillStyle=gnd; ctx.fillRect(0,450,canvas.width,canvas.height-450);
        // Brilhos dourados no ch√£o
        ctx.strokeStyle="rgba(255,200,50,0.15)"; ctx.lineWidth=1;
        for(let i=0;i<canvas.width;i+=80){ ctx.beginPath(); ctx.moveTo(i,450); ctx.lineTo(i,canvas.height); ctx.stroke(); }
        for(let j=450;j<canvas.height;j+=30){ ctx.beginPath(); ctx.moveTo(0,j); ctx.lineTo(canvas.width,j); ctx.stroke(); }
        // Luz dourada no horizonte
        ctx.fillStyle="rgba(255,200,50,0.2)"; ctx.fillRect(0,447,canvas.width,6);
    },
    // ‚îÄ‚îÄ CEN√ÅRIO 10: ARENA DO CELL GAMES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function drawCellGames() {
        // C√©u alaranjado com nuvens de tempestade
        let sky = ctx.createLinearGradient(0,0,0,450);
        sky.addColorStop(0,"#2e1800"); sky.addColorStop(0.3,"#5a3010"); sky.addColorStop(0.7,"#8b4a00"); sky.addColorStop(1,"#c06000");
        ctx.fillStyle=sky; ctx.fillRect(0,0,canvas.width,450);
        // Nuvens escuras de tempestade
        const clouds=[[100,80,180,60],[350,50,220,70],[650,90,250,65],[900,60,190,55],[200,130,160,50],[700,120,200,55]];
        clouds.forEach(([cx,cy,cw,ch])=>{
            let cg = ctx.createRadialGradient(cx+cw/2,cy+ch/2,0,cx+cw/2,cy+ch/2,cw/2);
            cg.addColorStop(0,"rgba(30,20,10,0.85)"); cg.addColorStop(0.6,"rgba(20,15,5,0.6)"); cg.addColorStop(1,"transparent");
            ctx.fillStyle=cg; ctx.beginPath(); ctx.ellipse(cx+cw/2,cy+ch/2,cw/2,ch/2,0,0,Math.PI*2); ctx.fill();
        });
        // Sol avermelhado
        let sol = ctx.createRadialGradient(200,120,0,200,120,80);
        sol.addColorStop(0,"rgba(255,140,0,0.9)"); sol.addColorStop(0.6,"rgba(200,80,0,0.4)"); sol.addColorStop(1,"transparent");
        ctx.fillStyle=sol; ctx.fillRect(120,40,160,160);
        // Rel√¢mpagos animados
        let lp = Math.abs(Math.sin(timeEnv*1.5));
        if(lp > 0.85){
            ctx.strokeStyle="rgba(255,255,150,"+lp+")"; ctx.lineWidth=2; ctx.shadowBlur=20; ctx.shadowColor="#ffff00";
            let lx = 300 + Math.floor(timeEnv*100)%500;
            ctx.beginPath(); ctx.moveTo(lx,0); ctx.lineTo(lx-30,150); ctx.lineTo(lx+20,200); ctx.lineTo(lx-15,350); ctx.lineTo(lx+10,450); ctx.stroke();
            ctx.shadowBlur=0;
        }
        // Ringue circular do Cell Games
        ctx.fillStyle="#c8b080";
        ctx.beginPath(); ctx.ellipse(canvas.width/2,540,420,80,0,0,Math.PI*2); ctx.fill();
        // Bordas do ringue com marcas verdes do Cell
        ctx.strokeStyle="rgba(0,200,0,0.5)"; ctx.lineWidth=3;
        ctx.beginPath(); ctx.ellipse(canvas.width/2,540,420,80,0,0,Math.PI*2); ctx.stroke();
        // Texto Cell Games no ringue
        ctx.font="bold 18px Rajdhani"; ctx.fillStyle="rgba(0,200,0,0.7)"; ctx.textAlign="center";
        ctx.fillText("CELL GAMES", canvas.width/2, 548);
        // Marcas de piso destru√≠do
        ctx.fillStyle="#a09070";
        [[150,460,80,15],[400,470,60,12],[700,455,90,18],[950,465,70,14]].forEach(([dx,dy,dw,dh])=>{
            ctx.beginPath(); ctx.ellipse(dx+dw/2,dy+dh/2,dw/2,dh/2,0,0,Math.PI*2); ctx.fill();
        });
        // Ch√£o
        let gnd = ctx.createLinearGradient(0,450,0,canvas.height);
        gnd.addColorStop(0,"#8b7050"); gnd.addColorStop(1,"#4a3820");
        ctx.fillStyle=gnd; ctx.fillRect(0,450,canvas.width,canvas.height-450);
        // Ra√≠zes / rachaduras no ch√£o
        ctx.strokeStyle="rgba(0,0,0,0.4)"; ctx.lineWidth=1.5;
        [[180,460,140,490],[350,480,500,465],[600,490,700,510],[850,460,900,490],[50,500,200,520]].forEach(([x1,y1,x2,y2])=>{
            ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
        });
    },
    // ‚îÄ‚îÄ CEN√ÅRIO 11: MUNDO DOS KAIS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function drawKaiWorld() {
        // Fundo c√≥smico azul-verde
        let sky = ctx.createLinearGradient(0,0,0,450);
        sky.addColorStop(0,"#001a10"); sky.addColorStop(0.4,"#003a20"); sky.addColorStop(1,"#00281a");
        ctx.fillStyle=sky; ctx.fillRect(0,0,canvas.width,450);
        // Aurora Boreal
        for(let a=0;a<5;a++){
            let ax=(a/5)*canvas.width+Math.sin(timeEnv*0.3+a)*50;
            let ag = ctx.createLinearGradient(ax,0,ax+120,350);
            ag.addColorStop(0,"transparent"); ag.addColorStop(0.3,"rgba(0,255,150,"+(0.05+a*0.02)+")");
            ag.addColorStop(0.7,"rgba(0,200,255,"+(0.04+a*0.015)+")"); ag.addColorStop(1,"transparent");
            ctx.fillStyle=ag; ctx.fillRect(ax,0,120,380);
        }
        // Planetas ao fundo
        [{cx:150,cy:180,r:60,c1:"#1a3a6a",c2:"#0a1a30"},{cx:900,cy:130,r:45,c1:"#2a1a4a",c2:"#100818"}].forEach(({cx,cy,r,c1,c2})=>{
            let pg = ctx.createRadialGradient(cx-r*0.3,cy-r*0.3,0,cx,cy,r);
            pg.addColorStop(0,c1); pg.addColorStop(1,c2);
            ctx.save(); ctx.globalAlpha=0.6;
            ctx.fillStyle=pg; ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.fill();
            ctx.restore();
        });
        // Estrelas verdes brilhantes
        for(let i=0;i<100;i++){
            let sx=(Math.sin(i*183)*0.5+0.5)*canvas.width;
            let sy=(Math.cos(i*101)*0.5+0.5)*400;
            let ss=0.5+Math.abs(Math.sin(i+timeEnv*0.5))*1.5;
            ctx.fillStyle= i%4===0?"rgba(0,255,150,"+(0.6+ss*0.3)+")":"rgba(200,255,220,"+(0.3+ss*0.2)+")";
            ctx.beginPath(); ctx.arc(sx,sy,ss*0.7,0,Math.PI*2); ctx.fill();
        }
        // Pir√¢mide dos Kais
        ctx.fillStyle="rgba(0,80,40,0.8)"; ctx.shadowBlur=20; ctx.shadowColor="rgba(0,255,100,0.5)";
        ctx.beginPath(); ctx.moveTo(canvas.width/2,120); ctx.lineTo(canvas.width/2-200,400); ctx.lineTo(canvas.width/2+200,400); ctx.closePath(); ctx.fill();
        ctx.shadowBlur=0;
        // Linhas na pir√¢mide
        ctx.strokeStyle="rgba(0,255,100,0.2)"; ctx.lineWidth=1;
        for(let level=1;level<8;level++){
            let t=level/8; let py=120+t*280; let pw=t*400;
            ctx.beginPath(); ctx.moveTo(canvas.width/2-pw/2,py); ctx.lineTo(canvas.width/2+pw/2,py); ctx.stroke();
        }
        // Topo da pir√¢mide brilhante
        ctx.fillStyle="rgba(0,255,100,0.9)"; ctx.shadowBlur=30; ctx.shadowColor="#00ff64";
        ctx.beginPath(); ctx.arc(canvas.width/2,120,12,0,Math.PI*2); ctx.fill();
        ctx.shadowBlur=0;
        // √Årvores alien√≠genas
        [[80,420],[180,430],[950,420],[1020,435]].forEach(([tx,ty])=>{
            ctx.fillStyle="#005a28"; ctx.fillRect(tx-4,ty,8,30);
            ctx.fillStyle="#00882a"; ctx.beginPath(); ctx.arc(tx,ty-15,22,0,Math.PI*2); ctx.fill();
            ctx.fillStyle="#00cc40"; ctx.beginPath(); ctx.arc(tx-8,ty-8,14,0,Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(tx+8,ty-5,12,0,Math.PI*2); ctx.fill();
        });
        // Ch√£o verde sagrado
        let gnd = ctx.createLinearGradient(0,450,0,canvas.height);
        gnd.addColorStop(0,"#003a18"); gnd.addColorStop(1,"#001a0a");
        ctx.fillStyle=gnd; ctx.fillRect(0,450,canvas.width,canvas.height-450);
        // Mandala luminosa no ch√£o
        ctx.strokeStyle="rgba(0,255,100,0.12)"; ctx.lineWidth=1;
        for(let i=0;i<canvas.width;i+=80){ ctx.beginPath(); ctx.moveTo(i,450); ctx.lineTo(i,canvas.height); ctx.stroke(); }
        for(let j=450;j<canvas.height;j+=30){ ctx.beginPath(); ctx.moveTo(0,j); ctx.lineTo(canvas.width,j); ctx.stroke(); }
        // Brilho verde sagrado no horizonte
        ctx.fillStyle="rgba(0,255,100,0.25)"; ctx.fillRect(0,447,canvas.width,6);
    },
    // ‚îÄ‚îÄ CEN√ÅRIO 12: HYPERBOLIC CHAMBER DARK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function drawDarkChamber() {
        // Vers√£o obscura da c√¢mara ‚Äî universo invertido
        ctx.fillStyle="#000305"; ctx.fillRect(0,0,canvas.width,canvas.height);
        // Grade sombria com falhas
        ctx.strokeStyle="rgba(0,200,255,0.08)"; ctx.lineWidth=1;
        for(let i=0;i<=20;i++){
            let t=i/20; let y=canvas.height*t;
            let xStart=canvas.width/2*(1-t)*0.8; let xEnd=canvas.width-xStart;
            ctx.beginPath(); ctx.moveTo(xStart,y); ctx.lineTo(xEnd,y); ctx.stroke();
        }
        for(let i=0;i<=20;i++){
            let t=i/20; let x=canvas.width*t;
            let yStart=canvas.height/2*(1-Math.abs(t-0.5)*2)*0.5;
            ctx.beginPath(); ctx.moveTo(x,yStart); ctx.lineTo(canvas.width/2,canvas.height/2); ctx.stroke();
        }
        // Distor√ß√£o esp√°cio-temporal (ondas)
        for(let wave=0;wave<4;wave++){
            let wy=200+wave*80+Math.sin(timeEnv*1.5+wave)*20;
            let wg = ctx.createLinearGradient(0,wy-20,0,wy+20);
            wg.addColorStop(0,"transparent"); wg.addColorStop(0.5,"rgba(0,200,255,0.06)"); wg.addColorStop(1,"transparent");
            ctx.fillStyle=wg; ctx.fillRect(0,wy-20,canvas.width,40);
        }
        // Cratera de energia no centro
        let ce = ctx.createRadialGradient(canvas.width/2,canvas.height/2,0,canvas.width/2,canvas.height/2,150);
        ce.addColorStop(0,"rgba(0,200,255,0.12)"); ce.addColorStop(0.5,"rgba(0,100,150,0.06)"); ce.addColorStop(1,"transparent");
        ctx.fillStyle=ce; ctx.fillRect(0,0,canvas.width,canvas.height);
        // Horizonte com raio de energia
        let ep = 0.3+Math.abs(Math.sin(timeEnv*0.8))*0.7;
        ctx.fillStyle="rgba(0,200,255,"+(ep*0.15)+")"; ctx.fillRect(0,canvas.height/2-3,canvas.width,6);
        ctx.shadowBlur=30*ep; ctx.shadowColor="#00c8ff";
        ctx.fillStyle="rgba(0,200,255,"+(ep*0.6)+")"; ctx.fillRect(0,canvas.height/2-1,canvas.width,2);
        ctx.shadowBlur=0;
        // Ch√£o sombrio com reflexo ciano
        let floor = ctx.createLinearGradient(0,450,0,canvas.height);
        floor.addColorStop(0,"#020810"); floor.addColorStop(1,"#010508");
        ctx.fillStyle=floor; ctx.fillRect(0,450,canvas.width,canvas.height-450);
        // Reflexo ciano no ch√£o
        ctx.strokeStyle="rgba(0,200,255,0.08)"; ctx.lineWidth=1;
        for(let i=0;i<canvas.width;i+=60){ ctx.beginPath(); ctx.moveTo(canvas.width/2,450); ctx.lineTo(i,canvas.height); ctx.stroke(); }
        for(let j=450;j<canvas.height;j+=30){ ctx.beginPath(); ctx.moveTo(0,j); ctx.lineTo(canvas.width,j); ctx.stroke(); }
        // Linha de energia no horizonte do ch√£o
        ctx.fillStyle="rgba(0,200,255,0.2)"; ctx.fillRect(0,449,canvas.width,3);
        // Part√≠culas flutuando
        for(let i=0;i<15;i++){
            let px=(Math.sin(i*157.3+timeEnv*0.5)*0.5+0.5)*canvas.width;
            let py=50+(Math.cos(i*89.7+timeEnv*0.3)*0.5+0.5)*380;
            let pr=1+Math.abs(Math.sin(i+timeEnv*2))*2;
            ctx.fillStyle="rgba(0,200,255,"+(0.3+pr*0.2)+")";
            ctx.shadowBlur=pr*6; ctx.shadowColor="#00c8ff";
            ctx.beginPath(); ctx.arc(px,py,pr,0,Math.PI*2); ctx.fill();
            ctx.shadowBlur=0;
        }
    },
    // ‚îÄ‚îÄ CEN√ÅRIO 13: DESERTO DE AREIA (PLANETA AREIA) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function drawDesert() {
        // C√©u laranja ardente com poeira
        let sky = ctx.createLinearGradient(0,0,0,450);
        sky.addColorStop(0,"#8b4500"); sky.addColorStop(0.4,"#c86400"); sky.addColorStop(1,"#e8a040");
        ctx.fillStyle=sky; ctx.fillRect(0,0,canvas.width,450);
        // Sol inclemente
        let sol = ctx.createRadialGradient(180,100,0,180,100,90);
        sol.addColorStop(0,"rgba(255,230,100,1)"); sol.addColorStop(0.5,"rgba(255,160,20,0.6)"); sol.addColorStop(1,"transparent");
        ctx.fillStyle=sol; ctx.fillRect(90,10,180,180);
        // Nuvens de poeira
        for(let i=0;i<6;i++){
            let cx=100+i*180+Math.sin(timeEnv*0.4+i)*30;
            let cy=100+Math.cos(i*1.3)*60;
            let r=40+i*15;
            let cg = ctx.createRadialGradient(cx,cy,0,cx,cy,r);
            cg.addColorStop(0,"rgba(180,120,40,0.3)"); cg.addColorStop(1,"transparent");
            ctx.fillStyle=cg; ctx.fillRect(cx-r,cy-r,r*2,r*2);
        }
        // Dunas ao fundo
        ctx.fillStyle="#c89050";
        ctx.beginPath(); ctx.moveTo(0,450);
        ctx.bezierCurveTo(100,380,200,430,350,390);
        ctx.bezierCurveTo(500,350,600,420,750,385);
        ctx.bezierCurveTo(900,350,1000,400,1100,370);
        ctx.lineTo(1100,450); ctx.closePath(); ctx.fill();
        // Camada mais escura de dunas
        ctx.fillStyle="#a07030";
        ctx.beginPath(); ctx.moveTo(0,450);
        ctx.bezierCurveTo(150,410,300,440,450,415);
        ctx.bezierCurveTo(600,390,750,430,900,410);
        ctx.bezierCurveTo(1000,395,1060,425,1100,410);
        ctx.lineTo(1100,450); ctx.closePath(); ctx.fill();
        // Ru√≠nas de pedra
        ctx.fillStyle="#5a3a10";
        [[80,370,30,80],[100,360,20,90],[600,365,25,85],[625,355,18,95]].forEach(([px,py,pw,ph])=>{
            ctx.fillRect(px,py,pw,ph);
        });
        // Ch√£o de areia
        let gnd = ctx.createLinearGradient(0,450,0,canvas.height);
        gnd.addColorStop(0,"#d4a060"); gnd.addColorStop(1,"#9a6030");
        ctx.fillStyle=gnd; ctx.fillRect(0,450,canvas.width,canvas.height-450);
        // Sombra das dunas no ch√£o
        ctx.fillStyle="rgba(0,0,0,0.1)"; ctx.fillRect(0,450,canvas.width,15);
        // Ondas de calor (distor√ß√£o)
        for(let i=0;i<8;i++){
            let hx=(i/8)*canvas.width+Math.sin(timeEnv*2+i)*20;
            ctx.strokeStyle=`rgba(255,180,80,${0.03+Math.abs(Math.sin(timeEnv+i))*0.04})`; ctx.lineWidth=8;
            ctx.beginPath(); ctx.moveTo(hx,450); ctx.lineTo(hx+50,435); ctx.stroke();
        }
    },
    // ‚îÄ‚îÄ CEN√ÅRIO 14: LABORAT√ìRIO DO DR. GERO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function drawLabGero() {
        // Fundo cinza met√°lico
        let bg = ctx.createLinearGradient(0,0,0,canvas.height);
        bg.addColorStop(0,"#0a0a0f"); bg.addColorStop(1,"#0d0d18");
        ctx.fillStyle=bg; ctx.fillRect(0,0,canvas.width,canvas.height);
        // Luzes de teto (spots)
        for(let i=0;i<6;i++){
            let lx=80+i*190;
            let lg = ctx.createRadialGradient(lx,0,0,lx,300,300);
            lg.addColorStop(0,"rgba(100,150,255,0.15)"); lg.addColorStop(0.5,"rgba(50,80,180,0.05)"); lg.addColorStop(1,"transparent");
            ctx.fillStyle=lg; ctx.fillRect(0,0,canvas.width,450);
            // Foco de luz
            ctx.fillStyle="rgba(200,220,255,0.9)"; ctx.shadowBlur=8; ctx.shadowColor="#aaccff";
            ctx.beginPath(); ctx.ellipse(lx,5,12,4,0,0,Math.PI*2); ctx.fill(); ctx.shadowBlur=0;
        }
        // Paredes de metal
        ctx.fillStyle="rgba(30,35,50,0.95)"; ctx.fillRect(0,0,canvas.width,420);
        // Grades met√°licas verticais
        ctx.strokeStyle="rgba(80,90,130,0.4)"; ctx.lineWidth=8;
        for(let i=0;i<14;i++){
            let gx=80*i; ctx.beginPath(); ctx.moveTo(gx,0); ctx.lineTo(gx,420); ctx.stroke();
        }
        // Tubos de vidro com androides (detalhes)
        const tubes = [[200,80,80,280],[500,80,80,280],[800,80,80,280]];
        tubes.forEach(([tx,ty,tw,th])=>{
            // Tubo
            let tg = ctx.createLinearGradient(tx,0,tx+tw,0);
            tg.addColorStop(0,"rgba(0,150,255,0.15)"); tg.addColorStop(0.5,"rgba(50,200,255,0.3)"); tg.addColorStop(1,"rgba(0,150,255,0.15)");
            ctx.fillStyle=tg; ctx.fillRect(tx,ty,tw,th);
            ctx.strokeStyle="rgba(0,200,255,0.6)"; ctx.lineWidth=3;
            ctx.strokeRect(tx,ty,tw,th);
            // Bolhas dentro do tubo
            for(let b=0;b<4;b++){
                let bx=tx+15+Math.random()*(tw-30);
                let by=ty+10+Math.random()*(th-20);
                ctx.fillStyle="rgba(100,220,255,0.3)";
                ctx.beginPath(); ctx.arc(bx,by,3+Math.random()*4,0,Math.PI*2); ctx.fill();
            }
            // Brilho n√©on azul em baixo do tubo
            ctx.fillStyle="rgba(0,200,255,0.3)"; ctx.shadowBlur=15; ctx.shadowColor="#00c8ff";
            ctx.fillRect(tx,ty+th-6,tw,6); ctx.shadowBlur=0;
        });
        // Consola de computador
        ctx.fillStyle="rgba(20,25,40,0.9)"; ctx.fillRect(0,370,canvas.width,50);
        ctx.fillStyle="rgba(0,200,255,0.15)"; ctx.fillRect(0,370,canvas.width,3);
        for(let s=0;s<8;s++){
            let sx=60+s*130; let blink=Math.random()>0.6;
            ctx.fillStyle=blink?"rgba(0,255,100,0.8)":"rgba(255,50,50,0.6)";
            ctx.shadowBlur=blink?6:0; ctx.shadowColor=blink?"#00ff64":"#ff3232";
            ctx.fillRect(sx,382,16,10); ctx.shadowBlur=0;
        }
        // Ch√£o de laborat√≥rio
        let floor = ctx.createLinearGradient(0,420,0,canvas.height);
        floor.addColorStop(0,"#181e2a"); floor.addColorStop(1,"#0c1018");
        ctx.fillStyle=floor; ctx.fillRect(0,420,canvas.width,canvas.height-420);
        // Grade do ch√£o
        ctx.strokeStyle="rgba(0,150,255,0.12)"; ctx.lineWidth=1;
        for(let i=0;i<canvas.width;i+=60){ ctx.beginPath(); ctx.moveTo(i,420); ctx.lineTo(i,canvas.height); ctx.stroke(); }
        for(let j=420;j<canvas.height;j+=30){ ctx.beginPath(); ctx.moveTo(0,j); ctx.lineTo(canvas.width,j); ctx.stroke(); }
        // Brilho azul no ch√£o
        ctx.fillStyle="rgba(0,180,255,0.12)"; ctx.fillRect(0,419,canvas.width,5);
    },
    // ‚îÄ‚îÄ CEN√ÅRIO 15: MUNDO DOS SAIYAJINS (GT / PLANETA NATAL) ‚îÄ
    function drawSaiyanWorld() {
        // C√©u crepuscular com planeta vermelho
        let sky = ctx.createLinearGradient(0,0,0,450);
        sky.addColorStop(0,"#000510"); sky.addColorStop(0.3,"#100520"); sky.addColorStop(0.7,"#200820"); sky.addColorStop(1,"#400010");
        ctx.fillStyle=sky; ctx.fillRect(0,0,canvas.width,450);
        // Dois luas / planetas
        [{cx:200,cy:100,r:55,c0:"#c8a0e0",c1:"#600080"},{cx:900,cy:150,r:35,c0:"#ff9060",c1:"#800020"}].forEach(({cx,cy,r,c0,c1})=>{
            let pg = ctx.createRadialGradient(cx-r*0.3,cy-r*0.3,0,cx,cy,r);
            pg.addColorStop(0,c0); pg.addColorStop(1,c1);
            ctx.fillStyle=pg; ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.fill();
        });
        // Estrelas
        for(let i=0;i<100;i++){
            let sx=(Math.sin(i*179.3)*0.5+0.5)*canvas.width;
            let sy=(Math.cos(i*113.7)*0.5+0.5)*380;
            ctx.fillStyle="rgba(255,255,255,"+(0.3+Math.abs(Math.sin(i+timeEnv*0.3))*0.5)+")";
            ctx.beginPath(); ctx.arc(sx,sy,0.7,0,Math.PI*2); ctx.fill();
        }
        // Floresta alien√≠gena escura
        ctx.fillStyle="#0a0520";
        for(let t=0;t<12;t++){
            let tx=t*(1100/12)+30; let th=60+Math.sin(t*2.3)*40;
            ctx.beginPath(); ctx.moveTo(tx-20,450); ctx.lineTo(tx,450-th);
            ctx.lineTo(tx+20,450); ctx.closePath(); ctx.fill();
            // Copa da √°rvore
            ctx.fillStyle="#150830";
            ctx.beginPath(); ctx.arc(tx,450-th-10,28,0,Math.PI*2); ctx.fill();
            ctx.fillStyle="#0a0520";
        }
        // Rochas flutuantes (estilo GT)
        [{x:300,y:200,w:80,h:25},{x:650,y:150,w:60,h:20},{x:950,y:220,w:70,h:22}].forEach(({x,y,w,h})=>{
            let ry = y + Math.sin(timeEnv*1.2)*8;
            ctx.fillStyle="rgba(80,40,100,0.85)";
            ctx.beginPath(); ctx.ellipse(x,ry,w/2,h/2,0,0,Math.PI*2); ctx.fill();
            ctx.strokeStyle="rgba(180,80,255,0.3)"; ctx.lineWidth=2;
            ctx.beginPath(); ctx.ellipse(x,ry,w/2,h/2,0,0,Math.PI*2); ctx.stroke();
            // Sombra embaixo
            ctx.fillStyle="rgba(0,0,0,0.3)";
            ctx.beginPath(); ctx.ellipse(x,450,w/3,6,0,0,Math.PI*2); ctx.fill();
        });
        // Ch√£o mystical
        let gnd = ctx.createLinearGradient(0,450,0,canvas.height);
        gnd.addColorStop(0,"#1a0530"); gnd.addColorStop(1,"#0a0215");
        ctx.fillStyle=gnd; ctx.fillRect(0,450,canvas.width,canvas.height-450);
        // Brilho violeta no ch√£o
        ctx.strokeStyle="rgba(180,50,255,0.1)"; ctx.lineWidth=1;
        for(let i=0;i<canvas.width;i+=70){ ctx.beginPath(); ctx.moveTo(i,450); ctx.lineTo(i,canvas.height); ctx.stroke(); }
        ctx.fillStyle="rgba(180,50,255,0.2)"; ctx.fillRect(0,447,canvas.width,5);
    },
    // ‚îÄ‚îÄ CEN√ÅRIO 16: DIMENS√ÉO DO ZENO SAMA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function drawZenoDimension() {
        // Fundo branco puro (casa do Zeno)
        ctx.fillStyle="#f5f8ff"; ctx.fillRect(0,0,canvas.width,canvas.height);
        // Orbes de energia coloridos flutuando
        const orbeColors=["#ff4488","#44aaff","#ffcc00","#44ffaa","#aa44ff","#ff8844"];
        for(let i=0;i<18;i++){
            let ox=(Math.sin(i*137+timeEnv*0.6)*0.5+0.5)*canvas.width;
            let oy=30+(Math.cos(i*89+timeEnv*0.4)*0.5+0.5)*380;
            let or=6+Math.abs(Math.sin(i+timeEnv*1.5))*8;
            let oc=orbeColors[i%orbeColors.length];
            ctx.fillStyle=oc; ctx.shadowBlur=or*3; ctx.shadowColor=oc;
            ctx.beginPath(); ctx.arc(ox,oy,or,0,Math.PI*2); ctx.fill();
            ctx.shadowBlur=0;
        }
        // Plataforma do Zeno (c√≠rculos conc√™ntricos)
        ctx.save(); ctx.translate(canvas.width/2,420);
        for(let r=200;r>0;r-=30){
            let tc = r/200;
            ctx.fillStyle=`rgba(${Math.floor(200*tc)},${Math.floor(180*(1-tc)+100)},255,${0.1+tc*0.3})`;
            ctx.beginPath(); ctx.ellipse(0,0,r,r*0.25,0,0,Math.PI*2); ctx.fill();
        }
        ctx.restore();
        // Cristais decorativos
        for(let c=0;c<8;c++){
            let cx=60+c*140; let cy=350+Math.sin(c*1.8)*30; let csize=15+c%3*8;
            ctx.fillStyle=`rgba(${orbeColors[c%6]})`;
            ctx.shadowBlur=10; ctx.shadowColor=orbeColors[c%6];
            ctx.save(); ctx.translate(cx,cy); ctx.rotate(c*0.5+timeEnv*0.3);
            ctx.beginPath();
            ctx.moveTo(0,-csize); ctx.lineTo(csize*0.4,0); ctx.lineTo(0,csize); ctx.lineTo(-csize*0.4,0);
            ctx.closePath(); ctx.fill(); ctx.shadowBlur=0; ctx.restore();
        }
        // Ch√£o espelhado branco
        let floor = ctx.createLinearGradient(0,450,0,canvas.height);
        floor.addColorStop(0,"#e8eeff"); floor.addColorStop(1,"#d0d8f8");
        ctx.fillStyle=floor; ctx.fillRect(0,450,canvas.width,canvas.height-450);
        // Reflexos coloridos no ch√£o
        for(let i=0;i<6;i++){
            let rx=100+i*170;
            let rg = ctx.createRadialGradient(rx,canvas.height,0,rx,canvas.height,100);
            rg.addColorStop(0,orbeColors[i]+"44"); rg.addColorStop(1,"transparent");
            ctx.fillStyle=rg; ctx.fillRect(0,450,canvas.width,canvas.height-450);
        }
    },
    // ‚îÄ‚îÄ CEN√ÅRIO 17: CAMPO DE BATALHA DESTRU√çDO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function drawDestroyedField() {
        // C√©u de fumo e cinzas
        let sky = ctx.createLinearGradient(0,0,0,450);
        sky.addColorStop(0,"#1a1a1a"); sky.addColorStop(0.3,"#2a2018"); sky.addColorStop(0.7,"#3a2810"); sky.addColorStop(1,"#4a3015");
        ctx.fillStyle=sky; ctx.fillRect(0,0,canvas.width,450);
        // Nuvens de fumo
        for(let i=0;i<8;i++){
            let smx=i*150+Math.sin(timeEnv*0.3+i)*40; let smy=50+i%3*60;
            let sg = ctx.createRadialGradient(smx,smy,0,smx,smy,80+i*20);
            sg.addColorStop(0,"rgba(60,50,40,0.5)"); sg.addColorStop(0.5,"rgba(40,35,25,0.3)"); sg.addColorStop(1,"transparent");
            ctx.fillStyle=sg; ctx.fillRect(smx-100,smy-80,200,160);
        }
        // Destro√ßos de edif√≠cios
        ctx.fillStyle="#2a2010";
        const debris=[[0,320,120,130],[250,280,90,170],[700,310,110,140],[950,290,150,160]];
        debris.forEach(([dx,dy,dw,dh])=>{
            // Edif√≠cio destru√≠do
            ctx.beginPath();
            ctx.moveTo(dx,450); ctx.lineTo(dx,dy); ctx.lineTo(dx+dw*0.6,dy-30); ctx.lineTo(dx+dw,dy+20); ctx.lineTo(dx+dw,450);
            ctx.closePath(); ctx.fill();
            // Janelas quebradas
            ctx.fillStyle="rgba(255,200,100,0.15)";
            for(let wy=dy+20;wy<440;wy+=25){ for(let wx=dx+8;wx<dx+dw-8;wx+=18){ if(Math.random()>0.4) ctx.fillRect(wx,wy,12,14); } }
            ctx.fillStyle="#2a2010";
        });
        // Inc√™ndios
        for(let f=0;f<5;f++){
            let fx=120+f*200; let fy=430; let fi=0.7+Math.abs(Math.sin(f+timeEnv*3))*0.3;
            let fg = ctx.createRadialGradient(fx,fy,0,fx,fy,30+fi*20);
            fg.addColorStop(0,`rgba(255,220,0,${fi})`); fg.addColorStop(0.4,`rgba(255,80,0,${fi*0.7})`); fg.addColorStop(1,"transparent");
            ctx.fillStyle=fg; ctx.fillRect(fx-50,fy-50,100,70);
        }
        // Ch√£o destru√≠do com rachaduras
        let gnd = ctx.createLinearGradient(0,450,0,canvas.height);
        gnd.addColorStop(0,"#3a2c1a"); gnd.addColorStop(1,"#1a1408");
        ctx.fillStyle=gnd; ctx.fillRect(0,450,canvas.width,canvas.height-450);
        // Rachaduras no ch√£o
        ctx.strokeStyle="rgba(255,100,0,0.4)"; ctx.lineWidth=2;
        [[100,455,280,510],[350,465,500,475],[600,458,700,505],[800,462,980,490],[50,510,200,520]].forEach(([x1,y1,x2,y2])=>{
            ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
        });
        // Poeira e cinzas flutuando
        for(let a=0;a<20;a++){
            let ax=(Math.sin(a*173+timeEnv*0.5)*0.5+0.5)*canvas.width;
            let ay=100+(Math.cos(a*89+timeEnv*0.3)*0.5+0.5)*320;
            ctx.fillStyle=`rgba(200,180,150,${0.1+Math.abs(Math.sin(a+timeEnv))*0.15})`;
            ctx.beginPath(); ctx.arc(ax,ay,1.5,0,Math.PI*2); ctx.fill();
        }
    },

    // ‚îÄ‚îÄ CEN√ÅRIO 18: PLANETA MAJIN BOO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function drawMajinBooWorld() {
        // C√©u cor-de-rosa sombrio
        let sky = ctx.createLinearGradient(0,0,0,450);
        sky.addColorStop(0,"#1a0018"); sky.addColorStop(0.4,"#3a0030"); sky.addColorStop(1,"#5a0040");
        ctx.fillStyle=sky; ctx.fillRect(0,0,canvas.width,450);
        // Lua rosa gigante
        let moon = ctx.createRadialGradient(200,100,0,200,100,110);
        moon.addColorStop(0,"rgba(255,150,200,0.9)"); moon.addColorStop(0.5,"rgba(220,80,150,0.6)"); moon.addColorStop(1,"transparent");
        ctx.fillStyle=moon; ctx.fillRect(90,0,220,220);
        ctx.fillStyle="rgba(255,180,220,0.95)"; ctx.shadowBlur=30; ctx.shadowColor="#ff80cc";
        ctx.beginPath(); ctx.arc(200,100,90,0,Math.PI*2); ctx.fill(); ctx.shadowBlur=0;
        // Nuvens de candy cor-de-rosa
        [[100,80,200,60],[400,50,280,70],[750,90,220,55],[1000,60,180,50]].forEach(([cx,cy,cw,ch])=>{
            let cg = ctx.createRadialGradient(cx+cw/2,cy,0,cx+cw/2,cy+ch,cw/2);
            cg.addColorStop(0,"rgba(255,100,160,0.45)"); cg.addColorStop(1,"transparent");
            ctx.fillStyle=cg; ctx.beginPath(); ctx.ellipse(cx+cw/2,cy+ch/2,cw/2,ch/2,0,0,Math.PI*2); ctx.fill();
        });
        // Estrelas cor-de-rosa
        for(let i=0;i<80;i++){
            let sx=(Math.sin(i*167)*0.5+0.5)*canvas.width;
            let sy=(Math.cos(i*89)*0.5+0.5)*400;
            let ss=0.5+Math.abs(Math.sin(i+timeEnv*0.4))*1.2;
            ctx.fillStyle=`rgba(255,150,200,${0.4+ss*0.3})`;
            ctx.beginPath(); ctx.arc(sx,sy,ss*0.8,0,Math.PI*2); ctx.fill();
        }
        // Casas de candy (estruturas do mundo do Boo)
        ctx.fillStyle="rgba(255,100,150,0.7)"; ctx.shadowBlur=10; ctx.shadowColor="#ff80cc";
        [[50,350,120,100],[850,320,140,130],[1000,360,80,90]].forEach(([bx,by,bw,bh])=>{
            ctx.fillRect(bx,by,bw,bh);
            ctx.fillStyle="rgba(255,180,200,0.8)"; ctx.fillRect(bx-10,by,bw+20,20); // telhado
            ctx.fillStyle="rgba(255,100,150,0.7)";
        });
        ctx.shadowBlur=0;
        // Part√≠culas de energia de Majin (pulsantes)
        for(let i=0;i<10;i++){
            let px=(Math.sin(i*173+timeEnv)*0.5+0.5)*canvas.width;
            let py=300+Math.abs(Math.cos(i*89+timeEnv*0.5))*100;
            let pa=0.3+Math.abs(Math.sin(i+timeEnv*3))*0.4;
            ctx.fillStyle=`rgba(255,50,100,${pa})`; ctx.shadowBlur=12; ctx.shadowColor="#ff3366";
            ctx.beginPath(); ctx.arc(px,py,4+Math.abs(Math.sin(i+timeEnv*2))*5,0,Math.PI*2); ctx.fill();
        }
        ctx.shadowBlur=0;
        // Ch√£o de candy rosa
        let gnd = ctx.createLinearGradient(0,450,0,canvas.height);
        gnd.addColorStop(0,"#5a0040"); gnd.addColorStop(1,"#2a001a");
        ctx.fillStyle=gnd; ctx.fillRect(0,450,canvas.width,canvas.height-450);
        ctx.fillStyle="rgba(255,100,160,0.2)"; ctx.fillRect(0,448,canvas.width,6);
        ctx.strokeStyle="rgba(255,100,160,0.12)"; ctx.lineWidth=1;
        for(let i=0;i<canvas.width;i+=80){ ctx.beginPath(); ctx.moveTo(i,450); ctx.lineTo(i,canvas.height); ctx.stroke(); }
    },
    // ‚îÄ‚îÄ CEN√ÅRIO 19: TORNEIO DOS DEUSES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function drawTournamentOfPower() {
        // C√©u c√≥smico branco-dourado
        let sky = ctx.createLinearGradient(0,0,0,450);
        sky.addColorStop(0,"#f0f8ff"); sky.addColorStop(0.4,"#e0ecff"); sky.addColorStop(1,"#c0d8f0");
        ctx.fillStyle=sky; ctx.fillRect(0,0,canvas.width,450);
        // Universos ao fundo (esferas coloridas)
        const universes=[
            {x:100,y:120,r:70,c1:"rgba(255,100,0,0.4)",c2:"rgba(200,50,0,0.1)"},
            {x:350,y:80,r:55,c1:"rgba(0,200,255,0.35)",c2:"rgba(0,100,200,0.08)"},
            {x:700,y:100,r:65,c1:"rgba(100,255,100,0.35)",c2:"rgba(0,150,0,0.08)"},
            {x:950,y:90,r:50,c1:"rgba(200,0,255,0.35)",c2:"rgba(100,0,200,0.08)"},
        ];
        universes.forEach(({x,y,r,c1,c2})=>{
            let ug=ctx.createRadialGradient(x,y,0,x,y,r);
            ug.addColorStop(0,c1); ug.addColorStop(1,c2);
            ctx.save(); ctx.globalAlpha=0.6;
            ctx.fillStyle=ug; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
            ctx.strokeStyle="rgba(255,255,255,0.5)"; ctx.lineWidth=1.5;
            ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.stroke();
            ctx.restore();
        });
        // Plataforma circular do torneio
        ctx.save();
        // Sombra da plataforma
        ctx.fillStyle="rgba(0,0,0,0.2)";
        ctx.beginPath(); ctx.ellipse(canvas.width/2,500,480,50,0,0,Math.PI*2); ctx.fill();
        // Plataforma principal
        let platGrad=ctx.createLinearGradient(0,420,0,480);
        platGrad.addColorStop(0,"#e8f0ff"); platGrad.addColorStop(0.5,"#c8d8f0"); platGrad.addColorStop(1,"#a0b8e0");
        ctx.fillStyle=platGrad;
        ctx.beginPath(); ctx.ellipse(canvas.width/2,480,470,45,0,0,Math.PI*2); ctx.fill();
        // Borda dourada
        ctx.strokeStyle="rgba(255,200,0,0.8)"; ctx.lineWidth=3;
        ctx.beginPath(); ctx.ellipse(canvas.width/2,478,470,45,0,0,Math.PI*2); ctx.stroke();
        // Padr√µes na plataforma
        ctx.strokeStyle="rgba(255,215,0,0.2)"; ctx.lineWidth=1;
        for(let r2=100;r2<=440;r2+=80){
            ctx.beginPath(); ctx.ellipse(canvas.width/2,478,r2,r2*0.095,0,0,Math.PI*2); ctx.stroke();
        }
        // Linhas radiais douradas
        for(let a=0;a<12;a++){
            let angle=(a/12)*Math.PI*2;
            ctx.beginPath(); ctx.moveTo(canvas.width/2,478); ctx.lineTo(canvas.width/2+Math.cos(angle)*460,478+Math.sin(angle)*44); ctx.stroke();
        }
        ctx.restore();
        // Brilhos de ki no ar
        for(let i=0;i<15;i++){
            let kx=(Math.sin(i*137+timeEnv*0.7)*0.5+0.5)*canvas.width;
            let ky=100+(Math.cos(i*97+timeEnv*0.4)*0.5+0.5)*300;
            let ka=0.2+Math.abs(Math.sin(i+timeEnv*2))*0.3;
            let kc=i%4===0?"rgba(255,200,0,"+ka+")":i%4===1?"rgba(0,200,255,"+ka+")":i%4===2?"rgba(255,100,0,"+ka+")":"rgba(200,0,255,"+ka+")";
            ctx.fillStyle=kc; ctx.shadowBlur=8; ctx.shadowColor=kc;
            ctx.beginPath(); ctx.arc(kx,ky,2+Math.abs(Math.sin(i+timeEnv))*2,0,Math.PI*2); ctx.fill();
        }
        ctx.shadowBlur=0;
        // Ch√£o vazio (o torneio flutua no vazio)
        let void_grad=ctx.createLinearGradient(0,450,0,canvas.height);
        void_grad.addColorStop(0,"#a0b8e0"); void_grad.addColorStop(0.3,"#6080b0"); void_grad.addColorStop(1,"#0a1020");
        ctx.fillStyle=void_grad; ctx.fillRect(0,450,canvas.width,canvas.height-450);
    },
    // ‚îÄ‚îÄ CEN√ÅRIO 20: C√ÇMARA DO ESP√çRITO E TEMPO (N√âVOA) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function drawSpiritTimeChamber() {
        // Fundo branco puro
        ctx.fillStyle="#fcfcfc"; ctx.fillRect(0,0,canvas.width,canvas.height);
        // N√©voa pulsante
        for(let i=0;i<12;i++){
            let fx=(Math.sin(i*137.5+timeEnv*0.2)*0.5+0.5)*canvas.width;
            let fy=(Math.cos(i*97.3+timeEnv*0.15)*0.5+0.5)*canvas.height;
            let fr=100+Math.abs(Math.sin(i+timeEnv*0.3))*150;
            let fog=ctx.createRadialGradient(fx,fy,0,fx,fy,fr);
            fog.addColorStop(0,`rgba(200,220,255,${0.08+Math.abs(Math.sin(i*0.7+timeEnv*0.4))*0.07})`);
            fog.addColorStop(1,"transparent");
            ctx.fillStyle=fog; ctx.fillRect(0,0,canvas.width,canvas.height);
        }
        // Grade de perspectiva 3D suave
        ctx.strokeStyle="rgba(100,140,220,0.12)"; ctx.lineWidth=1;
        for(let i=0;i<=30;i++){
            let t=i/30;
            let yy=canvas.height*t;
            let xL=canvas.width/2*(1-t)*0.9; let xR=canvas.width-xL;
            ctx.beginPath(); ctx.moveTo(xL,yy); ctx.lineTo(xR,yy); ctx.stroke();
        }
        for(let i=0;i<=24;i++){
            let t=i/24;
            let xx=canvas.width*t;
            ctx.strokeStyle=`rgba(100,140,220,${0.06+Math.abs(Math.sin(i+timeEnv*0.3))*0.04})`;
            ctx.beginPath(); ctx.moveTo(xx,0); ctx.lineTo(canvas.width/2+(xx-canvas.width/2)*0.1,canvas.height/2); ctx.stroke();
        }
        // Linha de horizonte com brilho
        ctx.strokeStyle="rgba(0,100,255,0.15)"; ctx.lineWidth=2;
        ctx.beginPath(); ctx.moveTo(0,canvas.height/2); ctx.lineTo(canvas.width,canvas.height/2); ctx.stroke();
        // Part√≠culas de energia branca
        for(let i=0;i<20;i++){
            let ex=(Math.sin(i*179+timeEnv)*0.5+0.5)*canvas.width;
            let ey=(Math.cos(i*113+timeEnv*0.6)*0.5+0.5)*canvas.height*0.8;
            let ea=0.1+Math.abs(Math.sin(i+timeEnv*2))*0.2;
            ctx.fillStyle=`rgba(100,150,255,${ea})`; ctx.shadowBlur=10; ctx.shadowColor="#aaccff";
            ctx.beginPath(); ctx.arc(ex,ey,1.5+Math.abs(Math.sin(i+timeEnv))*2,0,Math.PI*2); ctx.fill();
        }
        ctx.shadowBlur=0;
        // Ch√£o s√≥lido branco-azulado
        let gnd=ctx.createLinearGradient(0,450,0,canvas.height);
        gnd.addColorStop(0,"#dde8ff"); gnd.addColorStop(1,"#b0c8f0");
        ctx.fillStyle=gnd; ctx.fillRect(0,450,canvas.width,canvas.height-450);
        // Reflexo no ch√£o
        ctx.strokeStyle="rgba(100,150,255,0.1)"; ctx.lineWidth=1;
        for(let i=0;i<canvas.width;i+=60){ ctx.beginPath(); ctx.moveTo(canvas.width/2,450); ctx.lineTo(i,canvas.height); ctx.stroke(); }
        ctx.fillStyle="rgba(100,150,255,0.15)"; ctx.fillRect(0,448,canvas.width,4);
    }
];

let currentStageIndex = 0;

function drawBattle() {
    if(!selectedPlayerChar || !selectedEnemyChar) return;
    BATTLE_STAGES[currentStageIndex](); // Desenha o Cen√°rio atual
    
    if(selectedPlayerChar.isCharging) spawnParticles(300, 550, selectedPlayerChar.color || UI_COLORS.ki, 2, "charge");
    // Sprites ‚Äî ocultar quem est√° em anima√ß√£o de transforma√ß√£o
    if (!transAnim.active || transAnim.char !== selectedPlayerChar) {
        drawSprite(selectedPlayerChar, 300 + selectedPlayerChar.animX, 550, false, null, selectedPlayerChar.currentSkin, true, selectedPlayerChar.kaiokenAuraTimer);
    }
    if (!transAnim.active || transAnim.char !== selectedEnemyChar) {
        drawSprite(selectedEnemyChar, 800 + selectedEnemyChar.animX, 550, true, null, selectedEnemyChar.currentSkin, true, selectedEnemyChar.kaiokenAuraTimer);
    }
    // ‚îÄ‚îÄ Flash visual de bloqueio/esquiva do inimigo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if(enemyShieldFlash > 0) {
        ctx.save();
        ctx.globalAlpha = (enemyShieldFlash / 18) * 0.55;
        ctx.fillStyle = "#f39c12";
        const shR = 80 + (18 - enemyShieldFlash) * 3;
        ctx.shadowBlur = 30; ctx.shadowColor = "#f39c12";
        ctx.beginPath(); ctx.arc(800 + selectedEnemyChar.animX, 430, shR, 0, Math.PI*2); ctx.fill();
        ctx.globalAlpha = 1; ctx.shadowBlur = 0; ctx.restore();
        enemyShieldFlash--;
    }
    if(enemyDodgeFlash > 0) {
        ctx.save();
        ctx.globalAlpha = (enemyDodgeFlash / 14) * 0.45;
        ctx.fillStyle = "#00e5ff";
        ctx.shadowBlur = 24; ctx.shadowColor = "#00e5ff";
        // Linha de movimento (esquiva)
        ctx.strokeStyle = "#00e5ff"; ctx.lineWidth = 3;
        const dfAlpha = enemyDodgeFlash / 14;
        ctx.globalAlpha = dfAlpha * 0.7;
        for(let di = 0; di < 3; di++) {
            ctx.beginPath();
            ctx.moveTo(800 + selectedEnemyChar.animX + 20 + di*18, 350);
            ctx.lineTo(800 + selectedEnemyChar.animX + 20 + di*18, 530);
            ctx.stroke();
        }
        ctx.globalAlpha = 1; ctx.shadowBlur = 0; ctx.restore();
        enemyDodgeFlash--;
    }
    // Anima√ß√£o de transforma√ß√£o (por cima dos sprites)
    if (transAnim.active) updateTransformAnim();

    drawBattleHUD(30, 15, selectedPlayerChar, false); drawBattleHUD(canvas.width - 455, 15, selectedEnemyChar, true);

    // ‚îÄ‚îÄ BARRA ULTIMATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    {
        const ultX = 30, ultY = 135, ultW = 200, ultH = 14;
        ctx.save();
        ctx.fillStyle = "rgba(0,0,0,0.5)"; ctx.fillRect(ultX-1, ultY-1, ultW+2, ultH+2);
        ctx.fillStyle = "rgba(255,255,255,0.06)"; ctx.fillRect(ultX, ultY, ultW, ultH);
        let ultRatio = battleUltimateCharge/100;
        let ultGrad = ctx.createLinearGradient(ultX, 0, ultX+ultW, 0);
        ultGrad.addColorStop(0, "#ff6600"); ultGrad.addColorStop(0.5, "#ffcc00"); ultGrad.addColorStop(1, "#fff700");
        ctx.fillStyle = ultGrad;
        ctx.shadowBlur = ultRatio>=1 ? 15 : 6; ctx.shadowColor = "#f1c40f";
        ctx.fillRect(ultX, ultY, ultW * ultRatio, ultH);
        ctx.shadowBlur = 0;
        ctx.fillStyle = "rgba(255,255,255,0.2)"; ctx.fillRect(ultX, ultY, ultW*ultRatio, 4);
        ctx.font = "bold 11px Rajdhani"; ctx.fillStyle = ultRatio>=1 ? "#f1c40f" : "rgba(255,255,255,0.5)";
        ctx.textAlign = "left";
        ctx.fillText(ultRatio>=1 ? "‚òÖ ULTIMATE PRONTO!" : `ULTIMATE: ${Math.floor(battleUltimateCharge)}%`, ultX, ultY-3);
        ctx.restore();
    }

    // ‚îÄ‚îÄ COMBO COUNTER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if(battleComboCount >= 2 && battleComboTimer > 0) {
        ctx.save();
        let comboAlpha = Math.min(1, battleComboTimer/20);
        ctx.globalAlpha = comboAlpha;
        let comboScale = 1 + (battleComboCount >= 5 ? 0.2 : battleComboCount >= 3 ? 0.1 : 0);
        ctx.font = `italic bold ${Math.floor(36*comboScale)}px Oswald`;
        ctx.textAlign = "right";
        ctx.fillStyle = battleComboCount >= 5 ? "#ff8c00" : (battleComboCount >= 3 ? "#f1c40f" : "#fff");
        ctx.shadowBlur = 15; ctx.shadowColor = battleComboCount >= 5 ? "#ff4500" : "#f1c40f";
        ctx.fillText(`COMBO x${battleComboCount}!`, canvas.width - 30, 170);
        ctx.shadowBlur = 0; ctx.globalAlpha = 1;
        ctx.restore();
    }

    // ‚îÄ‚îÄ STATUS EFFECTS VISUAIS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const drawStatusBadges = (effects, baseX, baseY) => {
        effects.forEach((e, i) => {
            const icons = {burn:"üî•", stun:"‚ö°", boost:"üí™", poison:"‚ò†"};
            const cols = {burn:"#ff4500", stun:"#f1c40f", boost:"#2ecc71", poison:"#9b59b6"};
            ctx.save();
            ctx.fillStyle = `${cols[e.type] || "#fff"}33`;
            ctx.strokeStyle = cols[e.type] || "#fff";
            ctx.lineWidth = 1;
            ctx.beginPath(); ctx.roundRect(baseX + i*42, baseY, 38, 20, 4); ctx.fill(); ctx.stroke();
            ctx.font = "12px sans-serif"; ctx.textAlign = "center";
            ctx.fillText((icons[e.type]||"?") + e.duration, baseX + i*42 + 19, baseY+15);
            ctx.restore();
        });
    };
    if(battleStatusEffects.player.length) drawStatusBadges(battleStatusEffects.player, 30, 163);
    if(battleStatusEffects.enemy.length) drawStatusBadges(battleStatusEffects.enemy, canvas.width-220, 163);

    // ‚îÄ‚îÄ JANELA DE CONTRA-ATAQUE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if(battleCounterWindow && battleCounterTimer > 0) {
        ctx.save();
        let ctAlpha = Math.min(1, battleCounterTimer/15);
        ctx.globalAlpha = ctAlpha;
        ctx.font = "italic bold 22px Oswald";
        ctx.fillStyle = "#00ffaa"; ctx.textAlign = "center";
        ctx.shadowBlur = 20; ctx.shadowColor = "#00ffaa";
        ctx.fillText("‚ö° PRESSIONE DEFESA PARA CONTRA-ATACAR!", canvas.width/2, 200);
        ctx.shadowBlur = 0; ctx.globalAlpha = 1;
        ctx.restore();
        battleCounterTimer--;
        if(battleCounterTimer <= 0) battleCounterWindow = false;
    }

    // --- ONDA DE SOBREVIV√äNCIA INDICATOR ---
    if (isSurvivalMode) {
        ctx.save();
        ctx.font = "italic bold 20px Oswald";
        ctx.fillStyle = "#e67e22"; ctx.textAlign = "center";
        ctx.shadowBlur = 10; ctx.shadowColor = "#e67e22";
        ctx.fillText(`‚ö° ONDA ${survivalWave}`, canvas.width/2, 170);
        ctx.shadowBlur = 0; ctx.restore();
    }
    
    // --- BATTLE LOG (painel central inferior) ---
    ctx.save();
    let logW = 400, logH = 36;
    let logX = canvas.width/2 - logW/2, logY = 128;
    ctx.fillStyle = "rgba(0,0,0,0.75)";
    ctx.beginPath();
    ctx.moveTo(logX + 15, logY); ctx.lineTo(logX + logW - 15, logY);
    ctx.lineTo(logX + logW, logY + logH/2); ctx.lineTo(logX + logW - 15, logY + logH);
    ctx.lineTo(logX + 15, logY + logH); ctx.lineTo(logX, logY + logH/2);
    ctx.closePath(); ctx.fill();
    ctx.strokeStyle = battleTurn === "PLAYER" ? "#f39c12" : "#c0392b"; ctx.lineWidth = 2; ctx.stroke();
    ctx.font = "italic bold 18px Oswald"; ctx.fillStyle = "#fff"; ctx.textAlign = "center";
    ctx.fillText(battleLog.toUpperCase(), canvas.width/2, logY + 23);
    ctx.restore();

    // --- INDICADOR DE TURNO + BARRAS ATB ---
    ctx.save();
    // Barra ATB do jogador (baixo-esquerda da √°rea central)
    const atbBarW = 280, atbBarH = 14;
    const atbPX = canvas.width/2 - 350, atbPY = 112;
    const atbEX = canvas.width/2 + 70,  atbEY = 112;

    // Fundo
    ctx.fillStyle = "rgba(0,0,0,0.6)"; ctx.fillRect(atbPX-2, atbPY-2, atbBarW+4, atbBarH+4);
    ctx.fillStyle = "rgba(0,0,0,0.6)"; ctx.fillRect(atbEX-2, atbEY-2, atbBarW+4, atbBarH+4);

    // Barra jogador
    const atbPRatio = atbPlayer / 100;
    const atbPColor = atbReady ? "#f1c40f" : "#00d2ff";
    let atbPGrad = ctx.createLinearGradient(atbPX,0,atbPX+atbBarW,0);
    atbPGrad.addColorStop(0, atbPColor); atbPGrad.addColorStop(1,"#fff");
    ctx.shadowBlur = atbReady ? 16 : 6; ctx.shadowColor = atbPColor;
    ctx.fillStyle = atbPGrad; ctx.fillRect(atbPX, atbPY, atbBarW * atbPRatio, atbBarH);
    ctx.shadowBlur = 0;
    ctx.font = "bold 11px Rajdhani"; ctx.textAlign = "left"; ctx.fillStyle = atbReady ? "#f1c40f" : "rgba(255,255,255,0.7)";
    ctx.fillText(atbReady ? "‚ö° ATB PRONTO!" : `ATB ${Math.floor(atbPlayer)}%`, atbPX, atbPY - 2);

    // Bolinhas de esquivas restantes (sempre vis√≠veis)
    for (let si = 0; si < qteUsesMax; si++) {
        const sx = atbPX + atbBarW + 12 + si * 18;
        ctx.beginPath(); ctx.arc(sx, atbPY + 7, 6, 0, Math.PI*2);
        const filled = si < qteUsesLeft;
        ctx.fillStyle = filled ? "#00ffcc" : "rgba(255,255,255,0.12)";
        ctx.strokeStyle = filled ? "#00ffcc" : "rgba(255,255,255,0.25)";
        ctx.lineWidth = 1;
        ctx.shadowBlur = filled ? 8 : 0; ctx.shadowColor = "#00ffcc";
        ctx.fill(); ctx.stroke(); ctx.shadowBlur = 0;
    }
    ctx.font = "bold 10px Rajdhani"; ctx.fillStyle = "rgba(255,255,255,0.45)";
    ctx.fillText("ESQ", atbPX + atbBarW + 10, atbPY - 2);

    // Barra inimigo
    const atbERatio = atbEnemy / 100;
    let atbEGrad = ctx.createLinearGradient(atbEX,0,atbEX+atbBarW,0);
    atbEGrad.addColorStop(0,"#e74c3c"); atbEGrad.addColorStop(1,"#ff8c00");
    ctx.shadowBlur = 6; ctx.shadowColor = "#e74c3c";
    ctx.fillStyle = atbEGrad; ctx.fillRect(atbEX, atbEY, atbBarW * atbERatio, atbBarH);
    ctx.shadowBlur = 0;
    // Label com fase actual da IA
    const phaseColors = { NEUTRAL:"rgba(255,100,80,0.9)", AGGRESSIVE:"#ff4500", DEFENSIVE:"#3498db", POWERING:"#f1c40f", BERSERK:"#ff0000" };
    const phaseIcons  = { NEUTRAL:"", AGGRESSIVE:"‚ö°", DEFENSIVE:"üõ°", POWERING:"üîã", BERSERK:"üí•" };
    ctx.font = "bold 11px Rajdhani"; ctx.textAlign = "left";
    ctx.fillStyle = phaseColors[aiPhase] || "rgba(255,100,80,0.9)";
    ctx.shadowBlur = aiPhase === "BERSERK" ? 10 : 0; ctx.shadowColor = "#ff0000";
    ctx.fillText(`${phaseIcons[aiPhase]||""} INIMIGO ATB ${Math.floor(atbEnemy)}% ${aiPhase !== "NEUTRAL" ? "| "+aiPhase : ""}`, atbEX, atbEY - 2);
    ctx.shadowBlur = 0;

    // ‚îÄ‚îÄ INDICADOR DE GUARDA / ESQUIVA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if(aiPhase === "DEFENSIVE" || aiPhase === "POWERING") {
        ctx.save();
        const pulse = 0.65 + 0.35 * Math.abs(Math.sin(timeEnv * 4));
        ctx.globalAlpha = pulse;
        ctx.font = "bold 12px Rajdhani";
        ctx.fillStyle = aiPhase === "DEFENSIVE" ? "#f39c12" : "#3498db";
        ctx.shadowBlur = 14; ctx.shadowColor = ctx.fillStyle;
        ctx.textAlign = "right";
        ctx.fillText(aiPhase === "DEFENSIVE" ? "üõ° GUARDA ATIVA" : "‚ö° ESQUIVA ATIVA", canvas.width - 20, atbEY + 16);
        ctx.shadowBlur = 0; ctx.globalAlpha = 1;
        ctx.restore();
    } else if(aiPhase === "BERSERK") {
        ctx.save();
        const pulse = 0.7 + 0.3 * Math.abs(Math.sin(timeEnv * 7));
        ctx.globalAlpha = pulse;
        ctx.font = "bold 12px Rajdhani";
        ctx.fillStyle = "#ff2222";
        ctx.shadowBlur = 16; ctx.shadowColor = "#ff0000";
        ctx.textAlign = "right";
        ctx.fillText("üí• ESQUIVA FREN√âTICA", canvas.width - 20, atbEY + 16);
        ctx.shadowBlur = 0; ctx.globalAlpha = 1;
        ctx.restore();
    }

    ctx.restore();

    // --- QTE OVERLAY ---
    if(qteActive && qteTimer > 0) {
        ctx.save();
        const qteRatio = qteTimer / qteMaxTime;
        const qteAlpha = Math.min(1, qteTimer / 15);

        // Fundo semi-transparente
        ctx.fillStyle = `rgba(0,0,0,${0.55 * qteAlpha})`;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Painel QTE
        const qW = 460, qH = 130, qX = canvas.width/2 - qW/2, qY = 180;
        ctx.globalAlpha = qteAlpha;
        ctx.fillStyle = "rgba(5,10,20,0.95)";
        ctx.strokeStyle = qteType === "DODGE" ? "#00ffcc" : "#f39c12";
        ctx.lineWidth = 3;
        ctx.beginPath(); ctx.roundRect(qX, qY, qW, qH, 8); ctx.fill(); ctx.stroke();

        // √çcone e texto
        ctx.font = "italic bold 28px Oswald"; ctx.textAlign = "center";
        ctx.fillStyle = qteType === "DODGE" ? "#00ffcc" : "#f39c12";
        ctx.shadowBlur = 18; ctx.shadowColor = ctx.fillStyle;
        ctx.fillText(qteType === "DODGE" ? "‚ö° ESQUIVAR!" : "üõ° BLOQUEAR!", canvas.width/2, qY + 38);
        ctx.shadowBlur = 0;

        ctx.font = "bold 15px Rajdhani"; ctx.fillStyle = "rgba(255,255,255,0.75)";
        ctx.fillText("CLICA / TOCA PARA REAGIR", canvas.width/2, qY + 62);

        // Contador de esquivas restantes (bolinhas)
        if (qteUsesLeft <= 0) {
            ctx.font = "bold 13px Rajdhani"; ctx.fillStyle = "#e74c3c";
            ctx.fillText("‚õî SEM ESQUIVAS RESTANTES ‚Äî receber√°s dano!", canvas.width/2, qY + 100);
        } else {
            ctx.font = "bold 12px Rajdhani"; ctx.fillStyle = "rgba(255,255,255,0.5)";
            ctx.fillText("ESQUIVAS RESTANTES:", canvas.width/2 - 40, qY + 102);
            for (let si = 0; si < qteUsesMax; si++) {
                const sx = canvas.width/2 + 30 + si * 22;
                ctx.beginPath(); ctx.arc(sx, qY + 98, 7, 0, Math.PI*2);
                ctx.fillStyle = si < qteUsesLeft ? "#00ffcc" : "rgba(255,255,255,0.15)";
                ctx.shadowBlur = si < qteUsesLeft ? 8 : 0; ctx.shadowColor = "#00ffcc";
                ctx.fill(); ctx.shadowBlur = 0;
            }
        }

        // Barra de tempo (diminui)
        const bW = qW - 40, bH = 14, bX = qX + 20, bY2 = qY + 80;
        ctx.fillStyle = "rgba(255,255,255,0.1)"; ctx.fillRect(bX, bY2, bW, bH);
        const barColor = qteRatio > 0.5 ? "#2ecc71" : qteRatio > 0.25 ? "#f39c12" : "#e74c3c";
        let qteBGrad = ctx.createLinearGradient(bX,0,bX+bW*qteRatio,0);
        qteBGrad.addColorStop(0,barColor); qteBGrad.addColorStop(1,"#fff");
        ctx.fillStyle = qteBGrad;
        ctx.shadowBlur = 8; ctx.shadowColor = barColor;
        ctx.fillRect(bX, bY2, bW * qteRatio, bH);
        ctx.shadowBlur = 0;

        ctx.globalAlpha = 1;
        ctx.restore();
    }

    // Flash QTE resultado
    if(qteFlash > 0) {
        ctx.save();
        const fc = qteSuccess ? `rgba(0,255,180,${qteFlash*0.018})` : `rgba(255,50,50,${qteFlash*0.018})`;
        ctx.fillStyle = fc; ctx.fillRect(0,0,canvas.width,canvas.height);
        qteFlash--;
        ctx.restore();
    }

    if (activeBeam) drawBeamEffect();

    if(battleTurn === "PLAYER" && !showItemHUD && !showFusionHUD && !selectedPlayerChar.showTransHUD && !selectedPlayerChar.showAbsorbHUD) {
        // --- BARRA DE A√á√ïES DB STYLE ---
        const totalBtns = 7; // 4 ataques + DEFENDER + ITENS + ULTIMATE/COUNTER
        const btnY = 520;
        const btnH = 98;
        const panelW = canvas.width - 20;
        const panelX = 10;
        const btnW2 = (panelW - (totalBtns - 1) * 5) / totalBtns;

        // Fundo da barra de a√ß√µes ‚Äî estilo Dragon Ball
        ctx.save();
        ctx.fillStyle = "rgba(8, 3, 0, 0.92)";
        ctx.fillRect(panelX, btnY - 6, panelW, btnH + 12);
        ctx.strokeStyle = "rgba(245, 197, 24, 0.45)"; ctx.lineWidth = 2;
        ctx.strokeRect(panelX, btnY - 6, panelW, btnH + 12);
        // Linha dourada no topo
        ctx.fillStyle = "rgba(255,140,0,0.35)"; ctx.fillRect(panelX, btnY - 6, panelW, 2);
        ctx.restore();

        // Cores por tipo de ataque
        const moveColors = {
            physical: ["#e74c3c", "#c0392b"],
            beam:     ["#3498db", "#1a5276"],
            sphere:   ["#9b59b6", "#6c3483"],
            charge:   ["#27ae60", "#1e8449"],
            bodyChange: ["#e67e22", "#d35400"]
        };

        selectedPlayerChar.moves.forEach((move, i) => {
            let bx2 = panelX + i * (btnW2 + 5);
            let hov = mouse.y > btnY && mouse.y < btnY + btnH && mouse.x > bx2 && mouse.x < bx2 + btnW2;
            let mtype = move.type || "physical";
            let [col1, col2] = moveColors[mtype] || moveColors.physical;
            let canAfford = !move.cost || selectedPlayerChar.ki >= move.cost;

            ctx.save();
            // Fundo do bot√£o com gradiente
            let bg = ctx.createLinearGradient(bx2, btnY, bx2, btnY + btnH);
            bg.addColorStop(0, hov ? col1 : col2 + "cc");
            bg.addColorStop(1, "rgba(0,0,0,0.9)");
            ctx.fillStyle = bg;
            ctx.beginPath();
            ctx.moveTo(bx2 + 8, btnY); ctx.lineTo(bx2 + btnW2, btnY);
            ctx.lineTo(bx2 + btnW2 - 8, btnY + btnH); ctx.lineTo(bx2, btnY + btnH);
            ctx.closePath(); ctx.fill();

            // Borda
            ctx.strokeStyle = hov ? "#fff" : col1 + "88"; ctx.lineWidth = hov ? 2 : 1;
            ctx.beginPath();
            ctx.moveTo(bx2 + 8, btnY); ctx.lineTo(bx2 + btnW2, btnY);
            ctx.lineTo(bx2 + btnW2 - 8, btnY + btnH); ctx.lineTo(bx2, btnY + btnH);
            ctx.closePath(); ctx.stroke();

            // Reflexo superior
            ctx.fillStyle = "rgba(255,255,255,0.12)";
            ctx.beginPath();
            ctx.moveTo(bx2 + 8, btnY); ctx.lineTo(bx2 + btnW2, btnY);
            ctx.lineTo(bx2 + btnW2 - 4, btnY + 20); ctx.lineTo(bx2 + 4, btnY + 20);
            ctx.closePath(); ctx.fill();

            // √çcone do tipo de ataque
            const typeIcons = { physical: "üëä", beam: "‚ö°", sphere: "üîÆ", charge: "‚¨Ü", bodyChange: "üîÑ" };
            ctx.font = "16px sans-serif"; ctx.textAlign = "center";
            ctx.fillText(typeIcons[mtype] || "üëä", bx2 + btnW2/2 + 4, btnY + 22);

            // Nome do ataque
            ctx.font = `italic bold ${move.name.length > 12 ? 13 : 15}px Oswald`;
            ctx.fillStyle = hov ? "#000" : (canAfford ? "#fff" : "#aaa");
            ctx.shadowBlur = hov ? 0 : 6; ctx.shadowColor = col1;
            ctx.fillText(move.name, bx2 + btnW2/2 + 4, btnY + 55);
            ctx.shadowBlur = 0;

            // Custo de KI
            if (move.cost) {
                ctx.font = "bold 13px Rajdhani";
                ctx.fillStyle = canAfford ? "#00d2ff" : "#e74c3c";
                ctx.fillText(`${move.cost} KI`, bx2 + btnW2/2 + 4, btnY + 74);
            } else if (move.type === "charge") {
                ctx.font = "bold 12px Rajdhani"; ctx.fillStyle = "#2ecc71";
                ctx.fillText("+40 KI", bx2 + btnW2/2 + 4, btnY + 74);
            }

            // ‚îÄ‚îÄ Overlay cooldown ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            if(moveCooldowns[i] > 0) {
                ctx.save();
                ctx.globalAlpha = 0.72;
                ctx.fillStyle = "rgba(0,0,0,0.75)";
                ctx.beginPath();
                ctx.moveTo(bx2 + 8, btnY); ctx.lineTo(bx2 + btnW2, btnY);
                ctx.lineTo(bx2 + btnW2 - 8, btnY + btnH); ctx.lineTo(bx2, btnY + btnH);
                ctx.closePath(); ctx.fill();
                ctx.globalAlpha = 1;
                ctx.font = "italic bold 20px Oswald"; ctx.fillStyle = "#aaa"; ctx.textAlign = "center";
                ctx.fillText(`${Math.ceil(moveCooldowns[i]/60)}s`, bx2 + btnW2/2 + 4, btnY + 54);
                ctx.restore();
            }
            // ‚îÄ‚îÄ ATB: escurecer se barra n√£o est√° cheia ‚îÄ‚îÄ‚îÄ‚îÄ
            else if(!atbReady) {
                ctx.save(); ctx.globalAlpha = 0.5;
                ctx.fillStyle = "rgba(0,0,0,0.5)";
                ctx.beginPath();
                ctx.moveTo(bx2 + 8, btnY); ctx.lineTo(bx2 + btnW2, btnY);
                ctx.lineTo(bx2 + btnW2 - 8, btnY + btnH); ctx.lineTo(bx2, btnY + btnH);
                ctx.closePath(); ctx.fill(); ctx.globalAlpha = 1; ctx.restore();
            }

            ctx.restore();
        });

        // Bot√£o DEFENDER
        {
            let i = 4;
            let bx2 = panelX + i * (btnW2 + 5);
            let hov = mouse.y > btnY && mouse.y < btnY + btnH && mouse.x > bx2 && mouse.x < bx2 + btnW2;
            let canAfford = selectedPlayerChar.ki >= 10;
            ctx.save();
            let bg = ctx.createLinearGradient(bx2, btnY, bx2, btnY + btnH);
            bg.addColorStop(0, hov ? "#27ae60" : "#1e8449cc");
            bg.addColorStop(1, "rgba(0,0,0,0.9)");
            ctx.fillStyle = bg;
            ctx.beginPath();
            ctx.moveTo(bx2 + 8, btnY); ctx.lineTo(bx2 + btnW2, btnY);
            ctx.lineTo(bx2 + btnW2 - 8, btnY + btnH); ctx.lineTo(bx2, btnY + btnH);
            ctx.closePath(); ctx.fill();
            ctx.strokeStyle = hov ? "#fff" : "#27ae6088"; ctx.lineWidth = hov ? 2 : 1; ctx.stroke();
            ctx.font = "20px sans-serif"; ctx.textAlign = "center"; ctx.fillText("üõ°", bx2 + btnW2/2 + 4, btnY + 22);
            ctx.font = "italic bold 15px Oswald"; ctx.fillStyle = hov ? "#000" : (canAfford ? "#fff" : "#aaa");
            ctx.fillText("DEFENDER", bx2 + btnW2/2 + 4, btnY + 55);
            ctx.font = "bold 13px Rajdhani"; ctx.fillStyle = canAfford ? "#00d2ff" : "#e74c3c";
            ctx.fillText("10 KI", bx2 + btnW2/2 + 4, btnY + 74);
            if(moveCooldowns[4] > 0) {
                ctx.save(); ctx.globalAlpha = 0.72;
                ctx.fillStyle = "rgba(0,0,0,0.75)";
                ctx.beginPath(); ctx.moveTo(bx2+8,btnY); ctx.lineTo(bx2+btnW2,btnY); ctx.lineTo(bx2+btnW2-8,btnY+btnH); ctx.lineTo(bx2,btnY+btnH); ctx.closePath(); ctx.fill();
                ctx.globalAlpha = 1; ctx.font = "italic bold 20px Oswald"; ctx.fillStyle = "#aaa"; ctx.textAlign = "center";
                ctx.fillText(`${Math.ceil(moveCooldowns[4]/60)}s`, bx2+btnW2/2+4, btnY+54);
                ctx.restore();
            } else if(!atbReady) {
                ctx.save(); ctx.globalAlpha = 0.5; ctx.fillStyle = "rgba(0,0,0,0.5)";
                ctx.beginPath(); ctx.moveTo(bx2+8,btnY); ctx.lineTo(bx2+btnW2,btnY); ctx.lineTo(bx2+btnW2-8,btnY+btnH); ctx.lineTo(bx2,btnY+btnH); ctx.closePath(); ctx.fill();
                ctx.globalAlpha=1; ctx.restore();
            }
            ctx.restore();
        }

        // Bot√£o ITENS Z
        {
            let i = 5;
            let bx2 = panelX + i * (btnW2 + 5);
            let hov = mouse.y > btnY && mouse.y < btnY + btnH && mouse.x > bx2 && mouse.x < bx2 + btnW2;
            ctx.save();
            let bg = ctx.createLinearGradient(bx2, btnY, bx2, btnY + btnH);
            bg.addColorStop(0, hov ? "#f1c40f" : "#d4ac0d99");
            bg.addColorStop(1, "rgba(0,0,0,0.9)");
            ctx.fillStyle = bg;
            ctx.beginPath();
            ctx.moveTo(bx2 + 8, btnY); ctx.lineTo(bx2 + btnW2, btnY);
            ctx.lineTo(bx2 + btnW2 - 8, btnY + btnH); ctx.lineTo(bx2, btnY + btnH);
            ctx.closePath(); ctx.fill();
            ctx.strokeStyle = hov ? "#fff" : "#f1c40f88"; ctx.lineWidth = hov ? 2 : 1; ctx.stroke();
            ctx.font = "20px sans-serif"; ctx.textAlign = "center"; ctx.fillText("üéí", bx2 + btnW2/2 + 4, btnY + 22);
            ctx.font = "italic bold 15px Oswald"; ctx.fillStyle = hov ? "#000" : "#fff";
            ctx.fillText("ITENS Z", bx2 + btnW2/2 + 4, btnY + 55);
            ctx.restore();
        }

        // Bot√£o ULTIMATE (novo!)
        {
            let i = 6;
            let bx2 = panelX + i * (btnW2 + 5);
            let ready = battleUltimateCharge >= 100;
            let hov = ready && mouse.y > btnY && mouse.y < btnY + btnH && mouse.x > bx2 && mouse.x < bx2 + btnW2;
            ctx.save();
            if(ready) { ctx.shadowBlur = 20; ctx.shadowColor = "#f1c40f"; }
            let bg = ctx.createLinearGradient(bx2, btnY, bx2, btnY + btnH);
            if(ready) {
                bg.addColorStop(0, hov ? "#fff700" : "#e6ac00");
                bg.addColorStop(1, "rgba(80,40,0,0.9)");
            } else {
                bg.addColorStop(0, "rgba(40,30,10,0.9)");
                bg.addColorStop(1, "rgba(10,10,10,0.9)");
            }
            ctx.fillStyle = bg;
            ctx.beginPath();
            ctx.moveTo(bx2 + 8, btnY); ctx.lineTo(bx2 + btnW2, btnY);
            ctx.lineTo(bx2 + btnW2 - 8, btnY + btnH); ctx.lineTo(bx2, btnY + btnH);
            ctx.closePath(); ctx.fill();
            ctx.strokeStyle = ready ? (hov?"#fff":"#f1c40f") : "rgba(255,200,0,0.2)"; ctx.lineWidth = ready?2:1; ctx.stroke();
            ctx.shadowBlur = 0;
            // Barra de progresso no interior
            if(!ready) {
                let prog = battleUltimateCharge/100;
                ctx.fillStyle = "rgba(241,196,15,0.25)";
                ctx.fillRect(bx2, btnY + btnH - 12, btnW2 * prog, 12);
            }
            ctx.font = ready ? "22px sans-serif" : "18px sans-serif";
            ctx.textAlign = "center";
            ctx.fillText(ready ? "üí•" : "üîã", bx2 + btnW2/2 + 4, btnY + 24);
            ctx.font = `italic bold ${ready?16:13}px Oswald`;
            ctx.fillStyle = ready ? (hov?"#000":"#f1c40f") : "rgba(200,160,0,0.5)";
            ctx.fillText(ready ? "ULTIMATE!" : "ULTIMATE", bx2 + btnW2/2 + 4, btnY + 55);
            if(!ready) {
                ctx.font = "bold 12px Rajdhani"; ctx.fillStyle = "rgba(255,200,0,0.5)";
                ctx.fillText(`${Math.floor(battleUltimateCharge)}%`, bx2 + btnW2/2 + 4, btnY + 72);
            }
            // ATB overlay se barra n√£o cheia
            if(!atbReady) {
                ctx.save(); ctx.globalAlpha = 0.5; ctx.fillStyle = "rgba(0,0,0,0.5)";
                ctx.beginPath(); ctx.moveTo(bx2+8,btnY); ctx.lineTo(bx2+btnW2,btnY); ctx.lineTo(bx2+btnW2-8,btnY+btnH); ctx.lineTo(bx2,btnY+btnH); ctx.closePath(); ctx.fill();
                ctx.globalAlpha=1; ctx.restore();
            }
            ctx.restore();
        }

        // Bot√µes de Transforma√ß√£o / Absor√ß√£o
        let hasTrans = selectedPlayerChar.transList?.length > 0;
        let hasAbsorb = selectedPlayerChar.absorbList?.length > 0;
        if (hasTrans && hasAbsorb) {
            drawDBBtn(canvas.width/2 - 130, 462, 120, 42, "TRANSF", "#f39c12", "#000");
            drawDBBtn(canvas.width/2 + 10, 462, 120, 42, "ABSORVER", "#2ecc71", "#000");
        } else if (hasTrans) {
            drawDBBtn(canvas.width/2 - 130, 462, 260, 42, "‚ö° TRANSFORMAR / AURA", "#f39c12", "#000");
        } else if (hasAbsorb) {
            drawDBBtn(canvas.width/2 - 130, 462, 260, 42, "ABSORVER", "#2ecc71", "#000");
        }
    } else if(showItemHUD) drawItemHUD(); 
    else if(showFusionHUD) drawFusionHUD(); 
    else if(selectedPlayerChar.showTransHUD) drawTransformationHUD();
    else if(selectedPlayerChar.showAbsorbHUD) drawAbsorbHUD();
}

function drawBattleHUD(x, y, char, isRight) {
    ctx.save();
    const W = 420, H = 110;
    const isEvil = char.isEvil;
    const accentCol = isEvil ? "#e53935" : "#ff8c00";
    const accentGlow = isEvil ? "#ff1744" : "#f5c518";
    const hpRatio = Math.max(0, char.displayHp / char.maxHp);
    const kiRatio = Math.min(char.displayKi, 100) / 100;
    ctx.translate(x, y);

    // Painel base angulado estilo DB
    ctx.shadowBlur = 18; ctx.shadowColor = accentGlow;
    ctx.fillStyle = "rgba(8, 8, 12, 0.92)";
    ctx.beginPath();
    if (!isRight) {
        ctx.moveTo(0, 0); ctx.lineTo(W - 30, 0); ctx.lineTo(W, H/2);
        ctx.lineTo(W - 30, H); ctx.lineTo(0, H);
    } else {
        ctx.moveTo(30, 0); ctx.lineTo(W, 0); ctx.lineTo(W, H);
        ctx.lineTo(30, H); ctx.lineTo(0, H/2);
    }
    ctx.closePath(); ctx.fill();
    ctx.shadowBlur = 0;

    // Borda colorida
    ctx.strokeStyle = accentCol; ctx.lineWidth = 3;
    ctx.beginPath();
    if (!isRight) {
        ctx.moveTo(0, 0); ctx.lineTo(W - 30, 0); ctx.lineTo(W, H/2);
        ctx.lineTo(W - 30, H); ctx.lineTo(0, H);
    } else {
        ctx.moveTo(30, 0); ctx.lineTo(W, 0); ctx.lineTo(W, H);
        ctx.lineTo(30, H); ctx.lineTo(0, H/2);
    }
    ctx.closePath(); ctx.stroke();

    // Faixa superior colorida
    ctx.fillStyle = accentCol; ctx.globalAlpha = 0.25;
    ctx.beginPath();
    if (!isRight) { ctx.moveTo(0, 0); ctx.lineTo(W-30, 0); ctx.lineTo(W-30, 24); ctx.lineTo(0, 24); }
    else { ctx.moveTo(30, 0); ctx.lineTo(W, 0); ctx.lineTo(W, 24); ctx.lineTo(30, 24); }
    ctx.closePath(); ctx.fill();
    ctx.globalAlpha = 1;
    ctx.fillStyle = accentCol; ctx.fillRect(isRight ? 30 : 0, 0, W - 30, 3);

    // Nome do personagem
    ctx.font = "italic bold 22px Oswald";
    ctx.fillStyle = "#fff"; ctx.textAlign = isRight ? "right" : "left";
    ctx.shadowBlur = 8; ctx.shadowColor = accentGlow;
    ctx.fillText(char.name, isRight ? W - 15 : 10, 18);
    ctx.shadowBlur = 0;

    const bx = isRight ? 40 : 10;
    const bw = W - 55;

    // HP Label
    ctx.font = "bold 13px Rajdhani"; ctx.fillStyle = accentCol;
    ctx.textAlign = isRight ? "right" : "left";
    ctx.fillText("HP", isRight ? W - 10 : bx, 38);

    // HP Bar fundo
    ctx.fillStyle = "rgba(255,255,255,0.08)"; ctx.fillRect(bx, 40, bw, 20);

    // HP Bar valor com gradiente de sa√∫de
    let hpColor = hpRatio > 0.6 ? "#2ecc71" : hpRatio > 0.3 ? "#f39c12" : "#e74c3c";
    let hpGrad = ctx.createLinearGradient(bx, 0, bx + bw, 0);
    hpGrad.addColorStop(0, hpColor); hpGrad.addColorStop(0.5, "#fff"); hpGrad.addColorStop(1, hpColor);
    ctx.fillStyle = hpGrad; ctx.shadowBlur = 12; ctx.shadowColor = hpColor;
    ctx.fillRect(bx, 40, bw * hpRatio, 20); ctx.shadowBlur = 0;

    // Reflexo HP
    ctx.fillStyle = "rgba(255,255,255,0.25)"; ctx.fillRect(bx, 40, bw * hpRatio, 6);

    // Ticks HP (a cada 25%)
    ctx.fillStyle = "rgba(0,0,0,0.5)";
    for (let t = 1; t < 4; t++) ctx.fillRect(bx + (bw * t / 4) - 1, 40, 2, 20);

    // HP num√©rico
    ctx.font = "bold 12px Rajdhani"; ctx.fillStyle = "#fff"; ctx.textAlign = "center";
    ctx.fillText(`${Math.ceil(char.displayHp)} / ${char.maxHp}`, bx + bw/2, 55);

    // KI Label
    ctx.font = "bold 12px Rajdhani"; ctx.fillStyle = "#00d2ff";
    ctx.textAlign = isRight ? "right" : "left";
    ctx.fillText("KI", isRight ? W - 10 : bx, 73);

    // KI Bar fundo
    ctx.fillStyle = "rgba(0,210,255,0.1)"; ctx.fillRect(bx, 75, bw, 14);

    // KI Bar valor
    let kiGrad = ctx.createLinearGradient(bx, 0, bx + bw * kiRatio, 0);
    kiGrad.addColorStop(0, "#0077ff"); kiGrad.addColorStop(1, kiRatio >= 1 ? "#fff" : "#00d2ff");
    ctx.fillStyle = kiGrad;
    ctx.shadowBlur = kiRatio >= 1 ? 20 : 8; ctx.shadowColor = kiRatio >= 1 ? "#fff" : "#00d2ff";
    ctx.fillRect(bx, 75, bw * kiRatio, 14); ctx.shadowBlur = 0;

    // Reflexo KI
    ctx.fillStyle = "rgba(255,255,255,0.2)"; ctx.fillRect(bx, 75, bw * kiRatio, 4);

    // KI orbs marcadores
    for (let t = 1; t <= 4; t++) {
        let ox = bx + (bw * t / 4) - 4;
        let filled = kiRatio >= t / 4;
        ctx.beginPath(); ctx.arc(ox, 82, 5, 0, Math.PI*2);
        ctx.fillStyle = filled ? "#00d2ff" : "rgba(0,210,255,0.2)";
        ctx.shadowBlur = filled ? 8 : 0; ctx.shadowColor = "#00d2ff";
        ctx.fill(); ctx.shadowBlur = 0;
    }

    // KI %
    ctx.font = "bold 11px Rajdhani"; ctx.fillStyle = "rgba(255,255,255,0.5)"; ctx.textAlign = "center";
    ctx.fillText(`${Math.floor(kiRatio * 100)}%`, bx + bw/2, 87);

    // Estado de defesa
    if (char.isDefending) {
        ctx.font = "bold italic 14px Oswald"; ctx.fillStyle = "#2ecc71";
        ctx.textAlign = isRight ? "right" : "left";
        ctx.shadowBlur = 10; ctx.shadowColor = "#2ecc71";
        ctx.fillText("‚õä DEFESA ATIVA", isRight ? W - 10 : bx, 106);
        ctx.shadowBlur = 0;
    }

    // Linha inferior
    ctx.fillStyle = accentCol; ctx.globalAlpha = 0.6;
    ctx.fillRect(isRight ? 30 : 0, H - 2, W - 30, 2);
    ctx.globalAlpha = 1;
    ctx.restore();
}

function drawItemHUD() {
¬† ¬† ctx.fillStyle = "rgba(0,0,0,0.9)"; ctx.fillRect(0,0,canvas.width,canvas.height);
¬† ¬† ctx.font = "italic 40px Oswald"; ctx.fillStyle = "#fff"; ctx.textAlign = "center"; ctx.fillText("INVENT√ÅRIO DE BATALHA", canvas.width/2, 100);
¬† ¬† const keys = Object.keys(itemsDB);
¬† ¬† 
¬† ¬† let cols = 5; // Aumentado para 5 colunas para caber tudo em 2 linhas
¬† ¬† let startX = (canvas.width - ((cols - 1) * 160 + 120)) / 2; // Centraliza a grid de itens dinamicamente
¬† ¬† 
¬† ¬† keys.forEach((key, i) => {
¬† ¬† ¬† ¬† let col = i % cols; let row = Math.floor(i / cols);
¬† ¬† ¬† ¬† let x = startX + (col * 160); let y = 160 + (row * 150);
¬† ¬† ¬† ¬† let count = player.inventory[key] || 0;
¬† ¬† ¬† ¬† let hov = mouse.x > x && mouse.x < x + 120 && mouse.y > y && mouse.y < y + 120;
¬† ¬† ¬† ¬† drawSparkPanel(x, y, 120, 120, hov ? "rgba(0, 210, 255, 0.2)" : "rgba(255,255,255,0.05)");
¬† ¬† ¬† ¬† if(images[key] && images[key].complete && !images[key].failed) { ctx.drawImage(images[key], x+20, y+20, 80, 80); }¬†
¬† ¬† ¬† ¬† else { ctx.fillStyle = "#555"; ctx.fillRect(x+30, y+30, 60, 60); }
¬† ¬† ¬† ¬† ctx.font = "bold 20px Rajdhani"; ctx.fillStyle = UI_COLORS.secondary; ctx.fillText(`x${count}`, x + 100, y + 30);
¬† ¬† });
¬† ¬† drawSparkBtn(canvas.width/2 - 100, 520, 200, 50, "FECHAR", UI_COLORS.danger);
}

function drawFusionHUD() {
    // Fundo animado com brilho
    ctx.fillStyle = "rgba(0,0,0,0.97)"; 
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Efeito de energia de fundo
    let fusionPulse = 0.5 + Math.abs(Math.sin(timeEnv * 3)) * 0.5;
    let bgGlow = ctx.createRadialGradient(canvas.width/2, canvas.height/2, 0, canvas.width/2, canvas.height/2, 500);
    bgGlow.addColorStop(0, `rgba(150,50,255,${fusionPulse * 0.12})`);
    bgGlow.addColorStop(0.5, `rgba(50,0,150,${fusionPulse * 0.06})`);
    bgGlow.addColorStop(1, "transparent");
    ctx.fillStyle = bgGlow; ctx.fillRect(0, 0, canvas.width, canvas.height);

    const fusionData = showFusionHUD;
    const itemKey = fusionData.itemKey;
    const isDance = itemKey === "dance";
    const itemLabel = isDance ? "‚ö° T√âCNICA DE DAN√áA" : "üíé BRINCOS POTARA";
    const itemColor = isDance ? "#f1c40f" : "#9b59b6";

    // T√≠tulo com brilho
    ctx.save();
    ctx.font = "italic 44px Oswald"; 
    ctx.fillStyle = "#fff"; 
    ctx.textAlign = "center";
    ctx.shadowBlur = 20; ctx.shadowColor = itemColor;
    ctx.fillText("‚ö° SELECIONAR PARCEIRO DE FUS√ÉO", canvas.width / 2, 65);
    ctx.shadowBlur = 0;
    // Linha decorativa
    ctx.fillStyle = itemColor; ctx.fillRect(canvas.width/2 - 280, 72, 560, 3);
    ctx.restore();
    
    ctx.font = "bold 22px Rajdhani"; 
    ctx.fillStyle = itemColor;
    ctx.textAlign = "center";
    ctx.fillText(itemLabel, canvas.width / 2, 105);

    const partners = fusionData.partners || [];
    
    if (partners.length === 0) {
        ctx.font = "bold 28px Rajdhani"; 
        ctx.fillStyle = UI_COLORS.danger;
        ctx.fillText("NENHUMA FUS√ÉO DISPON√çVEL", canvas.width / 2, 300);
    } else {
        const cardW = 220;
        const cardH = 300;
        const gap = 35;
        const totalW = partners.length * (cardW + gap) - gap;
        const startX = (canvas.width - totalW) / 2;

        partners.forEach((partner, i) => {
            const x = startX + i * (cardW + gap);
            const y = 125;
            
            const isHovered = mouse.x > x && mouse.x < x + cardW && 
                            mouse.y > y && mouse.y < y + cardH;
            
            const isUnlocked = partner.unlocked;
            const bgColor = isUnlocked 
                ? (isHovered ? `rgba(${isDance?"241,196,15":"155,89,182"},0.35)` : "rgba(20,10,40,0.85)")
                : "rgba(80,0,0,0.4)";
            const borderColor = isUnlocked 
                ? (isHovered ? "#fff" : itemColor) 
                : UI_COLORS.danger;

            drawSparkPanel(x, y, cardW, cardH, bgColor, borderColor);

            if (isHovered && isUnlocked) {
                ctx.save();
                ctx.shadowBlur = 30; ctx.shadowColor = itemColor;
                ctx.strokeStyle = itemColor; ctx.lineWidth = 3;
                ctx.beginPath(); ctx.roundRect(x+2, y+2, cardW-4, cardH-4, 4); ctx.stroke();
                ctx.shadowBlur = 0; ctx.restore();
            }

            // Nome do parceiro
            ctx.font = "bold 18px Rajdhani"; 
            ctx.fillStyle = isUnlocked ? "#fff" : UI_COLORS.danger;
            ctx.textAlign = "center";
            ctx.fillText(partner.partnerName, x + cardW / 2, y + 32);

            if (isUnlocked) {
                // Sprite do parceiro
                drawSprite(
                    { originalKey: partner.partnerKey }, 
                    x + cardW / 2, 
                    y + 145, 
                    false, 
                    2.6, 
                    partner.partnerKey
                );

                // Seta + resultado
                ctx.font = "bold 20px Oswald"; 
                ctx.fillStyle = itemColor;
                ctx.fillText(isDance ? "‚üø DAN√áA ‚üø" : "‚óÜ POTARA ‚óÜ", x + cardW / 2, y + 180);
                
                ctx.font = "bold 15px Rajdhani"; 
                ctx.fillStyle = "#f1c40f";
                ctx.fillText("RESULTADO:", x + cardW/2, y + 205);
                
                ctx.font = "italic bold 16px Oswald"; 
                ctx.fillStyle = "#fff";
                ctx.fillText(partner.resultName, x + cardW / 2, y + 228);

                // Preview sprite do resultado (pequeno)
                if (charactersDB[partner.resultKey]) {
                    drawSprite(
                        { originalKey: partner.resultKey },
                        x + cardW / 2, y + 285,
                        false, 1.6, partner.resultKey
                    );
                }

                if (isHovered) {
                    ctx.font = "italic bold 17px Oswald"; 
                    ctx.fillStyle = isHovered ? "#f1c40f" : itemColor;
                    ctx.fillText(">>> FUNDIR! <<<", x + cardW / 2, y + cardH - 12);
                }
            } else {
                ctx.font = "bold 14px Rajdhani"; 
                ctx.fillStyle = UI_COLORS.danger;
                ctx.textAlign = "center";
                const reason = partner.reason || "BLOQUEADO";
                ctx.fillText("üîí " + reason, x + cardW / 2, y + 150);
                ctx.font = "14px Rajdhani"; ctx.fillStyle = "#555";
                ctx.fillText("Desbloqueie o parceiro", x + cardW/2, y + 175);
                ctx.fillText("para realizar a fus√£o", x + cardW/2, y + 195);
            }
        });
    }

    drawSparkBtn(canvas.width / 2 - 110, canvas.height - 72, 220, 50, "‚úï  CANCELAR", UI_COLORS.danger);
}

function drawTransformationHUD() {
    ctx.fillStyle = "rgba(0,0,0,0.9)"; ctx.fillRect(0,0,canvas.width,canvas.height);
    const list = selectedPlayerChar.transList || [];
    const unlockedList = list.filter(k => isUnlocked(k, "TRANS"));
    
    let cols = Math.min(unlockedList.length, 4);
    let startX = (canvas.width - (cols * 220)) / 2;
    unlockedList.forEach((key, i) => {
        let col = i % 4; let row = Math.floor(i / 4);
        let x = startX + col * 220, y = 150 + row * 160, w = 200, h = 150;
        let hov = mouse.x > x && mouse.x < x + w && mouse.y > y && mouse.y < y + h;
        drawSparkPanel(x, y, w, h, hov ? "rgba(241, 196, 15, 0.2)" : UI_COLORS.panel);
        ctx.font = "italic 26px Oswald"; ctx.fillStyle = "#fff"; ctx.textAlign = "center"; ctx.fillText(charactersDB[key].name, x + w/2, y + 60);
        ctx.font = "bold 18px Rajdhani"; ctx.fillStyle = UI_COLORS.ki; ctx.fillText(`${charactersDB[key].kiCost || 0} KI`, x + w/2, y + 100);
    });
    drawSparkBtn(canvas.width/2 - 100, canvas.height - 80, 200, 50, "CANCELAR", UI_COLORS.danger);
}

function drawAbsorbHUD() {
    ctx.fillStyle = "rgba(0,0,0,0.95)"; ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.font = "italic 40px Oswald"; ctx.fillStyle = "#fff"; ctx.textAlign = "center"; 
    ctx.fillText("SELECIONE O ALVO PARA ABSOR√á√ÉO", canvas.width/2, 100);
    
    const list = selectedPlayerChar.absorbList || [];
    let startX = (canvas.width - (list.length * 250)) / 2;
    
    list.forEach((item, i) => {
        let x = startX + i * 250, y = 200; 
        
        let unlocked = isUnlocked(item.target, "CHAR");
        if (charactersDB[item.target] && charactersDB[item.target].isTransformation) {
            unlocked = isUnlocked(item.target, "TRANS");
        }
        
        let hov = mouse.x > x && mouse.x < x + 230 && mouse.y > y && mouse.y < y + 230;
        drawSparkPanel(x, y, 230, 230, unlocked ? (hov ? "rgba(46, 204, 113, 0.2)" : UI_COLORS.panel) : "rgba(255,0,0,0.1)");
        
        ctx.font = "bold 24px Rajdhani"; ctx.fillStyle = unlocked ? "#fff" : UI_COLORS.danger; 
        ctx.fillText(charactersDB[item.target] ? charactersDB[item.target].name : item.target, x + 115, y + 40);
        
        if(unlocked) {
            drawSprite({ originalKey: item.target }, x + 115, y + 180, false, (charactersDB[item.target] && charactersDB[item.target].shopScale) || 2.2, item.target); 
            ctx.fillStyle = UI_COLORS.success; ctx.font = "italic 18px Oswald";
            ctx.fillText(">>> ABSORVER <<<", x + 115, y + 215);
        } else {
            ctx.fillText("BLOQUEADO", x + 115, y + 100);
        }
    });
    drawSparkBtn(canvas.width/2 - 100, 500, 200, 50, "CANCELAR", UI_COLORS.danger);
}

function drawSprite(char, x, y, flip = false, scaleOverride = null, skinKey = null, animated = false, activeAuraTimer = 0) {
    let sKey = skinKey || char.originalKey; let img = images[sKey]; let scale = scaleOverride || char.scale || 1.0;
    let idle = animated ? Math.sin(timeEnv * 10) * 8 : 0;
    let w = (img && img.naturalWidth) ? img.naturalWidth * scale : 60 * scale; let h = (img && img.naturalHeight) ? img.naturalHeight * scale : 100 * scale;
    ctx.save(); ctx.translate(x, y);
    if (animated) { ctx.fillStyle = "rgba(0, 0, 0, 0.5)"; ctx.beginPath(); ctx.ellipse(0, 0, w/2.5, 10, 0, 0, Math.PI*2); ctx.fill(); }
    ctx.translate(0, idle);
    
    // Escudo Visual de Defesa
    if(animated && char.isDefending) {
        ctx.save();
        ctx.beginPath(); ctx.arc(0, -h/2 + 20, Math.max(w, h)/1.5, 0, Math.PI*2);
        ctx.strokeStyle = "rgba(46, 204, 113, 0.6)"; ctx.lineWidth = 4; ctx.stroke();
        ctx.fillStyle = "rgba(46, 204, 113, 0.2)"; ctx.fill();
        ctx.restore();
    }

    // Aura default
    if(animated && char.aura) {
        let auraScale = 1 + Math.sin(timeEnv * 20) * 0.1;
        ctx.save(); ctx.scale(auraScale, auraScale); ctx.shadowBlur = 40; ctx.shadowColor = char.aura; ctx.globalAlpha = 0.5;
        ctx.beginPath(); ctx.ellipse(0, -h/2 + 20, w/1.2, h/1.2, 0, 0, Math.PI*2); ctx.fillStyle = char.aura; ctx.fill(); ctx.restore();
    }

    // Desenho do sprite original
    if(flip) ctx.scale(-1, 1);
    if(img && img.complete && !img.failed && img.naturalWidth > 0) { ctx.drawImage(img, -w/2, -h, w, h); } 
    else {
        let color = charactersDB[sKey]?.color || "#fff"; ctx.fillStyle = color; ctx.shadowBlur = 15; ctx.shadowColor = color;
        ctx.beginPath(); ctx.moveTo(-w/2, 0); ctx.lineTo(w/2, 0); ctx.lineTo(w/2 - 10, -h); ctx.lineTo(-w/2 + 10, -h); ctx.closePath(); ctx.fill();
        ctx.fillStyle = "#000"; ctx.textAlign = "center"; ctx.font = "bold 30px Rajdhani"; ctx.shadowBlur = 0;
        ctx.fillText(charactersDB[sKey]?.name?.charAt(0) || "?", 0, -h/2);
    }

       // Camada especial: Aura do Kaioken (sobreposta ao personagem)
    if (animated && activeAuraTimer > 0) {
        let auraImg = images["kaiokenaura"];
        if (auraImg && auraImg.complete && !auraImg.failed && auraImg.naturalWidth > 0) {
            ctx.save();
            let auraNW = auraImg.naturalWidth;
            let auraNH = auraImg.naturalHeight;
            // Escala "cover": mant√©m propor√ß√µes originais da sprite da aura,
            // mas amplia para cobrir completamente a sprite do personagem
            let coverScale = Math.max(w / auraNW, h / auraNH) * 1.35;
            let auraW = auraNW * coverScale;
            let auraH = auraNH * coverScale;
            // Efeito de pulsar r√°pido
            let pulse = 0.88 + Math.sin(timeEnv * 28) * 0.12;
            ctx.globalAlpha = 0.90 * pulse;
            // Brilho vermelho extra
            ctx.shadowBlur = 30 + Math.abs(Math.sin(timeEnv * 20)) * 20;
            ctx.shadowColor = "#ff2200";
            // Desenhado centrado horizontalmente, base na mesma linha do personagem
            ctx.drawImage(auraImg, -auraW / 2, -auraH, auraW, auraH);
            ctx.restore();
        }
    }
    
    
    ctx.restore();
}

function spawnFloatingText(x, y, text, color, size) { floatingTexts.push({x, y, text, color, size, life: 1}); }
function spawnParticles(x, y, color, count, type) {
    for(let i=0; i<count; i++) {
        let vx = (Math.random()-0.5)*15; let vy = (Math.random()-0.5)*15;
        if(type === "charge") { vx = (Math.random()-0.5)*5; vy = -Math.random()*15; y += 20; }
        particles.push({ x, y, color, vx, vy, life: 1, size: Math.random()*5+2 });
    }
}
function updateEffects() {
    shopScrollY += (targetShopScrollY - shopScrollY) * 0.15;
    charScrollY += (targetCharScrollY - charScrollY) * 0.15;
    storyScrollY += (targetStoryScrollY - storyScrollY) * 0.15;
    rankingScrollY += (targetRankingScrollY - rankingScrollY) * 0.15;
    dailyRewardScrollY += (targetDailyRewardScrollY - dailyRewardScrollY) * 0.15;
    achScrollY += (targetAchScrollY - achScrollY) * 0.15;

    for(let i=particles.length-1; i>=0; i--) {
        let p = particles[i]; p.x += p.vx; p.y += p.vy; p.life -= 0.04;
        ctx.globalAlpha = p.life; ctx.fillStyle = p.color; ctx.shadowBlur = 10; ctx.shadowColor = p.color; ctx.fillRect(p.x, p.y, p.size, p.size);
        if(p.life <= 0) particles.splice(i,1);
    }
    ctx.shadowBlur = 0;
    for(let i=floatingTexts.length-1; i>=0; i--) {
        let t = floatingTexts[i]; t.y -= 2; t.life -= 0.02;
        ctx.globalAlpha = t.life; ctx.fillStyle = t.color; ctx.font = `italic ${t.size}px Oswald`; ctx.textAlign = "center";
        ctx.lineWidth = 3; ctx.strokeStyle = "#000"; ctx.strokeText(t.text, t.x, t.y); ctx.fillText(t.text, t.x, t.y); 
        if(t.life <= 0) floatingTexts.splice(i,1);
    }
    ctx.globalAlpha = 1;

    // Interpola√ß√£o de Barras Suaves e Reset Suave do Dash
    if(selectedPlayerChar) {
        selectedPlayerChar.displayHp += (selectedPlayerChar.hp - selectedPlayerChar.displayHp) * 0.1;
        selectedPlayerChar.displayKi += (selectedPlayerChar.ki - selectedPlayerChar.displayKi) * 0.1;
        selectedPlayerChar.animX += (0 - selectedPlayerChar.animX) * 0.15;
    }
    if(selectedEnemyChar) {
        selectedEnemyChar.displayHp += (selectedEnemyChar.hp - selectedEnemyChar.displayHp) * 0.1;
        selectedEnemyChar.displayKi += (selectedEnemyChar.ki - selectedEnemyChar.displayKi) * 0.1;
        selectedEnemyChar.animX += (0 - selectedEnemyChar.animX) * 0.15;
    }
    
    // Decrementar timer da Aura do Kaioken
    if(selectedPlayerChar && selectedPlayerChar.kaiokenAuraTimer > 0) selectedPlayerChar.kaiokenAuraTimer--;
    if(selectedEnemyChar && selectedEnemyChar.kaiokenAuraTimer > 0) selectedEnemyChar.kaiokenAuraTimer--;
}

function drawBeamEffect() {
    ctx.save(); let startX = activeBeam.isPlayer ? 450 : 650, endX = activeBeam.isPlayer ? 650 : 450; let pulse = Math.random() * 10;
    ctx.shadowBlur = 50 + pulse; ctx.shadowColor = activeBeam.color; ctx.lineCap = "round";
    ctx.lineWidth = 40 + pulse; ctx.strokeStyle = activeBeam.color; ctx.beginPath(); ctx.moveTo(startX, 420); ctx.lineTo(endX, 420); ctx.stroke();
    ctx.lineWidth = 15; ctx.strokeStyle = "#fff"; ctx.beginPath(); ctx.moveTo(startX, 420); ctx.lineTo(endX, 420); ctx.stroke();
    ctx.restore(); activeBeam.life--; if(activeBeam.life <= 0) activeBeam = null;
}

// GESTOR DE CLIQUES E TOQUE
function handleInput() {
    if(currentState === STATES.MENU) {
        const btnW = 222, btnH = 46, btnGap = 9, colGap = 16;
        const col1X = 74, col2X = col1X + btnW + colGap;
        
        // Coluna 1: modos de jogo
        if(mouse.x >= col1X && mouse.x <= col1X + btnW) {
            let c1y = 148;
            if(mouse.y > c1y && mouse.y < c1y+btnH) { 
                playSound(500, 'sine', 0.1); isStoryMode = true; isSurvivalMode = false;
                selectedMissionIndex = Math.min(player.storyProgress, STORY_SEQUENCE.length - 1);
                currentState = STATES.STORY_MENU; return;
            }
            c1y += btnH + btnGap;
            if(mouse.y > c1y && mouse.y < c1y+btnH) { 
                playSound(500, 'sine', 0.1); isStoryMode = false; isSurvivalMode = false; 
                currentState = STATES.STAGE_SELECT; return;
            }
            c1y += btnH + btnGap;
            if(mouse.y > c1y && mouse.y < c1y+btnH) { playSound(500, 'sine', 0.1); isStoryMode = false; isSurvivalMode = true; survivalWave = 1; currentState = STATES.CHAR_SELECT; charSelectionStep = 0; return; }
            c1y += btnH + btnGap;
            if(mouse.y > c1y && mouse.y < c1y+btnH) { playSound(500, 'sine', 0.1); currentState = STATES.RANKING; return; }
            c1y += btnH + btnGap;
            if(mouse.y > c1y && mouse.y < c1y+btnH) { playSound(500, 'sine', 0.1); currentState = STATES.SHOP; shopTab = "CHARS"; return; }
            c1y += btnH + btnGap;
            if(mouse.y > c1y && mouse.y < c1y+btnH) {
                const dbCount = player.inventory["dragonballs"] || 0;
                if(dbCount >= 7) { playSound(900, 'sine', 0.3); summonPhase = "MAIN"; summonSelectedWish = null; summonWishCharScrollY = 0; currentState = STATES.SUMMON; }
                else { showMessage("VOC√ä PRECISA DE 7 ESFERAS DO DRAG√ÉO! (" + dbCount + "/7)"); playSound(300, 'triangle', 0.1); }
                return;
            }
        }
        
        // Coluna 2: utilit√°rios
        if(mouse.x >= col2X && mouse.x <= col2X + btnW) {
            let c2y = 148;
            if(mouse.y > c2y && mouse.y < c2y+btnH) { playSound(500, 'sine', 0.1); currentState = STATES.STATS; return; }
            c2y += btnH + btnGap;
            if(mouse.y > c2y && mouse.y < c2y+btnH) { playSound(500, 'sine', 0.1); currentState = STATES.DAILY_MISSIONS; return; }
            c2y += btnH + btnGap;
            if(mouse.y > c2y && mouse.y < c2y+btnH) { playSound(500, 'sine', 0.1); currentState = STATES.ACHIEVEMENTS; return; }
            c2y += btnH + btnGap;
            if(mouse.y > c2y && mouse.y < c2y+btnH) { playSound(500, 'sine', 0.1); dailyRewardPending = null; currentState = STATES.DAILY_REWARD; targetDailyRewardScrollY = 0; return; }
        }
    }
    else if(currentState === STATES.STAGE_SELECT) {
        // Bot√£o VOLTAR
        if(mouse.x > 20 && mouse.x < 200 && mouse.y > canvas.height-68 && mouse.y < canvas.height-20) {
            playSound(300,'triangle',0.1); currentState = STATES.MENU; return;
        }
        // Bot√£o CONFIRMAR
        if(mouse.x > canvas.width/2-130 && mouse.x < canvas.width/2+130 && mouse.y > canvas.height-68 && mouse.y < canvas.height-20) {
            playSound(600,'sine',0.1);
            currentStageIndex = selectedFreeBattleStage;
            currentState = STATES.CHAR_SELECT; charSelectionStep = 0; charHoverKey = null;
            return;
        }
        // Clique nos cards de cen√°rio
        const stages2 = BATTLE_STAGES.length;
        const cols2 = 5, cardW2 = 180, cardH2 = 120, gapX2 = 24, gapY2 = 18;
        const totalW2 = Math.min(stages2, cols2) * (cardW2 + gapX2) - gapX2;
        const startX2 = (canvas.width - totalW2) / 2;
        const startY2 = 115;
        for(let i = 0; i < stages2; i++) {
            const col2 = i % cols2, row2 = Math.floor(i / cols2);
            const cx2 = startX2 + col2*(cardW2+gapX2), cy2 = startY2 + row2*(cardH2+gapY2);
            if(mouse.x > cx2 && mouse.x < cx2+cardW2 && mouse.y > cy2 && mouse.y < cy2+cardH2) {
                selectedFreeBattleStage = i;
                playSound(500,'sine',0.08);
                break;
            }
        }
    }
    else if(currentState === STATES.SUMMON) {
        handleSummonInput();
        return;
    }
    else if(currentState === STATES.RANKING) {
        if(mouse.y > canvas.height - 80 && mouse.y < canvas.height - 30 && mouse.x > canvas.width/2 - 100 && mouse.x < canvas.width/2 + 100) { 
            playSound(300, 'triangle', 0.1); currentState = STATES.MENU; return; 
        }
    }
    else if(currentState === STATES.NEWS) {
    if(mouse.y > canvas.height - 75 && mouse.x > canvas.width/2 - 100 && mouse.x < canvas.width/2 + 100) {
        playSound(300, 'triangle', 0.1); currentState = STATES.MENU;
    }
}
    else if(currentState === STATES.DAILY_MISSIONS) {
        if(mouse.y > canvas.height - 65 && mouse.y < canvas.height - 17 && mouse.x > canvas.width/2 - 120 && mouse.x < canvas.width/2 + 120) {
            playSound(300, 'triangle', 0.1); currentState = STATES.MENU;
        }
    }
    else if(currentState === STATES.DAILY_REWARD) {
        const today = new Date().toDateString();
        const alreadyClaimed = player.lastDailyReward === today;
        const scrollAreaTop = 115;
        // Bot√£o Recolher ‚Äî posi√ß√£o relativa ao scroll
        if (!alreadyClaimed) {
            // streak bar: 50px, text: 30px, cards: 185px ‚Üí bot√£o recolher at offset 265 from scrollAreaTop+20
            const recolherAbsY = scrollAreaTop + 20 + dailyRewardScrollY + 50 + 30 + 185;
            if (mouse.y > recolherAbsY && mouse.y < recolherAbsY + 52 && mouse.x > canvas.width/2 - 160 && mouse.x < canvas.width/2 + 160) {
                claimDailyReward();
            }
        }
        // Bot√£o Voltar (fixo no fundo)
        if (mouse.y > canvas.height - 56 && mouse.y < canvas.height - 12 && mouse.x > canvas.width/2 - 110 && mouse.x < canvas.width/2 + 110) {
            playSound(300, 'triangle', 0.1); currentState = STATES.MENU; targetDailyRewardScrollY = 0;
        }
    }
    else if(currentState === STATES.STATS) {
        if(mouse.y > 480 && mouse.y < 530 && Math.abs(mouse.x - canvas.width/2) < 100) { playSound(300, 'triangle', 0.1); currentState = STATES.MENU; return; }
        
        if(player.statPoints > 0 && mouse.y > 330 && mouse.y < 370) {
            let sx = canvas.width/2 - 300;
            if(mouse.x > sx+20 && mouse.x < sx+160) { player.stats.hp++; player.statPoints--; playSound(600, 'sine', 0.1); save(); }
            if(mouse.x > sx+230 && mouse.x < sx+370) { player.stats.atk++; player.statPoints--; playSound(600, 'sine', 0.1); save(); }
            if(mouse.x > sx+440 && mouse.x < sx+580) { player.stats.ki++; player.statPoints--; playSound(600, 'sine', 0.1); save(); }
        }
    }
    else if(currentState === STATES.STORY_MENU) {
        // Bot√£o VOLTAR
        if(mouse.x > 20 && mouse.x < 200 && mouse.y > canvas.height - 68 && mouse.y < canvas.height - 20) {
            playSound(300, 'triangle', 0.1);
            currentState = STATES.MENU;
            targetStoryScrollY = 0;
            return;
        }
        
        let availableMissions = Math.min(player.storyProgress + 1, STORY_SEQUENCE.length);
        
        // Bot√£o INICIAR MISS√ÉO (no rodap√© do painel de detalhes)
        const listX = 20, listY = 110, listW = 440, listH = canvas.height - 200;
        const detX = listX + listW + 20, detW = canvas.width - detX - 20;
        const btnY = listY + listH - 80;
        if(mouse.x > detX + 20 && mouse.x < detX + detW - 20 && mouse.y > btnY && mouse.y < btnY + 55) {
            playSound(600, 'sine', 0.1);
            isStoryMode = true; isSurvivalMode = false;
            currentMissionPlaying = selectedMissionIndex;
            charSelectionStep = 0;
            currentState = STATES.CHAR_SELECT;
            charHoverKey = null;
            return;
        }
        
        // Clique na lista de miss√µes (recalcular items)
        let listItems = [];
        let lastSaga = null;
        for(let i = 0; i < availableMissions; i++) {
            let m = STORY_SEQUENCE[i];
            if(m.title && m.title !== lastSaga) { lastSaga = m.title; listItems.push({ type:'saga', label:m.title }); }
            listItems.push({ type:'mission', missionIndex: i });
        }
        const sagaH = 36, itemH = 56, gap = 8;
        
        let inClipX = mouse.x > listX && mouse.x < listX + listW;
        let inClipY = mouse.y > listY && mouse.y < listY + listH;
        
        if(inClipX && inClipY) {
            let curY = listY + storyScrollY;
            for(let item of listItems) {
                if(item.type === 'saga') { curY += sagaH + 4; continue; }
                let i = item.missionIndex;
                if(mouse.y > curY && mouse.y < curY + itemH) {
                    playSound(400, 'sine', 0.08);
                    selectedMissionIndex = i;
                    break;
                }
                curY += itemH + gap;
            }
        }
    }
    else if(currentState === STATES.SHOP) {
        if(mouse.x > canvas.width-175 && mouse.y > canvas.height-70) { playSound(300, 'triangle', 0.1); currentState = STATES.MENU; }
        // Novas abas: calculadas dinamicamente como no drawShop
        if(mouse.y > 96 && mouse.y < 148) {
            const tabTotalW2 = canvas.width - 44, tabH3 = 52, tabGap2 = 8;
            const tabW2 = (tabTotalW2 - tabGap2 * 3) / 4;
            const tabKeys = ["CHARS","COSTUMES","TRANS","ITEMS"];
            for(let ti=0; ti<4; ti++) {
                const tx2 = 22 + ti*(tabW2+tabGap2);
                if(mouse.x > tx2 && mouse.x < tx2+tabW2) {
                    playSound(600,'sine',0.1); shopTab = tabKeys[ti]; targetShopScrollY = 0; break;
                }
            }
        }
        if(shopTab === "CHARS") {
            // Card grid igual √†s outras abas
            let keys = Object.keys(charactersDB).filter(k => !charactersDB[k].isTransformation && !charactersDB[k].isCostume && !charactersDB[k].hidden);
            const iCols2 = 4, iW2 = 240, iH2 = 195, iGapX2 = 20, iGapY2 = 20;
            const iStartX2 = (canvas.width - (iCols2 * iW2 + (iCols2-1)*iGapX2)) / 2;
            const iStartY2 = 168;
            keys.forEach((key, i) => {
                let col = i % iCols2; let row = Math.floor(i / iCols2);
                let x = iStartX2 + col * (iW2 + iGapX2);
                let y = iStartY2 + row * (iH2 + iGapY2) + shopScrollY;
                let inClip = mouse.y > 158 && mouse.y < canvas.height - 97;
                if(inClip && mouse.x > x && mouse.x < x + iW2 && mouse.y > y && mouse.y < y + iH2) {
                    let char = charactersDB[key];
                    let owned = isUnlocked(key, "CHAR");
                    let price = char?.price;
                    if(owned || price === undefined || price === 0) {
                        showMessage("J√Å DISPON√çVEL"); playSound(500, 'sine', 0.08);
                    } else {
                        if(player.zeni >= price) {
                            player.zeni -= price;
                            if(!player.unlockedChars.includes(key)) player.unlockedChars.push(key);
                            save(); showMessage("PERSONAGEM DESBLOQUEADO!"); playSound(900, 'sine', 0.2);
                        } else showMessage("ZENI INSUFICIENTE");
                    }
                }
            });
        } else if(shopTab === "COSTUMES" || shopTab === "TRANS" || shopTab === "ITEMS") {
            let keys = []; let unlockList = [];
            if (shopTab === "COSTUMES") { keys = Object.keys(costumesDB); unlockList = player.unlockedCostumes; }
            else if (shopTab === "TRANS") { keys = Object.keys(charactersDB).filter(k => charactersDB[k].isTransformation && charactersDB[k].price !== undefined); unlockList = player.unlockedTransformations; }
            else { keys = Object.keys(itemsDB); }

            const iCols2 = 4, iW2 = 240, iH2 = 195, iGapX2 = 20, iGapY2 = 20;
            const iStartX2 = (canvas.width - (iCols2 * iW2 + (iCols2-1)*iGapX2)) / 2;
            const iStartY2 = 168;

            keys.forEach((key, i) => {
                let col = i % iCols2; let row = Math.floor(i / iCols2);
                let x = iStartX2 + col * (iW2 + iGapX2);
                let y = iStartY2 + row * (iH2 + iGapY2) + shopScrollY;
                let inClip = mouse.y > 158 && mouse.y < canvas.height - 97;
                
                if(inClip && mouse.x > x && mouse.x < x + iW2 && mouse.y > y && mouse.y < y + iH2) {
                    let db = shopTab==="COSTUMES"?costumesDB : (shopTab==="TRANS"?charactersDB : itemsDB);
                    
                    if (shopTab === "ITEMS") {
                        if(db[key].storyOnly) {
                            showMessage("S√ì OBT√çVEL NO MODO HIST√ìRIA"); playSound(300, 'triangle', 0.1);
                        } else if(player.zeni >= db[key].price) {
                            player.zeni -= db[key].price; player.inventory[key] = (player.inventory[key]||0)+1;
                            save(); showMessage("ADQUIRIDO"); playSound(800, 'sine', 0.2);
                        } else showMessage("ZENI INSUFICIENTE");
                    } else {
                        if(!isUnlocked(key, shopTab === "COSTUMES" ? "COSTUME" : "TRANS")) {
                            if(player.zeni >= db[key].price) {
                                player.zeni -= db[key].price; unlockList.push(key);
                                save(); showMessage(shopTab==="TRANS" ? "TRANSFORMA√á√ÉO DESBLOQUEADA" : "TRAJE ADQUIRIDO"); playSound(800, 'sine', 0.2);
                            } else showMessage("ZENI INSUFICIENTE");
                        } else showMessage("J√Å POSSUI");
                    }
                }
            });
        }
    }
    else if(currentState === STATES.CHAR_SELECT) {
        if(subMenuPhase) {
            if(mouse.y > canvas.height - 72 && mouse.y < canvas.height - 22 && mouse.x > canvas.width/2 - 130 && mouse.x < canvas.width/2 + 130) {
                playSound(300, 'triangle', 0.1); subMenuPhase = null; return;
            }
            
            const cW3 = 155, cH3 = 205, cGap3 = 18;
            let cols3 = Math.min(subMenuOptions.length, 5);
            let totalW3 = cols3 * cW3 + (cols3-1)*cGap3;
            let startX3 = (canvas.width - totalW3) / 2;
            subMenuOptions.forEach((optKey, i) => {
                let col3 = i % 5; let row3 = Math.floor(i / 5);
                let x3 = startX3 + col3 * (cW3 + cGap3); let y3 = 115 + row3 * (cH3 + 16);
                if(mouse.x > x3 && mouse.x < x3 + cW3 && mouse.y > y3 && mouse.y < y3 + cH3) {
                    playSound(600, 'sine', 0.1);
                    if (subMenuPhase === 'COSTUME') {
                        let trans = charactersDB[optKey].transList || [];
                        let unlockedTrans = trans.filter(t => isUnlocked(t, "TRANS"));
                        if (unlockedTrans.length > 0) {
                            subMenuPhase = 'TRANS';
                            subMenuOptions = [optKey, ...unlockedTrans];
                        } else {
                            finalizeCharSelection(optKey);
                        }
                    } else if (subMenuPhase === 'TRANS') {
                        finalizeCharSelection(optKey);
                    }
                }
            });
            return;
        }
        
        // Bot√£o VOLTAR
        if(mouse.x > 20 && mouse.x < 200 && mouse.y > canvas.height - 68 && mouse.y < canvas.height - 20) {
            playSound(300, 'triangle', 0.1); targetCharScrollY = 0; charHoverKey = null;
            if(charSelectionStep === 0) currentState = isStoryMode ? STATES.STORY_MENU : STATES.MENU;
            else charSelectionStep = 0;
            return;
        }
        
        // Filtros de categoria (linha de bot√µes abaixo do header)
        const CHAR_FILTERS_KEYS = ["TODOS","Z","DBS","GT","FILM","C","VIL√ÉO"];
        const filterY = 75, filterH = 30;
        let fx = 20;
        for(let f of CHAR_FILTERS_KEYS) {
            let fw = ctx.measureText(f === "TODOS" ? "TODOS" : f === "FILM" ? "FILMES" : f === "C" ? "CL√ÅSSIC" : f === "VIL√ÉO" ? "VIL√ïES" : "DB"+f).width + 24;
            if(mouse.x > fx && mouse.x < fx+fw && mouse.y > filterY && mouse.y < filterY+filterH) {
                if(charFilter !== f) { charFilter = f; targetCharScrollY = 0; playSound(500,'sine',0.05); }
                break;
            }
            fx += fw + 6;
        }
        
        // Bot√£o SELECIONAR no painel de preview
        const PORTRAIT = 95, GAP = 10, COLS = 5;
        const GRID_W = COLS * (PORTRAIT + GAP) - GAP;
        const prevX = 20 + GRID_W + 30;
        const prevW = canvas.width - prevX - 20;
        if(mouse.x > prevX && mouse.x < prevX + prevW && mouse.y > canvas.height - 68 && mouse.y < canvas.height - 20) {
            if(charHoverKey && isUnlocked(charHoverKey, "CHAR")) {
                playSound(600, 'sine', 0.1);
                handleCharGridClick(false, charHoverKey);
                return;
            } else if(charHoverKey && !isUnlocked(charHoverKey, "CHAR")) {
                currentState = STATES.SHOP; shopTab = "CHARS"; return;
            }
        }
        
        handleCharGridClick(false);
    }
    // ‚îÄ‚îÄ QTE: qualquer clique/toque resolve o QTE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    else if(currentState === STATES.BATTLE_RESULT) {
        // Continuar s√≥ dispon√≠vel ap√≥s anima√ß√£o (timer > 60)
        if(battleResult.timer > 60) {
            if(battleResult._survivalContinue) {
                // Continuar sobreviv√™ncia
                survivalWave++;
                let keys = Object.keys(charactersDB).filter(k => !charactersDB[k].isCostume);
                let randomEnemy = keys[Math.floor(Math.random() * keys.length)];
                currentStageIndex = Math.floor(Math.random() * BATTLE_STAGES.length);
                selectedEnemyChar = createBattleChar(randomEnemy, false);
                selectedPlayerChar.hp = Math.min(selectedPlayerChar.maxHp, selectedPlayerChar.hp + Math.floor(selectedPlayerChar.maxHp * 0.2));
                selectedPlayerChar.displayHp = selectedPlayerChar.hp;
                battleTurn = "PLAYER";
                battleLog = `ONDA ${survivalWave} INICIADA!`;
                // Reset ATB e QTE
                atbPlayer = 0; atbEnemy = 0; atbReady = false; atbPaused = false;
                qteUsesLeft = qteUsesMax;
                moveCooldowns = [0,0,0,0,0,0,0];
                currentState = STATES.BATTLE;
            } else {
                currentState = battleResult.won && isStoryMode ? STATES.STORY_MENU : STATES.MENU;
            }
            playSound(500,'sine',0.1);
        }
    }
    else if(currentState === STATES.ACHIEVEMENTS) {
        const H2 = canvas.height;
        if(mouse.y > H2 - 54 && mouse.y < H2 - 10 && mouse.x > canvas.width/2 - 120 && mouse.x < canvas.width/2 + 120) {
            playSound(300, 'triangle', 0.1); currentState = STATES.MENU; targetAchScrollY = 0;
        }
    }
    else if(currentState === STATES.BATTLE && qteActive) {
        resolveQTE(true);
        return;
    }
    else if(currentState === STATES.BATTLE && battleTurn === "PLAYER") {
        if(showFusionHUD && typeof showFusionHUD === 'object') {
            if(mouse.y > canvas.height - 80) { playSound(300, 'triangle', 0.1); showFusionHUD = false; return; }
            
            const fusionData = showFusionHUD;
            if (!fusionData.partners) return;
            
            const cardW = 240;
            const cardH = 240;
            const gap = 40;
            const totalW = fusionData.partners.length * (cardW + gap) - gap;
            const startX = (canvas.width - totalW) / 2;

            fusionData.partners.forEach((partner, i) => {
                const x = startX + i * (cardW + gap);
                const y = 150;
                
                if (mouse.x > x && mouse.x < x + cardW && mouse.y > y && mouse.y < y + cardH) {
                    if (partner.unlocked) {
                        executeFusion(partner.partnerKey);
                    } else {
                        showMessage(partner.reason || "BLOQUEADO");
                    }
                }
            });
        } else if(selectedPlayerChar.showAbsorbHUD) {
            const list = selectedPlayerChar.absorbList || [];
            let startX = (canvas.width - (list.length * 250)) / 2;
            list.forEach((item, i) => {
                let x = startX + i * 250; 
                if(mouse.x > x && mouse.x < x+230 && mouse.y > 200 && mouse.y < 430) {
                    let unlocked = isUnlocked(item.target, "CHAR");
                    if (charactersDB[item.target] && charactersDB[item.target].isTransformation) {
                        unlocked = isUnlocked(item.target, "TRANS");
                    }
                    if(unlocked) executeTransform(selectedPlayerChar, item.result, true);
                    else showMessage("ALVO BLOQUEADO");
                }
            });
        } else if(showItemHUD) {
¬† ¬† ¬† ¬† ¬† ¬† // Limita o clique de fechar estritamente √†s coordenadas do bot√£o FECHAR
¬† ¬† ¬† ¬† ¬† ¬† if(mouse.x > canvas.width/2 - 100 && mouse.x < canvas.width/2 + 100 && mouse.y > 520 && mouse.y < 570) { 
                playSound(300, 'triangle', 0.1); showItemHUD = false; return; 
            }
¬† ¬† ¬† ¬† ¬† ¬† const keys = Object.keys(itemsDB);
¬† ¬† ¬† ¬† ¬† ¬† let cols = 5;
¬† ¬† ¬† ¬† ¬† ¬† let startX = (canvas.width - ((cols - 1) * 160 + 120)) / 2;
¬† ¬† ¬† ¬† ¬† ¬† keys.forEach((key, i) => {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† let col = i % cols; let row = Math.floor(i / cols);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† let x = startX + (col * 160); let y = 160 + (row * 150);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if(mouse.x > x && mouse.x < x+120 && mouse.y > y && mouse.y < y+120) useItem(key);
¬† ¬† ¬† ¬† ¬† ¬† });
        } else if(selectedPlayerChar.showTransHUD) {
            if(mouse.y > canvas.height - 80) { playSound(300, 'triangle', 0.1); selectedPlayerChar.showTransHUD = false; return; }
            const list = selectedPlayerChar.transList || [];
            const unlockedList = list.filter(k => isUnlocked(k, "TRANS"));
            let cols = Math.min(unlockedList.length, 4);
            let startX = (canvas.width - (cols * 220)) / 2;
            unlockedList.forEach((key, i) => {
                let col = i % 4; let row = Math.floor(i / 4);
                let x = startX + col * 220; let y = 150 + row * 160; 
                if(mouse.x > x && mouse.x < x+200 && mouse.y > y && mouse.y < y+150) executeTransform(selectedPlayerChar, key, true);
            });
        } else {
            const totalBtns2 = 7;
            const btnY2 = 520, btnH2 = 98;
            const panelW2 = canvas.width - 20, panelX2 = 10;
            const btnW3 = (panelW2 - (totalBtns2 - 1) * 5) / totalBtns2;
            if(mouse.y > btnY2 && mouse.y < btnY2 + btnH2) {
                let clickedIndex = -1;
                for(let ci = 0; ci < totalBtns2; ci++) {
                    let cx = panelX2 + ci * (btnW3 + 5);
                    if(mouse.x > cx && mouse.x < cx + btnW3) { clickedIndex = ci; break; }
                }
                if(clickedIndex >= 0 && clickedIndex <= 6) {
                    let turnEnded = false;

                    // ‚îÄ‚îÄ Verificar ATB: jogador s√≥ pode agir quando barra cheia ‚îÄ‚îÄ
                    if(!atbReady && clickedIndex !== 5) { // itens s√£o sempre acess√≠veis
                        showMessage(`ATB: ${Math.floor(atbPlayer)}% ‚Äî AGUARDA!`);
                        return;
                    }
                    // ‚îÄ‚îÄ Verificar cooldown do move ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                    if(moveCooldowns[clickedIndex] > 0) {
                        showMessage(`COOLDOWN: ${Math.ceil(moveCooldowns[clickedIndex]/60)}s`);
                        return;
                    }

                    if(clickedIndex === 0) {
                        dealDamage(selectedPlayerChar, selectedEnemyChar, 0, true);
                        moveCooldowns[0] = 90;  // 1.5s
                        turnEnded = true;
                    }
                    else if(clickedIndex === 1) {
                        selectedPlayerChar.ki = Math.min(100, selectedPlayerChar.ki + 40); selectedPlayerChar.isCharging = true;
                        battleLog = "A CARREGAR KI!"; playSound(400, 'square', 0.5, 0.1);
                        setTimeout(() => selectedPlayerChar.isCharging = false, 500);
                        moveCooldowns[1] = 120; // 2s
                        turnEnded = true;
                    }
                    else if(clickedIndex === 2) {
                        if(selectedPlayerChar.ki >= selectedPlayerChar.moves[2].cost) {
                            selectedPlayerChar.ki -= selectedPlayerChar.moves[2].cost;
                            dealDamage(selectedPlayerChar, selectedEnemyChar, 2, true);
                            moveCooldowns[2] = 200; // ~3.3s
                            turnEnded = true;
                        } else showMessage("KI INSUFICIENTE");
                    }
                    else if(clickedIndex === 3) {
                        if(selectedPlayerChar.ki >= selectedPlayerChar.moves[3].cost) {
                            selectedPlayerChar.ki -= selectedPlayerChar.moves[3].cost;
                            dealDamage(selectedPlayerChar, selectedEnemyChar, 3, true);
                            moveCooldowns[3] = 270; // 4.5s
                            aiMemory.playerUsedSpecial++;
                            turnEnded = true;
                        } else showMessage("KI INSUFICIENTE");
                    }
                    else if(clickedIndex === 4) {
                        if(selectedPlayerChar.ki >= 10) {
                            selectedPlayerChar.ki -= 10; selectedPlayerChar.isDefending = true;
                            battleCounterWindow = true; battleCounterTimer = 60;
                            battleLog = "POSI√á√ÉO DE DEFESA!"; playSound(400, 'square', 0.2);
                            moveCooldowns[4] = 150; // 2.5s
                            aiMemory.playerUsedDefense++;
                            turnEnded = true;
                        } else showMessage("10 KI NECESS√ÅRIOS");
                    }
                    else if(clickedIndex === 5) { playSound(500, 'sine', 0.1); showItemHUD = true; }
                    else if(clickedIndex === 6) {
                        if(battleUltimateCharge >= 100) {
                            battleUltimateCharge = 0;
                            let ultimateDmg = Math.floor(selectedPlayerChar.maxHp * 0.7 * (1 + player.stats.atk*0.05));
                            selectedEnemyChar.hp = Math.max(0, selectedEnemyChar.hp - ultimateDmg);
                            screenFlash = 40; shakeIntensity = 50;
                            spawnParticles(canvas.width/2, 350, "#f1c40f", 80, "charge");
                            spawnParticles(canvas.width/2, 350, "#fff", 50, "hit");
                            spawnFloatingText(850, 180, `‚òÖ ULTIMATE! -${ultimateDmg}`, "#f1c40f", 70);
                            battleLog = `‚òÖ ${selectedPlayerChar.name.toUpperCase()} ‚Äî PODER M√ÅXIMO!`;
                            playSound(300,'sine',0.05); setTimeout(()=>playSound(600,'sine',0.1),150);
                            setTimeout(()=>playSound(1200,'sawtooth',0.5),300);
                            moveCooldowns[6] = 0; // ultimate n√£o tem cooldown (gasta 100%)
                            turnEnded = true;
                        } else {
                            showMessage(`ULTIMATE: ${Math.floor(battleUltimateCharge)}% CARREGADO`);
                        }
                    }

                    if(turnEnded) {
                        // Reset ATB do jogador ap√≥s agir
                        atbPlayer = 0; atbReady = false;
                        // Ki passivo
                        if(clickedIndex !== 1) selectedPlayerChar.ki = Math.min(100, selectedPlayerChar.ki + 5);
                        // O inimigo responde via ATB (n√£o mais via aiAction direto)
                        if(selectedEnemyChar.hp > 0 && !showItemHUD) {
                            battleTurn = "PLAYER"; // continua em player, inimigo age quando ATB chega a 100
                        }
                        if(selectedEnemyChar.hp <= 0) finalizeBattle();
                    }
                }
            }
            
            // L√≥gica para clicar nos bot√µes que agora foram divididos
            let hasTrans = selectedPlayerChar.transList?.length > 0;
            let hasAbsorb = selectedPlayerChar.absorbList?.length > 0;
            
            if (hasTrans && hasAbsorb) {
                if(mouse.y > 462 && mouse.y < 504) {
                    if (mouse.x > canvas.width/2 - 130 && mouse.x < canvas.width/2 - 10) {
                        playSound(500, 'sine', 0.1); selectedPlayerChar.showTransHUD = true;
                    } else if (mouse.x > canvas.width/2 + 10 && mouse.x < canvas.width/2 + 130) {
                        playSound(500, 'sine', 0.1); selectedPlayerChar.showAbsorbHUD = true;
                    }
                }
            } else if (hasTrans || hasAbsorb) {
                if(Math.abs(mouse.x - canvas.width/2) < 130 && mouse.y > 462 && mouse.y < 504) {
                    playSound(500, 'sine', 0.1);
                    if (hasAbsorb) selectedPlayerChar.showAbsorbHUD = true;
                    else selectedPlayerChar.showTransHUD = true;
                }
            }
        }
    }
}

function updatePointer(clientX, clientY) {
    const r = canvas.getBoundingClientRect();
    mouse.x = (clientX - r.left) * (canvas.width / r.width); 
    mouse.y = (clientY - r.top) * (canvas.height / r.height);
}

canvas.addEventListener('mousedown', (e) => { updatePointer(e.clientX, e.clientY); handleInput(); });

function handleCharGridClick(isShopMode, directKey) {
    let scrollY = isShopMode ? shopScrollY : charScrollY;
    
    // Filtrar chaves usando o mesmo filtro que drawCharSelectLayout
    function getCharCat(key, data) {
        if(data.isEvil) return "VIL√ÉO";
        let k = key.toLowerCase();
        if(k.includes('gt') || k.includes('baby') || k.includes('oozaruss4')) return "GT";
        if(k.includes('dbs') || k.includes('blue') || k.includes('ultra') || k.includes('broly') || k.includes('beerus') || k.includes('jiren') || k.includes('toppo') || k.includes('merged') || k.includes('berserker')) return "DBS";
        if(k.endsWith('c') || k.includes('classic') || key === 'GokuC' || key === 'GokuC2' || key === 'GokuC3' || key === 'GokuC4') return "C";
        if(k.includes('freeza') || k.includes('cell') || k.includes('boo') || k.includes('dabura') || k.includes('turles') || k.includes('slug') || k.includes('cooler') || k.includes('android') || k.includes('piccolo') || k.includes('raditz') || k.includes('nappa') || k.includes('vegeta') || k.includes('ginyu') || k.includes('dodoria') || k.includes('zarbon') || k.includes('recoome') || k.includes('burter') || k.includes('jeice') || k.includes('cui') || k.includes('saibaman') || k.includes('janemba')) return "VIL√ÉO";
        return "Z";
    }
    
    let allKeys = Object.keys(charactersDB).filter(k => !charactersDB[k].isTransformation && !charactersDB[k].isCostume && !charactersDB[k].hidden);
    let keys = (isShopMode || charFilter === "TODOS") ? allKeys : allKeys.filter(k => getCharCat(k, charactersDB[k]) === charFilter);
    
    const GRID_X = 20, GRID_START_Y = 115, PORTRAIT = 95, GAP = 10, COLS = 5;
    const GRID_W = COLS * (PORTRAIT + GAP) - GAP;
    const GRID_CLIP_H = canvas.height - 200;
    
    // Se foi passada uma key direta (pelo bot√£o SELECIONAR do preview)
    const processKey = (key) => {
        if(isShopMode) {
            if(!isUnlocked(key, "CHAR")) {
                if(charactersDB[key].price !== undefined && player.zeni >= charactersDB[key].price) {
                    player.zeni -= charactersDB[key].price; player.unlockedChars.push(key); save(); showMessage("GUERREIRO ADQUIRIDO");
                } else showMessage(charactersDB[key].price === undefined ? "N√ÉO COMPR√ÅVEL" : "ZENI INSUFICIENTE");
            } else showMessage("J√Å POSSUI");
        } else {
            if(isUnlocked(key, "CHAR")) {
                playSound(600, 'sine', 0.1);
                let costumes = charactersDB[key].costumes ? charactersDB[key].costumes.filter(c => isUnlocked(c, "COSTUME")) : [];
                let trans = charactersDB[key].transList || [];
                let unlockedTrans = trans.filter(t => isUnlocked(t, "TRANS"));
                if (costumes.length > 0) {
                    subMenuPhase = 'COSTUME'; subMenuOptions = [key, ...costumes];
                } else if (unlockedTrans.length > 0) {
                    subMenuPhase = 'TRANS'; subMenuOptions = [key, ...unlockedTrans];
                } else {
                    finalizeCharSelection(key);
                }
            } else showMessage("BLOQUEADO NA LOJA");
        }
    };
    
    if(directKey) { processKey(directKey); return; }
    
    keys.forEach((key, i) => {
        let col = i % COLS; let row = Math.floor(i / COLS);
        let x = GRID_X + col * (PORTRAIT + GAP);
        let y = GRID_START_Y + row * (PORTRAIT + GAP) + scrollY;
        
        let inClip = mouse.y > GRID_START_Y && mouse.y < GRID_START_Y + GRID_CLIP_H && mouse.x < GRID_X + GRID_W + 20;
        if(inClip && mouse.x > x && mouse.x < x + PORTRAIT && mouse.y > y && mouse.y < y + PORTRAIT) {
            charHoverKey = key;
            processKey(key);
        }
    });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  IA INTELIGENTE ‚Äî fases, mem√≥ria, transforma√ß√µes estrat√©gicas
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function aiUpdatePhase(ai) {
    const hp   = ai.hp / ai.maxHp;
    const ki   = ai.ki;
    const prev = aiPhase;

    // Determinar fase com base no estado do combate
    if (hp < 0.18) {
        aiPhase = "BERSERK";            // HP cr√≠tico ‚Üí ataque total
    } else if (hp < 0.40 && ki >= 60) {
        aiPhase = "AGGRESSIVE";         // HP baixo mas tem KI ‚Üí pressionar
    } else if (hp < 0.35 && ki < 30) {
        aiPhase = "DEFENSIVE";          // HP baixo e sem KI ‚Üí defender/carregar
    } else if (ki < 20 && hp > 0.5) {
        aiPhase = "POWERING";           // Confort√°vel mas sem KI ‚Üí carregar
    } else if (aiMemory.consecutiveQTESuccess >= 2) {
        aiPhase = "AGGRESSIVE";         // Jogador est√° a esquivar tudo ‚Üí mudar t√°tica
    } else if (aiMemory.playerUsedDefense >= 3) {
        aiPhase = "AGGRESSIVE";         // Jogador defensivo ‚Üí especiais para furar defesa
    } else {
        aiPhase = "NEUTRAL";
    }

    if (prev !== aiPhase) {
        const phaseLabels = {
            NEUTRAL:"...", AGGRESSIVE:"‚ö° INIMIGO FICOU AGRESSIVO!",
            DEFENSIVE:"üõ° INIMIGO RECUOU!", POWERING:"üîã INIMIGO A ACUMULAR PODER!",
            BERSERK:"üí• INIMIGO EM MODO BERSERK!"
        };
        if (phaseLabels[aiPhase] !== "...") {
            battleLog = phaseLabels[aiPhase];
            screenFlash = 12;
        }
    }
}

function aiDecideTransform(ai) {
    if (!ai.transList || ai.transList.length === 0) return false;
    if (aiTransformCooldown > 0) return false;

    const hp = ai.hp / ai.maxHp;
    const allTrans = ai.transList;
    // Filtrar transforma√ß√µes ainda n√£o usadas OU usar a seguinte na lista
    const availableTrans = allTrans.filter(k => k !== ai.currentSkin && charactersDB[k]);
    if (availableTrans.length === 0) return false;

    // Condi√ß√µes estrat√©gicas para transformar:
    const shouldTransform =
        hp < 0.55 ||                                  // HP abaixo de 55%
        aiPhase === "BERSERK" ||                       // modo berserk
        (aiPhase === "AGGRESSIVE" && hp < 0.70) ||     // agressivo com HP baixo
        (aiActionCount >= 4 && Math.random() < 0.35) || // a cada ~4 ac√ß√µes, 35% chance
        (aiMemory.consecutiveQTESuccess >= 3);          // jogador a esquivar tudo

    if (!shouldTransform) return false;

    // Escolher a transforma√ß√£o (sequencialmente, avan√ßa na lista)
    const nextTrans = availableTrans[aiTransformIndex % availableTrans.length];
    if (!nextTrans) return false;

    executeTransform(ai, nextTrans, false);

    // ‚îÄ‚îÄ Regenera√ß√£o de vida ao transformar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const healPercent = 0.30; // regenera 30% do HP m√°ximo
    const healAmount = Math.floor(ai.maxHp * healPercent);
    ai.hp = Math.min(ai.maxHp, ai.hp + healAmount);
    ai.displayHp = ai.hp;
    spawnParticles(800, 350, "#00ff88", 30, "explode");
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    battleLog = `‚ö° ${ai.name} TRANSFORMOU-SE! (+${healAmount} HP)`;
    screenFlash = 25;
    shakeIntensity = 20;
    spawnParticles(800, 350, ai.color || "#f1c40f", 60, "explode");
    playSound(900, 'sine', 0.4);
    aiTransformCooldown = 420; // ~7 segundos at√© pr√≥xima transforma√ß√£o (a 60fps)
    aiTransformIndex++;
    aiActionCount = 0;
    return true;
}

function aiChooseMove(ai) {
    const hp      = ai.hp / ai.maxHp;
    const ki      = ai.ki;
    const move3   = ai.moves[3];
    const move2   = ai.moves[2];
    const m3cost  = move3?.cost ?? 999;
    const m2cost  = move2?.cost ?? 999;
    const playerDefending = selectedPlayerChar?.isDefending;

    // Regenera√ß√£o KI passiva
    ai.ki = Math.min(100, ai.ki + 8);

    switch (aiPhase) {

        case "POWERING":
            // Carregar KI ‚Äî mas n√£o sempre (40% attack mesmo assim)
            if (ki < 50 && Math.random() < 0.65) {
                ai.ki = Math.min(100, ai.ki + 45);
                ai.isCharging = true;
                battleLog = "üîã INIMIGO A ACUMULAR KI...";
                setTimeout(() => { if(ai) ai.isCharging = false; }, 700);
                return null; // null = n√£o lan√ßa ataque
            }
            return 0; // ataque b√°sico enquanto carrega

        case "DEFENSIVE":
            if (ki >= 10 && Math.random() < 0.55) {
                ai.ki -= 10; ai.isDefending = true;
                battleLog = "üõ° INIMIGO DEFENDEU-SE!";
                playSound(200, 'square', 0.2);
                return null;
            }
            // Carregue KI se muito baixo
            if (ki < 25) {
                ai.ki = Math.min(100, ai.ki + 45); ai.isCharging = true;
                battleLog = "üîã INIMIGO A RECUPERAR...";
                setTimeout(() => { if(ai) ai.isCharging = false; }, 700);
                return null;
            }
            return 0;

        case "AGGRESSIVE":
            // Se o jogador defende muito ‚Üí usar especiais para furar
            if (playerDefending && ki >= m2cost) {
                ai.ki -= m2cost; return 2;
            }
            if (ki >= m3cost && Math.random() < 0.50) { ai.ki -= m3cost; return 3; }
            if (ki >= m2cost && Math.random() < 0.65) { ai.ki -= m2cost; return 2; }
            return 0;

        case "BERSERK":
            // Tudo ou nada: usa o move mais caro dispon√≠vel
            if (ki >= m3cost) { ai.ki -= m3cost; return 3; }
            if (ki >= m2cost) { ai.ki -= m2cost; return 2; }
            return 0; // ataque f√≠sico mesmo

        case "NEUTRAL":
        default:
            // Comportamento equilibrado mas inteligente
            // Se jogador falhou muitos QTEs ‚Üí continuar com especiais
            if (aiMemory.playerMissedQTE >= 2 && ki >= m2cost && Math.random() < 0.55) {
                ai.ki -= m2cost; return 2;
            }
            if (ki >= m3cost && Math.random() < 0.35) { ai.ki -= m3cost; return 3; }
            if (ki >= m2cost && Math.random() < 0.45) { ai.ki -= m2cost; return 2; }
            // √Äs vezes carrega KI mesmo no neutro (paci√™ncia)
            if (ki < 40 && Math.random() < 0.30) {
                ai.ki = Math.min(100, ai.ki + 40); ai.isCharging = true;
                battleLog = "INIMIGO A CARREGAR KI!";
                setTimeout(() => { if(ai) ai.isCharging = false; }, 600);
                return null;
            }
            return 0;
    }
}

function aiAction() {
    if (!selectedEnemyChar || !selectedPlayerChar) return;

    atbEnemy = 0;
    battleTurn = "ENEMY";
    selectedEnemyChar.isDefending = false;
    atbPaused = true;

    // Decrementar cooldown de transforma√ß√£o
    if (aiTransformCooldown > 0) aiTransformCooldown -= 60; // desconta ~1s por ac√ß√£o

    processStatusEffects();

    setTimeout(() => {
        const ai = selectedEnemyChar;
        if (!ai || !selectedPlayerChar) { atbPaused = false; return; }

        aiActionCount++;

        // Verificar stun
        const stunned = battleStatusEffects.enemy.find(e => e.type === "stun");
        if (stunned) {
            battleLog = "‚ö° INIMIGO ATORDOADO ‚Äî PERDEU O TURNO!";
            spawnFloatingText(800, 200, "ATORDOADO!", "#f1c40f", 36);
            battleStatusEffects.enemy = battleStatusEffects.enemy.filter(e => e.type !== "stun");
            atbPaused = false; battleTurn = "PLAYER"; return;
        }

        // 1. Atualizar fase da IA
        aiUpdatePhase(ai);

        // 2. Tentar transformar (estrat√©gico ‚Äî pode acontecer a qualquer momento)
        const transformed = aiDecideTransform(ai);
        if (transformed) {
            // Ap√≥s transformar, a IA ainda age neste turno (ficou mais forte)
            // Pequena pausa dram√°tica extra
            setTimeout(() => {
                aiUpdatePhase(ai); // reavalia fase com nova forma
                const moveIndex = aiChooseMove(ai);
                if (moveIndex === null) {
                    atbPaused = false; battleTurn = "PLAYER"; return;
                }
                launchAIAttack(ai, moveIndex);
            }, 800);
            return;
        }

        // 3. Decidir move
        const moveIndex = aiChooseMove(ai);
        if (moveIndex === null) {
            // Ac√ß√£o sem ataque (defender/carregar)
            atbPaused = false; battleTurn = "PLAYER"; return;
        }

        launchAIAttack(ai, moveIndex);
    }, 700); // delay menor que antes para parecer mais reativo
}

function launchAIAttack(ai, moveIndex) {
    if (!ai || !selectedPlayerChar) { atbPaused = false; return; }
    aiConsecutiveHits++;

    // Determinar tipo de QTE baseado no move
    const moveType = ai.moves[moveIndex]?.type || "physical";
    qteType    = (moveType === "beam" || moveType === "sphere") ? "DODGE" : "BLOCK";

    // Se jogador tem hist√≥rico de esquivar bem ‚Üí IA usa ataque f√≠sico √†s vezes para enganar
    if (aiMemory.consecutiveQTESuccess >= 2 && qteType === "DODGE" && Math.random() < 0.4) {
        // Usa ataque f√≠sico (BLOCK) em vez do esperado para apanhar o jogador de surpresa
        moveIndex = 0;
        qteType   = "BLOCK";
    }

    qtePending = { attacker: ai, target: selectedPlayerChar, moveIndex };
    qteActive  = true;
    qteTimer   = qteMaxTime;
    qteSuccess = false;

    // Mensagem mais descritiva por fase
    const msgs = {
        BERSERK:    ["üí• ATAQUE FREN√âTICO!", "üí• PODER TOTAL!", "üí• SEM MISERIC√ìRDIA!"],
        AGGRESSIVE: ["‚ö° ATAQUE R√ÅPIDO!", "‚ö° PRESS√ÉO TOTAL!", "‚ö° SEM PARAR!"],
        NEUTRAL:    [qteType==="DODGE" ? "‚ö° ESQUIVAR AGORA!" : "üõ° BLOQUEAR AGORA!"],
        DEFENSIVE:  ["üõ° BLOQUEAR AGORA!"],
        POWERING:   ["‚ö° ESQUIVAR AGORA!"],
    };
    const pool = msgs[aiPhase] || msgs.NEUTRAL;
    battleLog = pool[Math.floor(Math.random() * pool.length)];

    // Som varia por fase
    const freq = aiPhase === "BERSERK" ? 1100 : aiPhase === "AGGRESSIVE" ? 950 : 800;
    playSound(freq, 'sine', 0.18);
}

// ‚îÄ‚îÄ Resolver QTE (chamado ao pressionar bot√£o ou timeout) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function resolveQTE(success) {
    if (!qteActive || !qtePending) return;

    // Se o jogador tentou reagir mas n√£o tem mais usos ‚Üí for√ßar falha
    if (success && qteUsesLeft <= 0) {
        spawnFloatingText(280, 270, "SEM ESQUIVAS!", "#ff4444", 38);
        playSound(150, 'sawtooth', 0.3);
        success = false;
    }

    qteActive = false;
    qteSuccess = success;
    qteFlash = 35;

    // Atualizar mem√≥ria da IA
    if (success) {
        qteUsesLeft--;  // consumir uso
        player.totalQTESuccess = (player.totalQTESuccess || 0) + 1;
        aiMemory.consecutiveQTESuccess++;
        aiMemory.playerMissedQTE = Math.max(0, aiMemory.playerMissedQTE - 1);
        aiConsecutiveHits = 0;
    } else {
        aiMemory.playerMissedQTE++;
        aiMemory.consecutiveQTESuccess = 0;
    }

    const { attacker, target, moveIndex } = qtePending;
    qtePending = null;

    if (success) {
        if (qteType === "DODGE") {
            battleLog = "‚ö° ESQUIVOU!";
            spawnFloatingText(280, 260, "ESQUIVOU!", "#00ffcc", 44);
            spawnParticles(300, 400, "#00ffcc", 25, "hit");
            playSound(700, 'sine', 0.2);
            const counterDmg = Math.floor(selectedPlayerChar.moves[0].dmg * 0.6 * (1 + player.stats.atk * 0.05));
            attacker.hp = Math.max(0, attacker.hp - counterDmg);
            spawnFloatingText(870, 200, `COUNTER! -${counterDmg}`, "#00ffaa", 38);
            battleUltimateCharge = Math.min(100, battleUltimateCharge + 10);
        } else {
            battleLog = "üõ° BLOQUEOU! -70% DANO";
            target.isDefending = true;
            dealDamage(attacker, target, moveIndex, false);
            target.isDefending = false;
            playSound(300, 'square', 0.2);
            aiMemory.playerUsedDefense++;
        }
    } else {
        battleLog = "üí• N√ÉO REAGIU A TEMPO!";
        spawnFloatingText(280, 260, "TARDE DEMAIS!", "#ff4444", 36);
        const origDef = target.isDefending;
        target.isDefending = false;
        dealDamage(attacker, target, moveIndex, false);
        target.isDefending = origDef;
    }

    if (selectedPlayerChar && selectedPlayerChar.hp > 0) {
        battleTurn = "PLAYER";
        atbPaused = false;
        if (attacker.hp <= 0) finalizeBattle();
    } else {
        finalizeBattle();
    }
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ñ∂  SISTEMA DE CONQUISTAS & T√çTULOS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const ACHIEVEMENTS_DEF = [
    // Vit√≥rias
    { id:"win1",    icon:"‚öî",  name:"Primeiro Sangue",        desc:"Ven√ßa a sua primeira batalha.",             check: p => (p.victories||0) >= 1 },
    { id:"win10",   icon:"ü•ä",  name:"Guerreiro em Forma√ß√£o",  desc:"Ven√ßa 10 batalhas.",                        check: p => (p.victories||0) >= 10 },
    { id:"win50",   icon:"üí™",  name:"Veterano de Guerra",     desc:"Ven√ßa 50 batalhas.",                        check: p => (p.victories||0) >= 50 },
    { id:"win100",  icon:"üèÜ",  name:"Lenda do Ringue",        desc:"Ven√ßa 100 batalhas.",                       check: p => (p.victories||0) >= 100 },
    // Sobreviv√™ncia
    { id:"surv5",   icon:"üåä",  name:"Sobrevivente",           desc:"Alcance a onda 5 no modo Sobreviv√™ncia.",   check: p => (p.maxSurvivalWave||0) >= 5 },
    { id:"surv15",  icon:"üî•",  name:"Inquebr√°vel",            desc:"Alcance a onda 15 no modo Sobreviv√™ncia.",  check: p => (p.maxSurvivalWave||0) >= 15 },
    { id:"surv30",  icon:"üí•",  name:"For√ßa da Natureza",      desc:"Alcance a onda 30 no modo Sobreviv√™ncia.",  check: p => (p.maxSurvivalWave||0) >= 30 },
    // N√≠vel
    { id:"lv10",    icon:"‚¨Ü",  name:"Em Ascens√£o",            desc:"Alcance o n√≠vel 10.",                       check: p => (p.level||1) >= 10 },
    { id:"lv25",    icon:"‚≠ê",  name:"Super Guerreiro",        desc:"Alcance o n√≠vel 25.",                       check: p => (p.level||1) >= 25 },
    { id:"lv50",    icon:"üåü",  name:"Poder M√°ximo",           desc:"Alcance o n√≠vel 50.",                       check: p => (p.level||1) >= 50 },
    // Hist√≥ria
    { id:"story5",  icon:"üìñ",  name:"In√≠cio da Saga",         desc:"Complete 5 miss√µes da hist√≥ria.",           check: p => (p.storyProgress||0) >= 5 },
    { id:"story20", icon:"üìï",  name:"Her√≥i da Hist√≥ria",      desc:"Complete 20 miss√µes da hist√≥ria.",          check: p => (p.storyProgress||0) >= 20 },
    { id:"storyall",icon:"üëë",  name:"A Lenda Continua",       desc:"Complete todas as miss√µes da hist√≥ria.",    check: p => (p.storyProgress||0) >= 62 },
    // Zeni
    { id:"zeni50k", icon:"üí∞",  name:"Comerciante Z",          desc:"Acumule 50.000 Zeni.",                      check: p => (p.zeni||0) >= 50000 },
    { id:"zeni200k",icon:"üíé",  name:"Milion√°rio Saiyan",      desc:"Acumule 200.000 Zeni.",                     check: p => (p.zeni||0) >= 200000 },
    // Personagens
    { id:"chars10", icon:"üßë",  name:"Coleccionador",          desc:"Desbloqueie 10 personagens.",               check: p => (p.unlockedChars||[]).length >= 10 },
    { id:"chars25", icon:"üßë‚Äçü§ù‚Äçüßë",  name:"Enciclop√©dia Viva",      desc:"Desbloqueie 25 personagens.",               check: p => (p.unlockedChars||[]).length >= 25 },
    // QTE
    { id:"qte10",   icon:"‚ö°",  name:"Reflexos de Saiyan",     desc:"Execute 10 esquivas/bloqueios com sucesso.", check: p => (p.totalQTESuccess||0) >= 10 },
    { id:"qte50",   icon:"üåÄ",  name:"Esquiva Perfeita",        desc:"Execute 50 esquivas/bloqueios com sucesso.", check: p => (p.totalQTESuccess||0) >= 50 },
];

const TITLES_DEF = [
    { id:"rookie",    name:"Recruta",          condition: p => true,                                color:"#aaa"    },
    { id:"fighter",   name:"Guerreiro Z",      condition: p => (p.victories||0) >= 10,              color:"#2ecc71" },
    { id:"veteran",   name:"Veterano",         condition: p => (p.victories||0) >= 50,              color:"#3498db" },
    { id:"legend",    name:"Lenda",            condition: p => (p.victories||0) >= 100,             color:"#9b59b6" },
    { id:"survivor",  name:"Sobrevivente",     condition: p => (p.maxSurvivalWave||0) >= 15,        color:"#e67e22" },
    { id:"destroyer", name:"Deus da Destrui√ß√£o",condition:p => (p.level||1) >= 25,                 color:"#e74c3c" },
    { id:"godki",     name:"Guerreiro Divino", condition: p => (p.level||1) >= 50,                  color:"#f1c40f" },
    { id:"hero",      name:"Her√≥i da Hist√≥ria",condition: p => (p.storyProgress||0) >= 20,          color:"#00d2ff" },
];

function getPlayerTitle() {
    if (!player.titles) player.titles = [];
    // Verificar novos t√≠tulos desbloqueados
    TITLES_DEF.forEach(t => {
        if (t.condition(player) && !player.titles.includes(t.id)) {
            player.titles.push(t.id);
        }
    });
    // Retornar o t√≠tulo mais alto desbloqueado (√∫ltimo da lista)
    const unlocked = TITLES_DEF.filter(t => (player.titles||[]).includes(t.id));
    return unlocked.length > 0 ? unlocked[unlocked.length - 1] : TITLES_DEF[0];
}

function checkAchievements() {
    if (!player.achievements) player.achievements = [];
    const newOnes = [];
    ACHIEVEMENTS_DEF.forEach(a => {
        if (!player.achievements.includes(a.id) && a.check(player)) {
            player.achievements.push(a.id);
            newOnes.push(a);
        }
    });
    return newOnes;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ñ∂  ECR√É DE RESULTADO DE BATALHA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showBattleResult(won, zeniGained, expGained, levelUp, enemyName, mode) {
    const newTitle = getPlayerTitle();
    const newAchievs = checkAchievements();
    battleResult = {
        won, zeniGained, expGained, levelUp,
        newTitle:   newTitle,
        newAchievs: newAchievs,
        timer:      0,
        playerName: player.name,
        enemyName:  enemyName,
        mode:       mode,
    };
    currentState = STATES.BATTLE_RESULT;
    save();
}

function drawBattleResult() {
    const r = battleResult;
    r.timer++;
    const t = r.timer;
    const W = canvas.width, H = canvas.height;
    const won = r.won;

    // ‚îÄ‚îÄ Fundo com gradiente animado ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const bgCol1 = won ? "#0a1a0a" : "#1a0a0a";
    const bgCol2 = won ? "#002200" : "#220000";
    const bgGrad = ctx.createLinearGradient(0,0,0,H);
    bgGrad.addColorStop(0, bgCol1); bgGrad.addColorStop(1, bgCol2);
    ctx.fillStyle = bgGrad; ctx.fillRect(0,0,W,H);

    // Part√≠culas de fundo
    if (t < 180 && t % 4 === 0) {
        const col = won ? "#00ff88" : "#ff4444";
        spawnParticles(W/2 + (Math.random()-0.5)*600, H*0.3, col, 5, "explode");
    }

    // ‚îÄ‚îÄ Banner principal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const bannerAlpha = Math.min(1, t / 20);
    const bannerScale = t < 15 ? (0.3 + (t/15)*0.7) : (1 + Math.sin((t-15)*0.05)*0.015);
    ctx.save();
    ctx.globalAlpha = bannerAlpha;
    ctx.translate(W/2, 130);
    ctx.scale(bannerScale, bannerScale);

    const bannerCol   = won ? "#00ff88" : "#ff4444";
    const bannerGlow  = won ? "#00ffaa" : "#ff6666";
    const bannerText  = won ? "VIT√ìRIA!" : "DERROTA...";

    ctx.font = "italic bold 88px Bangers";
    ctx.textAlign = "center";
    ctx.shadowBlur = 40 + Math.sin(t*0.1)*10;
    ctx.shadowColor = bannerGlow;
    ctx.fillStyle = bannerCol;
    ctx.fillText(bannerText, 0, 0);
    ctx.shadowBlur = 0;
    ctx.restore();

    // ‚îÄ‚îÄ Linha divis√≥ria ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if (t > 15) {
        const lineAlpha = Math.min(1, (t-15)/15);
        ctx.save(); ctx.globalAlpha = lineAlpha;
        const lineGrad = ctx.createLinearGradient(W*0.1, 0, W*0.9, 0);
        lineGrad.addColorStop(0,"transparent");
        lineGrad.addColorStop(0.5, won ? "#00ff88" : "#ff4444");
        lineGrad.addColorStop(1,"transparent");
        ctx.strokeStyle = lineGrad; ctx.lineWidth = 2;
        ctx.beginPath(); ctx.moveTo(W*0.1, 170); ctx.lineTo(W*0.9, 170); ctx.stroke();
        ctx.restore();
    }

    // ‚îÄ‚îÄ Painel de stats ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if (t > 25) {
        const statsAlpha = Math.min(1, (t-25)/20);
        ctx.save(); ctx.globalAlpha = statsAlpha;

        // VS info
        ctx.font = "bold 20px Rajdhani"; ctx.textAlign = "center"; ctx.fillStyle = "rgba(255,255,255,0.5)";
        ctx.fillText(`${r.playerName}  vs  ${r.enemyName}`, W/2, 205);

        const mode_labels = { "LIVRE":"üÜì MODO LIVRE", "HISTORIA":"üìñ HIST√ìRIA", "SURVIVAL":"üåä SOBREVIV√äNCIA" };
        ctx.font = "bold 14px Rajdhani"; ctx.fillStyle = "rgba(255,255,255,0.3)";
        ctx.fillText(mode_labels[r.mode] || r.mode, W/2, 225);

        // Cards de recompensa
        const cards = [
            { label:"ZENI GANHO",  value:`+${r.zeniGained.toLocaleString()} Z`, icon:"üí∞", color:"#f1c40f" },
            { label:"EXP GANHO",   value:`+${r.expGained} EXP`,                 icon:"‚¨Ü",  color:"#2ecc71" },
            { label:"VIT√ìRIAS",    value:String(player.victories||0),            icon:"‚öî",  color:"#3498db" },
            { label:"N√çVEL",       value:String(player.level),                   icon:"‚≠ê",  color:"#9b59b6" },
        ];

        const cardW = 210, cardH = 90, cardSpacing = 20;
        const totalW = cards.length * cardW + (cards.length-1)*cardSpacing;
        const startX = W/2 - totalW/2;

        cards.forEach((c, i) => {
            const delay = 30 + i*8;
            const cardAlpha = Math.min(1, Math.max(0, (t - delay) / 15));
            const cx = startX + i*(cardW+cardSpacing);
            const cy = 250;
            ctx.save(); ctx.globalAlpha = statsAlpha * cardAlpha;
            ctx.fillStyle = "rgba(255,255,255,0.05)";
            ctx.strokeStyle = c.color + "55"; ctx.lineWidth = 2;
            ctx.beginPath(); ctx.roundRect(cx, cy, cardW, cardH, 8); ctx.fill(); ctx.stroke();
            ctx.font = "22px sans-serif"; ctx.textAlign = "center";
            ctx.fillText(c.icon, cx+cardW/2, cy+28);
            ctx.font = "bold 22px Oswald"; ctx.fillStyle = c.color;
            ctx.fillText(c.value, cx+cardW/2, cy+58);
            ctx.font = "bold 11px Rajdhani"; ctx.fillStyle = "rgba(255,255,255,0.4)";
            ctx.fillText(c.label, cx+cardW/2, cy+76);
            ctx.restore();
        });

        ctx.restore();
    }

    // ‚îÄ‚îÄ Level Up ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if (t > 55 && r.levelUp) {
        const luAlpha = Math.min(1, (t-55)/15);
        ctx.save(); ctx.globalAlpha = luAlpha;
        ctx.font = "italic bold 32px Oswald"; ctx.textAlign = "center";
        ctx.fillStyle = "#f1c40f";
        ctx.shadowBlur = 20; ctx.shadowColor = "#f1c40f";
        ctx.fillText("‚¨Ü LEVEL UP! Pontos de atributo +3", W/2, 375);
        ctx.shadowBlur = 0;
        ctx.restore();
    }

    // ‚îÄ‚îÄ T√≠tulo atual ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if (t > 65) {
        const titleAlpha = Math.min(1, (t-65)/15);
        ctx.save(); ctx.globalAlpha = titleAlpha;
        const title = getPlayerTitle();
        ctx.font = "bold 18px Rajdhani"; ctx.textAlign = "center";
        ctx.fillStyle = "rgba(255,255,255,0.4)";
        ctx.fillText("PATENTE:", W/2, 405);
        ctx.font = "italic bold 26px Oswald";
        ctx.fillStyle = title.color;
        ctx.shadowBlur = 12; ctx.shadowColor = title.color;
        ctx.fillText(`[ ${title.name.toUpperCase()} ]`, W/2, 430);
        ctx.shadowBlur = 0;
        ctx.restore();
    }

    // ‚îÄ‚îÄ Novas Conquistas ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if (t > 75 && r.newAchievs.length > 0) {
        r.newAchievs.slice(0,3).forEach((a, i) => {
            const delay = 75 + i*18;
            const aAlpha = Math.min(1, Math.max(0, (t-delay)/15));
            ctx.save(); ctx.globalAlpha = aAlpha;
            const aW = 340, aH = 38;
            const ax = W/2 - aW/2;
            const ay = 455 + i*48;
            ctx.fillStyle = "rgba(241,196,15,0.1)";
            ctx.strokeStyle = "#f1c40f88"; ctx.lineWidth = 1.5;
            ctx.beginPath(); ctx.roundRect(ax, ay, aW, aH, 6); ctx.fill(); ctx.stroke();
            ctx.font = "bold 15px Rajdhani"; ctx.textAlign = "left";
            ctx.fillStyle = "#f1c40f";
            ctx.fillText(`${a.icon}  CONQUISTA: ${a.name}`, ax+12, ay+24);
            ctx.restore();
        });
    }

    // ‚îÄ‚îÄ Bot√£o continuar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if (t > 60) {
        const btnAlpha = Math.min(1, (t-60)/20);
        const pulse = 0.85 + Math.sin(t*0.08)*0.15;
        ctx.save(); ctx.globalAlpha = btnAlpha * pulse;
        const btnW2 = 280, btnH2 = 52;
        const btnX = W/2 - btnW2/2, btnY = H - 80;
        const btnCol = won ? "#00cc66" : "#cc3300";
        ctx.fillStyle = btnCol + "33";
        ctx.strokeStyle = btnCol; ctx.lineWidth = 2;
        ctx.beginPath(); ctx.roundRect(btnX, btnY, btnW2, btnH2, 8); ctx.fill(); ctx.stroke();
        ctx.font = "italic bold 22px Oswald"; ctx.textAlign = "center";
        ctx.fillStyle = "#fff";
        ctx.shadowBlur = 10; ctx.shadowColor = btnCol;
        ctx.fillText("‚ñ∂  CONTINUAR", W/2, btnY + 33);
        ctx.shadowBlur = 0;
        ctx.restore();
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ñ∂  ECR√É DE CONQUISTAS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function drawAchievements() {
    const W = canvas.width, H = canvas.height;

    // Fundo quente
    let bgGrad = ctx.createRadialGradient(W/2, H/2, 50, W/2, H/2, 700);
    bgGrad.addColorStop(0, "#0a0500"); bgGrad.addColorStop(1, "#020100");
    ctx.fillStyle = bgGrad; ctx.fillRect(0,0,W,H);

    // Grade sutil dourada
    ctx.strokeStyle = "rgba(245,197,24,0.02)"; ctx.lineWidth = 1;
    for(let i=0; i<W; i+=50) { ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,H); ctx.stroke(); }
    for(let i=0; i<H; i+=50) { ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(W,i); ctx.stroke(); }

    const unlocked = (player.achievements||[]).length;
    const total = ACHIEVEMENTS_DEF.length;

    // === HEADER FIXO ===
    let hdrBg = ctx.createLinearGradient(0,0,0,118);
    hdrBg.addColorStop(0,"rgba(5,2,0,0.99)"); hdrBg.addColorStop(1,"rgba(5,2,0,0.88)");
    ctx.fillStyle = hdrBg; ctx.fillRect(0,0,W,118);

    // T√≠tulo
    ctx.font = "italic bold 48px Bangers"; ctx.textAlign = "center";
    ctx.fillStyle = "#f5c518"; ctx.shadowBlur = 20; ctx.shadowColor = "#ff8c00";
    ctx.fillText("üèÜ  CONQUISTAS", W/2, 56);
    ctx.shadowBlur = 0;

    // Subt√≠tulo e progresso
    ctx.font = "bold 14px Rajdhani"; ctx.fillStyle = "rgba(255,255,255,0.4)";
    ctx.fillText(`${unlocked} / ${total} desbloqueadas`, W/2, 74);

    // Barra de progresso
    const barW = 460, barH = 8, barX = W/2 - barW/2;
    ctx.fillStyle = "rgba(255,255,255,0.07)";
    ctx.beginPath(); ctx.roundRect(barX, 84, barW, barH, 4); ctx.fill();
    if(unlocked > 0) {
        const pGrad = ctx.createLinearGradient(barX, 0, barX+barW, 0);
        pGrad.addColorStop(0, "#c06000"); pGrad.addColorStop(1, "#f5c518");
        ctx.fillStyle = pGrad;
        ctx.shadowBlur = 8; ctx.shadowColor = "#f5c518";
        ctx.beginPath(); ctx.roundRect(barX, 84, barW*(unlocked/total), barH, 4); ctx.fill();
        ctx.shadowBlur = 0;
    }

    // T√≠tulo (patente)
    const titleData = getPlayerTitle();
    ctx.font = "italic bold 16px Oswald"; ctx.fillStyle = titleData.color;
    ctx.shadowBlur = 8; ctx.shadowColor = titleData.color;
    ctx.fillText(`[ ${titleData.name.toUpperCase()} ]`, W/2, 108);
    ctx.shadowBlur = 0;

    ctx.fillStyle = "rgba(245,197,24,0.2)"; ctx.fillRect(0, 116, W, 1);

    // === √ÅREA ROL√ÅVEL ===
    const scrollTop = 118;
    const scrollH = H - scrollTop - 60; // 60px para bot√£o voltar

    const cols = 3, cardW = 300, cardH = 88, gapX = 20, gapY = 12;
    const gridW = cols * cardW + (cols-1)*gapX;
    const startX = W/2 - gridW/2;
    const rows = Math.ceil(total / cols);
    const contentH = rows * (cardH + gapY) + 20;

    let maxAS = Math.min(0, scrollH - contentH - 12);
    targetAchScrollY = Math.max(maxAS, Math.min(0, targetAchScrollY));

    ctx.save();
    ctx.beginPath(); ctx.rect(0, scrollTop, W, scrollH); ctx.clip();

    ACHIEVEMENTS_DEF.forEach((a, i) => {
        const col = i % cols;
        const row = Math.floor(i / cols);
        const cx = startX + col*(cardW+gapX);
        const cy = scrollTop + 14 + row*(cardH+gapY) + achScrollY;
        const done = (player.achievements||[]).includes(a.id);
        const inView = cy > scrollTop - cardH && cy < scrollTop + scrollH + cardH;
        if(!inView) return;

        ctx.save();

        // Fundo do card
        let cGrad = ctx.createLinearGradient(cx, cy, cx, cy+cardH);
        if(done) {
            cGrad.addColorStop(0, "rgba(245,197,24,0.12)");
            cGrad.addColorStop(1, "rgba(100,60,0,0.85)");
        } else {
            cGrad.addColorStop(0, "rgba(10,8,5,0.95)");
            cGrad.addColorStop(1, "rgba(4,3,2,0.98)");
        }
        ctx.globalAlpha = done ? 1 : 0.4;
        ctx.fillStyle = cGrad;
        ctx.strokeStyle = done ? "rgba(245,197,24,0.5)" : "rgba(255,255,255,0.07)";
        ctx.lineWidth = done ? 1.5 : 1;
        ctx.shadowBlur = done ? 10 : 0; ctx.shadowColor = "#f5c518";
        ctx.beginPath(); ctx.roundRect(cx, cy, cardW, cardH, 7); ctx.fill(); ctx.stroke();
        ctx.shadowBlur = 0;

        // Linha de acento topo
        if(done) {
            let topAcc = ctx.createLinearGradient(cx, 0, cx+cardW, 0);
            topAcc.addColorStop(0, "transparent"); topAcc.addColorStop(0.5, "#f5c518"); topAcc.addColorStop(1, "transparent");
            ctx.fillStyle = topAcc; ctx.fillRect(cx+8, cy, cardW-16, 2);
        }

        // √çcone
        ctx.globalAlpha = done ? 1 : 0.3;
        ctx.font = "28px sans-serif"; ctx.textAlign = "left";
        ctx.fillText(a.icon, cx+14, cy+38);

        // Nome
        ctx.font = `bold ${done?"16":"14"}px Rajdhani`;
        ctx.fillStyle = done ? "#fff" : "rgba(255,255,255,0.35)";
        ctx.fillText(a.name, cx+54, cy+28);

        // Descri√ß√£o
        ctx.font = "12px Rajdhani";
        ctx.fillStyle = done ? "rgba(255,255,255,0.55)" : "rgba(255,255,255,0.2)";
        ctx.fillText(a.desc, cx+54, cy+46);

        // Badge conclu√≠do / bloqueado
        if (done) {
            ctx.font = "bold 11px Rajdhani"; ctx.fillStyle = "#f5c518";
            ctx.shadowBlur = 6; ctx.shadowColor = "#f5c518";
            ctx.textAlign = "right";
            ctx.fillText("‚úî CONCLU√çDO", cx+cardW-12, cy+cardH-10);
            ctx.shadowBlur = 0;
        } else {
            ctx.font = "bold 11px Rajdhani"; ctx.fillStyle = "rgba(255,255,255,0.15)";
            ctx.textAlign = "right";
            ctx.fillText("üîí BLOQUEADA", cx+cardW-12, cy+cardH-10);
        }

        ctx.restore();
    });

    ctx.restore();

    // Scrollbar
    if(contentH > scrollH) {
        drawScrollbar(W - 12, scrollTop, scrollH, achScrollY, maxAS);
    }

    // === RODAP√â FIXO ===
    let footBg = ctx.createLinearGradient(0, H-62, 0, H);
    footBg.addColorStop(0,"rgba(5,2,0,0.0)"); footBg.addColorStop(0.35,"rgba(5,2,0,0.97)");
    ctx.fillStyle = footBg; ctx.fillRect(0, H-62, W, 62);

    drawSparkBtn(W/2 - 120, H - 54, 240, 44, "‚óÄ  VOLTAR AO MENU", UI_COLORS.danger);
}

function finalizeBattle() {
    if(selectedEnemyChar.hp <= 0) {
        playSound(400, 'sine', 0.2); setTimeout(()=>playSound(600, 'sine', 0.2), 200); setTimeout(()=>playSound(800, 'sine', 0.4), 400);
        
        let reward = isSurvivalMode ? 200 * survivalWave : (isStoryMode && STORY_SEQUENCE[currentMissionPlaying] ? (STORY_SEQUENCE[currentMissionPlaying].zeniReward || 800) : 800);
        let expReward = isSurvivalMode ? 30 * survivalWave : (isStoryMode && STORY_SEQUENCE[currentMissionPlaying] ? (STORY_SEQUENCE[currentMissionPlaying].expReward || 50) : 50);
        player.zeni += reward; player.exp += expReward;
        
        if(isStoryMode && currentMissionPlaying === player.storyProgress) { player.storyProgress++; }

        // Drop de Esfera do Drag√£o no modo hist√≥ria (30% de chance, m√°x 7)
        if(isStoryMode) {
            const dbNow = player.inventory["dragonballs"] || 0;
            if(dbNow < 7 && Math.random() < 0.30) {
                player.inventory["dragonballs"] = dbNow + 1;
                showMessage("‚≠ï ESFERA DO DRAG√ÉO ENCONTRADA! (" + (dbNow+1) + "/7)");
                playSound(900, 'sine', 0.3);
            }
        }

        let levelUp = false;
        while(player.exp >= player.expToNext) { 
            player.level++;
            player.exp -= player.expToNext; 
            player.expToNext = Math.floor(player.expToNext * 1.5); 
            player.statPoints += 3; 
            levelUp = true; 
        }
        
        // Atualizar progresso de miss√µes di√°rias
        if(window.updateDailyMissionProgress) {
            const enemyOriginalKey = selectedEnemyChar.originalKey || selectedEnemyChar.currentSkin;
            window.updateDailyMissionProgress({ type: "battle_win", enemy: enemyOriginalKey });
            window.updateDailyMissionProgress({ type: "earn_zeni", amount: reward });
            if(isStoryMode) window.updateDailyMissionProgress({ type: "story_win", missionIndex: currentMissionPlaying });
        }
        
        if(isSurvivalMode) {
            if (survivalWave > (player.maxSurvivalWave || 0)) {
                player.maxSurvivalWave = survivalWave;
            }
            if(window.updateDailyMissionProgress) window.updateDailyMissionProgress({ type: "survival_wave" });
            player.victories = (player.victories || 0) + 1;
            showBattleResult(true, reward, expReward, levelUp, selectedEnemyChar.name || selectedEnemyChar.originalKey, "SURVIVAL");
            // Depois do ecr√£ de resultado, continuar sobreviv√™ncia
            battleResult._survivalContinue = true;
            return;
        } else {
            player.victories = (player.victories || 0) + 1;
            const modeStrW = isStoryMode ? 'HISTORIA' : 'LIVRE';
            if(window.saveBattleHistory) window.saveBattleHistory('WIN', selectedEnemyChar.name || selectedEnemyChar.originalKey, modeStrW);
            showBattleResult(true, reward, expReward, levelUp, selectedEnemyChar.name || selectedEnemyChar.originalKey, modeStrW);
        }
    } else {
        playSound(200, 'sawtooth', 0.6, 0.1); setTimeout(()=>playSound(150, 'sawtooth', 0.8, 0.1), 300);
        player.defeats = (player.defeats || 0) + 1;
        const modeStrL = isSurvivalMode ? 'SURVIVAL' : (isStoryMode ? 'HISTORIA' : 'LIVRE');
        if(window.saveBattleHistory) window.saveBattleHistory('LOSS', selectedEnemyChar.name || selectedEnemyChar.originalKey, modeStrL);
        showBattleResult(false, 0, 0, false, selectedEnemyChar.name || selectedEnemyChar.originalKey, modeStrL);
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ñ∂  SISTEMA SHENLONG ‚Äî Invocar o Drag√£o com 7 Esferas
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const shenlong_img = new Image();
shenlong_img.src = "Personagens/Shenlong.png";

function drawSummon() {
    const W = canvas.width, H = canvas.height;

    // Fundo m√≠stico
    let bg = ctx.createRadialGradient(W/2, H*0.4, 20, W/2, H/2, 700);
    bg.addColorStop(0, "#001a00");
    bg.addColorStop(0.5, "#000d00");
    bg.addColorStop(1, "#000000");
    ctx.fillStyle = bg; ctx.fillRect(0, 0, W, H);

    // Raios de energia verdes
    ctx.save();
    for(let i = 0; i < 12; i++) {
        const angle = (i / 12) * Math.PI * 2 + timeEnv * 0.3;
        const alpha = 0.04 + 0.03 * Math.abs(Math.sin(timeEnv + i));
        ctx.strokeStyle = `rgba(0,255,80,${alpha})`;
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(W/2, H*0.35);
        ctx.lineTo(W/2 + Math.cos(angle)*700, H*0.35 + Math.sin(angle)*700);
        ctx.stroke();
    }
    ctx.restore();

    // T√≠tulo
    ctx.save();
    ctx.shadowBlur = 30; ctx.shadowColor = "#00ff50";
    ctx.fillStyle = "#00ff80";
    ctx.font = "bold 28px Rajdhani";
    ctx.textAlign = "center";
    ctx.fillText("üêâ  INVOCAR SHENLONG", W/2, 42);
    ctx.shadowBlur = 0;
    ctx.restore();

    // Sprite do Shenlong
    const shH = 220, shW = shH * 1;
    if(shenlong_img.complete && shenlong_img.naturalWidth > 0) {
        ctx.save();
        ctx.shadowBlur = 40; ctx.shadowColor = "#00ff60";
        ctx.drawImage(shenlong_img, W/2 - shW/2, 55 + Math.sin(timeEnv*9)*6, shW, shH);
        ctx.shadowBlur = 0;
        ctx.restore();
    } else {
        ctx.fillStyle = "rgba(0,255,80,0.15)";
        ctx.fillRect(W/2 - shW/2, 55, shW, shH);
        ctx.fillStyle = "#00ff80"; ctx.font = "bold 48px Rajdhani"; ctx.textAlign = "center";
        ctx.fillText("üêâ", W/2, 55 + shH/2 + 15);
    }

    // Esferas do drag√£o (contagem)
    const dbCount = player.inventory["dragonballs"] || 0;
    ctx.save();
    for(let i = 0; i < 7; i++) {
        const ox = W/2 - 7*22/2 + i*22 + 11;
        const oy = 285;
        ctx.shadowBlur = i < dbCount ? 12 : 0;
        ctx.shadowColor = "#f39c12";
        ctx.beginPath();
        ctx.arc(ox, oy, 8, 0, Math.PI*2);
        ctx.fillStyle = i < dbCount ? "#f39c12" : "#333";
        ctx.fill();
        ctx.strokeStyle = i < dbCount ? "#fff8dc" : "#555";
        ctx.lineWidth = 1.5; ctx.stroke();
    }
    ctx.shadowBlur = 0;
    ctx.restore();

    // Separador
    ctx.strokeStyle = "rgba(0,255,80,0.3)"; ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(W*0.1, 300); ctx.lineTo(W*0.9, 300); ctx.stroke();

    // Fases
    if(summonPhase === "MAIN") {
        // T√≠tulo desejos
        ctx.fillStyle = "rgba(0,255,80,0.7)"; ctx.font = "bold 14px Rajdhani";
        ctx.textAlign = "center";
        ctx.fillText("FA√áA SEU DESEJO...", W/2, 322);

        const wishes = [
            { icon: "‚ö°", label: "DESBLOQUEAR PERSONAGEM", sub: "Obtenha qualquer guerreiro da loja" },
            { icon: "üí∞", label: "RECEBER 100.000 ZENI", sub: "Riqueza instant√¢nea" },
            { icon: "üéÅ", label: "OBTER UM ITEM", sub: "Qualquer item do jogo" },
            { icon: "üëë", label: "PODER DOS DEUSES", sub: "Desbloquear guerreiros divinos" }
        ];

        const btnW = W*0.72, btnH = 52, btnX = W*0.14, startY = 334;
        wishes.forEach((w, i) => {
            const by = startY + i * (btnH + 10);
            const hov = mouse.x > btnX && mouse.x < btnX+btnW && mouse.y > by && mouse.y < by+btnH;
            ctx.save();
            if(hov) { ctx.shadowBlur = 18; ctx.shadowColor = "#00ff80"; }
            ctx.fillStyle = hov ? "rgba(0,255,80,0.25)" : "rgba(0,100,20,0.35)";
            ctx.strokeStyle = hov ? "#00ff80" : "rgba(0,200,60,0.4)";
            ctx.lineWidth = 1.5;
            ctx.beginPath(); ctx.roundRect(btnX, by, btnW, btnH, 8); ctx.fill(); ctx.stroke();
            ctx.shadowBlur = 0;
            ctx.fillStyle = hov ? "#00ff80" : "#7fffaa";
            ctx.font = "bold 15px Rajdhani"; ctx.textAlign = "left";
            ctx.fillText(w.icon + "  " + w.label, btnX + 16, by + 21);
            ctx.fillStyle = "rgba(180,255,200,0.55)"; ctx.font = "12px Rajdhani";
            ctx.fillText(w.sub, btnX + 32, by + 38);
            ctx.restore();
        });

        // Bot√£o voltar
        const bx = W/2-70, bby = startY + 4*(btnH+10) + 8;
        const bhov = mouse.x > bx && mouse.x < bx+140 && mouse.y > bby && mouse.y < bby+36;
        ctx.fillStyle = bhov ? "rgba(255,80,80,0.3)" : "rgba(100,0,0,0.4)";
        ctx.strokeStyle = bhov ? "#ff5050" : "rgba(200,50,50,0.5)";
        ctx.lineWidth = 1;
        ctx.beginPath(); ctx.roundRect(bx, bby, 140, 36, 6); ctx.fill(); ctx.stroke();
        ctx.fillStyle = bhov ? "#ff8080" : "#ff5050"; ctx.font = "bold 14px Rajdhani"; ctx.textAlign = "center";
        ctx.fillText("‚Üê VOLTAR", W/2, bby + 23);

    } else if(summonPhase === "WISH1" || summonPhase === "WISH3") {
        // Scroll grid de personagens ou itens
        const isChars = summonPhase === "WISH1";
        const title = isChars ? "ESCOLHA UM PERSONAGEM PARA DESBLOQUEAR:" : "ESCOLHA UM ITEM:";
        ctx.fillStyle = "#7fffaa"; ctx.font = "bold 14px Rajdhani"; ctx.textAlign = "center";
        ctx.fillText(title, W/2, 318);

        let keys;
        if(isChars) {
            keys = Object.keys(charactersDB).filter(k => {
                const c = charactersDB[k];
                return !c.isTransformation && !c.isCostume && !c.hidden &&
                       c.price !== undefined && !player.unlockedChars.includes(k);
            });
        } else {
            keys = Object.keys(itemsDB).filter(k => !itemsDB[k].storyOnly);
        }

        const cols = 4, cardW = 110, cardH = 90, gapX = 14, gapY = 12;
        const totalW = cols*(cardW+gapX)-gapX;
        const startX = W/2 - totalW/2;
        const gridTop = 330, gridH = H - 330 - 90;

        ctx.save();
        ctx.beginPath(); ctx.rect(0, gridTop, W, gridH); ctx.clip();

        const scrollY = isChars ? summonWishCharScrollY : summonWishItemScrollY;
        keys.forEach((k, i) => {
            const col = i % cols, row = Math.floor(i / cols);
            const cx = startX + col*(cardW+gapX);
            const cy = gridTop + row*(cardH+gapY) + scrollY;
            if(cy + cardH < gridTop || cy > gridTop + gridH) return;

            const db = isChars ? charactersDB : itemsDB;
            const img = images[k];
            const hov = mouse.x > cx && mouse.x < cx+cardW && mouse.y > cy && mouse.y < cy+cardH;

            ctx.fillStyle = hov ? "rgba(0,255,80,0.2)" : "rgba(0,60,10,0.5)";
            ctx.strokeStyle = hov ? "#00ff80" : "rgba(0,200,60,0.3)";
            ctx.lineWidth = 1.5;
            ctx.beginPath(); ctx.roundRect(cx, cy, cardW, cardH, 6); ctx.fill(); ctx.stroke();

            if(img && img.complete && img.naturalWidth > 0) {
                const imgSize = 55;
                ctx.drawImage(img, cx + cardW/2 - imgSize/2, cy + 4, imgSize, imgSize);
            }

            ctx.fillStyle = hov ? "#00ff80" : "#aaffcc";
            ctx.font = "bold 10px Rajdhani"; ctx.textAlign = "center";
            const name = isChars ? (db[k].name || k) : (db[k].name || k);
            ctx.fillText(name.substring(0,16), cx + cardW/2, cy + cardH - 8);
        });
        ctx.restore();

        // Bot√£o cancelar
        const bx = W/2-70, bby = H - 72;
        const bhov = mouse.x > bx && mouse.x < bx+140 && mouse.y > bby && mouse.y < bby+36;
        ctx.fillStyle = bhov ? "rgba(255,80,80,0.3)" : "rgba(100,0,0,0.4)";
        ctx.strokeStyle = bhov ? "#ff5050" : "rgba(200,50,50,0.5)";
        ctx.lineWidth = 1;
        ctx.beginPath(); ctx.roundRect(bx, bby, 140, 36, 6); ctx.fill(); ctx.stroke();
        ctx.fillStyle = bhov ? "#ff8080" : "#ff5050"; ctx.font = "bold 14px Rajdhani"; ctx.textAlign = "center";
        ctx.fillText("‚Üê CANCELAR", W/2, bby + 23);

    } else if(summonPhase === "DONE") {
        ctx.save();
        ctx.shadowBlur = 40; ctx.shadowColor = "#f39c12";
        ctx.fillStyle = "#f5c518"; ctx.font = "bold 32px Rajdhani"; ctx.textAlign = "center";
        ctx.fillText("‚ú® DESEJO CONCEDIDO! ‚ú®", W/2, H/2);
        ctx.shadowBlur = 0;
        ctx.fillStyle = "rgba(255,255,255,0.6)"; ctx.font = "bold 14px Rajdhani";
        ctx.fillText("Clique para continuar", W/2, H/2 + 40);
        ctx.restore();
    }
}

function handleSummonInput() {
    const W = canvas.width, H = canvas.height;

    if(summonPhase === "DONE") {
        currentState = STATES.MENU;
        summonPhase = "MAIN";
        return;
    }

    if(summonPhase === "MAIN") {
        const btnW = W*0.72, btnH = 52, btnX = W*0.14, startY = 334;

        // Desejos 1-4
        for(let i = 0; i < 4; i++) {
            const by = startY + i*(btnH+10);
            if(mouse.x > btnX && mouse.x < btnX+btnW && mouse.y > by && mouse.y < by+btnH) {
                playSound(900, 'sine', 0.3);
                if(i === 0) { summonPhase = "WISH1"; }
                else if(i === 1) {
                    // 100k Zeni
                    player.inventory["dragonballs"] = 0;
                    player.zeni += 100000;
                    save(); summonPhase = "DONE";
                    playSound(1200, 'sine', 0.4);
                }
                else if(i === 2) { summonPhase = "WISH3"; }
                else if(i === 3) {
                    // Desbloquear deuses
                    const godChars = ["GokuDBSGod", "GokuDBS(BROLY)God", "VegetaDBSGod", "VegetaDBS(BROLY)God"];
                    godChars.forEach(g => {
                        if(charactersDB[g] && !player.unlockedChars.includes(g)) {
                            player.unlockedChars.push(g);
                        }
                    });
                    player.inventory["dragonballs"] = 0;
                    save(); summonPhase = "DONE";
                    playSound(1200, 'sine', 0.5);
                }
                return;
            }
        }

        // Bot√£o voltar
        const bx = W/2-70, bby = startY + 4*(btnH+10) + 8;
        if(mouse.x > bx && mouse.x < bx+140 && mouse.y > bby && mouse.y < bby+36) {
            currentState = STATES.MENU; summonPhase = "MAIN";
            playSound(300, 'triangle', 0.1);
        }
        return;
    }

    if(summonPhase === "WISH1" || summonPhase === "WISH3") {
        const isChars = summonPhase === "WISH1";
        let keys;
        if(isChars) {
            keys = Object.keys(charactersDB).filter(k => {
                const c = charactersDB[k];
                return !c.isTransformation && !c.isCostume && !c.hidden &&
                       c.price !== undefined && !player.unlockedChars.includes(k);
            });
        } else {
            keys = Object.keys(itemsDB).filter(k => !itemsDB[k].storyOnly);
        }

        const cols = 4, cardW = 110, cardH = 90, gapX = 14, gapY = 12;
        const totalW = cols*(cardW+gapX)-gapX;
        const startX = W/2 - totalW/2;
        const gridTop = 330;
        const scrollY = isChars ? summonWishCharScrollY : summonWishItemScrollY;

        keys.forEach((k, i) => {
            const col = i % cols, row = Math.floor(i / cols);
            const cx = startX + col*(cardW+gapX);
            const cy = gridTop + row*(cardH+gapY) + scrollY;
            if(mouse.x > cx && mouse.x < cx+cardW && mouse.y > cy && mouse.y < cy+cardH) {
                playSound(1200, 'sine', 0.4);
                if(isChars) {
                    if(!player.unlockedChars.includes(k)) player.unlockedChars.push(k);
                    showMessage("PERSONAGEM DESBLOQUEADO: " + (charactersDB[k].name || k));
                } else {
                    player.inventory[k] = (player.inventory[k] || 0) + 1;
                    showMessage("ITEM OBTIDO: " + (itemsDB[k].name || k));
                }
                player.inventory["dragonballs"] = 0;
                save(); summonPhase = "DONE";
            }
        });

        // Bot√£o cancelar
        const bx = W/2-70, bby = H - 72;
        if(mouse.x > bx && mouse.x < bx+140 && mouse.y > bby && mouse.y < bby+36) {
            summonPhase = "MAIN"; playSound(300, 'triangle', 0.1);
        }
        return;
    }
}


canvas.addEventListener('mousemove', e => updatePointer(e.clientX, e.clientY));

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ñ∂  SISTEMA DE SCROLL POR TOQUE ‚Äî com in√©rcia e escalonamento
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let touch_startY      = 0;   // posi√ß√£o Y no in√≠cio do toque (coords canvas)
let touch_lastY       = 0;   // posi√ß√£o Y no frame anterior (coords canvas)
let touch_velocity    = 0;   // velocidade em px/frame (coords canvas)
let touch_isScrolling = false; // true se o dedo se moveu o suficiente
let touch_inertiaId   = null;  // rAF id da in√©rcia

// Converte delta em pixels de tela ‚Üí pixels de canvas (s√≥ eixo Y)
function touch_screenToCanvasY(dyScreen) {
    const r = canvas.getBoundingClientRect();
    return dyScreen * (canvas.height / r.height);
}

// Aplica delta ao scroll da tela atual
function touch_applyScroll(dyCanvas) {
    if (currentState === STATES.SHOP) {
        targetShopScrollY += dyCanvas;
    } else if (currentState === STATES.CHAR_SELECT && !subMenuPhase) {
        targetCharScrollY += dyCanvas;
    } else if (currentState === STATES.STORY_MENU) {
        targetStoryScrollY += dyCanvas;
    } else if (currentState === STATES.RANKING) {
        targetRankingScrollY += dyCanvas;
    } else if (currentState === STATES.DAILY_REWARD) {
        targetDailyRewardScrollY += dyCanvas;
    } else if (currentState === STATES.ACHIEVEMENTS) {
        targetAchScrollY += dyCanvas;
    } else if (currentState === STATES.SUMMON) {
        if (summonPhase === "WISH1")      summonWishCharScrollY += dyCanvas;
        else if (summonPhase === "WISH3") summonWishItemScrollY += dyCanvas;
    }
}

// Estados que t√™m scroll
const SCROLL_STATES = new Set([
    STATES.SHOP, STATES.CHAR_SELECT, STATES.STORY_MENU,
    STATES.RANKING, STATES.DAILY_REWARD, STATES.ACHIEVEMENTS, STATES.SUMMON
]);

// In√©rcia: continua rolando ap√≥s soltar o dedo
function touch_startInertia() {
    if (touch_inertiaId) cancelAnimationFrame(touch_inertiaId);
    function step() {
        if (Math.abs(touch_velocity) < 0.5) { touch_velocity = 0; return; }
        touch_applyScroll(touch_velocity);
        touch_velocity *= 0.88; // fric√ß√£o
        touch_inertiaId = requestAnimationFrame(step);
    }
    touch_inertiaId = requestAnimationFrame(step);
}

canvas.addEventListener('touchstart', (e) => {
    e.preventDefault();
    if (e.touches.length > 0) {
        const t = e.touches[0];
        // Cancela in√©rcia ao tocar novamente
        if (touch_inertiaId) { cancelAnimationFrame(touch_inertiaId); touch_inertiaId = null; }
        touch_velocity    = 0;
        touch_isScrolling = false;
        touch_startY      = touch_screenToCanvasY(t.clientY);
        touch_lastY       = touch_startY;
        updatePointer(t.clientX, t.clientY);
    }
}, { passive: false });

canvas.addEventListener('touchmove', (e) => {
    e.preventDefault();
    if (e.touches.length > 0) {
        const t = e.touches[0];
        updatePointer(t.clientX, t.clientY);

        if (SCROLL_STATES.has(currentState)) {
            const currentY = touch_screenToCanvasY(t.clientY);
            const dy       = currentY - touch_lastY;
            touch_velocity = dy; // guarda para in√©rcia
            touch_applyScroll(dy);
            // Considera scroll se moveu mais de 6px no canvas
            if (Math.abs(currentY - touch_startY) > 6) touch_isScrolling = true;
            touch_lastY = currentY;
        }
    }
}, { passive: false });

canvas.addEventListener('touchend', (e) => {
    e.preventDefault();
    if (touch_isScrolling && SCROLL_STATES.has(currentState)) {
        // Lan√ßa in√©rcia apenas se havia velocidade
        if (Math.abs(touch_velocity) > 2) touch_startInertia();
    } else {
        // Tap limpo ‚Üí dispara clique
        handleInput();
    }
    touch_isScrolling = false;
}, { passive: false });

if (!CanvasRenderingContext2D.prototype.roundRect) {
    CanvasRenderingContext2D.prototype.roundRect = function (x, y, w, h, r) {
        if (typeof r === 'number') r = [r, r, r, r];
        this.beginPath(); this.moveTo(x + r[0], y); this.arcTo(x + w, y, x + w, y + h, r[1]); this.arcTo(x + w, y + h, x, y + h, r[2]);
        this.arcTo(x, y + h, x, y, r[3]); this.arcTo(x, y, x + w, y, r[0]); this.closePath(); return this;
    };
}
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ñ∂  SISTEMA DE MISS√ïES DI√ÅRIAS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getDailyMissionsData() {
    const today = new Date().toDateString();
    if (!player.dailyMissions) player.dailyMissions = { date: "", missions: [], progress: [] };
    
    // Resetar se mudou o dia
    if (player.dailyMissions.date !== today) {
        player.dailyMissions = {
            date: today,
            missions: generateDailyMissionSet(),
            progress: [0, 0, 0]
        };
        save();
    }
    return player.dailyMissions;
}

function generateDailyMissionSet() {
    // Semente baseada na data para miss√µes consistentes no dia
    const dateStr = new Date().toDateString();
    let seed = dateStr.split('').reduce((a,c) => a + c.charCodeAt(0), 0);
    const rng = (n) => { seed = (seed * 1664525 + 1013904223) & 0xFFFFFFFF; return Math.abs(seed) % n; };
    
    // Tipos de miss√£o dispon√≠veis
    const missionTypes = [
        { type: "beat_char", gen: () => {
            let eligibles = Object.keys(charactersDB).filter(k => !charactersDB[k].isCostume && !charactersDB[k].isTransformation);
            let picked = eligibles[rng(eligibles.length)];
            let char = charactersDB[picked];
            return {
                type: "beat_char",
                enemy: picked,
                label: `Derrotar ${char.name}`,
                desc: `Ven√ßa uma batalha contra ${char.name} em qualquer modo.`,
                icon: "‚öî",
                color: "#e74c3c",
                target: 1,
                zeniReward: 800 + rng(700),
                expReward: 60 + rng(50)
            };
        }},
        { type: "survival_waves", gen: () => {
            let waves = 3 + rng(5);
            return {
                type: "survival_waves",
                label: `Sobreviver ${waves} ondas`,
                desc: `Complete ${waves} ondas consecutivas no modo Sobreviv√™ncia.`,
                icon: "üåä",
                color: "#e67e22",
                target: waves,
                zeniReward: 600 + waves * 200,
                expReward: 40 + waves * 15
            };
        }},
        { type: "earn_zeni", gen: () => {
            let amount = (2 + rng(4)) * 500;
            return {
                type: "earn_zeni",
                label: `Ganhar ${amount} ZENI`,
                desc: `Acumule ${amount} ZENI em recompensas de batalha hoje.`,
                icon: "üí∞",
                color: "#f1c40f",
                target: amount,
                zeniReward: Math.floor(amount * 0.5),
                expReward: 50 + rng(40),
                sessionEarned: 0
            };
        }},
        { type: "win_battles", gen: () => {
            let wins = 2 + rng(4);
            return {
                type: "win_battles",
                label: `Vencer ${wins} batalhas`,
                desc: `Ven√ßa ${wins} batalhas em qualquer modo.`,
                icon: "üèÜ",
                color: "#9b59b6",
                target: wins,
                zeniReward: 500 + wins * 150,
                expReward: 35 + wins * 12
            };
        }},
        { type: "story_mission", gen: () => {
            let available = Math.min(player.storyProgress + 1, STORY_SEQUENCE.length);
            if(available === 0) available = 1;
            let idx = rng(available);
            let m = STORY_SEQUENCE[idx];
            let char = charactersDB[m.enemy];
            return {
                type: "story_mission",
                missionIndex: idx,
                enemy: m.enemy,
                label: `Completar Miss√£o #${idx+1}`,
                desc: `Complete a miss√£o #${idx+1} do Modo Hist√≥ria (${char ? char.name : m.enemy}).`,
                icon: "üìñ",
                color: "#2ecc71",
                target: 1,
                zeniReward: (m.zeniReward||800) * 1.5 | 0,
                expReward: (m.expReward||50) * 2 | 0
            };
        }}
    ];
    
    // Gerar 3 miss√µes √∫nicas de tipos diferentes
    let missions = [];
    let usedTypes = new Set();
    let attempts = 0;
    while(missions.length < 3 && attempts < 20) {
        let typeData = missionTypes[rng(missionTypes.length)];
        if(!usedTypes.has(typeData.type)) {
            usedTypes.add(typeData.type);
            missions.push(typeData.gen());
        }
        attempts++;
    }
    // Completar com miss√µes de qualquer tipo se necess√°rio
    while(missions.length < 3) {
        missions.push(missionTypes[missions.length % missionTypes.length].gen());
    }
    return missions;
}

// Chamado ap√≥s vit√≥ria para atualizar progresso das miss√µes di√°rias
function updateDailyMissionProgress(context) {
    const dm = getDailyMissionsData();
    let changed = false;
    
    dm.missions.forEach((m, i) => {
        if(dm.progress[i] >= m.target) return; // j√° completa
        
        if(m.type === "beat_char" && context.type === "battle_win" && context.enemy === m.enemy) {
            dm.progress[i] = Math.min(m.target, (dm.progress[i]||0) + 1); changed = true;
        }
        if(m.type === "win_battles" && context.type === "battle_win") {
            dm.progress[i] = Math.min(m.target, (dm.progress[i]||0) + 1); changed = true;
        }
        if(m.type === "survival_waves" && context.type === "survival_wave") {
            dm.progress[i] = Math.min(m.target, (dm.progress[i]||0) + 1); changed = true;
        }
        if(m.type === "earn_zeni" && context.type === "earn_zeni") {
            dm.progress[i] = Math.min(m.target, (dm.progress[i]||0) + (context.amount||0)); changed = true;
        }
        if(m.type === "story_mission" && context.type === "story_win" && context.missionIndex === m.missionIndex) {
            dm.progress[i] = Math.min(m.target, (dm.progress[i]||0) + 1); changed = true;
        }
        
        // Verificar se completou e dar recompensa
        if(changed && dm.progress[i] >= m.target && !(dm.claimed||[])[i]) {
            if(!dm.claimed) dm.claimed = [false,false,false];
            dm.claimed[i] = true;
            player.zeni += m.zeniReward || 0;
            player.exp += m.expReward || 0;
            while(player.exp >= player.expToNext) {
                player.level++; player.exp -= player.expToNext;
                player.expToNext = Math.floor(player.expToNext * 1.5);
                player.statPoints += 3;
            }
            showMessage(`‚úì MISS√ÉO DI√ÅRIA: +${m.zeniReward}Z +${m.expReward}EXP`);
            playSound(800,'sine',0.1); setTimeout(()=>playSound(1100,'sine',0.15),200); setTimeout(()=>playSound(1400,'sine',0.2),400);
        }
    });
    
    if(changed) { player.dailyMissions = dm; save(); }
}
window.updateDailyMissionProgress = updateDailyMissionProgress;

function drawDailyMissions() {
    const W = canvas.width, H = canvas.height;
    
    // Fundo gradiente profundo
    let bg = ctx.createRadialGradient(W/2, H/2, 0, W/2, H/2, 700);
    bg.addColorStop(0, "#0a0400"); bg.addColorStop(1, "#020100");
    ctx.fillStyle = bg; ctx.fillRect(0, 0, W, H);

    // Grade hexagonal decorativa
    ctx.strokeStyle = "rgba(255,140,0,0.04)"; ctx.lineWidth = 1;
    for(let i=0; i<W; i+=60){ ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,H); ctx.stroke(); }
    for(let i=0; i<H; i+=60){ ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(W,i); ctx.stroke(); }

    // Efeito de brilho no topo
    let topGlow = ctx.createLinearGradient(0,0,0,100);
    topGlow.addColorStop(0,"rgba(255,140,0,0.12)"); topGlow.addColorStop(1,"transparent");
    ctx.fillStyle = topGlow; ctx.fillRect(0,0,W,100);

    // === CABE√áALHO ===
    ctx.save();
    ctx.font = "italic 52px Bangers"; ctx.textAlign = "center";
    ctx.shadowBlur = 30; ctx.shadowColor = "#ff8c00";
    ctx.fillStyle = "#ff6a00"; ctx.fillText("üìã MISS√ïES", W/2 + 2, 58);
    ctx.fillStyle = "#f5c518"; ctx.fillText("üìã MISS√ïES", W/2, 56);
    ctx.font = "italic 22px Bangers"; ctx.fillStyle = "rgba(245,197,24,0.7)";
    ctx.shadowBlur = 0;
    ctx.fillText("DI√ÅRIAS", W/2, 80);
    ctx.restore();

    // Linha decorativa dupla
    ctx.fillStyle = "#ff8c00"; ctx.fillRect(W/2-220, 88, 440, 2);
    ctx.fillStyle = "rgba(255,140,0,0.25)"; ctx.fillRect(W/2-180, 91, 360, 1);

    // === BARRA DE STATUS GERAL ===
    const dm = getDailyMissionsData();
    const completedCount = dm.missions.filter((_,i)=>(dm.progress||[])[i]>=(dm.missions[i]||{}).target).length;
    const totalM = dm.missions.length || 3;
    const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate()+1);

    // Painel de status
    ctx.save();
    ctx.fillStyle = "rgba(10,5,0,0.85)";
    ctx.strokeStyle = "rgba(245,197,24,0.2)"; ctx.lineWidth = 1;
    ctx.beginPath(); ctx.roundRect(W/2-320, 98, 640, 36, 4); ctx.fill(); ctx.stroke();

    // Barra de progresso geral
    const sbX = W/2-300, sbY = 107, sbW = 440, sbH = 14;
    ctx.fillStyle = "rgba(255,255,255,0.06)"; ctx.fillRect(sbX, sbY, sbW, sbH);
    const sbPct = completedCount / totalM;
    let sbGrad = ctx.createLinearGradient(sbX,0,sbX+sbW,0);
    sbGrad.addColorStop(0, "#ff6a00"); sbGrad.addColorStop(0.5, "#f5c518"); sbGrad.addColorStop(1, "#2ecc71");
    ctx.fillStyle = sbGrad;
    ctx.shadowBlur = sbPct > 0 ? 10 : 0; ctx.shadowColor = "#f5c518";
    ctx.fillRect(sbX, sbY, sbW*sbPct, sbH); ctx.shadowBlur = 0;
    // Brilho
    ctx.fillStyle = "rgba(255,255,255,0.3)"; ctx.fillRect(sbX, sbY, sbW*sbPct, 4);

    ctx.font = "bold 12px Rajdhani"; ctx.textAlign = "right"; ctx.fillStyle = "rgba(255,255,255,0.5)";
    ctx.fillText(`${completedCount}/${totalM} ¬∑ Renova: ${tomorrow.toLocaleDateString('pt-BR')}`, W/2+310, sbY+11);
    ctx.restore();

    // === CARDS DE MISS√ÉO ===
    const cardW = 308, cardH = 285, gap = 22;
    const totalW = 3 * cardW + 2 * gap;
    const startX = (W - totalW) / 2;
    const cardY = 145;

    dm.missions.forEach((m, i) => {
        const cx = startX + i * (cardW + gap);
        const prog = (dm.progress||[])[i] || 0;
        const done = prog >= m.target;
        const pct = Math.min(1, prog / m.target);

        // Extrair componentes RGB da cor da miss√£o
        const colorMap = {
            '#e74c3c':'231,76,60', '#e67e22':'230,126,34', '#f1c40f':'241,196,15',
            '#9b59b6':'155,89,182', '#2ecc71':'46,204,113', '#3498db':'52,152,219'
        };
        const rgb = colorMap[m.color] || '255,140,0';

        ctx.save();

        // Sombra profunda do card
        ctx.shadowBlur = done ? 25 : 12;
        ctx.shadowColor = done ? m.color : "rgba(0,0,0,0.8)";

        // Fundo do card com gradiente
        let cardGrad = ctx.createLinearGradient(cx, cardY, cx, cardY+cardH);
        cardGrad.addColorStop(0, done ? `rgba(${rgb},0.18)` : "rgba(8,12,20,0.96)");
        cardGrad.addColorStop(1, done ? `rgba(${rgb},0.08)` : "rgba(3,5,8,0.98)");
        ctx.fillStyle = cardGrad;
        ctx.beginPath(); ctx.roundRect(cx, cardY, cardW, cardH, 8); ctx.fill();
        ctx.shadowBlur = 0;

        // Borda colorida
        ctx.strokeStyle = done ? m.color : `rgba(${rgb},0.3)`;
        ctx.lineWidth = done ? 2 : 1;
        ctx.beginPath(); ctx.roundRect(cx, cardY, cardW, cardH, 8); ctx.stroke();

        // Linha de acento no topo
        let topLine = ctx.createLinearGradient(cx, 0, cx+cardW, 0);
        topLine.addColorStop(0, "transparent"); topLine.addColorStop(0.5, m.color); topLine.addColorStop(1, "transparent");
        ctx.fillStyle = topLine; ctx.fillRect(cx+8, cardY, cardW-16, done ? 3 : 2);

        // === √ÅREA DO √çCONE ===
        // C√≠rculo de fundo do √≠cone
        let iconGlow = ctx.createRadialGradient(cx+cardW/2, cardY+70, 0, cx+cardW/2, cardY+70, 42);
        iconGlow.addColorStop(0, `rgba(${rgb},0.25)`); iconGlow.addColorStop(1, "transparent");
        ctx.fillStyle = iconGlow; ctx.fillRect(cx+cardW/2-42, cardY+28, 84, 84);

        // C√≠rculo de borda do √≠cone
        ctx.strokeStyle = `rgba(${rgb},0.4)`; ctx.lineWidth = 1.5;
        ctx.beginPath(); ctx.arc(cx+cardW/2, cardY+70, 36, 0, Math.PI*2); ctx.stroke();

        ctx.font = "44px serif"; ctx.textAlign = "center";
        ctx.fillText(m.icon, cx + cardW/2, cardY + 84);

        // N√∫mero do progresso circular (pequeno badge)
        if(done) {
            ctx.fillStyle = m.color; ctx.shadowBlur = 12; ctx.shadowColor = m.color;
            ctx.beginPath(); ctx.arc(cx+cardW/2+30, cardY+42, 14, 0, Math.PI*2); ctx.fill();
            ctx.shadowBlur = 0;
            ctx.font = "bold 16px Rajdhani"; ctx.fillStyle = "#000";
            ctx.fillText("‚úì", cx+cardW/2+30, cardY+47);
        }

        // === T√çTULO DA MISS√ÉO ===
        ctx.shadowBlur = done ? 8 : 0; ctx.shadowColor = m.color;
        ctx.font = `bold 16px Rajdhani`; ctx.fillStyle = done ? m.color : "#e8e8e8";
        ctx.fillText(m.label.toUpperCase(), cx + cardW/2, cardY + 118);
        ctx.shadowBlur = 0;

        // === DESCRI√á√ÉO ===
        ctx.font = "13px Rajdhani"; ctx.fillStyle = "rgba(200,200,200,0.6)";
        const maxLineW = cardW - 32;
        let words = m.desc.split(' '), line = '', ly = cardY + 140;
        words.forEach(w => {
            let test = line + w + ' ';
            if(ctx.measureText(test).width > maxLineW && line !== '') {
                ctx.fillText(line.trim(), cx + cardW/2, ly); line = w + ' '; ly += 16;
            } else line = test;
        });
        ctx.fillText(line.trim(), cx + cardW/2, ly);

        // === BARRA DE PROGRESSO ===
        const barY = cardY + cardH - 90;
        const barW = cardW - 28, barH = 10;
        const barX = cx + 14;

        // Fundo da barra
        ctx.fillStyle = "rgba(255,255,255,0.06)";
        ctx.beginPath(); ctx.roundRect(barX, barY, barW, barH, 5); ctx.fill();

        // Barra preenchida
        if(pct > 0) {
            let barGrad = ctx.createLinearGradient(barX, 0, barX+barW, 0);
            barGrad.addColorStop(0, m.color + "aa"); barGrad.addColorStop(1, m.color);
            ctx.fillStyle = barGrad;
            ctx.shadowBlur = 6; ctx.shadowColor = m.color;
            ctx.beginPath(); ctx.roundRect(barX, barY, barW*pct, barH, 5); ctx.fill();
            ctx.shadowBlur = 0;
            // Brilho interno
            ctx.fillStyle = "rgba(255,255,255,0.3)";
            ctx.beginPath(); ctx.roundRect(barX, barY, barW*pct, 3, 3); ctx.fill();
        }

        // Texto de progresso
        ctx.font = `bold 13px Rajdhani`;
        ctx.fillStyle = done ? m.color : "rgba(255,255,255,0.7)";
        ctx.fillText(done ? "‚úì MISS√ÉO CONCLU√çDA" : `${prog} / ${m.target}`, cx + cardW/2, barY + 24);

        // === RECOMPENSAS (rodap√© do card) ===
        const rwY = cardY + cardH - 30;
        ctx.fillStyle = "rgba(0,0,0,0.4)";
        ctx.beginPath(); ctx.roundRect(cx+2, rwY-16, cardW-4, 40, [0,0,7,7]); ctx.fill();

        ctx.font = "bold 13px Rajdhani"; ctx.textAlign = "center";
        // Zeni
        ctx.fillStyle = "#f1c40f"; ctx.shadowBlur = 6; ctx.shadowColor = "#f1c40f";
        ctx.fillText(`üí∞ +${m.zeniReward}Z`, cx + cardW*0.35, rwY+6);
        // EXP
        ctx.fillStyle = "#9b59b6"; ctx.shadowBlur = 6; ctx.shadowColor = "#9b59b6";
        ctx.fillText(`‚¨Ü +${m.expReward}EXP`, cx + cardW*0.65, rwY+6);
        ctx.shadowBlur = 0;

        ctx.restore();
    });

    // === PAINEL DE B√îNUS DI√ÅRIO ===
    const bonusY = cardY + cardH + 18;
    const allDone3 = completedCount >= 3;

    ctx.save();
    let bonusGrad = ctx.createLinearGradient(W/2-340, bonusY, W/2+340, bonusY+68);
    bonusGrad.addColorStop(0, allDone3 ? "rgba(46,204,113,0.15)" : "rgba(241,196,15,0.08)");
    bonusGrad.addColorStop(1, allDone3 ? "rgba(46,204,113,0.05)" : "rgba(241,196,15,0.03)");
    ctx.fillStyle = bonusGrad;
    ctx.strokeStyle = allDone3 ? "#2ecc71" : "rgba(241,196,15,0.4)";
    ctx.lineWidth = allDone3 ? 2 : 1;
    ctx.shadowBlur = allDone3 ? 15 : 0; ctx.shadowColor = "#2ecc71";
    ctx.beginPath(); ctx.roundRect(W/2-340, bonusY, 680, 68, 8); ctx.fill(); ctx.stroke();
    ctx.shadowBlur = 0;

    // √çcone
    ctx.font = "26px serif"; ctx.textAlign = "center";
    ctx.fillText(allDone3 ? "üèÜ" : "üåü", W/2-280, bonusY+42);

    // Texto de b√¥nus
    ctx.font = "bold 14px Rajdhani"; ctx.fillStyle = allDone3 ? "#2ecc71" : "#f1c40f";
    ctx.fillText("B√îNUS: Complete as 3 miss√µes di√°rias", W/2+20, bonusY+26);
    ctx.font = "12px Rajdhani"; ctx.fillStyle = allDone3 ? "rgba(46,204,113,0.9)" : "rgba(255,255,255,0.4)";
    ctx.fillText(allDone3 ? "‚úì B√îNUS DESBLOQUEADO ‚Äî +2000Z e +200EXP!" : `Faltam ${3-completedCount} miss√£o(√µes) ¬∑ Recompensa: +2000Z e +200EXP`, W/2+20, bonusY+48);

    // Bolinhas de progresso
    for(let b=0; b<3; b++) {
        const bx2 = W/2+230+b*24, by2 = bonusY+34;
        const bDone = b < completedCount;
        ctx.fillStyle = bDone ? "#2ecc71" : "rgba(255,255,255,0.1)";
        ctx.strokeStyle = bDone ? "#2ecc71" : "rgba(255,255,255,0.2)"; ctx.lineWidth = 1.5;
        ctx.shadowBlur = bDone ? 8 : 0; ctx.shadowColor = "#2ecc71";
        ctx.beginPath(); ctx.arc(bx2, by2, 8, 0, Math.PI*2); ctx.fill(); ctx.stroke();
        ctx.shadowBlur = 0;
        if(bDone) { ctx.font = "bold 11px Rajdhani"; ctx.fillStyle="#000"; ctx.fillText("‚úì", bx2, by2+4); }
    }
    ctx.restore();

    drawSparkBtn(W/2 - 120, H - 65, 240, 48, "‚óÄ  VOLTAR", UI_COLORS.danger);
}

function generateDailyReward() {
    // Gera recompensa baseada no n√≠vel do jogador e streak
    const streak = player.dailyStreak || 0;
    const lvl = player.level || 1;
    const tier = Math.floor(Math.random() * 3); // 0=Zeni, 1=Item, 2=Grande Zeni
    
    // Raridade aumenta com streak e n√≠vel
    const bonusMult = 1 + streak * 0.1 + lvl * 0.05;
    
    const rewards = [];
    
    // Recompensa principal
    if (tier === 0 || tier === 2) {
        const base = tier === 2 ? 2000 : 800;
        const zeni = Math.floor(base * bonusMult * (0.8 + Math.random() * 0.4));
        rewards.push({ type: "zeni", amount: zeni, label: `${zeni} ZENI`, color: "#f1c40f" });
    } else {
        const itemKeys = Object.keys(itemsDB);
        const rndItem = itemKeys[Math.floor(Math.random() * itemKeys.length)];
        rewards.push({ type: "item", key: rndItem, label: itemsDB[rndItem].name, color: "#00d2ff" });
    }
    
    // B√¥nus de EXP sempre
    const exp = Math.floor(20 * bonusMult * (1 + Math.random()));
    rewards.push({ type: "exp", amount: exp, label: `+${exp} EXP`, color: "#2ecc71" });
    
    // B√¥nus especial no streak 7, 14, 21...
    if ((streak + 1) % 7 === 0) {
        rewards.push({ type: "zeni", amount: 5000, label: "B√îNUS SEMANAL: 5000 ZENI!", color: "#e67e22" });
    }
    
    return rewards;
}

function drawDailyReward() {
    const W = canvas.width, H = canvas.height;
    ctx.fillStyle = "#080400"; ctx.fillRect(0,0,W,H);
    
    // Part√≠culas douradas festivas
    for(let i=0; i<30; i++) {
        let px = (Math.sin(i * 137.5 + timeEnv * 2) * 0.5 + 0.5) * W;
        let py = (Math.cos(i * 97.3 + timeEnv * 1.5) * 0.5 + 0.5) * H;
        let pr = 1 + Math.abs(Math.sin(i + timeEnv)) * 3;
        ctx.beginPath(); ctx.arc(px, py, pr, 0, Math.PI*2);
        ctx.fillStyle = i % 2 === 0 ? "#f5c518" : "#ff8c00"; ctx.globalAlpha = 0.4; ctx.fill();
    }
    ctx.globalAlpha = 1;
    
    // Grelha quente
    ctx.strokeStyle = "rgba(245, 197, 24, 0.04)"; ctx.lineWidth = 1;
    for(let i=0; i<W; i+=50) { ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,H); ctx.stroke(); }
    for(let i=0; i<H; i+=50) { ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(W,i); ctx.stroke(); }

    const today = new Date().toDateString();
    const alreadyClaimed = player.lastDailyReward === today;
    const streak = player.dailyStreak || 0;

    // === HEADER FIXO ===
    // Fundo do header
    let hdrBg = ctx.createLinearGradient(0,0,0,115);
    hdrBg.addColorStop(0,"rgba(8,4,0,0.99)"); hdrBg.addColorStop(1,"rgba(8,4,0,0.9)");
    ctx.fillStyle = hdrBg; ctx.fillRect(0,0,W,115);
    
    // T√≠tulo
    ctx.font = "italic 52px Bangers"; ctx.textAlign = "center";
    ctx.shadowBlur = 25; ctx.shadowColor = "#f5c518";
    ctx.fillStyle = "#ff8c00"; ctx.fillText("RECOMPENSA", W/2 - 160, 68);
    ctx.fillStyle = "#f5c518"; ctx.fillText("DI√ÅRIA", W/2 + 120, 68);
    ctx.shadowBlur = 0;
    ctx.fillStyle = "rgba(255,140,0,0.35)"; ctx.fillRect(0, 112, W, 1);
    
    // Streak no header
    ctx.font = "bold 14px Rajdhani"; ctx.fillStyle = "#e67e22"; ctx.textAlign = "center";
    ctx.fillText(`üî• SEQU√äNCIA: ${streak} DIA${streak !== 1 ? 'S' : ''} CONSECUTIVOS`, W/2, 95);

    // === √ÅREA ROL√ÅVEL ===
    const scrollAreaTop = 115;
    const scrollAreaH = H - 115 - 60; // deixa espa√ßo para bot√£o voltar
    
    // Calcular altura total do conte√∫do
    let contentH = 0;
    if (alreadyClaimed) {
        contentH = 320;
    } else {
        if (!dailyRewardPending) dailyRewardPending = generateDailyReward();
        contentH = 260 + 100; // cards + bot√£o recolher
    }
    contentH += 120; // streak bar + calend√°rio
    
    let maxDRS = Math.min(0, scrollAreaH - contentH - 20);
    targetDailyRewardScrollY = Math.max(maxDRS, Math.min(0, targetDailyRewardScrollY));
    
    ctx.save();
    ctx.beginPath(); ctx.rect(0, scrollAreaTop, W, scrollAreaH); ctx.clip();
    
    let sy = scrollAreaTop + 20 + dailyRewardScrollY;
    
    // Barra de streak (7 dias)
    const streakBarW = 480; const streakBarX = W/2 - streakBarW/2;
    ctx.fillStyle = "rgba(255,255,255,0.08)";
    ctx.beginPath(); ctx.roundRect(streakBarX, sy, streakBarW, 14, 7); ctx.fill();
    let sGrad = ctx.createLinearGradient(streakBarX, 0, streakBarX + streakBarW * ((streak % 7) / 7 || 0.01), 0);
    sGrad.addColorStop(0, "#c06000"); sGrad.addColorStop(1, "#f5c518");
    ctx.fillStyle = sGrad;
    ctx.beginPath(); ctx.roundRect(streakBarX, sy, streakBarW * ((streak % 7) / 7 || 0.01), 14, 7); ctx.fill();
    ctx.font = "12px Rajdhani"; ctx.fillStyle = "rgba(255,255,255,0.5)"; ctx.textAlign = "center";
    ctx.fillText(`Pr√≥ximo b√¥nus em ${7 - (streak % 7)} dia(s) ‚Äî b√¥nus a cada 7 dias`, W/2, sy + 30);
    sy += 50;
    
    if (alreadyClaimed) {
        // J√° coletou hoje
        drawSparkPanel(W/2 - 300, sy, 600, 180, "rgba(46,204,113,0.1)", "#2ecc71");
        ctx.font = "italic 34px Oswald"; ctx.fillStyle = "#2ecc71"; ctx.textAlign = "center";
        ctx.shadowBlur = 12; ctx.shadowColor = "#2ecc71";
        ctx.fillText("‚úì RECOMPENSA COLETADA HOJE!", W/2, sy + 65);
        ctx.shadowBlur = 0;
        ctx.font = "bold 18px Rajdhani"; ctx.fillStyle = "rgba(255,255,255,0.6)";
        const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 1);
        ctx.fillText(`Volte amanh√£ ‚Äî ${tomorrow.toLocaleDateString('pt-BR')}`, W/2, sy + 105);
        ctx.font = "bold 15px Rajdhani"; ctx.fillStyle = "#f1c40f";
        ctx.fillText(`STREAK ATUAL: ${streak} dia(s) | B√¥nus semanal a cada 7 dias!`, W/2, sy + 140);
        sy += 200;
    } else {
        // Mostrar as recompensas pendentes
        const rewards = dailyRewardPending;
        
        ctx.font = "bold 16px Rajdhani"; ctx.fillStyle = "#aaa"; ctx.textAlign = "center";
        ctx.fillText("CLIQUE EM RECOLHER PARA GANHAR:", W/2, sy + 10);
        sy += 30;
        
        const cardW = 210; const gap = 18;
        const totalW = rewards.length * cardW + (rewards.length - 1) * gap;
        const startX = W/2 - totalW/2;
        
        rewards.forEach((r, i) => {
            const cx = startX + i * (cardW + gap);
            const cy = sy;
            let hov = mouse.x > cx && mouse.x < cx + cardW && mouse.y > cy + scrollAreaTop - (scrollAreaTop - dailyRewardScrollY) && mouse.y < cy + 165 + scrollAreaTop - (scrollAreaTop - dailyRewardScrollY);
            
            // Card background
            ctx.save();
            let cGrd = ctx.createLinearGradient(cx, cy, cx, cy+165);
            cGrd.addColorStop(0, hov ? `rgba(241,196,15,0.18)` : "rgba(255,255,255,0.05)");
            cGrd.addColorStop(1, "rgba(0,0,0,0.7)");
            ctx.fillStyle = cGrd;
            ctx.strokeStyle = r.color + (hov ? "cc" : "55");
            ctx.lineWidth = hov ? 2 : 1;
            ctx.shadowBlur = hov ? 18 : 0; ctx.shadowColor = r.color;
            ctx.beginPath(); ctx.roundRect(cx, cy, cardW, 165, 8); ctx.fill(); ctx.stroke();
            ctx.shadowBlur = 0;
            
            // Linha de acento topo
            let topLine = ctx.createLinearGradient(cx,0,cx+cardW,0);
            topLine.addColorStop(0,"transparent"); topLine.addColorStop(0.5,r.color); topLine.addColorStop(1,"transparent");
            ctx.fillStyle = topLine; ctx.fillRect(cx+8, cy, cardW-16, 2);
            
            let icon = r.type === "zeni" ? "üí∞" : r.type === "item" ? "üì¶" : "‚ú®";
            ctx.font = "44px serif"; ctx.textAlign = "center";
            ctx.fillText(icon, cx + cardW/2, cy + 68);
            
            ctx.font = "bold 16px Rajdhani"; ctx.fillStyle = r.color;
            ctx.shadowBlur = 6; ctx.shadowColor = r.color;
            ctx.fillText(r.label.toUpperCase(), cx + cardW/2, cy + 103);
            ctx.shadowBlur = 0;
            
            if (r.type === "item") {
                ctx.font = "12px Rajdhani"; ctx.fillStyle = "rgba(255,255,255,0.5)";
                let desc = (itemsDB[r.key]?.desc || "").substring(0,28);
                ctx.fillText(desc + (desc.length >= 28 ? "..." : ""), cx + cardW/2, cy + 122);
            }
            
            ctx.font = "bold 12px Rajdhani"; ctx.fillStyle = "rgba(255,255,255,0.3)";
            ctx.fillText(r.type === "zeni" ? "ZENI" : r.type === "item" ? "ITEM" : "EXPERI√äNCIA", cx + cardW/2, cy + 148);
            ctx.restore();
        });
        sy += 185;
        
        // Bot√£o Recolher (dentro da √°rea rol√°vel)
        drawSparkBtn(W/2 - 160, sy, 320, 52, "‚≠ê RECOLHER RECOMPENSA", "#f1c40f", "#000");
        sy += 75;
    }
    
    // Separador
    ctx.fillStyle = "rgba(245,197,24,0.2)"; ctx.fillRect(W/2-220, sy, 440, 1); sy += 18;
    
    // Calend√°rio mini de checkboxes (√∫ltimos 7 dias)
    const calStartX = W/2 - 175;
    ctx.font = "bold 13px Rajdhani"; ctx.fillStyle = "#888"; ctx.textAlign = "center";
    ctx.fillText("HIST√ìRICO DE PRESEN√áA (7 DIAS)", W/2, sy + 4);
    sy += 22;
    for(let d = 0; d < 7; d++) {
        const cx = calStartX + d * 52;
        const filled = d < (streak % 7) || (streak >= 7 && d < 7);
        ctx.fillStyle = filled ? "#f1c40f" : "rgba(255,255,255,0.1)";
        ctx.shadowBlur = filled ? 8 : 0; ctx.shadowColor = "#f1c40f";
        ctx.beginPath(); ctx.arc(cx + 15, sy + 15, 14, 0, Math.PI*2); ctx.fill();
        ctx.shadowBlur = 0;
        if (filled) { ctx.fillStyle = "#000"; ctx.font = "bold 14px Rajdhani"; ctx.textAlign = "center"; ctx.fillText("‚úì", cx + 15, sy + 20); }
        ctx.font = "11px Rajdhani"; ctx.fillStyle = filled ? "#f1c40f" : "#666";
        ctx.fillText(`D${d+1}`, cx + 15, sy + 40);
    }

    ctx.restore();
    
    // Scrollbar
    if (contentH > scrollAreaH) {
        drawScrollbar(W - 12, scrollAreaTop, scrollAreaH, dailyRewardScrollY, maxDRS);
    }
    
    // === RODAP√â FIXO (bot√£o voltar) ===
    let footBg = ctx.createLinearGradient(0, H-62, 0, H);
    footBg.addColorStop(0,"rgba(8,4,0,0.0)"); footBg.addColorStop(0.3,"rgba(8,4,0,0.97)");
    ctx.fillStyle = footBg; ctx.fillRect(0, H-62, W, 62);
    drawSparkBtn(W/2 - 110, H - 56, 220, 44, "‚óÄ  VOLTAR", UI_COLORS.danger);
}

function claimDailyReward() {
    if (!dailyRewardPending) dailyRewardPending = generateDailyReward();
    const rewards = dailyRewardPending;
    
    rewards.forEach(r => {
        if (r.type === "zeni") { player.zeni += r.amount; }
        else if (r.type === "exp") {
            player.exp += r.amount;
            while(player.exp >= player.expToNext) {
                player.level++; player.exp -= player.expToNext;
                player.expToNext = Math.floor(player.expToNext * 1.5);
                player.statPoints += 3;
            }
        }
        else if (r.type === "item") {
            player.inventory[r.key] = (player.inventory[r.key] || 0) + 1;
        }
    });
    
    const today = new Date().toDateString();
    // Verifica streak (se ontem coletou, incrementa; sen√£o reseta)
    const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
    if (player.lastDailyReward === yesterday.toDateString()) {
        player.dailyStreak = (player.dailyStreak || 0) + 1;
    } else {
        player.dailyStreak = 1;
    }
    player.lastDailyReward = today;
    dailyRewardPending = null;
    save();
    
    const totalZeni = rewards.filter(r=>r.type==="zeni").reduce((s,r)=>s+r.amount, 0);
    showMessage(totalZeni > 0 ? `RECOMPENSA COLETADA! +${totalZeni} ZENI` : "RECOMPENSA DI√ÅRIA COLETADA!");
    playSound(600, 'sine', 0.15); setTimeout(()=>playSound(900,'sine',0.15),200); setTimeout(()=>playSound(1200,'sine',0.3),400);


    ctx.fillStyle = "#060200"; ctx.fillRect(0,0,canvas.width,canvas.height);
    
    // Grelha quente
    ctx.strokeStyle = "rgba(245, 197, 24, 0.04)"; ctx.lineWidth = 1;
    for(let i=0; i<canvas.width; i+=50) { ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,canvas.height); ctx.stroke(); }
    for(let i=0; i<canvas.height; i+=50) { ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(canvas.width,i); ctx.stroke(); }

    // T√≠tulo
    ctx.font = "italic 56px Bangers"; ctx.fillStyle = "#f5c518"; ctx.textAlign = "center";
    ctx.shadowBlur = 20; ctx.shadowColor = "#ff8c00";
    ctx.fillText("üì∞ UPDATE NEWS", canvas.width/2, 88);
    ctx.shadowBlur = 0;

    // Linha decorativa
    ctx.fillStyle = "#ff8c00"; ctx.fillRect(canvas.width/2 - 200, 100, 400, 2);
    ctx.fillStyle = "rgba(245,197,24,0.2)"; ctx.fillRect(canvas.width/2 - 350, 100, 140, 2);
    ctx.fillRect(canvas.width/2 + 210, 100, 140, 2);

    // Dados das atualiza√ß√µes
    const updates = [
        {
            version: "v1.5.0",
            date: "22/02/2026",
            color: "#e67e22",
            title: "DragonBallDeluge",
            items: [
                "Personagens adicionados: GokuGt(todas as formas),VegetaGt(todas as formas),Goku(ultrainstinto)",
                "vegeta Blue Evolution, BrolyDBS(todas as formas)",
                "Baby(todas as formas, extras), GokuDBSBroly(todas as formas)",
                "VegetaDBSBroly(Todas as formas)(ambos trajes do GokuDBS e do VegetaDBS)",
                "FreezaDBSBroly(Golden)(traje do FreezaDBS),"
            ]
        }
    ];

    let panelY = 135;
    updates.forEach((upd) => {
        let panelH = 50 + upd.items.length * 28;
        drawSparkPanel(80, panelY, canvas.width - 160, panelH, "rgba(10, 15, 20, 0.9)", upd.color);

        // Badge de vers√£o
        ctx.fillStyle = upd.color;
        ctx.beginPath();
        ctx.moveTo(90, panelY + 10); ctx.lineTo(180, panelY + 10);
        ctx.lineTo(170, panelY + 40); ctx.lineTo(80, panelY + 40);
        ctx.closePath(); ctx.fill();
        ctx.font = "bold 18px Oswald"; ctx.fillStyle = "#000"; ctx.textAlign = "center";
        ctx.fillText(upd.version, 130, panelY + 30);

        // T√≠tulo e data
        ctx.font = "italic 24px Oswald"; ctx.fillStyle = "#fff"; ctx.textAlign = "left";
        ctx.fillText(upd.title, 200, panelY + 30);
        ctx.font = "bold 14px Rajdhani"; ctx.fillStyle = "rgba(255,255,255,0.4)"; ctx.textAlign = "right";
        ctx.fillText(upd.date, canvas.width - 110, panelY + 30);

        // Linha separadora
        ctx.fillStyle = `rgba(${upd.color === "#f1c40f" ? "241,196,15" : upd.color === "#00d2ff" ? "0,210,255" : upd.color === "#2ecc71" ? "46,204,113" : "230,126,34"},0.3)`;
        ctx.fillRect(200, panelY + 42, canvas.width - 320, 1);

        // Itens da atualiza√ß√£o
        upd.items.forEach((item, idx) => {
            ctx.font = "16px Rajdhani"; ctx.fillStyle = "rgba(255,255,255,0.85)"; ctx.textAlign = "left";
            ctx.fillStyle = upd.color; ctx.fillText("‚ñ∂", 105, panelY + 62 + idx * 28);
            ctx.fillStyle = "rgba(255,255,255,0.85)";
            ctx.fillText(item, 125, panelY + 62 + idx * 28);
        });

        panelY += panelH + 15;
    });

    // Rodap√©
    ctx.font = "14px Rajdhani"; ctx.fillStyle = "rgba(255,255,255,0.3)"; ctx.textAlign = "center";
    ctx.fillText("DRAGON DELUGE ‚Äî DESENVOLVIDO POR PHYETRO", canvas.width/2, canvas.height - 100);

    drawSparkBtn(canvas.width/2 - 100, canvas.height - 75, 200, 50, "VOLTAR", "#e74c3c");
}
function toggleFullscreen() {
    const wrapper = document.getElementById('gameWrapper');
    if (!document.fullscreenElement) {
        const reqFS = wrapper.requestFullscreen 
            || wrapper.webkitRequestFullscreen 
            || wrapper.mozRequestFullScreen 
            || wrapper.msRequestFullscreen;
        if (reqFS) {
            reqFS.call(wrapper).then(() => {
                // Tenta for√ßar orienta√ß√£o landscape ap√≥s fullscreen
                if (screen.orientation && screen.orientation.lock) {
                    screen.orientation.lock('landscape').catch(() => {});
                }
            }).catch(() => {});
        }
    } else {
        const exitFS = document.exitFullscreen 
            || document.webkitExitFullscreen 
            || document.mozCancelFullScreen 
            || document.msExitFullscreen;
        if (exitFS) exitFS.call(document);
    }
}
window.toggleFullscreen = toggleFullscreen;

document.getElementById('fullscreenBtn').addEventListener('click', toggleFullscreen);

document.addEventListener('fullscreenchange', () => {
    const btn = document.getElementById('fullscreenBtn');
    if (document.fullscreenElement) {
        btn.textContent = '‚úï'; btn.title = 'Sair da Tela Cheia';
        btn.style.opacity = '0.4';
    } else {
        btn.textContent = '‚õ∂'; btn.title = 'Tela Cheia';
        btn.style.opacity = '0.5';
    }
});
document.addEventListener('webkitfullscreenchange', () => {
    const btn = document.getElementById('fullscreenBtn');
    if (document.webkitFullscreenElement) {
        btn.textContent = '‚úï'; btn.style.opacity = '0.4';
    } else {
        btn.textContent = '‚õ∂'; btn.style.opacity = '0.5';
    }
});

// ‚îÄ‚îÄ ORIENTA√á√ÉO E FULLSCREEN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function checkOrientation() {
    const rotateOverlay = document.getElementById('rotate-overlay');
    const gameWrapper   = document.getElementById('gameWrapper');
    if (!rotateOverlay) return;

    const isMobile  = window.innerWidth <= 900 || ('ontouchstart' in window);
    const isPortrait = window.innerHeight > window.innerWidth;

    if (isMobile && isPortrait) {
        // Portrait: mostra aviso de rota√ß√£o, esconde o canvas
        rotateOverlay.style.display = 'flex';
        gameWrapper.style.display   = 'none';
        // O #auth-overlay √© fixed e cobre a tela ‚Äî continua vis√≠vel se n√£o logado
    } else {
        // Landscape: esconde aviso, mostra o jogo
        rotateOverlay.style.display = 'none';
        gameWrapper.style.display   = '';
    }
}
window.addEventListener('resize', checkOrientation);
window.addEventListener('orientationchange', checkOrientation);
checkOrientation();

draw();
</script>
</body>
</html>
